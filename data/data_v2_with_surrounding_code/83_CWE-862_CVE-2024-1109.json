{
    "cve_id": "CVE-2024-1109",
    "cve_description": "The Podlove Podcast Publisher plugin for WordPress is vulnerable to unauthorized access of data due to a missing capability check on the init_download() and init() functions in all versions up to, and including, 4.0.11. This makes it possible for unauthenticated attackers to export the plugin's tracking data and podcast information.",
    "cve_publish_date": "2024-02-07T11:15Z",
    "cwe_id": "CWE-862",
    "cwe_name": "Missing Authorization",
    "cwe_description": "The product does not perform an authorization check when an actor attempts to access a resource or perform an action.",
    "commit_message": "fix: add missing capability check and nonce validation to exporter functions",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "import_export.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "11",
            "number_of_lines_deleted_vulnerable_to_cve": "12",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 14:             Export\\PodcastExporter::init();",
                "// Line 15:             Import\\PodcastImporter::init();",
                "// Line 16:             Export\\TrackingExporter::init();",
                "// Line 17:             Import\\TrackingImporter::init();",
                "// Line 18:             $this->register_tools();",
                "// Line 19:         });",
                "// Line 20: ",
                "// Line 21:         add_action('admin_enqueue_scripts', function () {",
                "// Line 22:             if (isset($_REQUEST['page']) && $_REQUEST['page'] === 'podlove_tools_settings_handle') {",
                "// Line 23:                 wp_enqueue_script('podlove_admin_import_script', $this->get_module_url().'/js/import.js', ['jquery'], \\Podlove\\get_plugin_header('Version'));",
                "// vulnerable line: 24: }",
                "// Line 25:         });",
                "// Line 26: ",
                "// Line 27:         add_action('admin_notices', function () {",
                "// Line 28:             if (!isset($_GET['page'])) {",
                "// Line 29:                 return false;",
                "// vulnerable line: 30: }",
                "// Line 31: ",
                "// Line 32:             if ($_GET['page'] != 'podlove_tools_settings_handle') {",
                "// Line 33:                 return false;",
                "// vulnerable line: 34: }",
                "// Line 35: ",
                "// Line 36:             if (!isset($_GET['status'])) {",
                "// Line 37:                 return false;",
                "// Line 38:             } ?>",
                "// Line 39:             <div class=\"updated\">",
                "// Line 40:                 <p>",
                "// Line 41:                     <?php",
                "// Line 42:                     switch ($_GET['status']) {",
                "// Line 43:                         case 'success':",
                "// Line 44:                             echo __('Import successful. Happy podcasting!');",
                "// Line 46:                             break;",
                "// Line 47:                         case 'version-warning':",
                "// Line 48:                             echo __('Heads up: Your export file was exported from a Publisher with a different version. If possible, both Publisher versions should be identical. However, that might not be a problem. Happy podcasting!');",
                "// Line 49: ",
                "// Line 50:                             break;",
                "// Line 51:                     } ?>",
                "// Line 52:                 </p>",
                "// Line 53:             </div>",
                "// Line 54:             <?php",
                "// Line 55:         });",
                "// vulnerable line: 56: }",
                "// Line 57: ",
                "// Line 58:     public function register_tools()",
                "// Line 59:     {",
                "// Line 60:         \\Podlove\u0007dd_tools_section(",
                "// Line 61:             'import-export',",
                "// Line 62:             __('Import & Export', 'podlove-podcasting-plugin-for-wordpress'),",
                "// Line 63:             function () {",
                "// Line 64:                 if (defined('SAVEQUERIES') && SAVEQUERIES) {",
                "// Line 65:                     ?>",
                "// Line 66:                     <div class=\"error\">",
                "// Line 67:                         <p>",
                "// Line 68:                             <b><?php echo __('Heads up!', 'podlove-podcasting-plugin-for-wordpress'); ?></b>",
                "// Line 69:                             <?php echo __('The WordPress debug option <code>SAVEQUERIES</code> is active. This might lead to memory issues when exporting or importing tracking data.<br>It is probably defined in <code>wp-config.php</code>. Please turn it off before using the export tool.', 'podlove-podcasting-plugin-for-wordpress'); ?>",
                "// Line 70:                         </p>",
                "// Line 71:                     </div>",
                "// Line 72:                     <?php",
                "// vulnerable line: 73: }",
                "// vulnerable line: 74: }",
                "// Line 75:         );",
                "// Line 76: ",
                "// Line 77:         \\Podlove\u0007dd_tools_field(",
                "// Line 78:             'export-podcast',",
                "// Line 79:             __('Podcast Export', 'podlove-podcasting-plugin-for-wordpress'),",
                "// Line 80:             [$this, 'tools_podcast_export'],",
                "// Line 81:             'import-export'",
                "// Line 82:         );",
                "// Line 83: ",
                "// Line 84:         \\Podlove\u0007dd_tools_field(",
                "// Line 94:             [$this, 'tools_podcast_import'],",
                "// Line 95:             'import-export'",
                "// Line 96:         );",
                "// Line 97: ",
                "// Line 98:         \\Podlove\u0007dd_tools_field(",
                "// Line 99:             'import-tracking',",
                "// Line 100:             __('Tracking Import', 'podlove-podcasting-plugin-for-wordpress'),",
                "// Line 101:             [$this, 'tools_tracking_import'],",
                "// Line 102:             'import-export'",
                "// Line 103:         );",
                "// vulnerable line: 104: }",
                "// Line 105: ",
                "// Line 106:     public function tools_podcast_export()",
                "// Line 107:     {",
                "// Line 108:         echo sprintf(",
                "// Line 109:             __('This export complements the existing %sWordPress export tool%s. It contains all relevant podcast data to enable you to move from this WordPress instance to another. Step by step:', 'podlove-podcasting-plugin-for-wordpress'),",
                "// Line 110:             '<a href=\"'.admin_url('export.php').'\">',",
                "// Line 111:             '</a>'",
                "// Line 112:         ); ?>",
                "// Line 113:         <ol>",
                "// Line 114:             <li>",
                "// Line 116:             __('Go to the %sWordPress export tool%s and export all data.', 'podlove-podcasting-plugin-for-wordpress'),",
                "// Line 117:             '<a href=\"'.admin_url('export.php').'\">',",
                "// Line 118:             '</a>'",
                "// Line 119:         ); ?>",
                "// Line 120:             </li>",
                "// Line 121:             <li><?php echo __('Import this file to your new WordPress instance.', 'podlove-podcasting-plugin-for-wordpress'); ?></li>",
                "// Line 122:             <li><?php echo __('Use the button below to export the podcast data file.', 'podlove-podcasting-plugin-for-wordpress'); ?></li>",
                "// Line 123:             <li><?php echo __('In your new WordPress instance, import that file.', 'podlove-podcasting-plugin-for-wordpress'); ?></li>",
                "// Line 124:         </ol>",
                "// Line 125: ",
                "// vulnerable line: 126: <a href=\"?podlove_export=1\" class=\"button\"><?php echo __('Export Podcast Data', 'podlove-podcasting-plugin-for-wordpress'); ?></a>",
                "// Line 127:         <?php",
                "// vulnerable line: 128: }",
                "// Line 129: ",
                "// Line 130:     public function tools_tracking_export()",
                "// Line 131:     {",
                "// Line 132:         ?>",
                "// Line 133:         <p>",
                "// Line 134:             <?php echo __('Im- and export of tracking data is a separate task. After you have completed the steps above, you can ex- and import tracking data.', 'podlove-podcasting-plugin-for-wordpress'); ?>",
                "// Line 135:         </p>",
                "// Line 136:         <p>",
                "// Line 137:             <button id=\"podlove_tracking_export\" class=\"button\"><?php echo __('Export Tracking Data', 'podlove-podcasting-plugin-for-wordpress'); ?></button>",
                "// Line 138:             <span id=\"podlove_tracking_export_status_wrapper\">",
                "// Line 139:                 <?php echo __('Export', 'podlove-podcasting-plugin-for-wordpress'); ?>: <span id=\"podlove_tracking_export_status\">starting ...</span>",
                "// Line 140:             </span>",
                "// Line 141:         </p>",
                "// Line 142: ",
                "// Line 143:         <style type=\"text/css\">",
                "// Line 144:         #podlove_tracking_export_status_wrapper {",
                "// Line 145:             display: none;",
                "// vulnerable line: 146: }",
                "// Line 147:         </style>",
                "// Line 148: ",
                "// Line 149:         <script type=\"text/javascript\">",
                "// Line 150:         (function($) {",
                "// Line 151: ",
                "// Line 152:             var timeoutID = null;",
                "// Line 153: ",
                "// Line 154:             var podlove_check_export_status = function() {",
                "// Line 155: ",
                "// Line 156:                 if (timeoutID) {",
                "// Line 157:                     window.clearTimeout(timeoutID);",
                "// vulnerable line: 158: }",
                "// Line 159: ",
                "// Line 160:                 $.ajax({",
                "// Line 161:                     url: ajaxurl,",
                "// Line 162:                     data: {action: 'podlove-export-tracking-status'},",
                "// vulnerable line: 163: dataType: 'json',",
                "// vulnerable line: 164: success: function(result) {",
                "// Line 165:                         if (result.all && result.progress) {",
                "// Line 166:                             $(\"#podlove_tracking_export\").attr('disabled', 'disabled');",
                "// Line 167:                             $(\"#podlove_tracking_export_status\").html((Math.round(1000.0 * (result.progress / result.all))/10.0) + \"%\");",
                "// Line 168:                             $(\"#podlove_tracking_export_status_wrapper\").show();",
                "// Line 169: ",
                "// Line 170:                             timeoutID = window.setTimeout(podlove_check_export_status, 1000);",
                "// vulnerable line: 171: } ",
                "// Line 172: ",
                "// Line 173:                         if (result.finished) {",
                "// Line 174:                             $(\"#podlove_tracking_export\").attr('disabled', false);",
                "// Line 175:                             $(\"#podlove_tracking_export_status_wrapper\").hide();",
                "// vulnerable line: 176: window.location = window.location + \"&podlove_export_tracking=1\";",
                "// vulnerable line: 177: }",
                "// vulnerable line: 178: }",
                "// Line 179:                 });",
                "// Line 180: ",
                "// Line 181:             };",
                "// Line 182: ",
                "// Line 183:             $(\"#podlove_tracking_export\").on(\"click\", function() {",
                "// Line 184: ",
                "// Line 185:                 $(\"#podlove_tracking_export\").attr('disabled', 'disabled');",
                "// Line 186:                 $(\"#podlove_tracking_export_status_wrapper\").show();",
                "// Line 187: ",
                "// Line 188:                 $.ajax({",
                "// Line 189:                     url: ajaxurl,",
                "// vulnerable line: 190: data: {action: 'podlove-export-tracking'},",
                "// vulnerable line: 191: dataType: 'json',",
                "// vulnerable line: 192: success: function(result) {",
                "// Line 193:                         console.log(\"tracking export finished\");",
                "// vulnerable line: 194: }",
                "// Line 195:                 });",
                "// Line 196: ",
                "// vulnerable line: 197: window.setTimeout(podlove_check_export_status, 2000);",
                "// Line 198:             });",
                "// Line 199: ",
                "// Line 200:             // start immediately, in case the user refreshes the page",
                "// Line 201:             podlove_check_export_status();",
                "// Line 202:         }(jQuery));",
                "// vulnerable line: 203: </script>        ",
                "// Line 204:         <?php",
                "// vulnerable line: 205: }",
                "// Line 206: ",
                "// Line 207:     public function tools_podcast_import()",
                "// Line 208:     {",
                "// Line 209:         ?>",
                "// Line 210:         <p>",
                "// Line 211:             <?php echo __('Use this import on <strong>fresh installs only</strong>! Otherwise you may lose data. In any case, you should have backups.', 'podlove-podcasting-plugin-for-wordpress'); ?>",
                "// Line 212:         </p>",
                "// Line 213: ",
                "// Line 214:         <form method=\"POST\" enctype=\"multipart/form-data\">",
                "// Line 215:             (<span><?php echo self::get_maximum_upload_size_text(); ?></span>)",
                "// vulnerable line: 216: <input type=\"file\" name=\"podlove_import\"/> ",
                "// Line 217:             <input type=\"submit\" value=\"<?php echo __('Import Podcast Data', 'podlove-podcasting-plugin-for-wordpress'); ?>\" class=\"button\" />",
                "// Line 218:             <?php wp_nonce_field('podlove_import', '_podlove_nonce'); ?>",
                "// vulnerable line: 219: </form>        ",
                "// Line 220:         <?php",
                "// vulnerable line: 221: }",
                "// Line 222: ",
                "// Line 223:     public function tools_tracking_import()",
                "// Line 224:     {",
                "// Line 225:         ?>",
                "// Line 226:         <form method=\"POST\" enctype=\"multipart/form-data\">",
                "// Line 227:             (<span><?php echo self::get_maximum_upload_size_text(); ?></span>)",
                "// Line 228:             <input type=\"file\" name=\"podlove_import_tracking\"/>",
                "// Line 229:             <input type=\"submit\" value=\"<?php echo __('Import Tracking Data', 'podlove-podcasting-plugin-for-wordpress'); ?>\" class=\"button\" />",
                "// Line 230:             <?php wp_nonce_field('podlove_import_tracking', '_podlove_nonce'); ?>",
                "// vulnerable line: 231: </form>        ",
                "// Line 232:         <?php",
                "// vulnerable line: 233: }",
                "// Line 234: ",
                "// Line 235:     public static function get_maximum_upload_size_text()",
                "// Line 236:     {",
                "// Line 237:         // this is exactly the same way it is done in wp_import_upload_form()",
                "// Line 238:         $bytes = apply_filters('import_upload_size_limit', \\wp_max_upload_size());",
                "// Line 239:         $size = \\size_format($bytes);",
                "// Line 240: ",
                "// Line 241:         return sprintf(__('Maximum size: %s'), $size);",
                "// vulnerable line: 242: }",
                "// vulnerable line: 243: }"
            ]
        },
        {
            "filename_of_changes": "podcast_exporter.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "8",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "tracking_exporter.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "17",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 8:     {",
                "// Line 9:         add_action('wp_ajax_podlove-export-tracking', [__CLASS__, 'export_tracking']);",
                "// Line 10:         add_action('wp_ajax_podlove-export-tracking-status', [__CLASS__, 'export_tracking_status']);",
                "// Line 11: ",
                "// Line 12:         self::init_download();",
                "// Line 13:     }",
                "// Line 14: ",
                "// Line 15:     public static function init_download()",
                "// Line 16:     {",
                "// Line 17:         if (!is_admin()) {",
                "// vulnerable line: 18: return;",
                "// Line 19:         }",
                "// Line 20: ",
                "// Line 21:         if (isset($_GET['podlove_export_tracking']) && $_GET['podlove_export_tracking']) {",
                "// Line 22:             delete_transient('podlove_tracking_export_finished');",
                "// Line 23: ",
                "// Line 24:             header('Content-Type: application/octet-stream');",
                "// Line 25:             header('Content-Description: File Transfer');",
                "// Line 26:             header('Content-Disposition: attachment; filename='.TrackingExporter::getDownloadFileName());",
                "// Line 27:             header('Cache-control: private');",
                "// Line 28:             header('Expires: -1');",
                "// Line 38: ",
                "// Line 39:         return $upload_dir['basedir'].DIRECTORY_SEPARATOR.'tracking.tmp';",
                "// Line 40:     }",
                "// Line 41: ",
                "// Line 42:     public static function export_tracking()",
                "// Line 43:     {",
                "// Line 44:         global $wpdb;",
                "// Line 45: ",
                "// Line 46:         // only one export at a time",
                "// Line 47:         if (get_option('podlove_tracking_export_all') !== false) {",
                "// vulnerable line: 48: return;",
                "// Line 49:         }",
                "// Line 50: ",
                "// Line 51:         update_option('podlove_tracking_export_all', $wpdb->get_var('SELECT COUNT(*) FROM '.\\Podlove\\Model\\DownloadIntent::table_name()));",
                "// Line 52:         update_option('podlove_tracking_export_progress', 0);",
                "// Line 53: ",
                "// Line 54:         $rowsPerQuery = 1000;",
                "// Line 55:         $lastId = 0;",
                "// Line 56:         $page = 0;",
                "// Line 57: ",
                "// Line 58:         $fp = gzopen(self::get_tracking_export_file_path(), 'w');"
            ]
        }
    ]
}