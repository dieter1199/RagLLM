{
    "cve_id": "CVE-2024-29203",
    "cve_description": "TinyMCE is an open source rich text editor. A cross-site scripting (XSS) vulnerability was discovered in TinyMCE’s content insertion code.  This allowed `iframe` elements containing malicious code to execute when inserted into the editor.  These `iframe` elements are restricted in their permissions by same-origin browser protections, but could still trigger operations such as downloading of malicious assets. This vulnerability is fixed in 6.8.1.",
    "cve_publish_date": "2024-03-26T14:15Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "TINY-10348 & TINY-10349: Add sandbox_iframes and convert_unsafe_embeds options (#9172)\n\n* TINY-10348: Add sandbox_iframes option\r\n\r\n* TINY-10349: Add convert_unsafe_embeds option\r\n\r\n* TINY-10348 & TINY-10349: Add paste tests\r\n\r\n* TINY-10348 & TINY-10349: Add changelog entries\r\n\r\n* TINY-10348: Add missing PageBreakPlugin dependency in SelectionToolbarTest\r\n\r\n* TINY-10349: Add attribute preservation tests for convert_unsafe_embeds",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "ContentFormatsTest.ts",
            "code_language": "TypeScript",
            "number_of_lines_added_for_mitigation": "18",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "DomParser.ts",
            "code_language": "TypeScript",
            "number_of_lines_added_for_mitigation": "2",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "InitContentBody.ts",
            "code_language": "TypeScript",
            "number_of_lines_added_for_mitigation": "2",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "LiveEmbedNodeTest.ts",
            "code_language": "TypeScript",
            "number_of_lines_added_for_mitigation": "26",
            "number_of_lines_deleted_vulnerable_to_cve": "7",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 1: import { ApproxStructure, Assertions, StructAssert, UiFinder } from '@ephox/agar';",
                "// vulnerable line: 2: import { describe, it } from '@ephox/bedrock-client';",
                "// vulnerable line: 3: import { Arr, Fun, Obj } from '@ephox/katamari';",
                "// vulnerable line: 4: import { TinyDom, TinyHooks } from '@ephox/wrap-mcagar';",
                "// Line 5: ",
                "// Line 6: import Editor from 'tinymce/core/api/Editor';",
                "// Line 7: import Plugin from 'tinymce/plugins/media/Plugin';",
                "// Line 8: ",
                "// Line 9: describe('browser.tinymce.plugins.media.core.LiveEmbedNodeTest', () => {",
                "// vulnerable line: 10: const hook = TinyHooks.bddSetupLight<Editor>({",
                "// Line 11:     plugins: [ 'media' ],",
                "// vulnerable line: 12: toolbar: 'media',",
                "// Line 13:     base_url: '/project/tinymce/js/tinymce'",
                "// Line 14:   }, [ Plugin ]);",
                "// Line 15: ",
                "// Line 16:   const assertStructure = (",
                "// Line 17:     editor: Editor,",
                "// Line 18:     tag: string,",
                "// Line 19:     classes: string[],",
                "// vulnerable line: 20: attrs: Record<string, string>,",
                "// Line 21:     styles: Record<string, string>,",
                "// Line 22:     getChildren: ApproxStructure.Builder<StructAssert[]> = Fun.constant([])",
                "// Line 23:   ) => {",
                "// Line 24:     const object = UiFinder.findIn(TinyDom.body(editor), 'span.mce-preview-object').getOrDie();",
                "// Line 25:     Assertions.assertStructure('should have all attributes', ApproxStructure.build((s, str, arr) => s.element('span', {",
                "// Line 26:       classes: [ arr.has('mce-object-' + tag) ],",
                "// Line 27:       styles: {",
                "// Line 28:         height: str.none('should not have height style'),",
                "// Line 29:         width: str.none('should not have width style'),",
                "// Line 30:         // TINY-7074: The wrapper span should have the same width/height styles",
                "// Line 31:         ...Obj.map(styles, (value) => str.is(value))",
                "// Line 32:       },",
                "// Line 33:       children: [",
                "// Line 34:         s.element(tag, {",
                "// Line 35:           classes: Arr.map(classes, arr.has),",
                "// Line 36:           attrs: {",
                "// Line 37:             height: str.none('should not have height'),",
                "// Line 38:             width: str.none('should not have width'),",
                "// vulnerable line: 39: ...Obj.map(attrs, (value) => str.is(value))",
                "// Line 40:           },",
                "// Line 41:           styles: {",
                "// Line 42:             height: str.none('should not have height style'),",
                "// Line 43:             width: str.none('should not have width style'),",
                "// Line 44:             ...Obj.map(styles, (value) => str.is(value))",
                "// Line 45:           },",
                "// Line 46:           children: getChildren(s, str, arr)",
                "// Line 47:         }),",
                "// Line 48:         s.zeroOrOne(s.element('span', {",
                "// Line 49:           classes: [ arr.has('mce-shim') ]"
            ]
        },
        {
            "filename_of_changes": "Nodes.ts",
            "code_language": "TypeScript",
            "number_of_lines_added_for_mitigation": "2",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 84:   setDimensions(node, previewNode, styles);",
                "// Line 85:   previewNode.attr({",
                "// Line 86:     src: node.attr('src'),",
                "// Line 87:     style: node.attr('style'),",
                "// Line 88:     class: node.attr('class')",
                "// Line 89:   });",
                "// Line 90: ",
                "// Line 91:   if (name === 'iframe') {",
                "// Line 92:     previewNode.attr({",
                "// Line 93:       allowfullscreen: node.attr('allowfullscreen'),",
                "// vulnerable line: 94: frameborder: '0'",
                "// Line 95:     });",
                "// Line 96:   } else {",
                "// Line 97:     // Exclude autoplay as we don't want video/audio to play by default",
                "// Line 98:     const attrs = [ 'controls', 'crossorigin', 'currentTime', 'loop', 'muted', 'poster', 'preload' ];",
                "// Line 99:     Arr.each(attrs, (attrName) => {",
                "// Line 100:       previewNode.attr(attrName, node.attr(attrName));",
                "// Line 101:     });",
                "// Line 102: ",
                "// Line 103:     // Recreate the child nodes using the sanitized inner HTML",
                "// Line 104:     const sanitizedHtml = previewWrapper.attr('data-mce-html');"
            ]
        },
        {
            "filename_of_changes": "OptionTypes.ts",
            "code_language": "TypeScript",
            "number_of_lines_added_for_mitigation": "4",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "Options.ts",
            "code_language": "TypeScript",
            "number_of_lines_added_for_mitigation": "20",
            "number_of_lines_deleted_vulnerable_to_cve": "19",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 938: const getTextPatterns = option('text_patterns');",
                "// Line 939: const getTextPatternsLookup = option('text_patterns_lookup');",
                "// Line 940: const getNonEditableClass = option('noneditable_class');",
                "// Line 941: const getEditableClass = option('editable_class');",
                "// Line 942: const getNonEditableRegExps = option('noneditable_regexp');",
                "// Line 943: const shouldPreserveCData = option('preserve_cdata');",
                "// Line 944: const shouldHighlightOnFocus = option('highlight_on_focus');",
                "// Line 945: const shouldSanitizeXss = option('xss_sanitization');",
                "// Line 946: const shouldUseDocumentWrite = option('init_content_sync');",
                "// Line 947: ",
                "// vulnerable line: 948: const hasTextPatternsLookup = (editor: Editor): boolean =>",
                "// vulnerable line: 949: editor.options.isSet('text_patterns_lookup');",
                "// Line 950: ",
                "// vulnerable line: 951: const getFontStyleValues = (editor: Editor): string[] =>",
                "// vulnerable line: 952: Tools.explode(editor.options.get('font_size_style_values'));",
                "// Line 953: ",
                "// vulnerable line: 954: const getFontSizeClasses = (editor: Editor): string[] =>",
                "// vulnerable line: 955: Tools.explode(editor.options.get('font_size_classes'));",
                "// Line 956: ",
                "// vulnerable line: 957: const isEncodingXml = (editor: Editor): boolean =>",
                "// vulnerable line: 958: editor.options.get('encoding') === 'xml';",
                "// Line 959: ",
                "// vulnerable line: 960: const getAllowedImageFileTypes = (editor: Editor): string[] =>",
                "// vulnerable line: 961: Tools.explode(editor.options.get('images_file_types'));",
                "// Line 962: ",
                "// Line 963: const hasTableTabNavigation = option('table_tab_navigation');",
                "// Line 964: ",
                "// Line 965: const getDetailsInitialState = option('details_initial_state');",
                "// Line 966: const getDetailsSerializedState = option('details_serialized_state');",
                "// Line 967: ",
                "// Line 968: const shouldForceHexColor = option('force_hex_color');",
                "// Line 969: ",
                "// Line 970: export {",
                "// Line 971:   register,",
                "// Line 1064:   getNonEditableClass,",
                "// Line 1065:   getNonEditableRegExps,",
                "// Line 1066:   getEditableClass,",
                "// Line 1067:   hasTableTabNavigation,",
                "// Line 1068:   shouldPreserveCData,",
                "// Line 1069:   shouldHighlightOnFocus,",
                "// Line 1070:   shouldSanitizeXss,",
                "// Line 1071:   getDetailsInitialState,",
                "// Line 1072:   getDetailsSerializedState,",
                "// Line 1073:   shouldUseDocumentWrite,",
                "// vulnerable line: 1074: shouldForceHexColor",
                "// Line 1075: };"
            ]
        },
        {
            "filename_of_changes": "PrePostProcess.ts",
            "code_language": "TypeScript",
            "number_of_lines_added_for_mitigation": "5",
            "number_of_lines_deleted_vulnerable_to_cve": "5",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 1: import { Result } from '@ephox/katamari';",
                "// Line 2: ",
                "// Line 3: import Editor from '../api/Editor';",
                "// Line 4: import * as Events from '../api/Events';",
                "// vulnerable line: 5: import DomParser from '../api/html/DomParser';",
                "// Line 6: import HtmlSerializer from '../api/html/Serializer';",
                "// Line 7: import * as Options from '../api/Options';",
                "// Line 8: import { EditorEvent } from '../api/util/EventDispatcher';",
                "// Line 9: import { Content, GetContentArgs, isTreeNode, SetContentArgs } from './ContentTypes';",
                "// Line 10: ",
                "// Line 11: const serializeContent = (content: Content): string =>",
                "// Line 12:   isTreeNode(content) ? HtmlSerializer({ validate: false }).serialize(content) : content;",
                "// Line 13: ",
                "// vulnerable line: 14: const withSerializedContent = <R extends EditorEvent<{ content: string }>>(content: Content, fireEvent: (content: string) => R, sanitize: boolean): R & { content: Content } => {",
                "// Line 15:   const serializedContent = serializeContent(content);",
                "// Line 16:   const eventArgs = fireEvent(serializedContent);",
                "// Line 17:   if (eventArgs.isDefaultPrevented()) {",
                "// Line 18:     return eventArgs;",
                "// Line 19:   } else if (isTreeNode(content)) {",
                "// Line 20:     // Restore the content type back to being an AstNode. If the content has changed we need to",
                "// Line 21:     // re-parse the new content, otherwise we can return the input.",
                "// Line 22:     if (eventArgs.content !== serializedContent) {",
                "// vulnerable line: 23: const rootNode = DomParser({ validate: false, forced_root_block: false, sanitize }).parse(eventArgs.content, { context: content.name });",
                "// Line 24:       return { ...eventArgs, content: rootNode };",
                "// Line 25:     } else {",
                "// Line 26:       return { ...eventArgs, content };",
                "// Line 27:     }",
                "// Line 28:   } else {",
                "// Line 29:     return eventArgs;",
                "// Line 30:   }",
                "// Line 31: };",
                "// Line 32: ",
                "// Line 33: const preProcessGetContent = <T extends GetContentArgs>(editor: Editor, args: T): Result<T, Content> => {",
                "// Line 40:     } else {",
                "// Line 41:       return Result.value(eventArgs);",
                "// Line 42:     }",
                "// Line 43:   }",
                "// Line 44: };",
                "// Line 45: ",
                "// Line 46: const postProcessGetContent = <T extends GetContentArgs>(editor: Editor, content: Content, args: T): Content => {",
                "// Line 47:   if (args.no_events) {",
                "// Line 48:     return content;",
                "// Line 49:   } else {",
                "// vulnerable line: 50: const processedEventArgs = withSerializedContent(content, (content) => Events.fireGetContent(editor, { ...args, content }), Options.shouldSanitizeXss(editor));",
                "// Line 51:     return processedEventArgs.content;",
                "// Line 52:   }",
                "// Line 53: };",
                "// Line 54: ",
                "// Line 55: const preProcessSetContent = <T extends SetContentArgs>(editor: Editor, args: T): Result<T, undefined> => {",
                "// Line 56:   if (args.no_events) {",
                "// Line 57:     return Result.value(args);",
                "// Line 58:   } else {",
                "// vulnerable line: 59: const processedEventArgs = withSerializedContent(args.content, (content) => Events.fireBeforeSetContent(editor, { ...args, content }), Options.shouldSanitizeXss(editor));",
                "// Line 60:     if (processedEventArgs.isDefaultPrevented()) {",
                "// Line 61:       Events.fireSetContent(editor, processedEventArgs);",
                "// Line 62:       return Result.error(undefined);",
                "// Line 63:     } else {",
                "// Line 64:       return Result.value(processedEventArgs);",
                "// Line 65:     }",
                "// Line 66:   }",
                "// Line 67: };",
                "// Line 68: ",
                "// Line 69: const postProcessSetContent = <T extends SetContentArgs>(editor: Editor, content: string, args: T): void => {"
            ]
        },
        {
            "filename_of_changes": "ProcessFilters.ts",
            "code_language": "TypeScript",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 4: import HtmlSerializer from '../api/html/Serializer';",
                "// Line 5: import * as Options from '../api/Options';",
                "// Line 6: import Tools from '../api/util/Tools';",
                "// Line 7: ",
                "// Line 8: interface ProcessResult {",
                "// Line 9:   readonly content: string;",
                "// Line 10:   readonly cancelled: boolean;",
                "// Line 11: }",
                "// Line 12: ",
                "// Line 13: const preProcess = (editor: Editor, html: string): string => {",
                "// vulnerable line: 14: const parser = DomParser({ sanitize: Options.shouldSanitizeXss(editor) }, editor.schema);",
                "// Line 15: ",
                "// Line 16:   // Strip meta elements",
                "// Line 17:   parser.addNodeFilter('meta', (nodes) => {",
                "// Line 18:     Tools.each(nodes, (node) => {",
                "// Line 19:       node.remove();",
                "// Line 20:     });",
                "// Line 21:   });",
                "// Line 22: ",
                "// Line 23:   const fragment = parser.parse(html, { forced_root_block: false, isRootContent: true });",
                "// Line 24:   return HtmlSerializer({ validate: true }, editor.schema).serialize(fragment);"
            ]
        },
        {
            "filename_of_changes": "SelectionToolbarTest.ts",
            "code_language": "TypeScript",
            "number_of_lines_added_for_mitigation": "2",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 13:   Center = 'center'",
                "// Line 14: }",
                "// Line 15: ",
                "// Line 16: describe('browser.tinymce.plugins.quickbars.SelectionToolbarTest', () => {",
                "// Line 17:   const hook = TinyHooks.bddSetupLight<Editor>({",
                "// Line 18:     plugins: 'quickbars link pagebreak',",
                "// Line 19:     inline: true,",
                "// Line 20:     toolbar: false,",
                "// Line 21:     menubar: false,",
                "// Line 22:     base_url: '/project/tinymce/js/tinymce'",
                "// vulnerable line: 23: }, [ LinkPlugin, QuickbarsPlugin ], true);",
                "// Line 24: ",
                "// Line 25:   const imgSrc = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';",
                "// Line 26: ",
                "// Line 27:   const pAssertButtonToggledState = (name: string, state: boolean) =>",
                "// Line 28:     Waiter.pTryUntil('Wait for toolbar button state', () => {",
                "// Line 29:       const button = UiFinder.findIn(SugarBody.body(), `.tox-toolbar button[aria-label=\"${name}\"]`).getOrDie();",
                "// Line 30:       return Assertions.assertStructure('', ApproxStructure.build((s, _str, arr) => s.element('button', {",
                "// Line 31:         classes: [ state ? arr.has('tox-tbtn--enabled') : arr.not('tox-tbtn--enabled') ]",
                "// Line 32:       })), button);",
                "// Line 33:     });"
            ]
        }
    ]
}