{
    "cve_id": "CVE-2018-25101",
    "cve_description": "A vulnerability, which was classified as problematic, has been found in l2c2technologies Koha up to 20180108. This issue affects some unknown processing of the file /cgi-bin/koha/opac-MARCdetail.pl. The manipulation of the argument biblionumber with the input 2\"><TEST> leads to cross site scripting. The attack may be initiated remotely. The identifier of the patch is 950fc8e101886821879066b33e389a47fb0a9782. It is recommended to upgrade the affected component. The identifier VDB-261677 was assigned to this vulnerability.",
    "cve_publish_date": "2024-04-22T02:15Z",
    "cwe_id": "CWE-79",
    "cwe_name": "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "cwe_description": "The product does not neutralize or incorrectly neutralizes user-controllable input before it is placed in output that is used as a web page that is served to other users.",
    "commit_message": "Bug 19319: Reflected XSS Vulnerability in opac-MARCdetail.pl\n\nTry going to this URL on your site: /cgi-bin/koha/opac-MARCdetail.pl?biblionumber=2\"><TEST>\n\nTest Plan:\n1) Go to /cgi-bin/koha/opac-MARCdetail.pl?biblionumber=2\"><TEST>\n2) Note <TEST> is embedded all over the html\n3) Apply this patch\n4) Refresh the page, note the injection is gone!\n5) run koha qa test tools\n\nSigned-off-by: Mark Tompsett <mtompset@hotmail.com>\n\nSigned-off-by: Marcel de Rooy <m.de.rooy@rijksmuseum.nl>\n\nSigned-off-by: Jonathan Druart <jonathan.druart@bugs.koha-community.org>\n\nSigned-off-by: Jonathan Druart <jonathan.druart@bugs.koha-community.org>",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "opac-ISBDdetail.pl",
            "code_language": "Perl",
            "number_of_lines_added_for_mitigation": "4",
            "number_of_lines_deleted_vulnerable_to_cve": "2",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 87: if (scalar @items >= 1) {",
                "// Line 88:     my @hiddenitems = GetHiddenItemnumbers(@items);",
                "// Line 89: ",
                "// Line 90:     if (scalar @hiddenitems == scalar @items ) {",
                "// Line 91:         print $query->redirect(\"/cgi-bin/koha/errors/404.pl\"); # escape early",
                "// Line 92:         exit;",
                "// Line 93:     }",
                "// Line 94: }",
                "// Line 95: ",
                "// Line 96: my $record = GetMarcBiblio({",
                "// vulnerable line: 97: biblionumber => $biblionumber,",
                "// Line 98:     embed_items  => 1 });",
                "// Line 99: if ( ! $record ) {",
                "// Line 100:     print $query->redirect(\"/cgi-bin/koha/errors/404.pl\");",
                "// Line 101:     exit;",
                "// Line 102: }",
                "// Line 103: my $framework = GetFrameworkCode( $biblionumber );",
                "// Line 104: my $record_processor = Koha::RecordProcessor->new({",
                "// Line 105:     filters => 'ViewPolicy',",
                "// Line 106:     options => {",
                "// Line 107:         interface => 'opac',",
                "// Line 178: ",
                "// Line 179:     $allow_onshelf_holds = C4::Reserves::OnShelfHoldsAllowed( $itm, ( $patron ? $patron->unblessed : {} ) )",
                "// Line 180:       unless $allow_onshelf_holds;",
                "// Line 181: }",
                "// Line 182: ",
                "// Line 183: $template->param(",
                "// Line 184:     RequestOnOpac       => C4::Context->preference(\"RequestOnOpac\"),",
                "// Line 185:     AllowOnShelfHolds   => $allow_onshelf_holds,",
                "// Line 186:     norequests   => $norequests,",
                "// Line 187:     ISBD         => $res,",
                "// vulnerable line: 188: biblionumber => $biblionumber,",
                "// Line 189: );",
                "// Line 190: ",
                "// Line 191: #Search for title in links",
                "// Line 192: my $marccontrolnumber   = GetMarcControlnumber ($record, $marcflavour);",
                "// Line 193: my $marcissns = GetMarcISSN ( $record, $marcflavour );",
                "// Line 194: my $issn = $marcissns->[0] || '';",
                "// Line 195: ",
                "// Line 196: if (my $search_for_title = C4::Context->preference('OPACSearchForTitleIn')){",
                "// Line 197:     $dat->{title} =~ s/\\/+$//; # remove trailing slash",
                "// Line 198:     $dat->{title} =~ s/\\s+$//; # remove trailing space"
            ]
        },
        {
            "filename_of_changes": "opac-MARCdetail.pl",
            "code_language": "Perl",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 343:             BIBLIONUMBER  => $biblionumber,",
                "// Line 344:         }",
                "// Line 345:     );",
                "// Line 346:     $template->param('OPACSearchForTitleIn' => $search_for_title);",
                "// Line 347: }",
                "// Line 348: ",
                "// Line 349: $template->param(",
                "// Line 350:     item_loop           => \\@item_loop,",
                "// Line 351:     item_header_loop    => \\@item_header_loop,",
                "// Line 352:     item_subfield_codes => \\@item_subfield_codes,",
                "// vulnerable line: 353: biblionumber        => $biblionumber,",
                "// Line 354: );",
                "// Line 355: ",
                "// Line 356: output_html_with_http_headers $query, $cookie, $template->output;"
            ]
        },
        {
            "filename_of_changes": "opac-MARCdetail.tt",
            "code_language": "Perl",
            "number_of_lines_added_for_mitigation": "6",
            "number_of_lines_deleted_vulnerable_to_cve": "6",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 1: [% USE Koha %]",
                "// Line 2: [% INCLUDE 'doc-head-open.inc' %]",
                "// vulnerable line: 3: <title>[% IF ( LibraryNameTitle ) %][% LibraryNameTitle %][% ELSE %]Koha online[% END %] catalog &rsaquo;  MARC details for record no. [% biblionumber | html %]</title>",
                "// Line 4: [% INCLUDE 'doc-head-close.inc' %]",
                "// Line 5: [% BLOCK cssinclude %][% END %]",
                "// Line 6: </head>",
                "// Line 7: [% INCLUDE 'bodytag.inc' bodyid='opac-marcdetail' bodyclass='scrollto' %]",
                "// Line 8: [% INCLUDE 'masthead.inc' %]",
                "// Line 9: <div class=\"main\">",
                "// Line 10:     <ul class=\"breadcrumb\">",
                "// Line 11:         <li><a href=\"/cgi-bin/koha/opac-main.pl\">Home</a> <span class=\"divider\">&rsaquo;</span></li>",
                "// Line 12:         <li><a href=\"#\">MARC view: [% bibliotitle %]</a></li>",
                "// Line 13:     </ul>",
                "// Line 14: ",
                "// Line 15:     <div class=\"container-fluid\">",
                "// Line 16:         <div class=\"row-fluid\">",
                "// Line 17:             <div class=\"span9\">",
                "// Line 18:                 <div id=\"opac-detail\" class=\"maincontent\">",
                "// Line 19:                     <div id=\"usermarcdetail\">",
                "// Line 20:                         <div id=\"catalogue_detail_biblio\">",
                "// Line 21: ",
                "// Line 22:                             <div id=\"views\">",
                "// vulnerable line: 23: <span class=\"view\"><a id=\"Normalview\" href=\"/cgi-bin/koha/opac-detail.pl?biblionumber=[% biblionumber | html %]\">Normal view</a></span>",
                "// Line 24:                                 <span class=\"view current-view\"><span id=\"MARCview\">MARC view</span></span>",
                "// vulnerable line: 25: [% IF ( ISBD ) %]<span class=\"view\"><a id=\"ISBDview\"  href=\"/cgi-bin/koha/opac-ISBDdetail.pl?biblionumber=[% biblionumber | html %]\">ISBD view</a></span>[% END %]",
                "// Line 26:                             </div>",
                "// vulnerable line: 27: <h1 class=\"title\">[% bibliotitle %] (Record no. [% biblionumber | html %])</h1>",
                "// Line 28: ",
                "// Line 29:                             [% IF ( OPACXSLTDetailsDisplay ) %]",
                "// vulnerable line: 30: <div id=\"switchview_div\">[ <a id=\"switchview\" href=\"/cgi-bin/koha/opac-showmarc.pl?id=[% biblionumber | html %]&amp;viewas=html\">view plain</a> ]</div>",
                "// Line 31:                                 <div id=\"plainmarc\"></div>",
                "// Line 32:                             [% END %]",
                "// Line 33: ",
                "// Line 34:                             <div id=\"labeledmarc\">",
                "// Line 35:                                 <table id=\"marc\" class=\"table table-bordered table-striped\">",
                "// Line 36:                                     [% FOREACH tab0X IN tab0XX %]",
                "// Line 37:                                     <tr><th colspan=\"2\">[% tab0X.tag %]</th></tr>",
                "// Line 38:                                     [% FOREACH subfiel IN tab0X.subfield %]",
                "// Line 39:                                             <tr>",
                "// Line 40:                                                 <td>[% subfiel.marc_lib %]</td>"
            ]
        },
        {
            "filename_of_changes": "opac-detail.pl",
            "code_language": "Perl",
            "number_of_lines_added_for_mitigation": "2",
            "number_of_lines_deleted_vulnerable_to_cve": "2",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 129:                 print $query->redirect($opacsuppressionredirect);",
                "// Line 130:                 exit;",
                "// Line 131:             }",
                "// Line 132:         } else {",
                "// Line 133:             print $query->redirect($opacsuppressionredirect);",
                "// Line 134:             exit;",
                "// Line 135:         }",
                "// Line 136:     }",
                "// Line 137: }",
                "// Line 138: ",
                "// vulnerable line: 139: $template->param( biblionumber => $biblionumber );",
                "// Line 140: ",
                "// Line 141: # get biblionumbers stored in the cart",
                "// Line 142: my @cart_list;",
                "// Line 143: ",
                "// Line 144: if($query->cookie(\"bib_list\")){",
                "// Line 145:     my $cart_list = $query->cookie(\"bib_list\");",
                "// Line 146:     @cart_list = split(/\\//, $cart_list);",
                "// Line 147:     if ( grep {$_ eq $biblionumber} @cart_list) {",
                "// Line 148:         $template->param( incart => 1 );",
                "// Line 149:     }",
                "// Line 596: ",
                "// Line 597: ",
                "// Line 598: my (%item_reserves, %priority);",
                "// Line 599: my ($show_holds_count, $show_priority);",
                "// Line 600: for ( C4::Context->preference(\"OPACShowHoldQueueDetails\") ) {",
                "// Line 601:     m/holds/o and $show_holds_count = 1;",
                "// Line 602:     m/priority/ and $show_priority = 1;",
                "// Line 603: }",
                "// Line 604: my $has_hold;",
                "// Line 605: if ( $show_holds_count || $show_priority) {",
                "// vulnerable line: 606: my $biblio = Koha::Biblios->find( $biblionumber );",
                "// Line 607:     my $holds = $biblio->holds;",
                "// Line 608:     $template->param( holds_count  => $holds->count );",
                "// Line 609:     while ( my $hold = $holds->next ) {",
                "// Line 610:         $item_reserves{ $hold->itemnumber }++ if $hold->itemnumber;",
                "// Line 611:         if ($show_priority && $hold->borrowernumber == $borrowernumber) {",
                "// Line 612:             $has_hold = 1;",
                "// Line 613:             $hold->itemnumber",
                "// Line 614:                 ? ($priority{ $hold->itemnumber } = $hold->priority)",
                "// Line 615:                 : ($template->param( priority => $hold->priority ));",
                "// Line 616:         }"
            ]
        }
    ]
}