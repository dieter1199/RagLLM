{
    "cve_id": "CVE-2024-35226",
    "cve_description": "Smarty is a template engine for PHP, facilitating the separation of presentation (HTML/CSS) from application logic. In affected versions template authors could inject php code by choosing a malicious file name for an extends-tag. Sites that cannot fully trust template authors should update asap. All users are advised to update. There is no patch for users on the v3 branch. There are no known workarounds for this vulnerability.",
    "cve_publish_date": "2024-05-28T21:16Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "Merge pull request from GHSA-4rmg-292m-wg3w",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "CompileIncludeTest.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "12",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "ExtendsIssue419Test.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "7",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "Smarty.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "9",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "Template.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "27",
            "number_of_lines_deleted_vulnerable_to_cve": "11",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 322:      */",
                "// Line 323:     public function __construct(Smarty $smarty) {",
                "// Line 324:         $this->smarty = $smarty;",
                "// Line 325:         $this->nocache_hash = str_replace(",
                "// Line 326:             [",
                "// Line 327:                 '.',",
                "// Line 328:                 ',',",
                "// Line 329:             ],",
                "// Line 330:             '_',",
                "// Line 331:             uniqid(mt_rand(), true)",
                "// vulnerable line: 332: );",
                "// Line 333: ",
                "// Line 334:         $this->modifierCompiler = new ModifierCompiler();",
                "// Line 335:         $this->functionCallCompiler = new FunctionCallCompiler();",
                "// Line 336:         $this->defaultHandlerFunctionCallCompiler = new DefaultHandlerFunctionCallCompiler();",
                "// Line 337:         $this->blockCompiler = new BlockCompiler();",
                "// Line 338:         $this->defaultHandlerBlockCompiler = new DefaultHandlerBlockCompiler();",
                "// Line 339:         $this->objectMethodBlockCompiler = new ObjectMethodBlockCompiler();",
                "// Line 340:         $this->objectMethodCallCompiler = new ObjectMethodCallCompiler();",
                "// Line 341:         $this->printExpressionCompiler = new PrintExpressionCompiler();",
                "// Line 342:     }",
                "// Line 349:      * @return string code",
                "// Line 350:      * @throws Exception",
                "// Line 351:      */",
                "// Line 352:     public function compileTemplate(\\Smarty\\Template $template) {",
                "// Line 353:         return $template->createCodeFrame(",
                "// Line 354:             $this->compileTemplateSource($template),",
                "// Line 355:             $this->smarty->runPostFilters($this->blockOrFunctionCode, $this->template) .",
                "// Line 356:             join('', $this->mergedSubTemplatesCode),",
                "// Line 357:             false,",
                "// Line 358:             $this",
                "// vulnerable line: 359: );",
                "// Line 360:     }",
                "// Line 361: ",
                "// Line 362:     /**",
                "// Line 363:      * Compile template source and run optional post filter",
                "// Line 364:      *",
                "// Line 365:      * @param \\Smarty\\Template $template",
                "// Line 366:      * @param Template|null $parent_compiler",
                "// Line 367:      *",
                "// Line 368:      * @return string",
                "// Line 369:      * @throws CompilerException",
                "// Line 397:             if ($this->template->getSource()->handler->checkTimestamps()) {",
                "// Line 398:                 $this->parent_compiler->getTemplate()->getCompiled()->file_dependency[$this->template->getSource()->uid] =",
                "// Line 399:                     [",
                "// Line 400:                         $this->template->getSource()->getResourceName(),",
                "// Line 401:                         $this->template->getSource()->getTimeStamp(),",
                "// Line 402:                         $this->template->getSource()->type,",
                "// Line 403:                     ];",
                "// Line 404:             }",
                "// Line 405:             // get template source",
                "// Line 406:             if (!empty($this->template->getSource()->components)) {",
                "// vulnerable line: 407: // we have array of inheritance templates by extends: resource",
                "// vulnerable line: 408: // generate corresponding source code sequence",
                "// vulnerable line: 409: $_content =",
                "// vulnerable line: 410: ExtendsTag::extendsSourceArrayCode($this->template);",
                "// Line 411:             } else {",
                "// Line 412:                 // get template source",
                "// Line 413:                 $_content = $this->template->getSource()->getContent();",
                "// Line 414:             }",
                "// vulnerable line: 415: $_compiled_code = $this->smarty->runPostFilters(",
                "// vulnerable line: 416: $this->doCompile(",
                "// vulnerable line: 417: $this->smarty->runPreFilters($_content, $this->template),",
                "// vulnerable line: 418: true",
                "// vulnerable line: 419: ),",
                "// vulnerable line: 420: $this->template",
                "// vulnerable line: 421: );",
                "// Line 422:         } catch (\\Exception $e) {",
                "// Line 423:             if ($this->smarty->debugging) {",
                "// Line 424:                 $this->smarty->getDebug()->end_compile($this->template);",
                "// Line 425:             }",
                "// Line 426:             $this->_tag_stack = [];",
                "// Line 427:             // free memory",
                "// Line 428:             $this->parent_compiler = null;",
                "// Line 429:             $this->template = null;",
                "// Line 430:             $this->parser = null;",
                "// Line 431:             throw $e;",
                "// Line 649:         $result = call_user_func_array(",
                "// Line 650:             $defaultPluginHandlerFunc,",
                "// Line 651:             [",
                "// Line 652:                 $tag,",
                "// Line 653:                 $plugin_type,",
                "// Line 654:                 null, // This used to pass $this->template, but this parameter has been removed in 5.0",
                "// Line 655:                 &$callback,",
                "// Line 656:                 &$script,",
                "// Line 657:                 &$cacheable,",
                "// Line 658:             ]",
                "// vulnerable line: 659: );",
                "// Line 660:         if ($result) {",
                "// Line 661:             $this->tag_nocache = $this->tag_nocache || !$cacheable;",
                "// Line 662:             if ($script !== null) {",
                "// Line 663:                 if (is_file($script)) {",
                "// Line 664:                     include_once $script;",
                "// Line 665:                 } else {",
                "// Line 666:                     $this->trigger_template_error(\"Default plugin handler: Returned script file '{$script}' for '{$tag}' not found\");",
                "// Line 667:                 }",
                "// Line 668:             }",
                "// Line 669:             if (is_callable($callback)) {",
                "// Line 802:         ) {",
                "// Line 803:             $templateName = $this->template->getSource()->type . ':' . trim(",
                "// Line 804:                     preg_replace(",
                "// Line 805:                         '![    ",
                "// Line 806: ]+!',",
                "// Line 807:                         ' ',",
                "// Line 808:                         strlen($lex->data) > 40 ?",
                "// Line 809:                             substr($lex->data, 0, 40) .",
                "// Line 810:                             '...' : $lex->data",
                "// Line 811:                     )",
                "// vulnerable line: 812: );",
                "// Line 813:         } else {",
                "// Line 814:             $templateName = $this->template->getSource()->getFullResourceName();",
                "// Line 815:         }",
                "// Line 816:         //        $line += $this->trace_line_offset;",
                "// Line 817:         $match = preg_split(\"/",
                "// Line 818: /\", $lex->data);",
                "// Line 819:         $error_text =",
                "// Line 820:             'Syntax error in template \"' . (empty($this->trace_filepath) ? $templateName : $this->trace_filepath) .",
                "// Line 821:             '\"  on line ' . ($line + $this->trace_line_offset) . ' \"' .",
                "// Line 822:             trim(preg_replace('![    ",
                "// Line 845:         if ($this->smarty->_parserdebug) {",
                "// Line 846:             $this->parser->errorRunDown();",
                "// Line 847:             echo ob_get_clean();",
                "// Line 848:             flush();",
                "// Line 849:         }",
                "// Line 850:         $e = new CompilerException(",
                "// Line 851:             $error_text,",
                "// Line 852:             0,",
                "// Line 853:             $this->template->getSource()->getFilepath() ?? $this->template->getSource()->getFullResourceName(),",
                "// Line 854:             $line",
                "// vulnerable line: 855: );",
                "// Line 856:         $e->source = trim(preg_replace('![    ",
                "// Line 857: ]+!', ' ', $match[$line - 1]));",
                "// Line 858:         $e->desc = $args;",
                "// Line 859:         $e->template = $this->template->getSource()->getFullResourceName();",
                "// Line 860:         throw $e;",
                "// Line 861:     }",
                "// Line 862: ",
                "// Line 863:     /**",
                "// Line 864:      * Return var_export() value with all white spaces removed",
                "// Line 865:      *",
                "// Line 895:      */",
                "// Line 896:     public function replaceDelimiter($lexerPreg) {",
                "// Line 897:         return str_replace(",
                "// Line 898:             ['SMARTYldel', 'SMARTYliteral', 'SMARTYrdel', 'SMARTYautoliteral', 'SMARTYal'],",
                "// Line 899:             [",
                "// Line 900:                 $this->ldelPreg, $this->literalPreg, $this->rdelPreg,",
                "// Line 901:                 $this->smarty->getAutoLiteral() ? '{1,}' : '{9}',",
                "// Line 902:                 $this->smarty->getAutoLiteral() ? '' : '\\s*',",
                "// Line 903:             ],",
                "// Line 904:             $lexerPreg",
                "// vulnerable line: 905: );",
                "// Line 906:     }",
                "// Line 907: ",
                "// Line 908:     /**",
                "// Line 909:      * Build lexer regular expressions for left and right delimiter and user defined literals",
                "// Line 910:      */",
                "// Line 911:     public function initDelimiterPreg() {",
                "// Line 912:         $ldel = $this->smarty->getLeftDelimiter();",
                "// Line 913:         $this->ldelLength = strlen($ldel);",
                "// Line 914:         $this->ldelPreg = '';",
                "// Line 915:         foreach (str_split($ldel, 1) as $chr) {",
                "// Line 941:      *  - throw exception if block in string was not closed",
                "// Line 942:      *",
                "// Line 943:      * @throws \\Smarty\\CompilerException",
                "// Line 944:      */",
                "// Line 945:     public function leaveDoubleQuote() {",
                "// Line 946:         if (array_pop($this->_tag_stack_count) !== $this->getTagStackCount()) {",
                "// Line 947:             $tag = $this->getOpenBlockTag();",
                "// Line 948:             $this->trigger_template_error(",
                "// Line 949:                 \"unclosed '{{$tag}}' in doubled quoted string\",",
                "// Line 950:                 null,",
                "// vulnerable line: 951: true",
                "// vulnerable line: 952: );",
                "// Line 953:         }",
                "// Line 954:     }",
                "// Line 955: ",
                "// Line 956:     /**",
                "// Line 957:      * Get left delimiter preg",
                "// Line 958:      *",
                "// Line 959:      * @return string",
                "// Line 960:      */",
                "// Line 961:     public function getLdelPreg() {",
                "// Line 962:         return $this->ldelPreg;",
                "// Line 1133:             return $this->compileRegisteredObjectMethodCall($base_tag, $args, $parameter, $tag);",
                "// Line 1134:         }",
                "// Line 1135: ",
                "// Line 1136:         // check if tag is a function",
                "// Line 1137:         if ($this->smarty->getFunctionHandler($base_tag)) {",
                "// Line 1138:             if (!isset($this->smarty->security_policy) || $this->smarty->security_policy->isTrustedTag($base_tag, $this)) {",
                "// Line 1139:                 return (new \\Smarty\\Compile\\PrintExpressionCompiler())->compile(",
                "// Line 1140:                     ['nofilter'], // functions are never auto-escaped",
                "// Line 1141:                     $this,",
                "// Line 1142:                     ['value' =>    $this->compileFunctionCall($base_tag, $args, $parameter)]",
                "// vulnerable line: 1143: );",
                "// Line 1144:             }",
                "// Line 1145:         }",
                "// Line 1146: ",
                "// Line 1147:         // check if tag is a block",
                "// Line 1148:         if ($this->smarty->getBlockHandler($base_tag)) {",
                "// Line 1149:             if (!isset($this->smarty->security_policy) || $this->smarty->security_policy->isTrustedTag($base_tag, $this)) {",
                "// Line 1150:                 return $this->blockCompiler->compile($args, $this, $parameter, $tag, $base_tag);",
                "// Line 1151:             }",
                "// Line 1152:         }",
                "// Line 1153: ",
                "// Line 1231:                     str_replace(",
                "// Line 1232:                         [",
                "// Line 1233:                             \"",
                "// Line 1234: \",",
                "// Line 1235:                             \"",
                "// Line 1236: \",",
                "// Line 1237:                         ],",
                "// Line 1238:                         \"",
                "// Line 1239: \",",
                "// Line 1240:                         $_content",
                "// vulnerable line: 1241: ),",
                "// Line 1242:                     $this",
                "// vulnerable line: 1243: ),",
                "// Line 1244:                 $this",
                "// vulnerable line: 1245: );",
                "// Line 1246:         if ($isTemplateSource && $this->template->caching) {",
                "// Line 1247:             $this->parser->insertPhpCode(\"<?php",
                "// Line 1248: \\$_smarty_tpl->getCompiled()->nocache_hash = '{$this->nocache_hash}';",
                "// Line 1249: ?>",
                "// Line 1250: \");",
                "// Line 1251:         }",
                "// Line 1252:         if ($this->smarty->_parserdebug) {",
                "// Line 1253:             $this->parser->PrintTrace();",
                "// Line 1254:             $this->parser->lex->PrintTrace();",
                "// Line 1255:         }",
                "// Line 1263:         }",
                "// Line 1264:         // finish parsing process",
                "// Line 1265:         $this->parser->doParse(0, 0);",
                "// Line 1266:         // check for unclosed tags",
                "// Line 1267:         if ($this->getTagStackCount() > 0) {",
                "// Line 1268:             // get stacked info",
                "// Line 1269:             [$openTag, $_data] = array_pop($this->_tag_stack);",
                "// Line 1270:             $this->trigger_template_error(",
                "// Line 1271:                 \"unclosed \" . $this->smarty->getLeftDelimiter() . $openTag .",
                "// Line 1272:                 $this->smarty->getRightDelimiter() . \" tag\"",
                "// vulnerable line: 1273: );",
                "// Line 1274:         }",
                "// Line 1275:         // call post compile callbacks",
                "// Line 1276:         foreach ($this->postCompileCallbacks as $cb) {",
                "// Line 1277:             $parameter = $cb;",
                "// Line 1278:             $parameter[0] = $this;",
                "// Line 1279:             call_user_func_array($cb[0], $parameter);",
                "// Line 1280:         }",
                "// Line 1281:         // return compiled code",
                "// Line 1282:         return $this->prefixCompiledCode . $this->parser->retvalue . $this->postfixCompiledCode;",
                "// Line 1283:     }",
                "// Line 1316:      *",
                "// Line 1317:      * @return bool",
                "// Line 1318:      * @throws Exception",
                "// Line 1319:      */",
                "// Line 1320:     private function canCompileTemplateFunctionCall(string $tag): bool {",
                "// Line 1321:         return",
                "// Line 1322:             isset($this->parent_compiler->tpl_function[$tag])",
                "// Line 1323:             || (",
                "// Line 1324:                 $this->template->getSmarty()->hasRuntime('TplFunction')",
                "// Line 1325:                 && ($this->template->getSmarty()->getRuntime('TplFunction')->getTplFunction($this->template, $tag) !== false)",
                "// vulnerable line: 1326: );",
                "// Line 1327:     }",
                "// Line 1328: ",
                "// Line 1329:     /**",
                "// Line 1330:      * @throws CompilerException",
                "// Line 1331:      */",
                "// Line 1332:     private function compileRegisteredObjectMethodCall(string $base_tag, array $args, array $parameter, string $tag) {",
                "// Line 1333: ",
                "// Line 1334:         $method = $parameter['object_method'];",
                "// Line 1335:         $allowedAsBlockFunction = in_array($method, $this->smarty->registered_objects[$base_tag][3]);",
                "// Line 1336: ",
                "// Line 1343:             if ($allowedAsBlockFunction) {",
                "// Line 1344:                 return $this->objectMethodBlockCompiler->compile($args, $this, $parameter, $tag, $method);",
                "// Line 1345:             } elseif ($allowedAsNormalFunction) {",
                "// Line 1346:                 return $this->objectMethodCallCompiler->compile($args, $this, $parameter, $tag, $method);",
                "// Line 1347:             }",
                "// Line 1348: ",
                "// Line 1349:             $this->trigger_template_error(",
                "// Line 1350:                 'not allowed method \"' . $method . '\" in registered object \"' .",
                "// Line 1351:                 $tag . '\"',",
                "// Line 1352:                 null,",
                "// vulnerable line: 1353: true",
                "// vulnerable line: 1354: );",
                "// Line 1355:         }",
                "// Line 1356: ",
                "// Line 1357:         // closing tag",
                "// Line 1358:         if ($allowedAsBlockFunction) {",
                "// Line 1359:             return $this->objectMethodBlockCompiler->compile($args, $this, $parameter, $tag, $method);",
                "// Line 1360:         }",
                "// Line 1361: ",
                "// Line 1362:         $this->trigger_template_error(",
                "// Line 1363:             'not allowed closing tag method \"' . $method .",
                "// Line 1364:             '\" in registered object \"' . $base_tag . '\"',",
                "// Line 1365:             null,",
                "// vulnerable line: 1366: true",
                "// vulnerable line: 1367: );",
                "// Line 1368:     }",
                "// Line 1369: ",
                "// Line 1370:     public function compileFunctionCall(string $base_tag, array $args, array $parameter = []) {",
                "// Line 1371:         return $this->functionCallCompiler->compile($args, $this, $parameter, $base_tag, $base_tag);",
                "// Line 1372:     }",
                "// Line 1373: ",
                "// Line 1374:     public function compileModifierInExpression(string $function, array $_attr) {",
                "// Line 1375:         $value = array_shift($_attr);",
                "// Line 1376:         return $this->compileModifier([array_merge([$function], $_attr)], $value);",
                "// Line 1377:     }"
            ]
        }
    ]
}