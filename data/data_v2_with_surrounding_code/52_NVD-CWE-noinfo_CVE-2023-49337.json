{
    "cve_id": "CVE-2023-49337",
    "cve_description": "Concrete CMS before 9.2.3 allows Stored XSS on the Admin Dashboard via /dashboard/system/basics/name. (8.5 and earlier are unaffected.)",
    "cve_publish_date": "2024-02-29T01:41Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "Sanitize site name everywhere",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "InstallerOptions.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 244:         return $this;",
                "// Line 245:     }",
                "// Line 246: ",
                "// Line 247:     /**",
                "// Line 248:      * Get the name of the site.",
                "// Line 249:      *",
                "// Line 250:      * @return string",
                "// Line 251:      */",
                "// Line 252:     public function getSiteName()",
                "// Line 253:     {",
                "// vulnerable line: 254: return $this->siteName;",
                "// Line 255:     }",
                "// Line 256: ",
                "// Line 257:     /**",
                "// Line 258:      * Get the name of the site.",
                "// Line 259:      *",
                "// Line 260:      * @param string $value",
                "// Line 261:      *",
                "// Line 262:      * @return $this",
                "// Line 263:      */",
                "// Line 264:     public function setSiteName($value)"
            ]
        },
        {
            "filename_of_changes": "SiteEntry.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 12: ",
                "// Line 13:     protected $site;",
                "// Line 14: ",
                "// Line 15:     public function __construct(Site $site)",
                "// Line 16:     {",
                "// Line 17:         $this->site = $site;",
                "// Line 18:     }",
                "// Line 19: ",
                "// Line 20:     public function getLabel()",
                "// Line 21:     {",
                "// vulnerable line: 22: return $this->site->getSiteName();",
                "// Line 23:     }",
                "// Line 24: ",
                "// Line 25:     public function getSiteTreeID()",
                "// Line 26:     {",
                "// Line 27:         return $this->site->getSiteTreeID();",
                "// Line 28:     }",
                "// Line 29: ",
                "// Line 30:     public function getIconElement()",
                "// Line 31:     {",
                "// Line 32:         return null;"
            ]
        },
        {
            "filename_of_changes": "SiteGroup.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 8: ",
                "// Line 9:     protected $site;",
                "// Line 10: ",
                "// Line 11:     public function __construct(Site $site)",
                "// Line 12:     {",
                "// Line 13:         $this->site = $site;",
                "// Line 14:     }",
                "// Line 15: ",
                "// Line 16:     public function getEntryGroupLabel()",
                "// Line 17:     {",
                "// vulnerable line: 18: return $this->site->getSiteName();",
                "// Line 19:     }",
                "// Line 20: ",
                "// Line 21:     public function getEntryGroupIdentifier()",
                "// Line 22:     {",
                "// Line 23:         return $this->site->getSiteID();",
                "// Line 24:     }",
                "// Line 25: }"
            ]
        },
        {
            "filename_of_changes": "SiteSelector.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 26:         $allSelected = $siteID === 'all' ? 'selected' : '';",
                "// Line 27:         $current = t('Current Site');",
                "// Line 28:         $all = t('All Sites');",
                "// Line 29:         $defaults = t('Default');",
                "// Line 30:         $specific = t('Sites');",
                "// Line 31: ",
                "// Line 32:         $sites = '';",
                "// Line 33:         foreach(\\Core::make('site')->getList() as $site) {",
                "// Line 34:             $sp = new \\Permissions($site);",
                "// Line 35:             if ($sp->canViewSiteInSelector()) {",
                "// vulnerable line: 36: $sites .= '<option ' . ($site->getSiteID() == $siteID ? 'selected' : '') . ' value=\"' . $site->getSiteID() . '\">' . $site->getSiteName() . '</option>';",
                "// Line 37:             }",
                "// Line 38:         }",
                "// Line 39: ",
                "// Line 40:         $currentLine = '';",
                "// Line 41:         $allLine = '';",
                "// Line 42:         if ($includeCurrent) {",
                "// Line 43:             $currentLine = \"<option value=\"current\" {$currentSelected}>{$current}</option>\";",
                "// Line 44:         }",
                "// Line 45:         if ($includeAll) {",
                "// Line 46:             $allLine = \"<option value=\"all\" {$allSelected}>{$all}</option>\";"
            ]
        },
        {
            "filename_of_changes": "SiteTree.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 42:     }",
                "// Line 43: ",
                "// Line 44: ",
                "// Line 45:     public function getSiteType()",
                "// Line 46:     {",
                "// Line 47:         return $this->getLocale()->getSite()->getType();",
                "// Line 48:     }",
                "// Line 49: ",
                "// Line 50:     public function getDisplayName()",
                "// Line 51:     {",
                "// vulnerable line: 52: return $this->getLocale()->getSite()->getSiteName();",
                "// Line 53:     }",
                "// Line 54: ",
                "// Line 55: }"
            ]
        },
        {
            "filename_of_changes": "SiteValue.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 32:     }",
                "// Line 33: ",
                "// Line 34:     public function getValue()",
                "// Line 35:     {",
                "// Line 36:         return $this->site;",
                "// Line 37:     }",
                "// Line 38: ",
                "// Line 39:     public function __toString()",
                "// Line 40:     {",
                "// Line 41:         if (is_object($this->site)) {",
                "// vulnerable line: 42: return (string) $this->site->getSiteName();",
                "// Line 43:         }",
                "// Line 44:         return '';",
                "// Line 45:     }",
                "// Line 46: }"
            ]
        },
        {
            "filename_of_changes": "bulk.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 109:                 $defaultLocale = $this->app->make('config')->get('concrete.locale') ?: Localization::BASE_LOCALE;",
                "// Line 110:             }",
                "// Line 111:             $section = Section::getBySectionOfSite($page);",
                "// Line 112:             if ($section) {",
                "// Line 113:                 $locale = $section->getLocale();",
                "// Line 114:             } else {",
                "// Line 115:                 $locale = $defaultLocale;",
                "// Line 116:             }",
                "// Line 117:             $siteName = $this->getSiteNameForLocale($locale);",
                "// Line 118:         } else {",
                "// vulnerable line: 119: $siteName = $this->app->make('site')->getSite()->getSiteName();",
                "// Line 120:         }",
                "// Line 121: ",
                "// Line 122:         return $siteName;",
                "// Line 123:     }",
                "// Line 124: ",
                "// Line 125:     protected function getRequestedSearchResults(array $searchRequest): PageList",
                "// Line 126:     {",
                "// Line 127:         $pageList = new PageList();",
                "// Line 128:         $pageList->setPageVersionToRetrieve(PageList::PAGE_VERSION_RECENT);",
                "// Line 129:         $pageList->sortBy('cDateModified', 'desc');"
            ]
        },
        {
            "filename_of_changes": "controller.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "2",
            "number_of_lines_deleted_vulnerable_to_cve": "2",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 49:     }",
                "// Line 50: ",
                "// Line 51:     public function form()",
                "// Line 52:     {",
                "// Line 53:         $siteID = null;",
                "// Line 54:         if (is_object($this->getValue())) {",
                "// Line 55:             $siteID = $this->getValue()->getSiteID();",
                "// Line 56:         }",
                "// Line 57:         $sites = array('' => t('** Select Site'));",
                "// Line 58:         foreach($this->app->make('site')->getList() as $site) {",
                "// vulnerable line: 59: $sites[$site->getSiteID()] = $site->getSiteName();",
                "// Line 60:         }",
                "// Line 61:         $form = $this->app->make('helper/form');",
                "// Line 62:         print $form->select($this->field('siteID'), $sites, $siteID);",
                "// Line 63:     }",
                "// Line 64: ",
                "// Line 65:     public function getDisplayValue()",
                "// Line 66:     {",
                "// Line 67:         $site = $this->getValue();",
                "// Line 68:         if (is_object($site)) {",
                "// vulnerable line: 69: return $site->getSiteName();",
                "// Line 70:         }",
                "// Line 71:     }",
                "// Line 72: ",
                "// Line 73:     public function createAttributeValue($site)",
                "// Line 74:     {",
                "// Line 75:         $av = new SiteValue();",
                "// Line 76:         $av->setSite($site);",
                "// Line 77:         return $av;",
                "// Line 78:     }",
                "// Line 79: "
            ]
        },
        {
            "filename_of_changes": "controller.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 288:             if (!strpos($fromEmail, '@')) {",
                "// Line 289:                 $fromEmail = (string) $this->app->make(Repository::class)->get('concrete.email.default.address');",
                "// Line 290:             }",
                "// Line 291:             if ($fromEmail !== '') {",
                "// Line 292:                 $fromName = (string) $this->app->make(Repository::class)->get('concrete.email.forgot_password.name');",
                "// Line 293:                 if ($fromName === '') {",
                "// Line 294:                     $fromName = $isForgotPassword ? t('Forgot Password') : t('Password Reset');",
                "// Line 295:                 }",
                "// Line 296:                 $mh->from($fromEmail, $fromName);",
                "// Line 297:             }",
                "// vulnerable line: 298: $mh->addParameter('siteName', tc('SiteName', $this->app->make('site')->getSite()->getSiteName()));",
                "// Line 299:             $mh->load('forgot_password');",
                "// Line 300:             $mh->setIsThrowOnFailure(true);",
                "// Line 301:             try {",
                "// Line 302:                 $mh->sendMail();",
                "// Line 303:             } catch (Throwable $x) {",
                "// Line 304:                 $error->add($x);",
                "// Line 305:             }",
                "// Line 306:         }",
                "// Line 307:         if (!$error->has()) {",
                "// Line 308:             $session = $this->app->make(SessionValidatorInterface::class)->getActiveSession();"
            ]
        },
        {
            "filename_of_changes": "controller.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "2",
            "number_of_lines_deleted_vulnerable_to_cve": "2",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 119:     public function getRequiredFeatures(): array",
                "// Line 120:     {",
                "// Line 121:         return [",
                "// Line 122:             Features::NAVIGATION,",
                "// Line 123:         ];",
                "// Line 124:     }",
                "// Line 125: ",
                "// Line 126:     public function add()",
                "// Line 127:     {",
                "// Line 128:         $site = $this->app->make('site')->getSite();",
                "// vulnerable line: 129: $brandingText = $site->getSiteName();",
                "// Line 130:         /** @var Detector $detector */",
                "// Line 131:         $detector = $this->app->make('multilingual/detector');",
                "// Line 132: ",
                "// Line 133:         $this->set('includeTransparency', false);",
                "// Line 134:         $this->set('includeStickyNav', false);",
                "// Line 135:         $this->set('includeNavigation', true);",
                "// Line 136:         $this->set('includeNavigationDropdowns', false);",
                "// Line 137:         $this->set('includeSearchInput', false);",
                "// Line 138:         $this->set('includeBrandText', true);",
                "// Line 139:         $this->set('includeBrandLogo', false);",
                "// Line 243:             $logo = File::getByID($this->brandingLogo);",
                "// Line 244:             if ($logo) {",
                "// Line 245:                 $this->set('logo', $logo);",
                "// Line 246:             }",
                "// Line 247:         }",
                "// Line 248:         if (!isset($logo)) {",
                "// Line 249:             $this->set('logo', null);",
                "// Line 250:         }",
                "// Line 251:         if ($this->includeBrandText && !$this->brandingText) {",
                "// Line 252:             $site = $this->app->make('site')->getSite();",
                "// vulnerable line: 253: $brandingText = $site->getSiteName();",
                "// Line 254:             $this->set('brandingText', $brandingText);",
                "// Line 255:         }",
                "// Line 256:         if ($this->brandingTransparentLogo) {",
                "// Line 257:             $transparentLogo = File::getByID($this->brandingTransparentLogo);",
                "// Line 258:             if ($transparentLogo) {",
                "// Line 259:                 $this->set('transparentLogo', $transparentLogo);",
                "// Line 260:             }",
                "// Line 261:         }",
                "// Line 262:         $this->set('navigation', $this->getNavigation());",
                "// Line 263:         $this->set('home', $home);"
            ]
        },
        {
            "filename_of_changes": "header_required.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 54:         $pageTitle = $c->getAttribute('meta_title');",
                "// Line 55:         if (!is_string($pageTitle) || $pageTitle === '') {",
                "// Line 56:             $seo = $app->make('helper/seo');",
                "// Line 57:             if (!$seo->hasCustomTitle()) {",
                "// Line 58:                 $pageTitle = $c->getCollectionName();",
                "// Line 59:                 if ($c->isSystemPage()) {",
                "// Line 60:                     $pageTitle = t($pageTitle);",
                "// Line 61:                 }",
                "// Line 62:                 $seo->addTitleSegmentBefore($pageTitle);",
                "// Line 63:             }",
                "// vulnerable line: 64: $seo->setSiteName(tc('SiteName', $site->getSiteName()));",
                "// Line 65:             $seo->setTitleFormat($appConfig->get('concrete.seo.title_format'));",
                "// Line 66:             $seo->setTitleSegmentSeparator($appConfig->get('concrete.seo.title_segment_separator'));",
                "// Line 67:             $pageTitle = $seo->getTitle();",
                "// Line 68:         }",
                "// Line 69:     }",
                "// Line 70: ",
                "// Line 71:     if ($pageDescription === '') {",
                "// Line 72:         // we aren't getting it dynamically.",
                "// Line 73:         $pageDescription = (string) $c->getAttribute('meta_description');",
                "// Line 74:         if ($pageDescription === '') {"
            ]
        },
        {
            "filename_of_changes": "login.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 19: if (!isset($authTypeParams)) {",
                "// Line 20:     $authTypeParams = null;",
                "// Line 21: }",
                "// Line 22: ",
                "// Line 23: /* @var Key[] $required_attributes */",
                "// Line 24: ",
                "// Line 25: $attribute_mode = (isset($required_attributes) && count($required_attributes));",
                "// Line 26: $site = app('site')->getSite() ?? null;",
                "// Line 27: $siteName = '';",
                "// Line 28: if ($site) {",
                "// vulnerable line: 29: $siteName = $site->getSiteName();",
                "// Line 30: }",
                "// Line 31: ",
                "// Line 32: ?>",
                "// Line 33: ",
                "// Line 34: <div class=\"login-page\">",
                "// Line 35:     <div class=\"container\">",
                "// Line 36:         <div class=\"login-page-header\">",
                "// Line 37:             <?php",
                "// Line 38:             $disclaimer = new Area('Disclaimer');",
                "// Line 39:             if ($disclaimer->getTotalBlocksInArea($c) || $c->isEditMode()) {"
            ]
        },
        {
            "filename_of_changes": "register.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 162:                     $mh->addParameter('user', $process);",
                "// Line 163:                     $mh->addParameter('uName', $process->getUserName());",
                "// Line 164:                     $mh->addParameter('uEmail', $process->getUserEmail());",
                "// Line 165:                     $attribs = UserAttributeKey::getRegistrationList();",
                "// Line 166:                     $attribValues = [];",
                "// Line 167:                     foreach ($attribs as $ak) {",
                "// Line 168:                         $attribValues[] = $ak->getAttributeKeyDisplayName('text') . ': ' . $process->getAttribute($ak->getAttributeKeyHandle(),",
                "// Line 169:                                 'display');",
                "// Line 170:                     }",
                "// Line 171:                     $mh->addParameter('attribs', $attribValues);",
                "// vulnerable line: 172: $mh->addParameter('siteName', tc('SiteName', \\Core::make('site')->getSite()->getSiteName()));",
                "// Line 173: ",
                "// Line 174:                     if ($config->get('concrete.email.register_notification.address')) {",
                "// Line 175:                         if ($config->get('concrete.email.register_notification.name')) {",
                "// Line 176:                             $fromName = $config->get('concrete.email.register_notification.name');",
                "// Line 177:                         } else {",
                "// Line 178:                             $fromName = t('Website Registration Notification');",
                "// Line 179:                         }",
                "// Line 180:                         $mh->from($config->get('concrete.email.register_notification.address'), $fromName);",
                "// Line 181:                     } else {",
                "// Line 182:                         $fromEmail = (string) $config->get('concrete.email.default.address');"
            ]
        },
        {
            "filename_of_changes": "sites.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 211:         return $this->view_domains($site->getSiteID());",
                "// Line 212:     }",
                "// Line 213: ",
                "// Line 214:     protected function setCurrentSite(?Site $site): void",
                "// Line 215:     {",
                "// Line 216:         $this->set('site', $site);",
                "// Line 217:         if ($site === null || $site->getSiteID() === null) {",
                "// Line 218:             $menu = null;",
                "// Line 219:         } else {",
                "// Line 220:             $breadcrumb = $this->app->make(DashboardBreadcrumbFactory::class)->getBreadcrumb($this->getPageObject());",
                "// vulnerable line: 221: $breadcrumb->add(new Item('', $site->getSiteName()));",
                "// Line 222:             $this->setBreadcrumb($breadcrumb);",
                "// Line 223:             $menu = new Element('dashboard/system/multisite/site/menu', '', $this->getPageObject(), ['site' => $site]);",
                "// Line 224:         }",
                "// Line 225:         $this->set('siteMenu', $menu);",
                "// Line 226:     }",
                "// Line 227: }"
            ]
        },
        {
            "filename_of_changes": "view_details.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 109:                     <th>",
                "// Line 110:                         <?php echo t('Results') ?>",
                "// Line 111:                     </th>",
                "// Line 112:                 </tr>",
                "// Line 113:                 </thead>",
                "// Line 114: ",
                "// Line 115:                 <tbody>",
                "// Line 116:                 <?php foreach ($sites as $site) { ?>",
                "// Line 117:                     <tr>",
                "// Line 118:                         <td>",
                "// vulnerable line: 119: <?php echo $site->getSiteName() ?>",
                "// Line 120:                         </td>",
                "// Line 121: ",
                "// Line 122:                         <td style=\"white-space: nowrap\" class=\"text-center\">",
                "// Line 123:                             <?php",
                "// Line 124:                             $siteResultsNode = $resultsNode->getSiteResultsNode($site);",
                "// Line 125:                             if ($siteResultsNode) { ?>",
                "// Line 126:                                 <?php echo $siteResultsNode->getTotalResultsInFolder(); ?>",
                "// Line 127:                             <?php } else { ?>",
                "// Line 128:                                 <span class=\"text-warning\">",
                "// Line 129:                                     <?php echo t('Unknown') ?>"
            ]
        }
    ]
}