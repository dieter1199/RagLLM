{
    "cve_id": "CVE-2024-29859",
    "cve_description": "In MISP before 2.4.187, add_misp_export in app/Controller/EventsController.php does not properly check for a valid file upload.",
    "cve_publish_date": "2024-03-21T04:15Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "fix: [security] properly check for valid file upload\n\n- as kindly reported by RÃ©mi Matasse and Raphael Lob from Synacktiv (https://www.synacktiv.com)",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "EventsController.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "7",
            "number_of_lines_deleted_vulnerable_to_cve": "2",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 2365: ",
                "// Line 2366:                     $ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));",
                "// Line 2367:                     if (($ext !== 'xml' && $ext !== 'json') && $file['size'] > 0 && is_uploaded_file($file['tmp_name'])) {",
                "// Line 2368:                         $log = ClassRegistry::init('Log');",
                "// Line 2369:                         $log->createLogEntry($this->Auth->user(), 'file_upload', 'Event', 0, 'MISP export file upload failed', 'File details: ' . json_encode($file));",
                "// Line 2370:                         $this->Flash->error(__('You may only upload MISP XML or MISP JSON files.'));",
                "// Line 2371:                         throw new MethodNotAllowedException(__('File upload failed or file does not have the expected extension (.xml / .json).'));",
                "// Line 2372:                     }",
                "// Line 2373: ",
                "// Line 2374:                     $isXml = $ext === 'xml';",
                "// vulnerable line: 2375: $data = FileAccessTool::readFromFile($file['tmp_name'], $file['size']);",
                "// Line 2376:                 } else {",
                "// Line 2377:                     throw new MethodNotAllowedException(__('No file uploaded.'));",
                "// Line 2378:                 }",
                "// Line 2379: ",
                "// Line 2380:                 $takeOwnership = Configure::read('MISP.take_ownership_xml_import')",
                "// Line 2381:                     && (isset($this->request->data['Event']['takeownership']) && $this->request->data['Event']['takeownership'] == 1);",
                "// Line 2382: ",
                "// Line 2383:                 $publish = $this->request->data['Event']['publish'] ?? false;",
                "// Line 2384: ",
                "// Line 2385:                 try {"
            ]
        }
    ]
}