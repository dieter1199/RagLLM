{
    "cve_id": "CVE-2024-31219",
    "cve_description": "Discourse-reactions is a plugin that allows user to add their reactions to the post. When whispers are enabled on a site via `whispers_allowed_groups` and reactions are made on whispers on public topics, the contents of the whisper and the reaction data are shown on the `/u/:username/activity/reactions` endpoint.\n",
    "cve_publish_date": "2024-04-15T18:15Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "SECURITY: Hide whisper posts in reactions given endpoint (#286)\n\nUsers who were not allowed to whisper could see reactions\r\nand whisper content of posts on public topics.",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "custom_reactions_controller.rb",
            "code_language": "Ruby",
            "number_of_lines_added_for_mitigation": "7",
            "number_of_lines_deleted_vulnerable_to_cve": "4",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 41:     params.require(:username)",
                "// Line 42:     user =",
                "// Line 43:       fetch_user_from_params(",
                "// Line 44:         include_inactive:",
                "// Line 45:           current_user.try(:staff?) || (current_user && SiteSetting.show_inactive_accounts),",
                "// Line 46:       )",
                "// Line 47:     raise Discourse::NotFound unless guardian.can_see_profile?(user)",
                "// Line 48: ",
                "// Line 49:     reaction_users =",
                "// Line 50:       DiscourseReactions::ReactionUser",
                "// vulnerable line: 51: .joins(:reaction, :post)",
                "// vulnerable line: 52: .joins(\"INNER JOIN topics t ON t.id = posts.topic_id AND t.deleted_at IS NULL\")",
                "// Line 53:         .joins(\"LEFT JOIN categories c ON c.id = t.category_id\")",
                "// Line 54:         .includes(:user, :post, :reaction)",
                "// Line 55:         .where(user_id: user.id)",
                "// Line 56:         .where(\"discourse_reactions_reactions.reaction_users_count IS NOT NULL\")",
                "// Line 57: ",
                "// Line 58:     reaction_users = secure_reaction_users!(reaction_users)",
                "// Line 59: ",
                "// Line 60:     if params[:before_reaction_user_id]",
                "// Line 61:       reaction_users =",
                "// Line 62:         reaction_users.where(",
                "// Line 264: ",
                "// Line 265:     opts = {}",
                "// Line 266:     secure_audience = post.topic.secure_audience_publish_messages",
                "// Line 267:     opts = secure_audience if secure_audience[:user_ids] != [] && secure_audience[:group_ids] != []",
                "// Line 268: ",
                "// Line 269:     MessageBus.publish(\"/topic/#{post.topic.id}/reactions\", message, opts)",
                "// Line 270:   end",
                "// Line 271: ",
                "// Line 272:   def secure_reaction_users!(reaction_users)",
                "// Line 273:     builder = DB.build(\"/*where*/\")",
                "// vulnerable line: 274: UserAction.filter_private_messages(builder, current_user.id, guardian)",
                "// vulnerable line: 275: UserAction.filter_categories(builder, guardian)",
                "// Line 276:     reaction_users.where(builder.to_sql.delete_prefix(\"/*where*/\").delete_prefix(\"WHERE\"))",
                "// Line 277:   end",
                "// Line 278: ",
                "// Line 279:   def translate_to_reactions(likes)",
                "// Line 280:     likes.map do |like|",
                "// Line 281:       DiscourseReactions::ReactionUser.new(",
                "// Line 282:         id: like.id,",
                "// Line 283:         post: like.post,",
                "// Line 284:         user: like.user,",
                "// Line 285:         created_at: like.created_at,"
            ]
        },
        {
            "filename_of_changes": "custom_reactions_controller_spec.rb",
            "code_language": "Ruby",
            "number_of_lines_added_for_mitigation": "30",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "plugin.rb",
            "code_language": "Ruby",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 1: # frozen_string_literal: true",
                "// Line 2: ",
                "// Line 3: # name: discourse-reactions",
                "// Line 4: # about: Allows users to react to a post with emojis.",
                "// Line 5: # meta_topic_id: 183261",
                "// vulnerable line: 6: # version: 0.3",
                "// Line 7: # author: Ahmed Gagan, Rafael dos Santos Silva, Kris Aubuchon, Joffrey Jaffeux, Kris Kotlarek, Jordan Vidrine",
                "// Line 8: # url: https://github.com/discourse/discourse-reactions",
                "// Line 9: ",
                "// Line 10: enabled_site_setting :discourse_reactions_enabled",
                "// Line 11: ",
                "// Line 12: register_asset \"stylesheets/common/discourse-reactions.scss\"",
                "// Line 13: register_asset \"stylesheets/desktop/discourse-reactions.scss\", :desktop",
                "// Line 14: register_asset \"stylesheets/mobile/discourse-reactions.scss\", :mobile",
                "// Line 15: ",
                "// Line 16: register_svg_icon \"fas fa-star\""
            ]
        }
    ]
}