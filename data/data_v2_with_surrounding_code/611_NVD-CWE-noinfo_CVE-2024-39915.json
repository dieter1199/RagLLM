{
    "cve_id": "CVE-2024-39915",
    "cve_description": "Thruk is a multibackend monitoring webinterface for Naemon, Nagios, Icinga and Shinken using the Livestatus API. This authenticated RCE in Thruk allows authorized users with network access to inject arbitrary commands via the URL parameter during PDF report generation. The Thruk web application does not properly process the url parameter when generating a PDF report. An authorized attacker with access to the reporting functionality could inject arbitrary commands that would be executed when the script /script/html2pdf.sh is called. The vulnerability can be exploited by an authorized user with network access. This issue has been addressed in version 3.16. Users are advised to upgrade. There are no known workarounds for this vulnerability.\n",
    "cve_publish_date": "2024-07-15T20:15Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "fix using unescaped url in reports\n\nskip spawing a shell when generating pdf report from custom url. Insufficient\nescaping of the url lead to remote code execution vulnerability.\n\nreferences:\n\n- https://github.com/sni/Thruk/security/advisories/GHSA-r7gx-h738-4w6f\n\ncredits:\n\n- https://github.com/OOsipova\n- https://github.com/BlackFan (Kaspersky)",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "Render.pm",
            "code_language": "Perl",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "2",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 385:     my $product_prefix = $c->config->{'product_prefix'};",
                "// Line 386:     my $url            = $c->stash->{'param'}->{'url'};",
                "// Line 387: ",
                "// Line 388:     # create fake session",
                "// Line 389:     my($sessionid) = Thruk::Utils::get_fake_session($c);",
                "// Line 390:     push @{$c->stash->{'report_tmp_files_to_delete'}}, $c->stash->{'fake_session_file'};",
                "// Line 391: ",
                "// Line 392:     # directly convert external urls",
                "// Line 393:     if($url =~ m/^https?:\\/\\/([^\\/]+)/mx && $c->stash->{'param'}->{'pdf'} && $c->stash->{'param'}->{'pdf'} eq 'yes') {",
                "// Line 394:         Thruk::Utils::External::update_status($ENV{'THRUK_JOB_DIR'}, 80, 'converting') if $ENV{'THRUK_JOB_DIR'};",
                "// vulnerable line: 395: my $cmd = $c->config->{home}.'/script/html2pdf.sh \"'.$url.'\" \"'.$c->stash->{'attachment'}.'.pdf\"';",
                "// Line 396:         local $ENV{THRUK_SESSION_ID} = $sessionid;",
                "// vulnerable line: 397: Thruk::Utils::IO::cmd($cmd);",
                "// Line 398:         move($c->stash->{'attachment'}.'.pdf', $c->stash->{'attachment'}) or die('move '.$c->stash->{'attachment'}.'.pdf to '.$c->stash->{'attachment'}.' failed: '.$!);",
                "// Line 399:         $Thruk::Utils::PDF::ctype      = 'application/pdf';",
                "// Line 400:         $Thruk::Utils::PDF::attachment = 'report.pdf';",
                "// Line 401:         return \"\";",
                "// Line 402:     }",
                "// Line 403: ",
                "// Line 404:     # strip host part if url points to thruk and do not use frame index page",
                "// Line 405:     $url =~ s|^.*/\\Q$product_prefix\\E/\\#?cgi\\-bin/||mx;",
                "// Line 406: ",
                "// Line 407:     # short urls like: tac.cgi"
            ]
        }
    ]
}