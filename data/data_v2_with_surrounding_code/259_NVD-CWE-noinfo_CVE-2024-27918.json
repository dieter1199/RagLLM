{
    "cve_id": "CVE-2024-27918",
    "cve_description": "Coder allows oragnizations to provision remote development environments via Terraform. Prior to versions 2.6.1, 2.7.3, and 2.8.4, a vulnerability in Coder's OIDC authentication could allow an attacker to bypass the `CODER_OIDC_EMAIL_DOMAIN` verification and create an account with an email not in the allowlist. Deployments are only affected if the OIDC provider allows users to create accounts on the provider. During OIDC registration, the user's email was improperly validated against the allowed `CODER_OIDC_EMAIL_DOMAIN`s. This could allow a user with a domain that only partially matched an allowed domain to successfully login or register. An attacker could register a domain name that exploited this vulnerability and register on a Coder instance with a public OIDC provider.\n\nCoder instances with OIDC enabled and protected by the `CODER_OIDC_EMAIL_DOMAIN` configuration are affected. Coder instances using a private OIDC provider are not affected, as arbitrary users cannot register through a private OIDC provider without first having an account on the provider. Public OIDC providers are impacted. GitHub authentication and external authentication are not impacted. This vulnerability is remedied in versions 2.8.4, 2.7.3, and 2.6.1 All versions prior to these patches are affected by the vulnerability.*It is recommended that customers upgrade their deployments as soon as possible if they are utilizing OIDC authentication with the `CODER_OIDC_EMAIL_DOMAIN` setting.",
    "cve_publish_date": "2024-03-21T02:52Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "Merge pull request from GHSA-7cc2-r658-7xpf\n\nThis fixes a vulnerability with the `CODER_OIDC_EMAIL_DOMAIN` option,\nwhere users with a superset of the allowed email domain would be allowed\nto login. For example, given `CODER_OIDC_EMAIL_DOMAIN=google.com`, a\nuser would be permitted entry if their email domain was\n`colin-google.com`.",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "userauth.go",
            "code_language": "Go",
            "number_of_lines_added_for_mitigation": "10",
            "number_of_lines_deleted_vulnerable_to_cve": "2",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 923:         // to keep the domain.",
                "// Line 924:         if username == \"\" {",
                "// Line 925:             username = email",
                "// Line 926:         }",
                "// Line 927:         username = httpapi.UsernameFrom(username)",
                "// Line 928:     }",
                "// Line 929: ",
                "// Line 930:     if len(api.OIDCConfig.EmailDomain) > 0 {",
                "// Line 931:         ok = false",
                "// Line 932:         for _, domain := range api.OIDCConfig.EmailDomain {",
                "// vulnerable line: 933: if strings.HasSuffix(strings.ToLower(email), strings.ToLower(domain)) {",
                "// Line 934:                 ok = true",
                "// Line 935:                 break",
                "// Line 936:             }",
                "// Line 937:         }",
                "// Line 938:         if !ok {",
                "// Line 939:             httpapi.Write(ctx, rw, http.StatusForbidden, codersdk.Response{",
                "// vulnerable line: 940: Message: fmt.Sprintf(\"Your email %q is not in domains %q !\", email, api.OIDCConfig.EmailDomain),",
                "// Line 941:             })",
                "// Line 942:             return",
                "// Line 943:         }",
                "// Line 944:     }",
                "// Line 945: ",
                "// Line 946:     var picture string",
                "// Line 947:     pictureRaw, ok := mergedClaims[\"picture\"]",
                "// Line 948:     if ok {",
                "// Line 949:         picture, _ = pictureRaw.(string)",
                "// Line 950:     }"
            ]
        },
        {
            "filename_of_changes": "userauth_test.go",
            "code_language": "Go",
            "number_of_lines_added_for_mitigation": "11",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        }
    ]
}