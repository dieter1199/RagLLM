{
    "cve_id": "CVE-2024-2313",
    "cve_description": "If kernel headers need to be extracted, bpftrace will attempt to load them from a temporary directory. An unprivileged attacker could use this to force bcc to load compromised linux headers. Linux distributions which provide kernel headers by default are not affected by default.",
    "cve_publish_date": "2024-03-10T23:15Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "Fix security hole checking unpacked kernel headers (#3033)\n\nMake sure to check that the unpacked kheaders tar\r\nis owned by root to prevent bpftrace from loading\r\ncompromised linux headers.\r\n\r\nCo-authored-by: Jordan Rome <jordalgo@fedoraproject.org>",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "utils.cpp",
            "code_language": "C++",
            "number_of_lines_added_for_mitigation": "22",
            "number_of_lines_deleted_vulnerable_to_cve": "4",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 717: };",
                "// Line 718: ",
                "// Line 719: std::string unpack_kheaders_tar_xz(const struct utsname &utsname)",
                "// Line 720: {",
                "// Line 721:   std::error_code ec;",
                "// Line 722: #if defined(__ANDROID__)",
                "// Line 723:   std_filesystem::path path_prefix{ \"/data/local/tmp\" };",
                "// Line 724: #else",
                "// Line 725:   std_filesystem::path path_prefix{ \"/tmp\" };",
                "// Line 726: #endif",
                "// vulnerable line: 727: std_filesystem::path path_kheaders{ \"/sys/kernel/kheaders.tar.xz\" };",
                "// Line 728:   if (const char *tmpdir = ::getenv(\"TMPDIR\")) {",
                "// Line 729:     path_prefix = tmpdir;",
                "// Line 730:   }",
                "// Line 731:   path_prefix /= \"kheaders-\";",
                "// Line 732:   std_filesystem::path shared_path{ path_prefix.string() + utsname.release };",
                "// Line 733: ",
                "// vulnerable line: 734: if (std_filesystem::exists(shared_path, ec)) {",
                "// Line 735:     // already unpacked",
                "// Line 736:     return shared_path.string();",
                "// Line 737:   }",
                "// Line 738: ",
                "// Line 739:   if (!std_filesystem::exists(path_kheaders, ec)) {",
                "// Line 740:     StderrSilencer silencer;",
                "// Line 741:     silencer.silence();",
                "// Line 742: ",
                "// Line 743:     FILE *modprobe = ::popen(\"modprobe kheaders\", \"w\");",
                "// Line 744:     if (modprobe == nullptr || pclose(modprobe) != 0) {",
                "// Line 745:       return \"\";",
                "// Line 746:     }",
                "// Line 747: ",
                "// Line 748:     if (!std_filesystem::exists(path_kheaders, ec)) {",
                "// Line 749:       return \"\";",
                "// Line 750:     }",
                "// Line 751:   }",
                "// Line 752: ",
                "// Line 753:   KernelHeaderTmpDir tmpdir{ path_prefix };",
                "// Line 754: ",
                "// vulnerable line: 755: FILE *tar = ::popen(",
                "// vulnerable line: 756: (\"tar xf /sys/kernel/kheaders.tar.xz -C \" + tmpdir.path).c_str(), \"w\");",
                "// Line 757:   if (!tar) {",
                "// Line 758:     return \"\";",
                "// Line 759:   }",
                "// Line 760: ",
                "// Line 761:   int rc = ::pclose(tar);",
                "// Line 762:   if (rc == 0) {",
                "// Line 763:     tmpdir.move_to(shared_path);",
                "// Line 764:     return shared_path;",
                "// Line 765:   }",
                "// Line 766: "
            ]
        },
        {
            "filename_of_changes": "utils.cpp",
            "code_language": "C++",
            "number_of_lines_added_for_mitigation": "21",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "utils.h",
            "code_language": "C++",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        }
    ]
}