{
    "cve_id": "CVE-2024-28117",
    "cve_description": "Grav is an open-source, flat-file content management system. Prior to version 1.7.45, Grav validates accessible functions through the Utils::isDangerousFunction function, but does not impose restrictions on twig functions like twig_array_map, allowing attackers to bypass the validation and execute arbitrary commands. Twig processing of static pages can be enabled in the front matter by any administrative user allowed to create or edit pages. As the Twig processor runs unsandboxed, this behavior can be used to gain arbitrary code execution and elevate privileges on the instance. Upgrading to patched version 1.7.45 can mitigate this issue.\n",
    "cve_publish_date": "2024-03-21T22:15Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "Mitigate various SSTI injections",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "Security.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "19",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "Twig.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "9",
            "number_of_lines_deleted_vulnerable_to_cve": "2",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 411:      * @param string|null $format Output format (defaults to HTML).",
                "// Line 412:      * @param array $vars",
                "// Line 413:      * @return string the rendered output",
                "// Line 414:      * @throws RuntimeException",
                "// Line 415:      */",
                "// Line 416:     public function processSite($format = null, array $vars = [])",
                "// Line 417:     {",
                "// Line 418:         try {",
                "// Line 419:             $grav = $this->grav;",
                "// Line 420: ",
                "// vulnerable line: 421: // set the page now its been processed",
                "// Line 422:             $grav->fireEvent('onTwigSiteVariables');",
                "// Line 423: ",
                "// Line 424:             /** @var Pages $pages */",
                "// Line 425:             $pages = $grav['pages'];",
                "// Line 426: ",
                "// Line 427:             /** @var PageInterface $page */",
                "// Line 428:             $page = $grav['page'];",
                "// Line 429: ",
                "// Line 430:             $twig_vars = $this->twig_vars;",
                "// Line 431:             $twig_vars['theme'] = $grav['config']->get('theme');",
                "// Line 432:             $twig_vars['pages'] = $pages->root();",
                "// Line 433:             $twig_vars['page'] = $page;",
                "// Line 434:             $twig_vars['header'] = $page->header();",
                "// Line 435:             $twig_vars['media'] = $page->media();",
                "// vulnerable line: 436: $twig_vars['content'] = $page->content();",
                "// Line 437: ",
                "// Line 438:             // determine if params are set, if so disable twig cache",
                "// Line 439:             $params = $grav['uri']->params(null, true);",
                "// Line 440:             if (!empty($params)) {",
                "// Line 441:                 $this->twig->setCache(false);",
                "// Line 442:             }",
                "// Line 443: ",
                "// Line 444:             // Get Twig template layout",
                "// Line 445:             $template = $this->getPageTwigTemplate($page, $format);",
                "// Line 446:             $page->templateFormat($format);"
            ]
        }
    ]
}