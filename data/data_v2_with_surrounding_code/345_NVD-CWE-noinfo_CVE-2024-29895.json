{
    "cve_id": "CVE-2024-29895",
    "cve_description": "Cacti provides an operational monitoring and fault management framework. A command injection vulnerability on the 1.3.x DEV branch allows any unauthenticated user to execute arbitrary command on the server when `register_argc_argv` option of PHP is `On`. In `cmd_realtime.php` line 119, the `$poller_id` used as part of the command execution is sourced from `$_SERVER['argv']`, which can be controlled by URL when `register_argc_argv` option of PHP is `On`. And this option is `On` by default in many environments such as the main PHP Docker image for PHP. Commit 53e8014d1f082034e0646edc6286cde3800c683d contains a patch for the issue, but this commit was reverted in commit 99633903cad0de5ace636249de16f77e57a3c8fc.",
    "cve_publish_date": "2024-05-14T15:17Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "Revert \"Merge pull request from GHSA-cr28-x256-xf5m\"\n\nThis reverts commit 53e8014d1f082034e0646edc6286cde3800c683d.",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "cmd_realtime.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "7",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 34: ",
                "// Line 35: /* correct for a windows PHP bug. fixed in 5.2.0 */",
                "// Line 36: if (cacti_count($_SERVER['argv']) < 4) {",
                "// Line 37:     print \"No graph_id, interval, pollerid specified.",
                "// Line 38: ",
                "// Line 39: \";",
                "// Line 40:     print \"Usage: cmd_realtime.php POLLER_ID GRAPH_ID INTERVAL",
                "// Line 41: ",
                "// Line 42: \";",
                "// Line 43: ",
                "// vulnerable line: 44: exit(-1);",
                "// vulnerable line: 45: }",
                "// Line 46: ",
                "// vulnerable line: 47: $poller_id = (int)$_SERVER['argv'][1];",
                "// Line 48: $graph_id  = (int)$_SERVER['argv'][2];",
                "// Line 49: $interval  = (int)$_SERVER['argv'][3];",
                "// Line 50: ",
                "// vulnerable line: 51: if ($poller_id <= 0) {",
                "// Line 52:     print \"Invalid poller_id specified.",
                "// Line 53: ",
                "// Line 54: \";",
                "// Line 55: ",
                "// vulnerable line: 56: exit(-1);",
                "// vulnerable line: 57: }",
                "// Line 58: ",
                "// Line 59: if ($graph_id <= 0) {",
                "// Line 60:     print \"Invalid graph_id specified.",
                "// Line 61: ",
                "// Line 62: \";",
                "// Line 63: ",
                "// vulnerable line: 64: exit(-1);",
                "// vulnerable line: 65: }",
                "// Line 66: ",
                "// Line 67: if ($interval <= 0) {",
                "// Line 68:     print \"Invalid interval specified.",
                "// Line 69: ",
                "// Line 70: \";",
                "// Line 71: ",
                "// vulnerable line: 72: exit(-1);",
                "// vulnerable line: 73: }",
                "// Line 74: ",
                "// Line 75: /* record the start time */",
                "// Line 76: $start = microtime(true);",
                "// Line 77: ",
                "// Line 78: /* initialize the polling items */",
                "// Line 79: $polling_items = array();",
                "// Line 80: ",
                "// Line 81: /* get poller_item for graph_id */",
                "// Line 82: $local_data_ids = db_fetch_assoc_prepared('SELECT DISTINCT dtr.local_data_id, dl.host_id",
                "// Line 83:     FROM graph_templates_item AS gti",
                "// Line 87:     ON dl.id=dtr.local_data_id",
                "// Line 88:     WHERE gti.local_graph_id = ?",
                "// Line 89:     AND dtr.local_data_id > 0',",
                "// Line 90:     array($graph_id));",
                "// Line 91: ",
                "// Line 92: if (!cacti_count($local_data_ids)) {",
                "// Line 93:     print \"No local_graph_id found",
                "// Line 94: ",
                "// Line 95: \";",
                "// Line 96: ",
                "// vulnerable line: 97: exit(-1);",
                "// vulnerable line: 98: }",
                "// Line 99: ",
                "// Line 100: $ids      = array();",
                "// Line 101: $hosts    = array();",
                "// Line 102: $idbyhost = array();",
                "// Line 103: ",
                "// Line 104: foreach ($local_data_ids as $row) {",
                "// Line 105:     if ($row['local_data_id'] > 0 && $row['host_id'] != '') {",
                "// Line 106:         $ids[$row['local_data_id']]  = $row['local_data_id'];",
                "// Line 107:         $hosts[$row['host_id']]      = $row['host_id'];",
                "// Line 108: ",
                "// Line 109:         $idbyhost[$row['host_id']][] = $row['local_data_id'];",
                "// vulnerable line: 110: }",
                "// vulnerable line: 111: }",
                "// Line 112: ",
                "// Line 113: $print_data_to_stdout = true;",
                "// Line 114: ",
                "// Line 115: if (cacti_sizeof($idbyhost)) {",
                "// Line 116:     $polling_items = db_fetch_assoc('SELECT *",
                "// Line 117:         FROM poller_item",
                "// Line 118:         WHERE local_data_id IN (' . implode(',', $ids) . ')",
                "// Line 119:         AND host_id IN (' . implode(',', $hosts) . ')",
                "// Line 120:         ORDER BY host_id');",
                "// Line 121: ",
                "// Line 132:             1 => array('pipe', 'w'), // stdout is a pipe that the child will write to",
                "// Line 133:             2 => array('pipe', 'w')  // stderr is a pipe to write to",
                "// Line 134:         );",
                "// Line 135: ",
                "// Line 136:         if (function_exists('proc_open')) {",
                "// Line 137:             $cactiphp            = proc_open(read_config_option('path_php_binary') . ' -q ' . CACTI_PATH_BASE . '/script_server.php realtime ' . $poller_id, $cactides, $pipes);",
                "// Line 138:             $output              = fgets($pipes[1], 1024);",
                "// Line 139:             $using_proc_function = true;",
                "// Line 140:         } else {",
                "// Line 141:             $using_proc_function = false;",
                "// vulnerable line: 142: }",
                "// Line 143:     } else {",
                "// Line 144:         $using_proc_function = false;",
                "// vulnerable line: 145: }",
                "// Line 146: ",
                "// Line 147:     /* all polled items need the same insert time */",
                "// Line 148:     $host_update_time = date('Y-m-d H:i:s');",
                "// Line 149: ",
                "// Line 150:     foreach ($idbyhost as $host_id => $local_data_ids) {",
                "// Line 151:         $col_poller_id = db_fetch_cell_prepared('SELECT poller_id",
                "// Line 152:             FROM host",
                "// Line 153:             WHERE id = ?', array($host_id));",
                "// Line 154: ",
                "// Line 155:         $local_data_ids = array(",
                "// Line 159:         if ($col_poller_id > 1) {",
                "// Line 160:             $hostname = db_fetch_cell_prepared('SELECT hostname",
                "// Line 161:                 FROM poller",
                "// Line 162:                 WHERE id = ?',",
                "// Line 163:                 array($col_poller_id));",
                "// Line 164: ",
                "// Line 165:             $port = read_config_option('remote_agent_port');",
                "// Line 166: ",
                "// Line 167:             if ($port != '') {",
                "// Line 168:                 $port = ':' . $port;",
                "// vulnerable line: 169: }",
                "// Line 170: ",
                "// Line 171:             $url = get_url_type() . '://' . $hostname . $port .",
                "// Line 172:                 CACTI_PATH_URL . '/remote_agent.php' .",
                "// Line 173:                 '?action=polldata' .",
                "// Line 174:                 '&host_id=' . $host_id .",
                "// Line 175:                 '&' . http_build_query($local_data_ids) .",
                "// Line 176:                 '&poller_id=' . $poller_id;",
                "// Line 177: ",
                "// Line 178:             $fgc_contextoption = get_default_contextoption();",
                "// Line 179:             $fgc_context       = stream_context_create($fgc_contextoption);",
                "// Line 182:             if (cacti_sizeof($output)) {",
                "// Line 183:                 $sql = '';",
                "// Line 184: ",
                "// Line 185:                 foreach ($output as $item) {",
                "// Line 186:                     $sql .= ($sql != '' ? ', ':'')      . '(' .",
                "// Line 187:                         db_qstr($item['local_data_id']) . ', ' .",
                "// Line 188:                         db_qstr($item['rrd_name'])      . ', ' .",
                "// Line 189:                         db_qstr($host_update_time)      . ', ' .",
                "// Line 190:                         db_qstr($poller_id)             . ', ' .",
                "// Line 191:                         db_qstr($item['value'])         . ')';",
                "// vulnerable line: 192: }",
                "// Line 193: ",
                "// Line 194:                 db_execute(\"INSERT INTO poller_output_realtime",
                "// Line 195:                     (local_data_id, rrd_name, time, poller_id, output)",
                "// Line 196:                     VALUES $sql\");",
                "// vulnerable line: 197: }",
                "// Line 198:         } else {",
                "// Line 199:             $poller_items = db_fetch_assoc_prepared('SELECT *",
                "// Line 200:                 FROM poller_item",
                "// Line 201:                 WHERE host_id = ?",
                "// Line 202:                 AND local_data_id IN(' . implode(',', $local_data_ids['local_data_ids']) . ')',",
                "// Line 203:                 array($host_id));",
                "// Line 204: ",
                "// Line 205:             if (cacti_sizeof($poller_items)) {",
                "// Line 206:                 foreach ($poller_items as $item) {",
                "// Line 207:                     switch ($item['action']) {",
                "// Line 210:                                 $output = 'U';",
                "// Line 211:                             } else {",
                "// Line 212:                                 $host = db_fetch_row_prepared('SELECT ping_retries, max_oids",
                "// Line 213:                                 FROM host",
                "// Line 214:                                 WHERE id = ?',",
                "// Line 215:                                     array($host_id));",
                "// Line 216: ",
                "// Line 217:                                 if (!cacti_sizeof($host)) {",
                "// Line 218:                                     $host['ping_retries'] = 1;",
                "// Line 219:                                     $host['max_oids']     = 1;",
                "// vulnerable line: 220: }",
                "// Line 221: ",
                "// Line 222:                                 $session = cacti_snmp_session($item['hostname'], $item['snmp_community'], $item['snmp_version'],",
                "// Line 223:                                     $item['snmp_username'], $item['snmp_password'], $item['snmp_auth_protocol'], $item['snmp_priv_passphrase'],",
                "// Line 224:                                     $item['snmp_priv_protocol'], $item['snmp_context'], $item['snmp_engine_id'], $item['snmp_port'],",
                "// Line 225:                                     $item['snmp_timeout'], $host['ping_retries'], $host['max_oids']);",
                "// Line 226: ",
                "// Line 227:                                 if ($session === false) {",
                "// Line 228:                                     $output = 'U';",
                "// Line 229:                                 } else {",
                "// Line 230:                                     $output = cacti_snmp_session_get($session, $item['arg1']);",
                "// Line 231:                                     $session->close();",
                "// vulnerable line: 232: }",
                "// Line 233: ",
                "// Line 234:                                 if (prepare_validate_result($output) === false) {",
                "// Line 235:                                     if (strlen($output) > 20) {",
                "// Line 236:                                         $strout = 20;",
                "// Line 237:                                     } else {",
                "// Line 238:                                         $strout = strlen($output);",
                "// vulnerable line: 239: }",
                "// Line 240: ",
                "// Line 241:                                     $output = 'U';",
                "// vulnerable line: 242: }",
                "// vulnerable line: 243: }",
                "// Line 244: ",
                "// Line 245:                             break;",
                "// Line 246:                         case POLLER_ACTION_SCRIPT: /* script (popen) */",
                "// Line 247:                             $output = trim(exec_poll($item['arg1']), 2);",
                "// Line 248: ",
                "// Line 249:                             if (prepare_validate_result($output) === false) {",
                "// Line 250:                                 if (strlen($output) > 20) {",
                "// Line 251:                                     $strout = 20;",
                "// Line 252:                                 } else {",
                "// Line 253:                                     $strout = strlen($output);",
                "// vulnerable line: 254: }",
                "// Line 255: ",
                "// Line 256:                                 $output = 'U';",
                "// vulnerable line: 257: }",
                "// Line 258: ",
                "// Line 259:                             break;",
                "// Line 260:                         case POLLER_ACTION_SCRIPT_PHP: /* script (php script server) */",
                "// Line 261:                             if ($using_proc_function == true) {",
                "// Line 262:                                 $output = trim(str_replace(\"",
                "// Line 263: \", '', exec_poll_php($item['arg1'], $using_proc_function, $pipes, $cactiphp)));",
                "// Line 264: ",
                "// Line 265:                                 if (prepare_validate_result($output) === false) {",
                "// Line 266:                                     if (strlen($output) > 20) {",
                "// Line 267:                                         $strout = 20;",
                "// Line 268:                                     } else {",
                "// Line 269:                                         $strout = strlen($output);",
                "// vulnerable line: 270: }",
                "// Line 271: ",
                "// Line 272:                                     $output = 'U';",
                "// vulnerable line: 273: }",
                "// Line 274:                             } else {",
                "// Line 275:                                 $output = 'U';",
                "// vulnerable line: 276: }",
                "// Line 277: ",
                "// Line 278:                             break;",
                "// vulnerable line: 279: }",
                "// Line 280: ",
                "// Line 281:                     if (isset($output)) {",
                "// Line 282:                         db_execute_prepared('INSERT INTO poller_output_realtime",
                "// Line 283:                             (local_data_id, rrd_name, time, poller_id, output)",
                "// Line 284:                             VALUES",
                "// Line 285:                             (?, ?, ?, ?, ?)',",
                "// Line 286:                             array($item['local_data_id'], $item['rrd_name'], $host_update_time, $poller_id, $output));",
                "// vulnerable line: 287: }",
                "// vulnerable line: 288: }",
                "// vulnerable line: 289: }",
                "// vulnerable line: 290: }",
                "// vulnerable line: 291: }",
                "// Line 292: ",
                "// Line 293:     if (($using_proc_function == true) && ($script_server_calls > 0)) {",
                "// Line 294:         /* close php server process */",
                "// Line 295:         fwrite($pipes[0], \"quit",
                "// Line 296: \");",
                "// Line 297:         fclose($pipes[0]);",
                "// Line 298:         fclose($pipes[1]);",
                "// Line 299:         fclose($pipes[2]);",
                "// Line 300: ",
                "// Line 301:         $return_value = proc_close($cactiphp);",
                "// vulnerable line: 302: }",
                "// vulnerable line: 303: }"
            ]
        }
    ]
}