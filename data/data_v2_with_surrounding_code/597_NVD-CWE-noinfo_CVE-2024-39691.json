{
    "cve_id": "CVE-2024-39691",
    "cve_description": "matrix-appservice-irc is a Node.js IRC bridge for the Matrix messaging protocol. The fix for GHSA-wm4w-7h2q-3pf7 / CVE-2024-32000 included in matrix-appservice-irc 2.0.0 relied on the Matrix homeserver-provided timestamp to determine whether a user has access to the event they're replying to when determining whether or not to include a truncated version of the original event in the IRC message. Since this value is controlled by external entities, a malicious Matrix homeserver joined to a room in which a matrix-appservice-irc bridge instance (before version 2.0.1) is present can fabricate the timestamp with the intent of tricking the bridge into leaking room messages the homeserver should not have access to. matrix-appservice-irc 2.0.1 drops the reliance on `origin_server_ts` when determining whether or not an event should be visible to a user, instead tracking the event timestamps internally. As a workaround, it's possible to limit the amount of information leaked by setting a reply template that doesn't contain the original message.",
    "cve_publish_date": "2024-07-05T19:15Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "Don't use origin_server_ts when tracking joins, use bridge-time instead (#1804)\n\n* Don't use origin_server_ts when tracking joins, use bridge-time instead\r\n\r\n* Changelog",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "MatrixHandler.ts",
            "code_language": "TypeScript",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 407: ",
                "// Line 408:         return null;",
                "// Line 409:     }",
                "// Line 410: ",
                "// Line 411:     /**",
                "// Line 412:      * Called when the AS receives a new Matrix invite/join/leave event.",
                "// Line 413:      * @param {Object} event : The Matrix member event.",
                "// Line 414:      */",
                "// Line 415:     private _onMemberEvent(req: BridgeRequest, event: OnMemberEventData) {",
                "// Line 416:         if (event.content.membership === 'join') {",
                "// vulnerable line: 417: this.memberJoinTs.set(`${event.room_id}/${event.state_key}`, event.origin_server_ts ?? Date.now());",
                "// Line 418:         }",
                "// Line 419:         else {",
                "// Line 420:             this.memberJoinTs.delete(`${event.room_id}/${event.state_key}`);",
                "// Line 421:         }",
                "// Line 422:         this.memberTracker?.onEvent(event);",
                "// Line 423:     }",
                "// Line 424: ",
                "// Line 425:     /**",
                "// Line 426:      * Called when a Matrix user tries to invite another user into a PM",
                "// Line 427:      * @param {Object} event : The Matrix invite event."
            ]
        }
    ]
}