{
    "cve_id": "CVE-2024-32462",
    "cve_description": "Flatpak is a system for building, distributing, and running sandboxed desktop applications on Linux. in versions before 1.10.9, 1.12.9, 1.14.6, and 1.15.8, a malicious or compromised Flatpak app could execute arbitrary code outside its sandbox. Normally, the `--command` argument of `flatpak run` expects to be given a command to run in the specified Flatpak app, optionally along with some arguments. However it is possible to instead pass `bwrap` arguments to `--command=`, such as `--bind`. It's possible to pass an arbitrary `commandline` to the portal interface `org.freedesktop.portal.Background.RequestBackground` from within a Flatpak app. When this is converted into a `--command` and arguments, it achieves the same effect of passing arguments directly to `bwrap`, and thus can be used for a sandbox escape. The solution is to pass the `--` argument to `bwrap`, which makes it stop processing options. This has been supported since bubblewrap 0.3.0. All supported versions of Flatpak require at least that version of bubblewrap. xdg-desktop-portal version 1.18.4 will mitigate this vulnerability by only allowing Flatpak apps to create .desktop files for commands that do not start with --. The vulnerability is patched in 1.15.8, 1.10.9, 1.12.9, and 1.14.6.",
    "cve_publish_date": "2024-04-18T18:15Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "When starting non-static command using bwrap use \"--\"\n\nThis ensures that the command is not taken to be a bwrap option.\n\nResolves: CVE-2024-32462\nResolves: GHSA-phv6-cpc2-2fgj\nSigned-off-by: Alexander Larsson <alexl@redhat.com>\n[smcv: Fix DISABLE_SANDBOXED_TRIGGERS code path]\n[smcv: Make flatpak_run_maybe_start_dbus_proxy() more obviously correct]\nSigned-off-by: Simon McVittie <smcv@collabora.com>",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "flatpak-builtins-build.c",
            "code_language": "C",
            "number_of_lines_added_for_mitigation": "2",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 582:                               NULL);",
                "// Line 583:     }",
                "// Line 584: ",
                "// Line 585:   flatpak_bwrap_populate_runtime_dir (bwrap, NULL);",
                "// Line 586: ",
                "// Line 587:   flatpak_bwrap_envp_to_args (bwrap);",
                "// Line 588: ",
                "// Line 589:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
                "// Line 590:     return FALSE;",
                "// Line 591: ",
                "// vulnerable line: 592: flatpak_bwrap_add_args (bwrap, command, NULL);",
                "// Line 593:   flatpak_bwrap_append_argsv (bwrap,",
                "// Line 594:                               &argv[rest_argv_start + 2],",
                "// Line 595:                               rest_argc - 2);",
                "// Line 596: ",
                "// Line 597:   g_ptr_array_add (bwrap->argv, NULL);",
                "// Line 598: ",
                "// Line 599:   g_snprintf (pid_str, sizeof (pid_str), \"%d\", getpid ());",
                "// Line 600:   pid_path = g_build_filename (instance_id_host_dir, \"pid\", NULL);",
                "// Line 601:   g_file_set_contents (pid_path, pid_str, -1, NULL);",
                "// Line 602: "
            ]
        },
        {
            "filename_of_changes": "flatpak-dir.c",
            "code_language": "C",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "flatpak-run-dbus.c",
            "code_language": "C",
            "number_of_lines_added_for_mitigation": "3",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        },
        {
            "filename_of_changes": "flatpak-run.c",
            "code_language": "C",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 3442:         }",
                "// Line 3443:       command = default_command;",
                "// Line 3444:     }",
                "// Line 3445: ",
                "// Line 3446:   flatpak_bwrap_sort_envp (bwrap);",
                "// Line 3447:   flatpak_bwrap_envp_to_args (bwrap);",
                "// Line 3448: ",
                "// Line 3449:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
                "// Line 3450:     return FALSE;",
                "// Line 3451: ",
                "// vulnerable line: 3452: flatpak_bwrap_add_arg (bwrap, command);",
                "// Line 3453: ",
                "// Line 3454:   if (!add_rest_args (bwrap, app_id,",
                "// Line 3455:                       exports, (flags & FLATPAK_RUN_FLAG_FILE_FORWARDING) != 0,",
                "// Line 3456:                       doc_mount_path,",
                "// Line 3457:                       args, n_args, error))",
                "// Line 3458:     return FALSE;",
                "// Line 3459: ",
                "// Line 3460:   /* Hold onto the lock until we execute bwrap */",
                "// Line 3461:   flatpak_bwrap_add_noinherit_fd (bwrap, g_steal_fd (&per_app_dir_lock_fd));",
                "// Line 3462: "
            ]
        }
    ]
}