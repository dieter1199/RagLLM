{
    "cve_id": "CVE-2023-44396",
    "cve_description": "iTop is an IT service management platform.  Dashlet edits ajax endpoints can be used to produce XSS. Fixed in iTop 2.7.10, 3.0.4, and 3.1.1.\n",
    "cve_publish_date": "2024-04-15T18:15Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "NÂ°6606 security hardening",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "ajax.render.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "13",
            "number_of_lines_deleted_vulnerable_to_cve": "12",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 1187:             break;",
                "// Line 1188: ",
                "// Line 1189:         case 'toggle_dashboard':",
                "// Line 1190:             $oPage->SetContentType('text/html');",
                "// Line 1191:             $sDashboardId = utils::ReadParam('dashboard_id', '', false, 'raw_data');",
                "// Line 1192: ",
                "// Line 1193:             $bStandardSelected = appUserPreferences::GetPref('display_original_dashboard_'.$sDashboardId, false);",
                "// Line 1194:             appUserPreferences::UnsetPref('display_original_dashboard_'.$sDashboardId);",
                "// Line 1195:             appUserPreferences::SetPref('display_original_dashboard_'.$sDashboardId, !$bStandardSelected);",
                "// Line 1196: ",
                "// vulnerable line: 1197: $aExtraParams = utils::ReadParam('extra_params', array(), false, 'raw_data');",
                "// Line 1198:             $sDashboardFile = utils::ReadParam('file', '', false, 'raw_data');",
                "// Line 1199:             $sReloadURL = utils::ReadParam('reload_url', '', false, 'url');",
                "// Line 1200:             $oDashboard = RuntimeDashboard::GetDashboard($sDashboardFile, $sDashboardId);",
                "// Line 1201:             $aResult = array('error' => '');",
                "// Line 1202:             if (!is_null($oDashboard))",
                "// Line 1203:             {",
                "// Line 1204:                 if (!empty($sReloadURL))",
                "// Line 1205:                 {",
                "// Line 1206:                     $oDashboard->SetReloadURL($sReloadURL);",
                "// Line 1207:                 }",
                "// Line 1208:                 $oDashboard->Render($oPage, false, $aExtraParams);",
                "// Line 1209:             }",
                "// Line 1210:             $oPage->add_ready_script(\"$('.dashboard_contents table.listResults').tableHover(); $('.dashboard_contents table.listResults').tablesorter( { widgets: ['myZebra', 'truncatedList']} );\");",
                "// Line 1211:             break;",
                "// Line 1212: ",
                "// Line 1213:         case 'reload_dashboard':",
                "// Line 1214:             $oPage->SetContentType('text/html');",
                "// Line 1215:             $sDashboardId = utils::ReadParam('dashboard_id', '', false, 'raw_data');",
                "// vulnerable line: 1216: $aExtraParams = utils::ReadParam('extra_params', array(), false, 'raw_data');",
                "// Line 1217:             $sDashboardFile = utils::ReadParam('file', '', false, 'raw_data');",
                "// Line 1218:             $sReloadURL = utils::ReadParam('reload_url', '', false, 'url');",
                "// Line 1219:             $oDashboard = RuntimeDashboard::GetDashboard($sDashboardFile, $sDashboardId);",
                "// Line 1220:             $aResult = array('error' => '');",
                "// Line 1221:             if (!is_null($oDashboard))",
                "// Line 1222:             {",
                "// Line 1223:                 if (!empty($sReloadURL))",
                "// Line 1224:                 {",
                "// Line 1225:                     $oDashboard->SetReloadURL($sReloadURL);",
                "// Line 1226:                 }",
                "// Line 1227:                 $oDashboard->Render($oPage, false, $aExtraParams);",
                "// Line 1228:             }",
                "// Line 1229:             $oPage->add_ready_script(\"$('.dashboard_contents table.listResults').tableHover(); $('.dashboard_contents table.listResults').tablesorter( { widgets: ['myZebra', 'truncatedList']} );\");",
                "// Line 1230:             break;",
                "// Line 1231: ",
                "// Line 1232:         case 'save_dashboard':",
                "// Line 1233:             $sDashboardId = utils::ReadParam('dashboard_id', '', false, 'context_param');",
                "// vulnerable line: 1234: $aExtraParams = utils::ReadParam('extra_params', array(), false, 'raw_data');",
                "// Line 1235:             $sReloadURL = utils::ReadParam('reload_url', '', false, 'url');",
                "// Line 1236:             $sJSExtraParams = json_encode($aExtraParams);",
                "// Line 1237:             $aParams = array();",
                "// Line 1238:             $aParams['layout_class'] = utils::ReadParam('layout_class', '');",
                "// Line 1239:             $aParams['title'] = utils::ReadParam('title', '', false, 'raw_data');",
                "// Line 1240:             $aParams['auto_reload'] = utils::ReadParam('auto_reload', false);",
                "// Line 1241:             $aParams['auto_reload_sec'] = utils::ReadParam('auto_reload_sec', 300);",
                "// Line 1242:             $aParams['cells'] = utils::ReadParam('cells', array(), false, 'raw_data');",
                "// Line 1243: ",
                "// Line 1244:             $oDashboard = new RuntimeDashboard($sDashboardId);",
                "// Line 1281:                  $('.dashboard_contents#$sDivId').html(data);",
                "// Line 1282:                  $('.dashboard_contents#$sDivId').unblock();",
                "// Line 1283:                 }",
                "// Line 1284:              );",
                "// Line 1285: EOF",
                "// Line 1286:             );",
                "// Line 1287:             break;",
                "// Line 1288: ",
                "// Line 1289:         case 'render_dashboard':",
                "// Line 1290:             $sDashboardId = utils::ReadParam('dashboard_id', '', false, 'raw_data');",
                "// vulnerable line: 1291: $aExtraParams = utils::ReadParam('extra_params', array(), false, 'raw_data');",
                "// Line 1292:             $aParams = array();",
                "// Line 1293:             $aParams['layout_class'] = utils::ReadParam('layout_class', '');",
                "// Line 1294:             $aParams['title'] = utils::ReadParam('title', '', false, 'raw_data');",
                "// Line 1295:             $aParams['cells'] = utils::ReadParam('cells', array(), false, 'raw_data');",
                "// Line 1296:             $aParams['auto_reload'] = utils::ReadParam('auto_reload', false);",
                "// Line 1297:             $aParams['auto_reload_sec'] = utils::ReadParam('auto_reload_sec', 300);",
                "// Line 1298:             $sReloadURL = utils::ReadParam('reload_url', '', false, 'url');",
                "// Line 1299:             $oKPI = new ExecutionKPI();",
                "// Line 1300:             $oDashboard = new RuntimeDashboard($sDashboardId);",
                "// Line 1301:             $oDashboard->FromParams($aParams);",
                "// Line 1302:             $oDashboard->SetReloadURL($sReloadURL);",
                "// Line 1303:             $oDashboard->Render($oPage, true /* bEditMode */, $aExtraParams);",
                "// Line 1304:             $oKPI->ComputeAndReport('Data fetch and format');",
                "// Line 1305:             break;",
                "// Line 1306: ",
                "// Line 1307:         case 'dashboard_editor':",
                "// Line 1308:             $sId = utils::ReadParam('id', '', false, 'context_param');",
                "// vulnerable line: 1309: $aExtraParams = utils::ReadParam('extra_params', array(), false, 'raw_data');",
                "// Line 1310:             $aExtraParams['dashboard_div_id'] = utils::Sanitize($sId, '', 'element_identifier');",
                "// Line 1311:             $sDashboardFile = utils::ReadParam('file', '', false, 'string');",
                "// Line 1312:             $sReloadURL = utils::ReadParam('reload_url', '', false, 'url');",
                "// Line 1313:             $oKPI = new ExecutionKPI();",
                "// Line 1314:             $oDashboard = RuntimeDashboard::GetDashboard($sDashboardFile, $sId);",
                "// Line 1315:             if (!is_null($oDashboard))",
                "// Line 1316:             {",
                "// Line 1317:                 if (!empty($sReloadURL))",
                "// Line 1318:                 {",
                "// Line 1319:                     $oDashboard->SetReloadURL($sReloadURL);",
                "// Line 1320:                 }",
                "// Line 1321:                 $oDashboard->RenderEditor($oPage, $aExtraParams);",
                "// Line 1322:             }",
                "// Line 1323:             $oKPI->ComputeAndReport('Data fetch and format');",
                "// Line 1324:             break;",
                "// Line 1325: ",
                "// Line 1326:         case 'new_dashlet_id':",
                "// Line 1327:             $sDashboardDivId = utils::ReadParam(\"dashboardid\");",
                "// Line 1328:             $bIsCustomized = true; // Only called at runtime when customizing a dashboard",
                "// vulnerable line: 1329: $iRow = utils::ReadParam(\"iRow\");",
                "// vulnerable line: 1330: $iCol = utils::ReadParam(\"iCol\");",
                "// vulnerable line: 1331: $sDashletIdOrig = utils::ReadParam(\"dashletid\");",
                "// Line 1332:             $sFinalDashletId = Dashboard::GetDashletUniqueId($bIsCustomized, $sDashboardDivId, $iRow, $iCol, $sDashletIdOrig);",
                "// Line 1333:             $oPage = new ajax_page('');",
                "// Line 1334:             $oPage->add($sFinalDashletId);",
                "// Line 1335:             break;",
                "// Line 1336: ",
                "// Line 1337:         case 'new_dashlet':",
                "// Line 1338:             require_once(APPROOT.'application/forms.class.inc.php');",
                "// Line 1339:             require_once(APPROOT.'application/dashlet.class.inc.php');",
                "// vulnerable line: 1340: $sDashletClass = utils::ReadParam('dashlet_class', '');",
                "// vulnerable line: 1341: $sDashletId = utils::ReadParam('dashlet_id', '', false, 'raw_data');",
                "// Line 1342:             if (is_subclass_of($sDashletClass, 'Dashlet'))",
                "// Line 1343:             {",
                "// Line 1344:                 $oDashlet = new $sDashletClass(new ModelReflectionRuntime(), $sDashletId);",
                "// Line 1345:                 $offset = $oPage->start_capture();",
                "// Line 1346:                 $oDashlet->DoRender($oPage, true /* bEditMode */, false /* bEnclosingDiv */);",
                "// Line 1347:                 $sHtml = addslashes($oPage->end_capture($offset));",
                "// Line 1348:                 $sHtml = str_replace(\"",
                "// Line 1349: \", '', $sHtml);",
                "// Line 1350:                 $sHtml = str_replace(\"",
                "// Line 1351: \", '', $sHtml);",
                "// Line 1358: \", '', $sHtml);",
                "// Line 1359:                 $sHtml = str_replace(\"",
                "// Line 1360: \", '', $sHtml);",
                "// Line 1361:                 $oPage->add_script(\"$('#dashlet_properties_$sDashletId').html('$sHtml')\"); // in ajax web page add_script has the same effect as add_ready_script                                                                       // but is executed BEFORE all 'ready_scripts'",
                "// Line 1362:             }",
                "// Line 1363:             break;",
                "// Line 1364: ",
                "// Line 1365:         case 'update_dashlet_property':",
                "// Line 1366:             require_once(APPROOT.'application/forms.class.inc.php');",
                "// Line 1367:             require_once(APPROOT.'application/dashlet.class.inc.php');",
                "// vulnerable line: 1368: $aExtraParams = utils::ReadParam('extra_params', array(), false, 'raw_data');",
                "// vulnerable line: 1369: $aParams = utils::ReadParam('params', '', false, 'raw_data');",
                "// vulnerable line: 1370: $sDashletClass = $aParams['attr_dashlet_class'];",
                "// vulnerable line: 1371: $sDashletType = $aParams['attr_dashlet_type'];",
                "// vulnerable line: 1372: $sDashletId = utils::HtmlEntities($aParams['attr_dashlet_id']);",
                "// vulnerable line: 1373: $aUpdatedProperties = $aParams['updated']; // Code of the changed properties as an array: 'attr_xxx', 'attr_xxy', etc...",
                "// vulnerable line: 1374: $aPreviousValues = $aParams['previous_values']; // hash array: 'attr_xxx' => 'old_value'",
                "// Line 1375:             if (is_subclass_of($sDashletClass, 'Dashlet'))",
                "// Line 1376:             {",
                "// Line 1377:                 /** @var \\Dashlet $oDashlet */",
                "// Line 1378:                 $oDashlet = new $sDashletClass(new ModelReflectionRuntime(), $sDashletId);",
                "// Line 1379:                 $oDashlet->SetDashletType($sDashletType);",
                "// Line 1380:                 $oForm = $oDashlet->GetForm();",
                "// Line 1381:                 $aValues = $oForm->ReadParams(); // hash array: 'xxx' => 'new_value'",
                "// Line 1382: ",
                "// Line 1383:                 $aCurrentValues = $aValues;",
                "// Line 1384:                 $aUpdatedDecoded = array();"
            ]
        },
        {
            "filename_of_changes": "utils.inc.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "17",
            "number_of_lines_deleted_vulnerable_to_cve": "0",
            "Code_with_highlighted_vulnerability_lines": []
        }
    ]
}