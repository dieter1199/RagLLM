{
    "cve_id": "CVE-2024-31820",
    "cve_description": "An issue in Ecommerce-CodeIgniter-Bootstrap commit v. d22b54e8915f167a135046ceb857caaf8479c4da allows a remote attacker to execute arbitrary code via the getLangFolderForEdit method of the Languages.php component.",
    "cve_publish_date": "2024-04-29T18:15Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "Vulnerability fixes from Lion Tree",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "Languages.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "24",
            "number_of_lines_deleted_vulnerable_to_cve": "3",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 123:             $prevFile = $jsFile;",
                "// Line 124:             $i++;",
                "// Line 125:         }",
                "// Line 126:         $jsFileInclude .= \"};\";",
                "// Line 127:         savefile($jsFile, $jsFileInclude);",
                "// Line 128:     }",
                "// Line 129: ",
                "// Line 130:     private function getLangFolderForEdit()",
                "// Line 131:     {",
                "// Line 132:         $langFiles = array();",
                "// vulnerable line: 133: $files = rreadDir('application' . DIRECTORY_SEPARATOR . 'language' . DIRECTORY_SEPARATOR . '' . $_GET['editLang'] . DIRECTORY_SEPARATOR);",
                "// Line 134:         $arrPhpFiles = $arrJsFiles = array();",
                "// Line 135:         foreach ($files as $ext => $filesLang) {",
                "// Line 136:             foreach ($filesLang as $fileLang) {",
                "// Line 137:                 if ($ext == 'php') {",
                "// Line 138:                     require $fileLang;",
                "// Line 139:                     if (isset($lang)) {",
                "// Line 140:                         $arrPhpFiles[$fileLang] = $lang;",
                "// Line 141:                         unset($lang);",
                "// Line 142:                     }",
                "// Line 143:                 }"
            ]
        },
        {
            "filename_of_changes": "Orders_model.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "6",
            "number_of_lines_deleted_vulnerable_to_cve": "2",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 72:             $operator = '-';",
                "// Line 73:             $operator_pro = '+';",
                "// Line 74:         }",
                "// Line 75:         $this->db->select('products');",
                "// Line 76:         $this->db->where('id', $id);",
                "// Line 77:         $result = $this->db->get('orders');",
                "// Line 78:         $arr = $result->row_array();",
                "// Line 79:         $products = unserialize($arr['products']);",
                "// Line 80:         foreach ($products as $product) {",
                "// Line 81:                 if (isset($operator)) {",
                "// vulnerable line: 82: if (!$this->db->query('UPDATE products SET quantity=quantity' . $operator . $product['product_quantity'] . ' WHERE id = ' . $product['product_info']['id'])) {",
                "// Line 83:                         log_message('error', print_r($this->db->error(), true));",
                "// Line 84:                         show_error(lang('database_error'));",
                "// Line 85:                     }",
                "// Line 86:                 }",
                "// Line 87:                 if (isset($operator_pro)) {",
                "// vulnerable line: 88: if (!$this->db->query('UPDATE products SET procurement=procurement' . $operator_pro . $product['product_quantity'] . ' WHERE id = ' . $product['product_info']['id'])) {",
                "// Line 89:                         log_message('error', print_r($this->db->error(), true));",
                "// Line 90:                         show_error(lang('database_error'));",
                "// Line 91:                     }",
                "// Line 92:                 } ",
                "// Line 93:         }",
                "// Line 94:     }",
                "// Line 95: ",
                "// Line 96:     public function setBankAccountSettings($post)",
                "// Line 97:     {",
                "// Line 98:         $query = $this->db->query('SELECT id FROM bank_accounts');"
            ]
        },
        {
            "filename_of_changes": "Publish.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "9",
            "number_of_lines_deleted_vulnerable_to_cve": "6",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 2: ",
                "// Line 3: /*",
                "// Line 4:  * @Author:    Kiril Kirkov",
                "// Line 5:  *  Gitgub:    https://github.com/kirilkirkov",
                "// Line 6:  */",
                "// Line 7: if (!defined('BASEPATH')) {",
                "// Line 8:     exit('No direct script access allowed');",
                "// Line 9: }",
                "// Line 10: ",
                "// Line 11: class Publish extends ADMIN_Controller",
                "// vulnerable line: 12: {",
                "// Line 13: ",
                "// Line 14:     public function __construct()",
                "// vulnerable line: 15: {",
                "// Line 16:         parent::__construct();",
                "// Line 17:         $this->load->model(array(",
                "// Line 18:             'Products_model',",
                "// Line 19:             'Languages_model',",
                "// Line 20:             'Brands_model',",
                "// Line 21:             'Categories_model'",
                "// Line 22:         ));",
                "// Line 23:     }",
                "// Line 24: ",
                "// Line 25:     public function index($id = 0)",
                "// vulnerable line: 26: {",
                "// Line 27:         $this->login_check();",
                "// Line 28:         $is_update = false;",
                "// Line 29:         $trans_load = null;",
                "// Line 30:         if ($id > 0 && $_POST == null) {",
                "// Line 31:             $_POST = $this->Products_model->getOneProduct($id);",
                "// Line 32:             $trans_load = $this->Products_model->getTranslations($id);",
                "// Line 33:         }",
                "// Line 34:         if (isset($_POST['submit'])) {",
                "// Line 35:             if (isset($_GET['to_lang'])) {",
                "// Line 36:                 $id = 0;",
                "// Line 64:         $data['shop_categories'] = $this->Categories_model->getShopCategories();",
                "// Line 65:         $data['brands'] = $this->Brands_model->getBrands();",
                "// Line 66:         $data['otherImgs'] = $this->loadOthersImages();",
                "// Line 67:         $this->load->view('_parts/header', $head);",
                "// Line 68:         $this->load->view('ecommerce/publish', $data);",
                "// Line 69:         $this->load->view('_parts/footer');",
                "// Line 70:         $this->saveHistory('Go to publish product');",
                "// Line 71:     }",
                "// Line 72: ",
                "// Line 73:     private function uploadImage()",
                "// vulnerable line: 74: {",
                "// Line 75:         $config['upload_path'] = './attachments/shop_images/';",
                "// Line 76:         $config['allowed_types'] = $this->allowed_img_types;",
                "// Line 77:         $this->load->library('upload', $config);",
                "// Line 78:         $this->upload->initialize($config);",
                "// Line 79:         if (!$this->upload->do_upload('userfile')) {",
                "// Line 80:             log_message('error', 'Image Upload Error: ' . $this->upload->display_errors());",
                "// Line 81:         }",
                "// Line 82:         $img = $this->upload->data();",
                "// Line 83:         return $img['file_name'];",
                "// Line 84:     }",
                "// Line 85: ",
                "// Line 86:     /*",
                "// Line 87:      * called from ajax",
                "// Line 88:      */",
                "// Line 89: ",
                "// Line 90:     public function do_upload_others_images()",
                "// vulnerable line: 91: {",
                "// Line 92:         if ($this->input->is_ajax_request()) {",
                "// Line 93:             $upath = '.' . DIRECTORY_SEPARATOR . 'attachments' . DIRECTORY_SEPARATOR . 'shop_images' . DIRECTORY_SEPARATOR . $_POST['folder'] . DIRECTORY_SEPARATOR;",
                "// Line 94:             if (!file_exists($upath)) {",
                "// Line 95:                 mkdir($upath, 0777);",
                "// Line 96:             }",
                "// Line 97: ",
                "// Line 98:             $this->load->library('upload');",
                "// Line 99: ",
                "// Line 100:             $files = $_FILES;",
                "// Line 101:             $cpt = count($_FILES['others']['name']);",
                "// Line 110:                 $this->upload->initialize(array(",
                "// Line 111:                     'upload_path' => $upath,",
                "// Line 112:                     'allowed_types' => $this->allowed_img_types",
                "// Line 113:                 ));",
                "// Line 114:                 $this->upload->do_upload('others');",
                "// Line 115:             }",
                "// Line 116:         }",
                "// Line 117:     }",
                "// Line 118: ",
                "// Line 119:     public function loadOthersImages()",
                "// vulnerable line: 120: {",
                "// Line 121:         $output = '';",
                "// Line 122:         if (isset($_POST['folder']) && $_POST['folder'] != null) {",
                "// Line 123:             $dir = 'attachments' . DIRECTORY_SEPARATOR . 'shop_images' . DIRECTORY_SEPARATOR . $_POST['folder'] . DIRECTORY_SEPARATOR;",
                "// Line 124:             if (is_dir($dir)) {",
                "// Line 125:                 if ($dh = opendir($dir)) {",
                "// Line 126:                     $i = 0;",
                "// Line 127:                     while (($file = readdir($dh)) !== false) {",
                "// Line 128:                         if (is_file($dir . $file)) {",
                "// Line 129:                             $output .= '",
                "// Line 130:                                 <div class=\"other-img\" id=\"image-container-' . $i . '\">",
                "// Line 145:             echo $output;",
                "// Line 146:         } else {",
                "// Line 147:             return $output;",
                "// Line 148:         }",
                "// Line 149:     }",
                "// Line 150: ",
                "// Line 151:     /*",
                "// Line 152:      * called from ajax",
                "// Line 153:      */",
                "// Line 154: ",
                "// vulnerable line: 155: public function removeSecondaryImage()",
                "// vulnerable line: 156: {",
                "// Line 157:         if ($this->input->is_ajax_request()) {",
                "// vulnerable line: 158: $img = '.' . DIRECTORY_SEPARATOR . 'attachments' . DIRECTORY_SEPARATOR . 'shop_images' . DIRECTORY_SEPARATOR . '' . $_POST['folder'] . DIRECTORY_SEPARATOR . $_POST['image'];",
                "// vulnerable line: 159: unlink($img);",
                "// Line 160:         }",
                "// Line 161:     }",
                "// Line 162: ",
                "// Line 163: }"
            ]
        }
    ]
}