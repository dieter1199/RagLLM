{
    "cve_id": "CVE-2024-25410",
    "cve_description": "flusity-CMS 2.33 is vulnerable to Unrestricted Upload of File with Dangerous Type in update_setting.php.",
    "cve_publish_date": "2024-02-26T16:27Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "Update update_setting.php\n\nSigned-off-by: Darius Jakaitis <105962203+flusity@users.noreply.github.com>",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "update_setting.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "22",
            "number_of_lines_deleted_vulnerable_to_cve": "25",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 1: <?php",
                "// Line 2: ",
                "// Line 3: if (session_status() !== PHP_SESSION_ACTIVE) {",
                "// Line 4:     session_start();",
                "// vulnerable line: 5: }",
                "// Line 6: ",
                "// Line 7: define('IS_ADMIN', true);",
                "// Line 8: $configurations = require $_SERVER['DOCUMENT_ROOT'] . '/security/config.php';",
                "// Line 9: require_once $_SERVER['DOCUMENT_ROOT'] . '/core/functions/functions.php';",
                "// Line 10: ",
                "// vulnerable line: 11: require_once $_SERVER['DOCUMENT_ROOT'] . '/security/config.php';",
                "// Line 12: require_once $_SERVER['DOCUMENT_ROOT'] . '/core/functions/functions.php';",
                "// Line 13: define('ROOT_PATH', $_SERVER['DOCUMENT_ROOT'] . '/');",
                "// Line 14: ",
                "// Line 15: $config = $configurations['config'];",
                "// Line 16: $prefix = $configurations['prefix'];",
                "// Line 17: ",
                "// vulnerable line: 18: $db = getDBConnection($config);",
                "// Line 19: secureSession($db, $prefix);",
                "// Line 20: $language_code = getLanguageSetting($db, $prefix);",
                "// Line 21: $translations = getTranslations($db, $prefix, $language_code);",
                "// Line 22: ",
                "// Line 23: $result = ['error_message' => false];",
                "// Line 24: $updateResult = ['error_message' => false];",
                "// Line 25: ",
                "// vulnerable line: 26: if (isset($_POST['site_title'], $_POST['meta_description'], $_POST['footer_text'], $_POST['pretty_url'], $_POST['bilingualism'], $_POST['language'],",
                "// vulnerable line: 27: $_POST['posts_per_page'], $_POST['registration_enabled'], $_POST['session_lifetime'], $_POST['default_keywords'])) { ",
                "// Line 28: ",
                "// Line 29:     $allowed_file_types = ['image/png', 'image/jpeg', 'image/gif'];",
                "// vulnerable line: 30: $target_dir = ROOT_PATH. \"/uploads/\";",
                "// Line 31:     $max_file_size = 100 * 1024; // Maximum file size (100KB)",
                "// Line 32:     $brand_icone = null; // Initialize this variable before if condition",
                "// Line 33: ",
                "// Line 34:     if (isset($_FILES[\"brand_icone\"]) && $_FILES[\"brand_icone\"][\"size\"] > 0) {",
                "// Line 35:         $uploaded_file = $_FILES[\"brand_icone\"];",
                "// vulnerable line: 36: $unique_code = bin2hex(random_bytes(8));",
                "// Line 37:         $filename_parts = pathinfo($uploaded_file[\"name\"]);",
                "// vulnerable line: 38: $new_filename = $filename_parts['filename'] . '_' . $unique_code . '.' . $filename_parts['extension'];",
                "// vulnerable line: 39: $target_file = $target_dir . basename($new_filename);",
                "// vulnerable line: 40: $brand_icone = $new_filename; // Use the new filename",
                "// Line 41: ",
                "// vulnerable line: 42: if (!in_array($uploaded_file['type'], $allowed_file_types)) {",
                "// vulnerable line: 43: $_SESSION['error_message'] = t(\"Invalid file type.\");",
                "// Line 44: ",
                "// vulnerable line: 45: } ",
                "// Line 46: ",
                "// vulnerable line: 47: if ($uploaded_file['size'] > $max_file_size) {",
                "// Line 48:             $_SESSION['error_message'] = t(\"File size exceeded limit.\");",
                "// Line 49: ",
                "// vulnerable line: 50: } ",
                "// Line 51: ",
                "// vulnerable line: 52: if (move_uploaded_file($uploaded_file[\"tmp_name\"], $target_file)) {",
                "// vulnerable line: 53: $file_url = $_SERVER['REQUEST_SCHEME'] . \"://\" . $_SERVER['HTTP_HOST'] . \"/uploads/\" . $new_filename;",
                "// vulnerable line: 54: saveFileToDatabase($db, $prefix, $new_filename, $file_url);",
                "// vulnerable line: 55: $_SESSION['success_message'] = \"File\" .\" \". basename($uploaded_file[\"name\"]) . \" \" .t(\"file uploaded successfully.\");",
                "// Line 56:         } else {",
                "// vulnerable line: 57: $_SESSION['error_message'] = t(\"Error loading file.\");",
                "// Line 58: ",
                "// vulnerable line: 59: }",
                "// Line 60:     } elseif (isset($_POST['brand_icone_id']) && !empty($_POST['brand_icone_id'])) {",
                "// Line 61:         // Fetch the file using its id",
                "// Line 62:         $file = getFileById($db, $prefix, $_POST['brand_icone_id']);",
                "// Line 63:         $brand_icone = $file['name'];",
                "// vulnerable line: 64: }",
                "// Line 65: ",
                "// Line 66:     $site_title = $_POST['site_title'];",
                "// Line 67:     $meta_description = $_POST['meta_description'];",
                "// Line 68:     $footer_text_settings = $_POST['footer_text'];",
                "// Line 69:     $pretty_url = $_POST['pretty_url']; ",
                "// Line 70:     $bilingualism = $_POST['bilingualism'];",
                "// Line 71:     //$pretty_url = isset($_POST['pretty_url']) ? 1 : 0;",
                "// Line 72:     $registration_enabled = $_POST['registration_enabled'];",
                "// Line 73:    // $registration_enabled = isset($_POST['registration_enabled']) ? 1 : 0;",
                "// Line 74: ",
                "// Line 80:     $session_life =  $session_lifetime;",
                "// Line 81: ",
                "// Line 82:     $updateResult = updateSettings($db, $prefix, $site_title, $meta_description, $footer_text_settings, $pretty_url, $bilingualism, $language, $posts_per_page, $registration_enabled, $session_life, $default_keywords, $brand_icone); ",
                "// Line 83: ",
                "// Line 84:     if ($updateResult) {",
                "// Line 85:         $_SESSION['success_message'] =  t('Settings successfully updated.');",
                "// Line 86: ",
                "// Line 87:     } else {",
                "// Line 88:         $_SESSION['error_message'] = t('Error updating settings. Try again.');",
                "// Line 89: ",
                "// vulnerable line: 90: }",
                "// vulnerable line: 91: }",
                "// Line 92: ",
                "// Line 93: echo json_encode($updateResult); ",
                "// Line 94: ",
                "// vulnerable line: 95: ?>"
            ]
        }
    ]
}