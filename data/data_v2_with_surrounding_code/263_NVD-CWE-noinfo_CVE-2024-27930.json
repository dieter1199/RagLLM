{
    "cve_id": "CVE-2024-27930",
    "cve_description": "GLPI is a Free Asset and IT Management Software package, Data center management, ITIL Service Desk, licenses tracking and software auditing. An authenticated user can access sensitive fields data from items on which he has read access. This issue has been patched in version 10.0.13.",
    "cve_publish_date": "2024-03-18T16:15Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "Merge pull request from GHSA-82vv-j9pr-qmwq\n\n* Check `displaywith` and `condition` in IDOR tokens\n\n* Restrict AJAX endpoints to central interface\n\n* Better filtering of sensitive fields",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "Session.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "21",
            "number_of_lines_deleted_vulnerable_to_cve": "2",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 1632: ",
                "// Line 1633:             Html::displayErrorAndDie($message, true);",
                "// Line 1634:         }",
                "// Line 1635:     }",
                "// Line 1636: ",
                "// Line 1637: ",
                "// Line 1638:     /**",
                "// Line 1639:      * Get new IDOR token",
                "// Line 1640:      * This token validates the itemtype used by an ajax request is the one asked by a dropdown.",
                "// Line 1641:      * So, we avoid IDOR request where an attacker asks for an another itemtype",
                "// vulnerable line: 1642: * than the originaly indtended",
                "// Line 1643:      *",
                "// Line 1644:      * @since 9.5.3",
                "// Line 1645:      *",
                "// Line 1646:      * @param string $itemtype",
                "// Line 1647:      * @param array  $add_params more criteria to check validy of idor tokens",
                "// Line 1648:      *",
                "// Line 1649:      * @return string",
                "// Line 1650:      **/",
                "// Line 1651:     public static function getNewIDORToken(string $itemtype = \"\", array $add_params = []): string",
                "// Line 1652:     {",
                "// Line 1690: ",
                "// Line 1691:         $token = $data['_idor_token'];",
                "// Line 1692: ",
                "// Line 1693:         if (",
                "// Line 1694:             isset($_SESSION['glpiidortokens'][$token])",
                "// Line 1695:             && $_SESSION['glpiidortokens'][$token]['expires'] >= time()",
                "// Line 1696:         ) {",
                "// Line 1697:             $idor_data =  $_SESSION['glpiidortokens'][$token];",
                "// Line 1698:             unset($idor_data['expires']);",
                "// Line 1699: ",
                "// vulnerable line: 1700: // check all stored data for the idor token are present (and identifical) in the posted data",
                "// Line 1701:             $match_expected = function ($expected, $given) use (&$match_expected) {",
                "// Line 1702:                 if (is_array($expected)) {",
                "// Line 1703:                     if (!is_array($given)) {",
                "// Line 1704:                         return false;",
                "// Line 1705:                     }",
                "// Line 1706:                     foreach ($expected as $key => $value) {",
                "// Line 1707:                         if (!array_key_exists($key, $given) || !$match_expected($value, $given[$key])) {",
                "// Line 1708:                             return false;",
                "// Line 1709:                         }",
                "// Line 1710:                     }"
            ]
        },
        {
            "filename_of_changes": "cable.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 36: use Glpi\\Socket;",
                "// Line 37: ",
                "// Line 38: /** @var array $CFG_GLPI */",
                "// Line 39: global $CFG_GLPI;",
                "// Line 40: ",
                "// Line 41: include('../inc/includes.php');",
                "// Line 42: ",
                "// Line 43: // Send UTF8 Headers",
                "// Line 44: header(\"Content-Type: text/html; charset=UTF-8\");",
                "// Line 45: Html::header_nocache();",
                "// vulnerable line: 46: Session::checkLoginUser();",
                "// Line 47: ",
                "// Line 48: $action = $_POST['action'] ?? $_GET[\"action\"];",
                "// Line 49: ",
                "// Line 50: switch ($action) {",
                "// Line 51:     case 'get_items_from_itemtype':",
                "// Line 52:         if ($_POST['itemtype'] && class_exists($_POST['itemtype'])) {",
                "// Line 53:             $_POST['itemtype']::dropdown(['name'                => $_POST['dom_name'],",
                "// Line 54:                 'rand'                => $_POST['dom_rand'],",
                "// Line 55:                 'display_emptychoice' => true,",
                "// Line 56:                 'display_dc_position' => in_array($_POST['itemtype'], $CFG_GLPI['rackable_types']),"
            ]
        },
        {
            "filename_of_changes": "dropdownAllItems.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "11",
            "number_of_lines_deleted_vulnerable_to_cve": "5",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 49:     $link = \"getDropdownValue.php\";",
                "// Line 50: ",
                "// Line 51:     if ($_POST[\"idtable\"] == 'User') {",
                "// Line 52:         $link = \"getDropdownUsers.php\";",
                "// Line 53:     }",
                "// Line 54: ",
                "// Line 55:     $rand = $_POST['rand'] ?? mt_rand();",
                "// Line 56: ",
                "// Line 57:     $field_id = Html::cleanId(\"dropdown_\" . $_POST[\"name\"] . $rand);",
                "// Line 58: ",
                "// vulnerable line: 59: $p        = [",
                "// Line 60:         'value'               => 0,",
                "// Line 61:         'valuename'           => Dropdown::EMPTY_VALUE,",
                "// Line 62:         'itemtype'            => $_POST[\"idtable\"],",
                "// Line 63:         'display_emptychoice' => true,",
                "// vulnerable line: 64: 'displaywith'         => ['otherserial', 'serial'],",
                "// vulnerable line: 65: '_idor_token'         => Session::getNewIDORToken($_POST[\"idtable\"]),",
                "// Line 66:     ];",
                "// Line 67:     if (isset($_POST['value'])) {",
                "// Line 68:         $p['value'] = $_POST['value'];",
                "// Line 69:     }",
                "// Line 70:     if (isset($_POST['entity_restrict'])) {",
                "// vulnerable line: 71: $p['entity_restrict'] = $_POST['entity_restrict'];",
                "// Line 72:     }",
                "// Line 73:     if (isset($_POST['condition'])) {",
                "// vulnerable line: 74: $p['condition'] = $_POST['condition'];",
                "// Line 75:     }",
                "// Line 76:     if (isset($_POST['used'])) {",
                "// Line 77:         $_POST['used'] = Toolbox::jsonDecode($_POST['used'], true);",
                "// Line 78:     }",
                "// Line 79:     if (isset($_POST['used'][$_POST['idtable']])) {",
                "// Line 80:         $p['used'] = $_POST['used'][$_POST['idtable']];",
                "// Line 81:     }",
                "// Line 82:     if (isset($_POST['width'])) {",
                "// Line 83:         $p['width'] = $_POST['width'];",
                "// Line 84:     }"
            ]
        },
        {
            "filename_of_changes": "socket.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 32:  *",
                "// Line 33:  * ---------------------------------------------------------------------",
                "// Line 34:  */",
                "// Line 35: ",
                "// Line 36: include('../inc/includes.php');",
                "// Line 37: ",
                "// Line 38: // Send UTF8 Headers",
                "// Line 39: header(\"Content-Type: text/html; charset=UTF-8\");",
                "// Line 40: Html::header_nocache();",
                "// Line 41: ",
                "// vulnerable line: 42: Session::checkLoginUser();",
                "// Line 43: ",
                "// Line 44: switch ($_POST['action']) {",
                "// Line 45:     case 'getItemsFromItemtype':",
                "// Line 46:         if ($_POST['itemtype'] && class_exists($_POST['itemtype'])) {",
                "// Line 47:             $_POST['itemtype']::dropdown(['name'                => $_POST['dom_name'],",
                "// Line 48:                 'display_emptychoice' => true,",
                "// Line 49:                 'rand' => $_POST['dom_rand']",
                "// Line 50:             ]);",
                "// Line 51:         }",
                "// Line 52:         break;"
            ]
        },
        {
            "filename_of_changes": "visibility.php",
            "code_language": "PHP",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 37: global $CFG_GLPI;",
                "// Line 38: ",
                "// Line 39: // Direct access to file",
                "// Line 40: if (strpos($_SERVER['PHP_SELF'], \"visibility.php\")) {",
                "// Line 41:     $AJAX_INCLUDE = 1;",
                "// Line 42:     include('../inc/includes.php');",
                "// Line 43:     header(\"Content-Type: text/html; charset=UTF-8\");",
                "// Line 44:     Html::header_nocache();",
                "// Line 45: }",
                "// Line 46: ",
                "// vulnerable line: 47: Session::checkLoginUser();",
                "// Line 48: ",
                "// Line 49: if (",
                "// Line 50:     isset($_POST['type']) && !empty($_POST['type'])",
                "// Line 51:     && isset($_POST['right'])",
                "// Line 52: ) {",
                "// Line 53:     $display = false;",
                "// Line 54:     $rand    = mt_rand();",
                "// Line 55:     $prefix = '';",
                "// Line 56:     $suffix = '';",
                "// Line 57:     if (isset($_POST['prefix']) && !empty($_POST['prefix'])) {"
            ]
        }
    ]
}