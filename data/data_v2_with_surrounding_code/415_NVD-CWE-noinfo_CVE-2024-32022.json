{
    "cve_id": "CVE-2024-32022",
    "cve_description": "Kohya_ss is a GUI for Kohya's Stable Diffusion trainers. Kohya_ss  is vulnerable to command injection in basic_caption_gui.py. This vulnerability is fixed in 23.1.5.",
    "cve_publish_date": "2024-04-16T15:15Z",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "Remove shell=True from scripts (#2257)\n\n* Remove shell=True from scripts",
    "type_of_change": "Modification",
    "changes": [
        {
            "filename_of_changes": "basic_caption_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 76:         # Log the command",
                "// Line 77:         log.info(run_cmd)",
                "// Line 78: ",
                "// Line 79:         # Set the environment variable for the Python path",
                "// Line 80:         env = os.environ.copy()",
                "// Line 81:         env[\"PYTHONPATH\"] = (",
                "// Line 82:             rf\"{scriptdir}{os.pathsep}{scriptdir}/tools{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 83:         )",
                "// Line 84: ",
                "// Line 85:         # Run the command based on the operating system",
                "// vulnerable line: 86: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 87: ",
                "// Line 88:     # Check if overwrite option is enabled",
                "// Line 89:     if overwrite:",
                "// Line 90:         # Add prefix and postfix to caption files",
                "// Line 91:         if prefix or postfix:",
                "// Line 92:             add_pre_postfix(",
                "// Line 93:                 folder=images_dir,",
                "// Line 94:                 caption_file_ext=caption_ext,",
                "// Line 95:                 prefix=prefix,",
                "// Line 96:                 postfix=postfix,"
            ]
        },
        {
            "filename_of_changes": "blip_caption_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 72: ",
                "// Line 73:     log.info(run_cmd)",
                "// Line 74: ",
                "// Line 75:     # Set up the environment",
                "// Line 76:     env = os.environ.copy()",
                "// Line 77:     env[\"PYTHONPATH\"] = (",
                "// Line 78:         f\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 79:     )",
                "// Line 80: ",
                "// Line 81:     # Run the command in the sd-scripts folder context",
                "// vulnerable line: 82: subprocess.run(run_cmd, shell=True, env=env, cwd=f\"{scriptdir}/sd-scripts\")",
                "// Line 83: ",
                "// Line 84:     # Add prefix and postfix",
                "// Line 85:     add_pre_postfix(",
                "// Line 86:         folder=train_data_dir,",
                "// Line 87:         caption_file_ext=caption_file_ext,",
                "// Line 88:         prefix=prefix,",
                "// Line 89:         postfix=postfix,",
                "// Line 90:     )",
                "// Line 91: ",
                "// Line 92:     log.info(\"...captioning done\")"
            ]
        },
        {
            "filename_of_changes": "class_command_executor.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 21:         \"\"\"",
                "// Line 22:         Execute a command if no other command is currently running.",
                "// Line 23: ",
                "// Line 24:         Parameters:",
                "// Line 25:         - run_cmd (str): The command to execute.",
                "// Line 26:         - **kwargs: Additional keyword arguments to pass to subprocess.Popen.",
                "// Line 27:         \"\"\"",
                "// Line 28:         if self.process and self.process.poll() is None:",
                "// Line 29:             log.info(\"The command is already running. Please wait for it to finish.\")",
                "// Line 30:         else:",
                "// vulnerable line: 31: self.process = subprocess.Popen(run_cmd, shell=True, **kwargs)",
                "// Line 32: ",
                "// Line 33:     def kill_command(self):",
                "// Line 34:         \"\"\"",
                "// Line 35:         Kill the currently running command and its child processes.",
                "// Line 36:         \"\"\"",
                "// Line 37:         if self.process and self.process.poll() is None:",
                "// Line 38:             try:",
                "// Line 39:                 # Get the parent process and kill all its children",
                "// Line 40:                 parent = psutil.Process(self.process.pid)",
                "// Line 41:                 for child in parent.children(recursive=True):"
            ]
        },
        {
            "filename_of_changes": "convert_lcm_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 52:         run_cmd += f\" --ssd-1b\"",
                "// Line 53: ",
                "// Line 54:     log.info(run_cmd)",
                "// Line 55: ",
                "// Line 56:     env = os.environ.copy()",
                "// Line 57:     env[\"PYTHONPATH\"] = (",
                "// Line 58:         rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 59:     )",
                "// Line 60: ",
                "// Line 61:     # Run the command",
                "// vulnerable line: 62: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 63: ",
                "// Line 64:     # Return a success message",
                "// Line 65:     log.info(\"Done extracting...\")",
                "// Line 66: ",
                "// Line 67: ",
                "// Line 68: def gradio_convert_lcm_tab(headless=False):",
                "// Line 69:     current_model_dir = os.path.join(scriptdir, \"outputs\")",
                "// Line 70:     current_save_dir = os.path.join(scriptdir, \"outputs\")",
                "// Line 71: ",
                "// Line 72:     def list_models(path):"
            ]
        },
        {
            "filename_of_changes": "convert_model_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 97:         run_cmd += f' \"{target_model_path}\"'",
                "// Line 98: ",
                "// Line 99:     log.info(run_cmd)",
                "// Line 100: ",
                "// Line 101:     env = os.environ.copy()",
                "// Line 102:     env[\"PYTHONPATH\"] = (",
                "// Line 103:         rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 104:     )",
                "// Line 105: ",
                "// Line 106:     # Run the command",
                "// vulnerable line: 107: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 108: ",
                "// Line 109: ",
                "// Line 110: ###",
                "// Line 111: # Gradio UI",
                "// Line 112: ###",
                "// Line 113: ",
                "// Line 114: ",
                "// Line 115: def gradio_convert_model_tab(headless=False):",
                "// Line 116:     from .common_gui import create_refresh_button",
                "// Line 117: "
            ]
        },
        {
            "filename_of_changes": "extract_lora_from_dylora_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 57:     run_cmd += f\" --unit {unit}\"",
                "// Line 58: ",
                "// Line 59:     log.info(run_cmd)",
                "// Line 60: ",
                "// Line 61:     env = os.environ.copy()",
                "// Line 62:     env[\"PYTHONPATH\"] = (",
                "// Line 63:         rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 64:     )",
                "// Line 65: ",
                "// Line 66:     # Run the command",
                "// vulnerable line: 67: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 68: ",
                "// Line 69:     log.info(\"Done extracting DyLoRA...\")",
                "// Line 70: ",
                "// Line 71: ",
                "// Line 72: ###",
                "// Line 73: # Gradio UI",
                "// Line 74: ###",
                "// Line 75: ",
                "// Line 76: ",
                "// Line 77: def gradio_extract_dylora_tab(headless=False):"
            ]
        },
        {
            "filename_of_changes": "extract_lora_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 95:         run_cmd += f\" --load_tuned_model_to {load_tuned_model_to}\"",
                "// Line 96: ",
                "// Line 97:     log.info(run_cmd)",
                "// Line 98: ",
                "// Line 99:     env = os.environ.copy()",
                "// Line 100:     env[\"PYTHONPATH\"] = (",
                "// Line 101:         rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 102:     )",
                "// Line 103: ",
                "// Line 104:     # Run the command",
                "// vulnerable line: 105: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 106: ",
                "// Line 107: ",
                "// Line 108: ###",
                "// Line 109: # Gradio UI",
                "// Line 110: ###",
                "// Line 111: ",
                "// Line 112: ",
                "// Line 113: def gradio_extract_lora_tab(headless=False):",
                "// Line 114:     current_model_dir = os.path.join(scriptdir, \"outputs\")",
                "// Line 115:     current_model_org_dir = os.path.join(scriptdir, \"outputs\")"
            ]
        },
        {
            "filename_of_changes": "extract_lycoris_locon_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 103:     run_cmd += rf' \"{output_name}\"'",
                "// Line 104: ",
                "// Line 105:     log.info(run_cmd)",
                "// Line 106: ",
                "// Line 107:     env = os.environ.copy()",
                "// Line 108:     env[\"PYTHONPATH\"] = (",
                "// Line 109:         rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 110:     )",
                "// Line 111: ",
                "// Line 112:     # Run the command",
                "// vulnerable line: 113: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 114: ",
                "// Line 115:     log.info(\"Done extracting...\")",
                "// Line 116: ",
                "// Line 117: ",
                "// Line 118: ###",
                "// Line 119: # Gradio UI",
                "// Line 120: ###",
                "// Line 121: # def update_mode(mode):",
                "// Line 122: #     # 'fixed', 'threshold','ratio','quantile'",
                "// Line 123: #     if mode == 'fixed':"
            ]
        },
        {
            "filename_of_changes": "finetune_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "4",
            "number_of_lines_deleted_vulnerable_to_cve": "2",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 513: ",
                "// Line 514:             log.info(run_cmd)",
                "// Line 515: ",
                "// Line 516:             env = os.environ.copy()",
                "// Line 517:             env[\"PYTHONPATH\"] = (",
                "// Line 518:                 rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 519:             )",
                "// Line 520: ",
                "// Line 521:             if not print_only:",
                "// Line 522:                 # Run the command",
                "// vulnerable line: 523: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 524: ",
                "// Line 525:         # create images buckets",
                "// Line 526:         if generate_image_buckets:",
                "// Line 527:             run_cmd = rf'\"{PYTHON}\" \"{scriptdir}/sd-scripts/finetune/prepare_buckets_latents.py\"'",
                "// Line 528:             run_cmd += rf' \"{image_folder}\"'",
                "// Line 529:             run_cmd += rf' \"{train_dir}/{caption_metadata_filename}\"'",
                "// Line 530:             run_cmd += rf' \"{train_dir}/{latent_metadata_filename}\"'",
                "// Line 531:             run_cmd += rf' \"{pretrained_model_name_or_path}\"'",
                "// Line 532:             run_cmd += f\" --batch_size={batch_size}\"",
                "// Line 533:             run_cmd += f\" --max_resolution={max_resolution}\"",
                "// Line 546: ",
                "// Line 547:             log.info(run_cmd)",
                "// Line 548: ",
                "// Line 549:             env = os.environ.copy()",
                "// Line 550:             env[\"PYTHONPATH\"] = (",
                "// Line 551:                 rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 552:             )",
                "// Line 553: ",
                "// Line 554:             if not print_only:",
                "// Line 555:                 # Run the command",
                "// vulnerable line: 556: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 557: ",
                "// Line 558:         image_num = len(",
                "// Line 559:             [",
                "// Line 560:                 f",
                "// Line 561:                 for f, lower_f in (",
                "// Line 562:                     (file, file.lower()) for file in os.listdir(image_folder)",
                "// Line 563:                 )",
                "// Line 564:                 if lower_f.endswith((\".jpg\", \".jpeg\", \".png\", \".webp\"))",
                "// Line 565:             ]",
                "// Line 566:         )"
            ]
        },
        {
            "filename_of_changes": "git_caption_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 44:     run_cmd += f' \"{train_data_dir}\"'",
                "// Line 45: ",
                "// Line 46:     log.info(run_cmd)",
                "// Line 47: ",
                "// Line 48:     env = os.environ.copy()",
                "// Line 49:     env[\"PYTHONPATH\"] = (",
                "// Line 50:         rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 51:     )",
                "// Line 52: ",
                "// Line 53:     # Run the command",
                "// vulnerable line: 54: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 55: ",
                "// Line 56:     # Add prefix and postfix",
                "// Line 57:     add_pre_postfix(",
                "// Line 58:         folder=train_data_dir,",
                "// Line 59:         caption_file_ext=caption_ext,",
                "// Line 60:         prefix=prefix,",
                "// Line 61:         postfix=postfix,",
                "// Line 62:     )",
                "// Line 63: ",
                "// Line 64:     log.info(\"...captioning done\")"
            ]
        },
        {
            "filename_of_changes": "group_images_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 46:             run_cmd += f\" --caption_ext={caption_ext}\"",
                "// Line 47: ",
                "// Line 48:     log.info(run_cmd)",
                "// Line 49: ",
                "// Line 50:     env = os.environ.copy()",
                "// Line 51:     env[\"PYTHONPATH\"] = (",
                "// Line 52:         rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 53:     )",
                "// Line 54: ",
                "// Line 55:     # Run the command",
                "// vulnerable line: 56: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 57: ",
                "// Line 58:     log.info(\"...grouping done\")",
                "// Line 59: ",
                "// Line 60: ",
                "// Line 61: def gradio_group_images_gui_tab(headless=False):",
                "// Line 62:     from .common_gui import create_refresh_button",
                "// Line 63: ",
                "// Line 64:     current_input_folder = os.path.join(scriptdir, \"data\")",
                "// Line 65:     current_output_folder = os.path.join(scriptdir, \"data\")",
                "// Line 66: "
            ]
        },
        {
            "filename_of_changes": "merge_lora_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 445:             run_cmd += f\" --ratios {ratios_cmd}\"",
                "// Line 446: ",
                "// Line 447:         log.info(run_cmd)",
                "// Line 448: ",
                "// Line 449:         env = os.environ.copy()",
                "// Line 450:         env[\"PYTHONPATH\"] = (",
                "// Line 451:             rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 452:         )",
                "// Line 453: ",
                "// Line 454:         # Run the command",
                "// vulnerable line: 455: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 456: ",
                "// Line 457:         log.info(\"Done merging...\")"
            ]
        },
        {
            "filename_of_changes": "merge_lycoris_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 49:         run_cmd += f\" --is_v2\"",
                "// Line 50: ",
                "// Line 51:     log.info(run_cmd)",
                "// Line 52: ",
                "// Line 53:     env = os.environ.copy()",
                "// Line 54:     env[\"PYTHONPATH\"] = (",
                "// Line 55:         rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 56:     )",
                "// Line 57: ",
                "// Line 58:     # Run the command",
                "// vulnerable line: 59: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 60: ",
                "// Line 61:     log.info(\"Done merging...\")",
                "// Line 62: ",
                "// Line 63: ",
                "// Line 64: ###",
                "// Line 65: # Gradio UI",
                "// Line 66: ###",
                "// Line 67: ",
                "// Line 68: ",
                "// Line 69: def gradio_merge_lycoris_tab(headless=False):"
            ]
        },
        {
            "filename_of_changes": "resize_lora_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 76:         run_cmd += f\" --verbose\"",
                "// Line 77: ",
                "// Line 78:     log.info(run_cmd)",
                "// Line 79: ",
                "// Line 80:     env = os.environ.copy()",
                "// Line 81:     env[\"PYTHONPATH\"] = (",
                "// Line 82:         rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 83:     )",
                "// Line 84: ",
                "// Line 85:     # Run the command",
                "// vulnerable line: 86: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 87: ",
                "// Line 88:     log.info(\"Done resizing...\")",
                "// Line 89: ",
                "// Line 90: ",
                "// Line 91: ###",
                "// Line 92: # Gradio UI",
                "// Line 93: ###",
                "// Line 94: ",
                "// Line 95: ",
                "// Line 96: def gradio_resize_lora_tab(headless=False):"
            ]
        },
        {
            "filename_of_changes": "svd_merge_lora_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 92:     run_cmd += f' --new_conv_rank \"{new_conv_rank}\"'",
                "// Line 93: ",
                "// Line 94:     log.info(run_cmd)",
                "// Line 95: ",
                "// Line 96:     env = os.environ.copy()",
                "// Line 97:     env[\"PYTHONPATH\"] = (",
                "// Line 98:         rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 99:     )",
                "// Line 100: ",
                "// Line 101:     # Run the command",
                "// vulnerable line: 102: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 103: ",
                "// Line 104: ",
                "// Line 105: ###",
                "// Line 106: # Gradio UI",
                "// Line 107: ###",
                "// Line 108: ",
                "// Line 109: ",
                "// Line 110: def gradio_svd_merge_lora_tab(headless=False):",
                "// Line 111:     current_save_dir = os.path.join(scriptdir, \"outputs\")",
                "// Line 112:     current_a_model_dir = current_save_dir"
            ]
        },
        {
            "filename_of_changes": "wd14_caption_gui.py",
            "code_language": "Python",
            "number_of_lines_added_for_mitigation": "1",
            "number_of_lines_deleted_vulnerable_to_cve": "1",
            "Code_with_highlighted_vulnerability_lines": [
                "// Line 87: ",
                "// Line 88:     log.info(run_cmd)",
                "// Line 89: ",
                "// Line 90:     env = os.environ.copy()",
                "// Line 91:     env[\"PYTHONPATH\"] = (",
                "// Line 92:         rf\"{scriptdir}{os.pathsep}{scriptdir}/sd-scripts{os.pathsep}{env.get('PYTHONPATH', '')}\"",
                "// Line 93:     )",
                "// Line 94:     env[\"TF_ENABLE_ONEDNN_OPTS\"] = \"0\"",
                "// Line 95: ",
                "// Line 96:     # Run the command",
                "// vulnerable line: 97: subprocess.run(run_cmd, shell=True, env=env)",
                "// Line 98:     ",
                "// Line 99:     # Add prefix and postfix",
                "// Line 100:     add_pre_postfix(",
                "// Line 101:         folder=train_data_dir,",
                "// Line 102:         caption_file_ext=caption_extension,",
                "// Line 103:         prefix=always_first_tags,",
                "// Line 104:     )",
                "// Line 105: ",
                "// Line 106:     log.info(\"...captioning done\")",
                "// Line 107: "
            ]
        }
    ]
}