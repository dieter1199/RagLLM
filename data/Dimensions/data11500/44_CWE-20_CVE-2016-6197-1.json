{
    "cve_id": "CVE-2016-6197",
    "cve_description": "fs/overlayfs/dir.c in the OverlayFS filesystem implementation in the Linux kernel before 4.6 does not properly verify the upper dentry before proceeding with unlink and rename system-call processing, which allows local users to cause a denial of service (system crash) via a rename system call that specifies a self-hardlink.",
    "cve_publish_date": "2016-08-06",
    "cwe_id": "CWE-20",
    "cwe_name": "Improper Input Validation",
    "cwe_description": "The product receives input or data, but it does\n        not validate or incorrectly validates that the input has the\n        properties that are required to process the data safely and\n        correctly.",
    "commit_message": "ovl: verify upper dentry before unlink and rename\n\nUnlink and rename in overlayfs checked the upper dentry for staleness by\nverifying upper->d_parent against upperdir.  However the dentry can go\nstale also by being unhashed, for example.\n\nExpand the verification to actually look up the name again (under parent\nlock) and check if it matches the upper dentry.  This matches what the VFS\ndoes before passing the dentry to filesytem's unlink/rename methods, which\nexcludes any inconsistency caused by overlayfs.\n\nSigned-off-by: Miklos Szeredi <mszeredi@redhat.com>",
    "type_of_change": "Modification",
    "filename_of_changes": "dir.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "38",
    "number_of_lines_deleted_vulnerable_to_cve": "21",
    "vulnerable_lines": [
        "// Line_Reference 599: \tstruct dentry *upper = ovl_dentry_upper(dentry);",
        "// Line_Reference 604: \tif (upper->d_parent == upperdir) {",
        "// Line_Reference 605: \t\t/* Don't let d_delete() think it can reset d_inode */",
        "// Line_Reference 606: \t\tdget(upper);",
        "// Line_Reference 611: \t\tdput(upper);",
        "// Line_Reference 843: \tolddentry = ovl_dentry_upper(old);",
        "// Line_Reference 844: \tnewdentry = ovl_dentry_upper(new);",
        "// Line_Reference 845: \tif (newdentry) {",
        "// Line_Reference 847: \t\t\tnewdentry = opaquedir;",
        "// Line_Reference 848: \t\t\topaquedir = NULL;",
        "// Line_Reference 850: \t\t\tdget(newdentry);",
        "// Line_Reference 854: \t\tnewdentry = lookup_one_len(new->d_name.name, new_upperdir,",
        "// Line_Reference 855: \t\t\t\t\t   new->d_name.len);",
        "// Line_Reference 856: \t\terr = PTR_ERR(newdentry);",
        "// Line_Reference 857: \t\tif (IS_ERR(newdentry))",
        "// Line_Reference 858: \t\t\tgoto out_unlock;",
        "// Line_Reference 861: \terr = -ESTALE;",
        "// Line_Reference 862: \tif (olddentry->d_parent != old_upperdir)",
        "// Line_Reference 863: \t\tgoto out_dput;",
        "// Line_Reference 864: \tif (newdentry->d_parent != new_upperdir)",
        "// Line_Reference 865: \t\tgoto out_dput;"
    ]
}
