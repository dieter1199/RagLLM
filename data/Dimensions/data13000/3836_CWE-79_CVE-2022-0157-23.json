{
    "cve_id": "CVE-2022-0157",
    "cve_description": "phoronix-test-suite is vulnerable to Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "cve_publish_date": "2022-01-10",
    "cwe_id": "CWE-79",
    "cwe_name": "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "cwe_description": "The product does not neutralize or incorrectly neutralizes user-controllable input before it is placed in output that is used as a web page that is served to other users.",
    "commit_message": "phodevi: Input sanitization updates for Phoromatic Server\n\nAlso other code formatting / cleanups while reviewing the code...",
    "type_of_change": "Modification",
    "filename_of_changes": "phoromatic_schedules.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "101",
    "number_of_lines_deleted_vulnerable_to_cve": "110",
    "vulnerable_lines": [
        "// Line_Reference 6: \tCopyright (C) 2008 - 2018, Phoronix Media",
        "// Line_Reference 7: \tCopyright (C) 2008 - 2018, Michael Larabel",
        "// Line_Reference 23: ",
        "// Line_Reference 58: ",
        "// Line_Reference 178: ",
        "// Line_Reference 251: \t\t\t\t$trigger_url = 'http://' . phoromatic_web_socket_server_ip() . '/event.php?type=trigger&user=' . $_SESSION['UserName'] . '&public_key=' . $row['PublicKey'] . '&trigger=XXX';",
        "// Line_Reference 252: \t\t\t\t$main .= '<p>This test schedule can be manually triggered to run at any time by calling <strong>' . $trigger_url . '</strong> where <em>XXX</em> is the trigger value to be used (if relevant, such as a time-stamp, Git/SVN commit number or hash, etc). There\\'s also the option of sub-targeting system(s) part of this schedule. One option is appending <em>&sub_target_this_ip</em> if this URL is being called from one of the client test systems to only sub-target the triggered testing on that client, among other options.</p>';",
        "// Line_Reference 253: \t\t\t\t$main .= '<p>If you wish to run this test schedule now, click the following button and the schedule will be run on all intended systems at their next earliest possible convenience.</p>';",
        "// Line_Reference 254: \t\t\t\t$main .= '<p><form action=\"?schedules/' . $PATH[0] . '\" name=\"manual_run\" method=\"post\">';",
        "// Line_Reference 255: \t\t\t\t$main .= '<input type=\"hidden\" name=\"do_manual_test_run\" value=\"1\" /><input type=\"submit\" value=\"Run Test Schedule Now\" onclick=\"return confirm(\\'Run this test schedule now?\\');\" />';",
        "// Line_Reference 256: \t\t\t\t$main .= '</form></p>';",
        "// Line_Reference 257: \t\t\t\t$main .= '<p><form action=\"?schedules/' . $PATH[0] . '\" name=\"skip_run\" method=\"post\">';",
        "// Line_Reference 258: \t\t\t\t$main .= '<input type=\"hidden\" name=\"skip_current_ticket\" value=\"1\" /><input type=\"submit\" value=\"Skip Current Test Ticket\" onclick=\"return confirm(\\'Skip any currently active test ticket on all systems?\\');\" />';",
        "// Line_Reference 259: \t\t\t\t$main .= '</form></p>';",
        "// Line_Reference 429: ",
        "// Line_Reference 430: ",
        "// Line_Reference 449: \t\t\t\t\t\t$main .= '<a href=\"?result/' . $test_result_row['PPRID'] . '\"><li>' . $test_result_row['Title'] . '<br /><table><tr><td>' . phoromatic_system_id_to_name($test_result_row['SystemID']) . '</td><td>' . phoromatic_user_friendly_timedate($test_result_row['UploadTime']) .  '</td></tr></table></li></a>';",
        "// Line_Reference 492: \t\t\t<p>Test schedules are used for tests that are intended to be run on a recurring basis -- either daily or other defined time period -- or whenever a trigger/event occurs, like a new Git commit to a software repository being tracked. Test schedules can be run on any given system(s)/group(s) and can be later edited.</p>';",
        "// Line_Reference 493: ",
        "// Line_Reference 494: \t\t\tif(!PHOROMATIC_USER_IS_VIEWER)",
        "// Line_Reference 495: \t\t\t{",
        "// Line_Reference 496: \t\t\t\t$main .= '",
        "// Line_Reference 497: \t\t\t\t<hr />",
        "// Line_Reference 498: \t\t\t\t<h2>Create A Schedule</h2>",
        "// Line_Reference 499: \t\t\t\t<p><a href=\"?sched\">Create a schedule</a> followed by adding tests/suites to run for that schedule on the selected systems.</p>';",
        "// Line_Reference 500: \t\t\t}",
        "// Line_Reference 501: ",
        "// Line_Reference 502: \t\t\t$main .= '<hr /><h2>Current Schedules</h2>';",
        "// Line_Reference 505: \t\t\t$main .= '<div class=\"pts_phoromatic_info_box_area\">",
        "// Line_Reference 506: \t\t\t\t\t<ul>",
        "// Line_Reference 507: \t\t\t\t\t\t<li><h1>Active Test Schedules</h1></li>';",
        "// Line_Reference 509: \t\t\t\t\t$stmt = phoromatic_server::$db->prepare('SELECT Title, ScheduleID, Description, RunTargetSystems, RunTargetGroups, RunAt, ActiveOn FROM phoromatic_schedules WHERE AccountID = :account_id AND State >= 1 ORDER BY Title ASC');",
        "// Line_Reference 510: \t\t\t\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);",
        "// Line_Reference 511: \t\t\t\t\t$result = $stmt->execute();",
        "// Line_Reference 512: \t\t\t\t\t$row = $result->fetchArray();",
        "// Line_Reference 513: ",
        "// Line_Reference 514: \t\t\t\t\tif($row == false)",
        "// Line_Reference 515: \t\t\t\t\t{",
        "// Line_Reference 516: \t\t\t\t\t\t$main .= '<li class=\"light\" style=\"text-align: center;\">No Schedules Found</li>';",
        "// Line_Reference 517: \t\t\t\t\t}",
        "// Line_Reference 518: \t\t\t\t\telse",
        "// Line_Reference 519: \t\t\t\t\t{",
        "// Line_Reference 520: \t\t\t\t\t\tdo",
        "// Line_Reference 521: \t\t\t\t\t\t{",
        "// Line_Reference 522: \t\t\t\t\t\t\t$stmt_tests = phoromatic_server::$db->prepare('SELECT COUNT(*) AS TestCount FROM phoromatic_schedules_tests WHERE AccountID = :account_id AND ScheduleID = :schedule_id ORDER BY TestProfile ASC');",
        "// Line_Reference 523: \t\t\t\t\t\t\t$stmt_tests->bindValue(':account_id', $_SESSION['AccountID']);",
        "// Line_Reference 524: \t\t\t\t\t\t\t$stmt_tests->bindValue(':schedule_id', $row['ScheduleID']);",
        "// Line_Reference 525: \t\t\t\t\t\t\t$result_tests = $stmt_tests->execute();",
        "// Line_Reference 526: \t\t\t\t\t\t\t$row_tests = $result_tests->fetchArray();",
        "// Line_Reference 527: \t\t\t\t\t\t\t$test_count = !empty($row_tests) ? $row_tests['TestCount'] : 0;",
        "// Line_Reference 528: ",
        "// Line_Reference 529: \t\t\t\t\t\t\t$group_count = empty($row['RunTargetGroups']) ? 0 : count(explode(',', $row['RunTargetGroups']));",
        "// Line_Reference 530: \t\t\t\t\t\t\t$main .= '<a href=\"?schedules/' . $row['ScheduleID'] . '\"><li>' . $row['Title'] . '<br /><table><tr><td>' . pts_strings::plural_handler(count(phoromatic_server::systems_associated_with_schedule($_SESSION['AccountID'], $row['ScheduleID'])), 'System') . '</td><td>' . pts_strings::plural_handler($group_count, 'Group') . '</td><td>' . pts_strings::plural_handler($test_count, 'Test') . '</td><td>' . pts_strings::plural_handler(phoromatic_results_for_schedule($row['ScheduleID']), 'Result') . ' Total</td><td>' . pts_strings::plural_handler(phoromatic_results_for_schedule($row['ScheduleID'], 'TODAY'), 'Result') . ' Today</td><td><strong>' . phoromatic_schedule_activeon_string($row['ActiveOn'], $row['RunAt']) . '</strong></td></tr></table></li></a>';",
        "// Line_Reference 531: \t\t\t\t\t\t}",
        "// Line_Reference 532: \t\t\t\t\t\twhile($row = $result->fetchArray());",
        "// Line_Reference 533: \t\t\t\t\t}",
        "// Line_Reference 536: \t\t\t$main .= '</ul>",
        "// Line_Reference 537: \t\t\t</div>';",
        "// Line_Reference 539: \t\t\t$main .= '<hr /><h2>Schedule Overview</h2>';",
        "// Line_Reference 540: \t\t\t$week = array('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday');",
        "// Line_Reference 542: \t\t\tforeach($week as $i => $day)",
        "// Line_Reference 544: \t\t\t\t$stmt = phoromatic_server::$db->prepare('SELECT Title, ScheduleID, RunAt, RunTargetGroups, RunTargetSystems FROM phoromatic_schedules WHERE AccountID = :account_id AND State >= 1 AND ActiveOn LIKE :active_on ORDER BY RunAt,ActiveOn,Title ASC');",
        "// Line_Reference 545: \t\t\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);",
        "// Line_Reference 546: \t\t\t\t$stmt->bindValue(':active_on', '%' . $i . '%');",
        "// Line_Reference 547: \t\t\t\t$result = $stmt->execute();",
        "// Line_Reference 548: \t\t\t\t$has_matched = false;",
        "// Line_Reference 549: \t\t\t\twhile($row = $result->fetchArray())",
        "// Line_Reference 551: \t\t\t\t\tif(!$has_matched)",
        "// Line_Reference 552: \t\t\t\t\t{",
        "// Line_Reference 553: \t\t\t\t\t\t$main .= '<h3>' . $day . '</h3>' . PHP_EOL . '<p>';",
        "// Line_Reference 554: \t\t\t\t\t\t$has_matched = true;",
        "// Line_Reference 555: \t\t\t\t\t}",
        "// Line_Reference 556: \t\t\t\t\t$main .= '<em>' . $row['RunAt'] . '</em> <a href=\"?schedules/' . $row['ScheduleID'] . '\">' . $row['Title'] . '</a>';",
        "// Line_Reference 557: \t\t\t\t\t//$main .= $row['RunTargetSystems'] . ' ' . $row['RunTargetGroups'];",
        "// Line_Reference 558: \t\t\t\t\t$main .= '<br />';",
        "// Line_Reference 560: ",
        "// Line_Reference 561: \t\t\t\tif($has_matched)",
        "// Line_Reference 562: \t\t\t\t\t$main .= '</p>' . PHP_EOL;",
        "// Line_Reference 563: ",
        "// Line_Reference 566: \t\t\t$main .= '<div class=\"pts_phoromatic_info_box_area\">",
        "// Line_Reference 567: \t\t\t\t\t<ul>",
        "// Line_Reference 568: \t\t\t\t\t\t<li><h1>Deactivated Test Schedules</h1></li>';",
        "// Line_Reference 570: \t\t\t\t\t$stmt = phoromatic_server::$db->prepare('SELECT Title, ScheduleID, Description, RunTargetSystems, RunTargetGroups, RunAt, ActiveOn FROM phoromatic_schedules WHERE AccountID = :account_id AND State < 1 ORDER BY Title ASC');",
        "// Line_Reference 571: \t\t\t\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);",
        "// Line_Reference 572: \t\t\t\t\t$result = $stmt->execute();",
        "// Line_Reference 573: \t\t\t\t\t$row = $result->fetchArray();",
        "// Line_Reference 575: \t\t\t\t\tif($row == false)",
        "// Line_Reference 576: \t\t\t\t\t{",
        "// Line_Reference 577: \t\t\t\t\t\t$main .= '<li class=\"light\" style=\"text-align: center;\">No Schedules Found</li>';",
        "// Line_Reference 578: \t\t\t\t\t}",
        "// Line_Reference 579: \t\t\t\t\telse",
        "// Line_Reference 580: \t\t\t\t\t{",
        "// Line_Reference 581: \t\t\t\t\t\tdo",
        "// Line_Reference 582: \t\t\t\t\t\t{",
        "// Line_Reference 583: \t\t\t\t\t\t\t$stmt_tests = phoromatic_server::$db->prepare('SELECT COUNT(*) AS TestCount FROM phoromatic_schedules_tests WHERE AccountID = :account_id AND ScheduleID = :schedule_id ORDER BY TestProfile ASC');",
        "// Line_Reference 584: \t\t\t\t\t\t\t$stmt_tests->bindValue(':account_id', $_SESSION['AccountID']);",
        "// Line_Reference 585: \t\t\t\t\t\t\t$stmt_tests->bindValue(':schedule_id', $row['ScheduleID']);",
        "// Line_Reference 586: \t\t\t\t\t\t\t$result_tests = $stmt_tests->execute();",
        "// Line_Reference 587: \t\t\t\t\t\t\t$row_tests = $result_tests->fetchArray();",
        "// Line_Reference 588: \t\t\t\t\t\t\t$test_count = !empty($row_tests) ? $row_tests['TestCount'] : 0;",
        "// Line_Reference 589: ",
        "// Line_Reference 590: \t\t\t\t\t\t\t$group_count = empty($row['RunTargetGroups']) ? 0 : count(explode(',', $row['RunTargetGroups']));",
        "// Line_Reference 591: \t\t\t\t\t\t\t$main .= '<a href=\"?schedules/' . $row['ScheduleID'] . '\"><li>' . $row['Title'] . '<br /><table><tr><td>' . pts_strings::plural_handler(count(phoromatic_server::systems_associated_with_schedule($_SESSION['AccountID'], $row['ScheduleID'])), 'System') . '</td><td>' . pts_strings::plural_handler($group_count, 'Group') . '</td><td>' . pts_strings::plural_handler($test_count, 'Test') . '</td><td>' . pts_strings::plural_handler(phoromatic_results_for_schedule($row['ScheduleID']), 'Result') . ' Total</td><td>' . pts_strings::plural_handler(phoromatic_results_for_schedule($row['ScheduleID'], 'TODAY'), 'Result') . ' Today</td><td><strong>' . phoromatic_schedule_activeon_string($row['ActiveOn'], $row['RunAt']) . '</strong></td></tr></table></li></a>';",
        "// Line_Reference 592: \t\t\t\t\t\t}",
        "// Line_Reference 593: \t\t\t\t\t\twhile($row = $result->fetchArray());",
        "// Line_Reference 594: \t\t\t\t\t}",
        "// Line_Reference 597: \t\t\t$main .= '</ul>",
        "// Line_Reference 598: \t\t\t</div>';",
        "// Line_Reference 600: \t\t\techo '<div id=\"pts_phoromatic_main_area\">' . $main . '</div>';",
        "// Line_Reference 601: \t\t\techo phoromatic_webui_footer();"
    ]
}
