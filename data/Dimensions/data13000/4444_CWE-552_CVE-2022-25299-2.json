{
    "cve_id": "CVE-2022-25299",
    "cve_description": "This affects the package cesanta/mongoose before 7.6. The unsafe handling of file names during upload using mg_http_upload() method may enable attackers to write files to arbitrary locations outside the designated target folder.",
    "cve_publish_date": "2022-02-18",
    "cwe_id": "CWE-552",
    "cwe_name": "Files or Directories Accessible to External Parties",
    "cwe_description": "The product makes files or directories accessible to unauthorized actors, even though they should not be.",
    "commit_message": "Protect against the directory traversal in mg_upload()",
    "type_of_change": "Modification",
    "filename_of_changes": "mongoose.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "28",
    "number_of_lines_deleted_vulnerable_to_cve": "28",
    "vulnerable_lines": [
        "// Line_Reference 1145: #if MG_ENABLE_FILE",
        "// Line_Reference 1146: int mg_http_upload(struct mg_connection *c, struct mg_http_message *hm,",
        "// Line_Reference 1147:                    const char *dir) {",
        "// Line_Reference 1148:   char offset[40] = \"\", name[200] = \"\", path[256];",
        "// Line_Reference 1149:   mg_http_get_var(&hm->query, \"offset\", offset, sizeof(offset));",
        "// Line_Reference 1150:   mg_http_get_var(&hm->query, \"name\", name, sizeof(name));",
        "// Line_Reference 1151:   if (name[0] == '\\0') {",
        "// Line_Reference 1152:     mg_http_reply(c, 400, \"\", \"%s\", \"name required\");",
        "// Line_Reference 1153:     return -1;",
        "// Line_Reference 1154:   } else {",
        "// Line_Reference 1155:     FILE *fp;",
        "// Line_Reference 1156:     size_t oft = strtoul(offset, NULL, 0);",
        "// Line_Reference 1157:     snprintf(path, sizeof(path), \"%s%c%s\", dir, MG_DIRSEP, name);",
        "// Line_Reference 1158:     LOG(LL_DEBUG,",
        "// Line_Reference 1159:         (\"%p %d bytes @ %d [%s]\", c->fd, (int) hm->body.len, (int) oft, name));",
        "// Line_Reference 1160:     if ((fp = fopen(path, oft == 0 ? \"wb\" : \"ab\")) == NULL) {",
        "// Line_Reference 1161:       mg_http_reply(c, 400, \"\", \"fopen(%s): %d\", name, errno);",
        "// Line_Reference 1162:       return -2;",
        "// Line_Reference 1163:     } else {",
        "// Line_Reference 1164:       fwrite(hm->body.ptr, 1, hm->body.len, fp);",
        "// Line_Reference 1165:       fclose(fp);",
        "// Line_Reference 1166:       mg_http_reply(c, 200, \"\", \"\");",
        "// Line_Reference 1167:       return (int) hm->body.len;",
        "// Line_Reference 1168:     }",
        "// Line_Reference 1169:   }",
        "// Line_Reference 1170: }",
        "// Line_Reference 1171: #endif",
        "// Line_Reference 1172: "
    ]
}
