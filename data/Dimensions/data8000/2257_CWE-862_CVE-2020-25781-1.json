{
    "cve_id": "CVE-2020-25781",
    "cve_description": "An issue was discovered in file_download.php in MantisBT before 2.24.3. Users without access to view private issue notes are able to download the (supposedly private) attachments linked to these notes by accessing the corresponding file download URL directly.",
    "cve_publish_date": "2020-09-30",
    "cwe_id": "CWE-862",
    "cwe_name": "Missing Authorization",
    "cwe_description": "The product does not perform an authorization check when an actor attempts to access a resource or perform an action.",
    "commit_message": "Check ability to download attachments at bugnote level\n\nThis prevents users authorized to download attachments but not to view\nprivate bugnotes, from accessing files attached to a private note via\n`file_download.php?file_id={FILE_ID}&type=bug` (CVE-2020-25781).\n\nIncludes some minor code cleanup in file_get_visible_attachments():\n- use a foreach loop\n- reuse variables instead of derefenrcing array\n\nFixes #27039",
    "type_of_change": "Modification",
    "filename_of_changes": "file_api.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "10",
    "number_of_lines_deleted_vulnerable_to_cve": "20",
    "vulnerable_lines": [
        "// Line_Reference 454: \t$t_attachments_view_threshold = config_get( 'view_attachments_threshold' );",
        "// Line_Reference 457: \tfor( $i = 0;$i < $t_attachments_count;$i++ ) {",
        "// Line_Reference 458: \t\t$t_row = $t_attachment_rows[$i];",
        "// Line_Reference 461: \t\t# This covers access checks for issue attachments",
        "// Line_Reference 462: \t\tif( !file_can_view_bug_attachments( $p_bug_id, $t_user_id ) ) {",
        "// Line_Reference 466: \t\t# This covers access checks for issue note attachments",
        "// Line_Reference 467: \t\t$t_attachment_note_id = (int)$t_row['bugnote_id'];",
        "// Line_Reference 468: \t\tif( $t_attachment_note_id !== 0 ) {",
        "// Line_Reference 469: \t\t\tif( bugnote_get_field( $t_attachment_note_id, 'view_state' ) != VS_PUBLIC ) {",
        "// Line_Reference 470: \t\t\t\tif( !access_has_bugnote_level( $t_attachments_view_threshold, $t_attachment_note_id ) ) {",
        "// Line_Reference 471: \t\t\t\t\tcontinue;",
        "// Line_Reference 472: \t\t\t\t}",
        "// Line_Reference 473: \t\t\t}",
        "// Line_Reference 474: \t\t}",
        "// Line_Reference 475: ",
        "// Line_Reference 478: \t\t$t_filesize = $t_row['filesize'];",
        "// Line_Reference 486: \t\t$t_attachment['size'] = (int)$t_filesize;",
        "// Line_Reference 490: \t\t$t_attachment['bugnote_id'] = (int)$t_row['bugnote_id'];",
        "// Line_Reference 492: \t\t$t_attachment['can_download'] = file_can_download_bug_attachments( $p_bug_id, (int)$t_row['user_id'] );",
        "// Line_Reference 493: \t\t$t_attachment['can_delete'] = file_can_delete_bug_attachments( $p_bug_id, (int)$t_row['user_id'] );"
    ]
}
