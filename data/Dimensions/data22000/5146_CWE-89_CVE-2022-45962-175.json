{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "AddAbsences.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "64",
    "number_of_lines_deleted_vulnerable_to_cve": "65",
    "vulnerable_lines": [
        "// Line_Reference 32: if(isset($_SESSION['student_id']) && $_SESSION['student_id'] != '')",
        "// Line_Reference 33: {",
        "// Line_Reference 52:     if (count($_REQUEST['period']) && count($_REQUEST['student']) && count($_REQUEST['dates'])) {",
        "// Line_Reference 63:         $current_RET = DBGet(DBQuery('SELECT STUDENT_ID,PERIOD_ID,COURSE_PERIOD_ID,SCHOOL_DATE,ATTENDANCE_CODE FROM attendance_period WHERE EXTRACT(MONTH FROM SCHOOL_DATE)=\\'' . ($_REQUEST['month'] * 1) . '\\' AND EXTRACT(YEAR FROM SCHOOL_DATE)=\\'' . $_REQUEST[year] . '\\' AND PERIOD_ID IN ' . $periods_list . ' AND STUDENT_ID IN ' . $students_list . ''), array(), array('STUDENT_ID', 'SCHOOL_DATE', 'PERIOD_ID', 'COURSE_PERIOD_ID'));",
        "// Line_Reference 82: //",
        "// Line_Reference 84:                     if(in_array($course_periods_RET['PERIOD_ID'], $period_key))",
        "// Line_Reference 85:                     {",
        "// Line_Reference 88: //",
        "// Line_Reference 94: ",
        "// Line_Reference 95:                                 $check_dup_continues=DBGet(DBQuery('SELECT COUNT(*) as REC_EX FROM attendance_period WHERE STUDENT_ID='.$student_id.' AND SCHOOL_DATE=\\''.$date.'\\' AND PERIOD_ID=\\''.$period_id.'\\' AND MARKING_PERIOD_ID=\\''.$current_mp.'\\''));",
        "// Line_Reference 96:                                 if($check_dup_continues[1]['REC_EX']==0)",
        "// Line_Reference 97:                                 {",
        "// Line_Reference 98:                                 $absence_reason=optional_param('absence_reason', '', PARAM_SPCL);",
        "// Line_Reference 99:                                 $absence_reason= singleQuoteReplace(\"\",\"\",$absence_reason);",
        "// Line_Reference 100:                                 $sql = 'INSERT INTO attendance_period (STUDENT_ID,SCHOOL_DATE,PERIOD_ID,MARKING_PERIOD_ID,COURSE_PERIOD_ID,ATTENDANCE_CODE,ATTENDANCE_TEACHER_CODE,ATTENDANCE_REASON,ADMIN)values(\\'' . $student_id . '\\',\\'' . $date . '\\',\\'' . $period_id . '\\',\\'' . $current_mp . '\\',\\'' . $course_period_id . '\\',\\'' . optional_param('absence_code', '', PARAM_NUMBER) . '\\',\\'' . optional_param('absence_code', '', PARAM_NUMBER) . '\\',\\'' .$absence_reason. '\\',\\'Y\\')';",
        "// Line_Reference 101:                                 }",
        "// Line_Reference 102:                                 else",
        "// Line_Reference 103:                                 {",
        "// Line_Reference 104:                                 $absence_reason=optional_param('absence_reason', '', PARAM_SPCL);",
        "// Line_Reference 105:                                 $absence_reason= singleQuoteReplace(\"\",\"\",$absence_reason);",
        "// Line_Reference 106:                                   $sql = 'UPDATE attendance_period SET ATTENDANCE_CODE=\\'' . optional_param('absence_code', '', PARAM_NUMBER) . '\\',ATTENDANCE_TEACHER_CODE=\\'' . optional_param('absence_code', '', PARAM_NUMBER) . '\\',ATTENDANCE_REASON=\\'' . $absence_reason . '\\',ADMIN=\\'Y\\',COURSE_PERIOD_ID=\\'' . $course_period_id . '\\'",
        "// Line_Reference 107: \t\t\t\t\t\t\t\tWHERE STUDENT_ID=\\'' . $student_id . '\\' AND SCHOOL_DATE=\\'' . $date . '\\' AND PERIOD_ID=\\'' . $period_id . '\\'';",
        "// Line_Reference 109:                                  DBQuery($sql);",
        "// Line_Reference 133:             $current_RET = DBGet(DBQuery('SELECT STUDENT_ID,PERIOD_ID,SCHOOL_DATE,ATTENDANCE_CODE FROM attendance_period WHERE course_period_id=' . $cp_id . ' AND EXTRACT(MONTH FROM SCHOOL_DATE)=\\'' . ($_REQUEST['month'] * 1) . '\\' AND EXTRACT(YEAR FROM SCHOOL_DATE)=\\'' . $_REQUEST[year] . '\\''), array(), array('SCHOOL_DATE', 'PERIOD_ID'));",
        "// Line_Reference 185:     $extra['link'] = array('FULL_NAME' =>false);",
        "// Line_Reference 187:     if(isset($_SESSION['student_id']) && $_SESSION['student_id'] != '')",
        "// Line_Reference 188:     {",
        "// Line_Reference 194:             echo \"<div class='alert alert-success alert-dismissible'><a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;&nbsp;&nbsp;</a>\".$note.\"</div>\";",
        "// Line_Reference 204:         echo '<label class=\"control-label col-lg-2\">'._addAbsenceToPeriods.'</label>';",
        "// Line_Reference 216:         echo '<label class=\"control-label col-lg-3\">'._absenceCode.'</label>';",
        "// Line_Reference 229:         echo '<label class=\"control-label col-lg-3\">'._absenceReason.'</label>';",
        "// Line_Reference 245:         $months=array(\"01\"=>'January',\"02\"=>'February',\"03\"=>'March',\"04\"=>'April',\"05\"=>'May',\"06\"=>'June',\"07\"=>'July',\"08\"=>'August',\"09\"=>'September',\"10\"=>'October',\"11\"=>'November',\"12\"=>'December');",
        "// Line_Reference 247: //        echo '<div class=\"clearfix\"><div class=\"col-md-12\"><div class=\"form-inline\">' . PrepareDate(strtoupper(date(\"d-M-y\", $time)), '', false, array('M' => 1, 'Y' => 1, 'submit' =>true)) . '</div></div></div>';",
        "// Line_Reference 248: ",
        "// Line_Reference 249: ",
        "// Line_Reference 250:         $date = $_REQUEST['year'].'-'.$_REQUEST['month'].'-1';",
        "// Line_Reference 255: ",
        "// Line_Reference 258:         echo '<a class=\"btn\" href=\"'.PreparePHP_SELF($_REQUEST).'&month='.$prev_month.'&year='.$prev_year.'\"><i class=\"icon-arrow-left8 position-left\"></i> <span class=\"hidden-xs\">'._prevMonth.'</span></a>';",
        "// Line_Reference 262:         echo \"<SELECT class=\\\"form-control inline-block m-r-10\\\" NAME=month id=monthSelect  onchange='document.location.href=\\\"\" . PreparePHP_SELF($_REQUEST).\"&month=\\\"+this.form.monthSelect.value;'>\";",
        "// Line_Reference 263:         foreach($months as $mi=>$md){",
        "// Line_Reference 264:             if($_REQUEST['month']==$mi)",
        "// Line_Reference 265:             echo \"<OPTION value=\".$mi.\" SELECTED >$md</OPTION>\";",
        "// Line_Reference 267:             echo \"<OPTION value=\".$mi.\" >$md</OPTION>\";",
        "// Line_Reference 268: ",
        "// Line_Reference 271:         echo \"<SELECT class=\\\"form-control inline-block\\\" NAME=year id=yearSelect  onchange='document.location.href=\\\"\" . PreparePHP_SELF($_REQUEST).\"&year=\\\"+this.form.yearSelect.value;'>\";",
        "// Line_Reference 272:         for($years=1959;$years<=date('Y')+30;$years++){",
        "// Line_Reference 273:             if($_REQUEST['year']==$years)",
        "// Line_Reference 274:             echo \"<OPTION value=\".$years.\" SELECTED >$years</OPTION>\";",
        "// Line_Reference 276:             echo \"<OPTION value=\".$years.\" >$years</OPTION>\";",
        "// Line_Reference 277: ",
        "// Line_Reference 283:         echo '<a class=\"btn\" href=\"'.PreparePHP_SELF($_REQUEST).'&month='.$next_month.'&year='.$next_year.'\"><span class=\"hidden-xs\">'._nextMonth.'</span> <i class=\"icon-arrow-right8 position-right\"></i></a>';",
        "// Line_Reference 286: ",
        "// Line_Reference 287: ",
        "// Line_Reference 292: ",
        "// Line_Reference 294:         echo '<th>'._sun.'</th><th>'._mon.'</th><th>'._tue.'</th><th>'._wed.'</th><th>'._thu.'</th><th>'._fri.'</th><th>'._sat.'</th></tr></thead><tbody><tr>';",
        "// Line_Reference 325: ",
        "// Line_Reference 354:     $extra['columns_before'] = array('CHECKBOX' => '</A><INPUT type=checkbox value=Y name=controller onclick=\"checkAll(this.form,this.form.controller.checked,\\'student\\');\"><A>');",
        "// Line_Reference 356: ",
        "// Line_Reference 358:     if ($_REQUEST['search_modfunc'] == 'list')",
        "// Line_Reference 359:         $extra['footer'] = '<div class=\"panel-footer text-right p-r-20\">'.SubmitButton(_save, '', 'class=\"btn btn-primary\" onclick=\"self_disable(this);\"') . '</div>';",
        "// Line_Reference 373:     echo '<h4 class=\"modal-title\">'._chooseCourse.'</h4>';",
        "// Line_Reference 384:     echo '<h6>' . count($subjects_RET) . ((count($subjects_RET) == 1) ? ' '._subjectWas : ' '._subjectsWere) . ' found.</h6>';",
        "// Line_Reference 402: function _makeChooseCheckbox($value, $title) {",
        "// Line_Reference 405:     return \"<INPUT type=checkbox name=student[\" . $THIS_RET['STUDENT_ID'] . \"] value=Y>\";",
        "// Line_Reference 408: ?>"
    ]
}
