{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "index.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "142",
    "number_of_lines_deleted_vulnerable_to_cve": "115",
    "vulnerable_lines": [
        "// Line_Reference 29: error_reporting(1);",
        "// Line_Reference 30: ini_set('session.cookie_httponly', 1);",
        "// Line_Reference 31: include_once(\"functions/DelDirectoryFnc.php\");",
        "// Line_Reference 32: include_once(\"functions/ParamLibFnc.php\");",
        "// Line_Reference 33: require_once(\"functions/PragRepFnc.php\");",
        "// Line_Reference 34: include_once(\"RemoveBackup.php\");",
        "// Line_Reference 35: include('lang/language.php');",
        "// Line_Reference 36: include_once(\"functions/PasswordHashFnc.php\");",
        "// Line_Reference 37: ",
        "// Line_Reference 47:     $error[] = \"\"._eitherYourAccountIsInactiveOrYourAccessPermissionHasBeenRevoked.\".\"._pleaseContactTheSchoolAdministration.\".\";",
        "// Line_Reference 57:  if ($install == 'comp') {",
        "// Line_Reference 58:      if (is_dir('install')) {",
        "// Line_Reference 59:          $dir = 'install/'; // IMPORTANT: with '/' at the end",
        "// Line_Reference 60:           $remove_directory = delete_directory($dir);",
        "// Line_Reference 61:      }",
        "// Line_Reference 62:  }",
        "// Line_Reference 80: ",
        "// Line_Reference 81:     $username = mysqli_real_escape_string($connection,trim(optional_param('USERNAME', '', PARAM_RAW)));",
        "// Line_Reference 83:     $arr_cookie_options = array (",
        "// Line_Reference 84:         'expires' => time() + 60*60*24*100,",
        "// Line_Reference 91:     if($_REQUEST['remember'])",
        "// Line_Reference 92:     {",
        "// Line_Reference 94: ",
        "// Line_Reference 95:         $cName='remember_me_name';",
        "// Line_Reference 96:         $cPwd='remember_me_pwd';",
        "// Line_Reference 97:         $cLang='remember_me_lang';",
        "// Line_Reference 98: ",
        "// Line_Reference 100:         setcookie($cPwd, cryptor(optional_param('PASSWORD','',PARAM_RAW), 'ENC'), $arr_cookie_options);",
        "// Line_Reference 101:         setcookie($cLang, optional_param('language','',PARAM_RAW), time()+60*60*24*100, \"/\");",
        "// Line_Reference 102:     }",
        "// Line_Reference 103:     else",
        "// Line_Reference 104:     {",
        "// Line_Reference 105:         setcookie('remember_me_name', 'gone', time()-60*60*24*100, \"/\");",
        "// Line_Reference 106:         setcookie('remember_me_pwd', 'gone', time()-60*60*24*100, \"/\");",
        "// Line_Reference 107:         setcookie('remember_me_lang', 'gone', time()-60*60*24*100, \"/\");",
        "// Line_Reference 111:         $password = str_replace(\"\\'\", \"\",(mysqli_real_escape_string($connection,optional_param('PASSWORD', '', PARAM_RAW))));",
        "// Line_Reference 112:     $password = str_replace(\"&\", \"\",(mysqli_real_escape_string($connection,optional_param('PASSWORD', '', PARAM_RAW))));",
        "// Line_Reference 113:     $password = str_replace(\"\\\\\", \"\",(mysqli_real_escape_string($connection,optional_param('PASSWORD', '', PARAM_RAW))));",
        "// Line_Reference 121:         $login_status = VerifyHash($password,$user_password);",
        "// Line_Reference 122:         if($login_status==1) {  $login_uniform = $validate_username; }",
        "// Line_Reference 123:         else { $login_uniform = []; }",
        "// Line_Reference 126: ",
        "// Line_Reference 128: ",
        "// Line_Reference 182:                     $error[] = \" \"._incorrectUsernameOrPassword.\". \"._pleaseTryAgain.\".\";",
        "// Line_Reference 222:                     $error[] = \" \"._incorrectUsernameOrPassword.\". \"._pleaseTryAgain.\".\";",
        "// Line_Reference 245:         if ($maintain['SYSTEM_MAINTENANCE_SWITCH'] == Y && ( $login_RET || $student_RET)) {",
        "// Line_Reference 259:             $log_as_admin =[];",
        "// Line_Reference 261:             foreach($superadmin_login as $val)",
        "// Line_Reference 262:             {",
        "// Line_Reference 265:                 $login_status = VerifyHash($password,$super_admin_password);",
        "// Line_Reference 266:                 if($login_status==1)",
        "// Line_Reference 267:                     {",
        "// Line_Reference 268:                         $log_as_admin = DBGet(DBQuery(\"SELECT USER_ID,PROFILE_ID FROM login_authentication WHERE USER_ID=$super_admin_userid AND PROFILE_ID=0\"));",
        "// Line_Reference 269:                     }",
        "// Line_Reference 320:                         $error[] = \" \"._incorrectUsernameOrPassword.\". \"._pleaseTryAgain.\".\";",
        "// Line_Reference 325:                     $admin_RET =[];",
        "// Line_Reference 326:                     $admin_RET_Validation = DBGet(DBQuery(\"SELECT STAFF_ID,la.USERNAME,la.FAILED_LOGIN,la.LAST_LOGIN,la.PROFILE_ID,la.PASSWORD FROM staff s,login_authentication la WHERE PROFILE='$username' AND s.STAFF_ID=la.USER_ID\"));",
        "// Line_Reference 327:                     foreach($admin_RET_Validation as $val)",
        "// Line_Reference 328:                     {",
        "// Line_Reference 331:                         $login_status = VerifyHash($password,$user_validate_password);",
        "// Line_Reference 332:                         if($login_status==1)",
        "// Line_Reference 333:                             {",
        "// Line_Reference 334:                                 $admin_RET = DBGet(DBQuery(\"SELECT STAFF_ID,la.USERNAME,la.FAILED_LOGIN,la.LAST_LOGIN,la.PROFILE_ID,la.PASSWORD FROM staff s,login_authentication la WHERE PROFILE='$username' AND s.STAFF_ID=$user_validate_id\"));",
        "// Line_Reference 335:                             }",
        "// Line_Reference 339:                     /*$admin_RET = DBGet(DBQuery(\"SELECT STAFF_ID,la.USERNAME,la.FAILED_LOGIN,la.LAST_LOGIN,la.PROFILE_ID FROM staff s,login_authentication la WHERE PROFILE='$username' AND UPPER(la.PASSWORD)=UPPER('$password') AND s.STAFF_ID=la.USER_ID\"));*/",
        "// Line_Reference 355:                         $error[] = \" \"._incorrectUsernameOrPassword.\". \"._pleaseTryAgain.\".\";",
        "// Line_Reference 359:                 $error[] = \" \"._incorrectUsernameOrPassword.\". \"._pleaseTryAgain.\".\";",
        "// Line_Reference 362:             $error[] = \" \"._incorrectUsernameOrPassword.\". \"._pleaseTryAgain.\".\";",
        "// Line_Reference 368:         $_SESSION['LAST_LOGIN'] = $login_RET[1]['LAST_LOGIN'];",
        "// Line_Reference 400:                      ################################## For Inserting into Log tables  ######################################",
        "// Line_Reference 412:             $fname_ins = singleQuoteReplace(\"'\", \"''\", $_SESSION[FIRST_NAME]);",
        "// Line_Reference 413:             $lname_ins = singleQuoteReplace(\"'\", \"''\", $_SESSION[LAST_NAME]);",
        "// Line_Reference 433:                 $staff_info_password_status = VerifyHash($password,$staff_info_password);",
        "// Line_Reference 434:                 if($staff_info_password_status==1) {  $staff_info = $validate_staff_info; }",
        "// Line_Reference 435:                 else { $staff_info = []; }",
        "// Line_Reference 476:                              ############################################For Inserting into Log tables end################################################",
        "// Line_Reference 482:     }",
        "// Line_Reference 483: ",
        "// Line_Reference 484:     elseif (($login_RET && $login_RET[1]['IS_DISABLE'] == 'Y') || ($student_RET && $student_RET[1]['IS_DISABLE'] == 'Y')) {",
        "// Line_Reference 489:                 $error[] = \"\"._eitherYourAccountIsInactiveOrYourAccessPermissionHasBeenRevoked.\".\"._pleaseContactTheSchoolAdministration.\".\";",
        "// Line_Reference 490:             else{",
        "// Line_Reference 491:                $check_acess=DBGet(DBQuery('SELECT OPENSIS_ACCESS FROM staff_school_info WHERE STAFF_ID='.$login_RET[1]['STAFF_ID']));",
        "// Line_Reference 492:                if($check_acess[1]['OPENSIS_ACCESS']=='N')",
        "// Line_Reference 493:                $error[] = \"You do not have portal access. Contact the school administration to enable it.\";",
        "// Line_Reference 494:                else",
        "// Line_Reference 495:                $error[] = \"Your account has been disabled. Contact the school administration to enable your account.\";",
        "// Line_Reference 500:                 $error[] = \"\"._eitherYourAccountIsInactiveOrYourAccessPermissionHasBeenRevoked.\".\"._pleaseContactTheSchoolAdministration.\".\";",
        "// Line_Reference 504:     }",
        "// Line_Reference 505:     elseif ($student_RET) {",
        "// Line_Reference 512: ",
        "// Line_Reference 513: ",
        "// Line_Reference 515:         DBQuery(\"INSERT INTO login_records (SYEAR,STAFF_ID,FIRST_NAME,LAST_NAME,PROFILE,USER_NAME,LOGIN_TIME,FAILLOG_COUNT,IP_ADDRESS,STATUS,SCHOOL_ID) values('\" . $_SESSION['UserSyear'] . \"','\" . $student_RET[1][STUDENT_ID] . \"','\" . singleQuoteReplace(\"'\", \"''\", $student_RET[1][FIRST_NAME]) . \"','\" . singleQuoteReplace(\"'\", \"''\", $student_RET[1][LAST_NAME]) . \"','Student','\" . $student_RET[1][USERNAME] . \"','$date','\" . $student_RET[1][FAILED_LOGIN] . \"','$ip','Success','\" . $student_RET[1][SCHOOL_ID] . \"')\");",
        "// Line_Reference 532:         $_SESSION['LAST_LOGIN'] = $student_RET[1]['LAST_LOGIN'];",
        "// Line_Reference 556:     }",
        "// Line_Reference 557:     else {",
        "// Line_Reference 559:         $openSIS_uname=mysqli_real_escape_string($connection,trim(optional_param('USERNAME', 0, PARAM_RAW)));",
        "// Line_Reference 560:         DBQuery(\"UPDATE login_authentication SET FAILED_LOGIN=FAILED_LOGIN+1 WHERE UPPER(USERNAME)=UPPER('\" . $openSIS_uname. \"')\");",
        "// Line_Reference 571:         $openSIS2_uname=mysqli_real_escape_string($connection,trim(optional_param('USERNAME', 0, PARAM_ALPHAEXT)));",
        "// Line_Reference 582: ",
        "// Line_Reference 592:                     $error[] = \" \"._incorrectUsernameOrPassword.\". \"._pleaseTryAgain.\".\";",
        "// Line_Reference 594:                     $error[] = \"\"._dueToExcessiveIncorrectLoginAttemptsYourAccountHasBeenDisabled.\". \"._contactTheSchoolAdministrationToEnableYourAccount.\".\";",
        "// Line_Reference 596:                 $error[] = \" \"._incorrectUsernameOrPassword.\". \"._pleaseTryAgain.\".\";",
        "// Line_Reference 597: ",
        "// Line_Reference 598: ",
        "// Line_Reference 611:     if ($_REQUEST[staff] == 'na') {",
        "// Line_Reference 630: }",
        "// Line_Reference 631: ",
        "// Line_Reference 632: else {",
        "// Line_Reference 635:             $error[] = \"\"._pleaseProvideUsernameAndPassword.\". \"._pleaseTryAgain.\".\";",
        "// Line_Reference 638:             $error[] = \"\"._pleaseProvideUsername.\". \"._pleaseTryAgain.\".\";",
        "// Line_Reference 641:             $error[] = \"\"._pleaseProvidePassword.\". \"._pleaseTryAgain.\".\";",
        "// Line_Reference 660:         $note[] = ''._yourAccountHasBeenCreated.'.  '._youWillBeNotifiedByEmailWhenItIsVerifiedBySchoolAdministrationAndYouCanLogIn.'.';",
        "// Line_Reference 678:     ?>",
        "// Line_Reference 698:     <?php",
        "// Line_Reference 706: ?>"
    ]
}
