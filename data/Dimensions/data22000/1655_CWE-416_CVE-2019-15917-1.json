{
    "cve_id": "CVE-2019-15917",
    "cve_description": "An issue was discovered in the Linux kernel before 5.0.5. There is a use-after-free issue when hci_uart_register_dev() fails in hci_uart_set_proto() in drivers/bluetooth/hci_ldisc.c.",
    "cve_publish_date": "2019-09-04",
    "cwe_id": "CWE-416",
    "cwe_name": "Use After Free",
    "cwe_description": "The product reuses or references memory after it has been freed. At some point afterward, the memory may be allocated again and saved in another pointer, while the original pointer references a location somewhere within the new allocation. Any operations using the original pointer are no longer valid because the memory \"belongs\" to the code that operates on the new pointer.",
    "commit_message": "Bluetooth: hci_ldisc: Postpone HCI_UART_PROTO_READY bit set in hci_uart_set_proto()\n\ntask A:                                task B:\nhci_uart_set_proto                     flush_to_ldisc\n - p->open(hu) -> h5_open  //alloc h5  - receive_buf\n - set_bit HCI_UART_PROTO_READY         - tty_port_default_receive_buf\n - hci_uart_register_dev                 - tty_ldisc_receive_buf\n                                          - hci_uart_tty_receive\n\t\t\t\t           - test_bit HCI_UART_PROTO_READY\n\t\t\t\t            - h5_recv\n - clear_bit HCI_UART_PROTO_READY             while() {\n - p->open(hu) -> h5_close //free h5\n\t\t\t\t              - h5_rx_3wire_hdr\n\t\t\t\t               - h5_reset()  //use-after-free\n                                              }\n\nIt could use ioctl to set hci uart proto, but there is\na use-after-free issue when hci_uart_register_dev() fail in\nhci_uart_set_proto(), see stack above, fix this by setting\nHCI_UART_PROTO_READY bit only when hci_uart_register_dev()\nreturn success.\n\nReported-by: syzbot+899a33dc0fa0dbaf06a6@syzkaller.appspotmail.com\nSigned-off-by: Kefeng Wang <wangkefeng.wang@huawei.com>\nReviewed-by: Jeremy Cline <jcline@redhat.com>\nSigned-off-by: Marcel Holtmann <marcel@holtmann.org>",
    "type_of_change": "Modification",
    "filename_of_changes": "hci_ldisc.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "1",
    "number_of_lines_deleted_vulnerable_to_cve": "2",
    "vulnerable_lines": [
        "// Line_Reference 699: \tset_bit(HCI_UART_PROTO_READY, &hu->flags);",
        "// Line_Reference 703: \t\tclear_bit(HCI_UART_PROTO_READY, &hu->flags);"
    ]
}
