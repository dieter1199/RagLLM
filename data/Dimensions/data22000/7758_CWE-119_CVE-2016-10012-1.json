{
    "cve_id": "CVE-2016-10012",
    "cve_description": "The shared memory manager (associated with pre-authentication compression) in sshd in OpenSSH before 7.4 does not ensure that a bounds check is enforced by all compilers, which might allows local users to gain privileges by leveraging access to a sandboxed privilege-separation process, related to the m_zback and m_zlib data structures.",
    "cve_publish_date": "2017-01-05",
    "cwe_id": "CWE-119",
    "cwe_name": "Improper Restriction of Operations within the Bounds of a Memory Buffer",
    "cwe_description": "The product performs operations on a memory buffer, but it reads from or writes to a memory location outside the buffer's intended boundary. This may result in read or write operations on unexpected memory locations that could be linked to other variables, data structures, or internal program data.",
    "commit_message": "Remove support for pre-authentication compression. Doing compression\nearly in the protocol probably seemed reasonable in the 1990s, but\ntoday it's clearly a bad idea in terms of both cryptography (cf.\nmultiple compression oracle attacks in TLS) and attack surface.\n\nMoreover, to support it across privilege-separation zlib needed\nthe assistance of a complex shared-memory manager that made the\nrequired attack surface considerably larger.\n\nPrompted by Guido Vranken pointing out a compiler-elided security\ncheck in the shared memory manager found by Stack\n(http://css.csail.mit.edu/stack/); ok deraadt@ markus@\n\nNB. pre-auth authentication has been disabled by default in sshd\nfor >10 years.",
    "type_of_change": "Modification",
    "filename_of_changes": "monitor.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "1",
    "number_of_lines_deleted_vulnerable_to_cve": "47",
    "vulnerable_lines": [
        "// Line_Reference 1: /* $OpenBSD: monitor.c,v 1.165 2016/09/05 13:57:31 djm Exp $ */",
        "// Line_Reference 73: #include \"monitor_mm.h\"",
        "// Line_Reference 338: void",
        "// Line_Reference 339: monitor_sync(struct monitor *pmonitor)",
        "// Line_Reference 340: {",
        "// Line_Reference 341: \tif (options.compression) {",
        "// Line_Reference 342: \t\t/* The member allocation is not visible, so sync it */",
        "// Line_Reference 343: \t\tmm_share_sync(&pmonitor->m_zlib, &pmonitor->m_zback);",
        "// Line_Reference 344: \t}",
        "// Line_Reference 345: }",
        "// Line_Reference 346: ",
        "// Line_Reference 347: /* Allocation functions for zlib */",
        "// Line_Reference 348: static void *",
        "// Line_Reference 349: mm_zalloc(struct mm_master *mm, u_int ncount, u_int size)",
        "// Line_Reference 350: {",
        "// Line_Reference 351: \tif (size == 0 || ncount == 0 || ncount > SIZE_MAX / size)",
        "// Line_Reference 352: \t\tfatal(\"%s: mm_zalloc(%u, %u)\", __func__, ncount, size);",
        "// Line_Reference 353: ",
        "// Line_Reference 354: \treturn mm_malloc(mm, size * ncount);",
        "// Line_Reference 355: }",
        "// Line_Reference 356: ",
        "// Line_Reference 357: static void",
        "// Line_Reference 358: mm_zfree(struct mm_master *mm, void *address)",
        "// Line_Reference 359: {",
        "// Line_Reference 360: \tmm_free(mm, address);",
        "// Line_Reference 361: }",
        "// Line_Reference 362: ",
        "// Line_Reference 1295: ",
        "// Line_Reference 1296: \t/* Update with new address */",
        "// Line_Reference 1297: \tif (options.compression) {",
        "// Line_Reference 1298: \t\tssh_packet_set_compress_hooks(ssh, pmonitor->m_zlib,",
        "// Line_Reference 1299: \t\t    (ssh_packet_comp_alloc_func *)mm_zalloc,",
        "// Line_Reference 1300: \t\t    (ssh_packet_comp_free_func *)mm_zfree);",
        "// Line_Reference 1301: \t}",
        "// Line_Reference 1354: \tstruct ssh *ssh = active_state;\t\t\t/* XXX */",
        "// Line_Reference 1358: ",
        "// Line_Reference 1361: \t/* Used to share zlib space across processes */",
        "// Line_Reference 1362: \tif (options.compression) {",
        "// Line_Reference 1363: \t\tmon->m_zback = mm_create(NULL, MM_MEMSIZE);",
        "// Line_Reference 1364: \t\tmon->m_zlib = mm_create(mon->m_zback, 20 * MM_MEMSIZE);",
        "// Line_Reference 1365: ",
        "// Line_Reference 1366: \t\t/* Compression needs to share state across borders */",
        "// Line_Reference 1367: \t\tssh_packet_set_compress_hooks(ssh, mon->m_zlib,",
        "// Line_Reference 1368: \t\t    (ssh_packet_comp_alloc_func *)mm_zalloc,",
        "// Line_Reference 1369: \t\t    (ssh_packet_comp_free_func *)mm_zfree);",
        "// Line_Reference 1370: \t}",
        "// Line_Reference 1371: "
    ]
}
