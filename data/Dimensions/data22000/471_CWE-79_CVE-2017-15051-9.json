{
    "cve_id": "CVE-2017-15051",
    "cve_description": "Multiple stored cross-site scripting (XSS) vulnerabilities in TeamPass before 2.1.27.9 allow authenticated remote attackers to inject arbitrary web script or HTML via the (1) URL value of an item or (2) user log history. To exploit the vulnerability, the attacker must be first authenticated to the application. For the first one, the attacker has to simply inject XSS code within the URL field of a shared item. For the second one however, the attacker must prepare a payload within its profile, and then ask an administrator to modify its profile. From there, whenever the administrator accesses the log, it can be XSS'ed.",
    "cve_publish_date": "2017-11-27",
    "cwe_id": "CWE-79",
    "cwe_name": "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "cwe_description": "The product does not neutralize or incorrectly neutralizes user-controllable input before it is placed in output that is used as a web page that is served to other users.",
    "commit_message": "2.1.27\n\nSeveral fixes",
    "type_of_change": "Modification",
    "filename_of_changes": "items.queries.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "162",
    "number_of_lines_deleted_vulnerable_to_cve": "71",
    "vulnerable_lines": [
        "// Line_Reference 132:             $label = noHTML(htmlspecialchars_decode($dataReceived['label']));",
        "// Line_Reference 133:             $url = htmlspecialchars_decode($dataReceived['url']);",
        "// Line_Reference 135:             $login = htmlspecialchars_decode($dataReceived['login']);",
        "// Line_Reference 484:                 $label = noHTML(($dataReceived['label']));",
        "// Line_Reference 485:                 $url = noHTML(htmlspecialchars_decode($dataReceived['url']));",
        "// Line_Reference 487:                 $login = noHTML(htmlspecialchars_decode($dataReceived['login']));",
        "// Line_Reference 489:                 $email = noHTML(htmlspecialchars_decode($dataReceived['email']));",
        "// Line_Reference 536:                     (@in_array(",
        "// Line_Reference 537:                         $post_id,",
        "// Line_Reference 538:                         $_SESSION['list_folders_limited'][$post_folder_id]",
        "// Line_Reference 539:                     ))",
        "// Line_Reference 1075:                 $returnValues = '[{\"error\" : \"not_allowed\"}, {\"error_text\" : \"2'.addslashes($LANG['error_not_allowed_to']).'\"}]';",
        "// Line_Reference 1083:             if (null !== $post_item_id",
        "// Line_Reference 1084:                 && empty($post_item_id) === false",
        "// Line_Reference 1412:             $rows_tmp = DB::query(\"SELECT role_id FROM \".prefix_table(\"restriction_to_roles\").\" WHERE item_id=%i\", $post_id);",
        "// Line_Reference 1413:             $myTest = 0;",
        "// Line_Reference 1414:             if (in_array($_SESSION['user_id'], $rows_tmp)) {",
        "// Line_Reference 1415:                 $myTest = 1;",
        "// Line_Reference 1419:             if (null !== filter_input(INPUT_POST, 'salt_key_required', FILTER_SANITIZE_STRING)",
        "// Line_Reference 1420:                 && filter_input(INPUT_POST, 'salt_key_required', FILTER_SANITIZE_STRING) === '1'",
        "// Line_Reference 1421:                 && null !== filter_input(INPUT_POST, 'salt_key_set', FILTER_SANITIZE_STRING)",
        "// Line_Reference 1422:                 && filter_input(INPUT_POST, 'salt_key_set', FILTER_SANITIZE_STRING) === '1'",
        "// Line_Reference 1445:             if (null !== filter_input(INPUT_POST, 'expired_item', FILTER_SANITIZE_STRING)",
        "// Line_Reference 1446:                 && filter_input(INPUT_POST, 'expired_item', FILTER_SANITIZE_STRING) === '1'",
        "// Line_Reference 1462:                     && isset($_SESSION['list_folders_limited'][$post_folder_id])",
        "// Line_Reference 1463:                     && in_array($post_id, $_SESSION['list_folders_limited'][$post_folder_id]))",
        "// Line_Reference 1629:                 if (null !== filter_input(INPUT_POST, 'restricted', FILTER_SANITIZE_STRING)) {",
        "// Line_Reference 1630:                     $arrData['restricted'] = filter_input(INPUT_POST, 'restricted', FILTER_SANITIZE_STRING);",
        "// Line_Reference 1847:                     \"has_change_proposal\" => DB::count()",
        "// Line_Reference 1890:         case \"update_rep\":",
        "// Line_Reference 1901:             $title = htmlspecialchars_decode($dataReceived['title']);",
        "// Line_Reference 1928:                 $dataReceived['folder']",
        "// Line_Reference 1959:                     $dataReceived['folder']",
        "// Line_Reference 1968:                     $dataReceived['folder'],",
        "// Line_Reference 1996:                 $dataReceived['source_folder_id']",
        "// Line_Reference 2003:                 $dataReceived['target_folder_id']",
        "// Line_Reference 2007:             if ($tree->isChildOf($dataReceived['target_folder_id'], $dataReceived['source_folder_id']) === true) {",
        "// Line_Reference 2032:                         'parent_id' => $dataReceived['target_folder_id']",
        "// Line_Reference 2035:                     $dataReceived['source_folder_id']",
        "// Line_Reference 2825:         /*",
        "// Line_Reference 2826:           * CASE",
        "// Line_Reference 2827:           * WANT TO CLIPBOARD PW/LOGIN OF ITEM",
        "// Line_Reference 2828:         */",
        "// Line_Reference 2829:         case \"get_clipboard_item\":",
        "// Line_Reference 2830:             $dataItem = DB::queryfirstrow(",
        "// Line_Reference 2831:                 \"SELECT pw,login,perso FROM \".prefix_table(\"items\").\" WHERE id=%i\",",
        "// Line_Reference 2832:                 $post_id",
        "// Line_Reference 2833:             );",
        "// Line_Reference 2834: ",
        "// Line_Reference 2835:             if (filter_input(INPUT_POST, 'field', FILTER_SANITIZE_STRING) === \"pw\") {",
        "// Line_Reference 2836:                 if ($dataItem['perso'] === '1') {",
        "// Line_Reference 2837:                     $data = cryption(",
        "// Line_Reference 2838:                         $dataItem['pw'],",
        "// Line_Reference 2839:                         $_SESSION['user_settings']['session_psk'],",
        "// Line_Reference 2840:                         \"decrypt\"",
        "// Line_Reference 2841:                     );",
        "// Line_Reference 2842:                 } else {",
        "// Line_Reference 2843:                     $data = cryption(",
        "// Line_Reference 2844:                         $dataItem['pw'],",
        "// Line_Reference 2845:                         \"\",",
        "// Line_Reference 2846:                         \"decrypt\"",
        "// Line_Reference 2847:                     );",
        "// Line_Reference 2848:                 }",
        "// Line_Reference 2849:             } else {",
        "// Line_Reference 2850:                 $data = $dataItem['login'];",
        "// Line_Reference 2851:             }",
        "// Line_Reference 2852:             // Encrypt data to return",
        "// Line_Reference 2853:             echo prepareExchangedData($data, \"encode\");",
        "// Line_Reference 2854:             break;",
        "// Line_Reference 2855: ",
        "// Line_Reference 2863:                 \"SELECT name,id_item,file"
    ]
}
