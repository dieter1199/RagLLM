{
    "cve_id": "CVE-2011-2479",
    "cve_description": "The Linux kernel before 2.6.39 does not properly create transparent huge pages in response to a MAP_PRIVATE mmap system call on /dev/zero, which allows local users to cause a denial of service (system crash) via a crafted application.",
    "cve_publish_date": "2013-03-01",
    "cwe_id": "CWE-399",
    "cwe_name": "Resource Management Errors",
    "cwe_description": "Weaknesses in this category are related to improper management of system resources.",
    "commit_message": "mm: thp: fix /dev/zero MAP_PRIVATE and vm_flags cleanups\n\nThe huge_memory.c THP page fault was allowed to run if vm_ops was null\n(which would succeed for /dev/zero MAP_PRIVATE, as the f_op->mmap wouldn't\nsetup a special vma->vm_ops and it would fallback to regular anonymous\nmemory) but other THP logics weren't fully activated for vmas with vm_file\nnot NULL (/dev/zero has a not NULL vma->vm_file).\n\nSo this removes the vm_file checks so that /dev/zero also can safely use\nTHP (the other albeit safer approach to fix this bug would have been to\nprevent the THP initial page fault to run if vm_file was set).\n\nAfter removing the vm_file checks, this also makes huge_memory.c stricter\nin khugepaged for the DEBUG_VM=y case.  It doesn't replace the vm_file\ncheck with a is_pfn_mapping check (but it keeps checking for VM_PFNMAP\nunder VM_BUG_ON) because for a is_cow_mapping() mapping VM_PFNMAP should\nonly be allowed to exist before the first page fault, and in turn when\nvma->anon_vma is null (so preventing khugepaged registration).  So I tend\nto think the previous comment saying if vm_file was set, VM_PFNMAP might\nhave been set and we could still be registered in khugepaged (despite\nanon_vma was not NULL to be registered in khugepaged) was too paranoid.\nThe is_linear_pfn_mapping check is also I think superfluous (as described\nby comment) but under DEBUG_VM it is safe to stay.\n\nAddresses https://bugzilla.kernel.org/show_bug.cgi?id=33682\n\nSigned-off-by: Andrea Arcangeli <aarcange@redhat.com>\nReported-by: Caspar Zhang <bugs@casparzhang.com>\nAcked-by: Mel Gorman <mel@csn.ul.ie>\nAcked-by: Rik van Riel <riel@redhat.com>\nCc: <stable@kernel.org>\t\t[2.6.38.x]\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
    "type_of_change": "Modification",
    "filename_of_changes": "huge_memory.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "24",
    "number_of_lines_deleted_vulnerable_to_cve": "19",
    "vulnerable_lines": [
        "// Line_Reference 1419: \t\tif (*vm_flags & (VM_HUGEPAGE |",
        "// Line_Reference 1420: \t\t\t\t VM_SHARED   | VM_MAYSHARE   |",
        "// Line_Reference 1421: \t\t\t\t VM_PFNMAP   | VM_IO      | VM_DONTEXPAND |",
        "// Line_Reference 1422: \t\t\t\t VM_RESERVED | VM_HUGETLB | VM_INSERTPAGE |",
        "// Line_Reference 1423: \t\t\t\t VM_MIXEDMAP | VM_SAO))",
        "// Line_Reference 1439: \t\tif (*vm_flags & (VM_NOHUGEPAGE |",
        "// Line_Reference 1440: \t\t\t\t VM_SHARED   | VM_MAYSHARE   |",
        "// Line_Reference 1441: \t\t\t\t VM_PFNMAP   | VM_IO      | VM_DONTEXPAND |",
        "// Line_Reference 1442: \t\t\t\t VM_RESERVED | VM_HUGETLB | VM_INSERTPAGE |",
        "// Line_Reference 1443: \t\t\t\t VM_MIXEDMAP | VM_SAO))",
        "// Line_Reference 1577: \tif (vma->vm_file || vma->vm_ops)",
        "// Line_Reference 1580: \tVM_BUG_ON(is_linear_pfn_mapping(vma) || is_pfn_mapping(vma));",
        "// Line_Reference 1831: \t/* VM_PFNMAP vmas may have vm_ops null but vm_file set */",
        "// Line_Reference 1832: \tif (!vma->anon_vma || vma->vm_ops || vma->vm_file)",
        "// Line_Reference 1836: \tVM_BUG_ON(is_linear_pfn_mapping(vma) || is_pfn_mapping(vma));",
        "// Line_Reference 2069: \t\t/* VM_PFNMAP vmas may have vm_ops null but vm_file set */",
        "// Line_Reference 2070: \t\tif (!vma->anon_vma || vma->vm_ops || vma->vm_file)",
        "// Line_Reference 2074: ",
        "// Line_Reference 2075: \t\tVM_BUG_ON(is_linear_pfn_mapping(vma) || is_pfn_mapping(vma));"
    ]
}
