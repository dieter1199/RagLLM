{
    "cve_id": "CVE-2020-14067",
    "cve_description": "The install_from_hash functionality in Navigate CMS 2.9 does not consider the .phtml extension when examining files within a ZIP archive that may contain PHP code, in check_upload in lib/packages/extensions/extension.class.php and lib/packages/themes/theme.class.php.",
    "cve_publish_date": "2020-06-15",
    "cwe_id": "CWE-434",
    "cwe_name": "Unrestricted Upload of File with Dangerous Type",
    "cwe_description": "The product allows the upload or transfer of dangerous file types that are automatically processed within its environment.",
    "commit_message": "* themes,extensions: secure \"install_from_hash\" functionality",
    "type_of_change": "Modification",
    "filename_of_changes": "extensions.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "47",
    "number_of_lines_deleted_vulnerable_to_cve": "69",
    "vulnerable_lines": [
        "// Line_Reference 163:                 $tmp_file = sys_get_temp_dir().DIRECTORY_SEPARATOR.$query['code'].'.zip';",
        "// Line_Reference 164:                 @core_file_curl($url, $tmp_file);",
        "// Line_Reference 165:                 if(@filesize($tmp_file) == 0)",
        "// Line_Reference 167:                     @unlink($tmp_file);",
        "// Line_Reference 168:                     // core file curl failed, try using file_get_contents...",
        "// Line_Reference 169:                     $tmp = @file_get_contents($url);",
        "// Line_Reference 170:                     if(!empty($tmp))",
        "// Line_Reference 171:                     {",
        "// Line_Reference 172:                         @file_put_contents($tmp_file, $tmp);",
        "// Line_Reference 173:                     }",
        "// Line_Reference 174:                     unset($tmp);",
        "// Line_Reference 177:                 if(@filesize($tmp_file) > 0)",
        "// Line_Reference 179:                     // uncompress ZIP and copy it to the extensions dir",
        "// Line_Reference 180:                     @mkdir(NAVIGATE_PATH.'/plugins/'.$query['code']);",
        "// Line_Reference 182:                     $zip = new ZipArchive();",
        "// Line_Reference 183:                     $zip_open_status = $zip->open($tmp_file);",
        "// Line_Reference 184:                     if($zip_open_status === TRUE)",
        "// Line_Reference 186:                         $zip->extractTo(NAVIGATE_PATH.'/plugins/'.$query['code']);",
        "// Line_Reference 187:                         $zip->close();",
        "// Line_Reference 188: ",
        "// Line_Reference 189:                         $layout->navigate_notification(t(374, \"Item installed successfully.\"), false);",
        "// Line_Reference 191:                     else // zip extraction failed",
        "// Line_Reference 193:                         $layout->navigate_notification('ERROR '.$zip_open_status, true, true);",
        "// Line_Reference 194:                         $error = true;",
        "// Line_Reference 216:                             title: \"'.t(56, \"Unexpected error\").'\"",
        "// Line_Reference 220: ",
        "// Line_Reference 222:         // don't break, we want to show the themes grid right now (theme_upload by browser upload won't trigger)",
        "// Line_Reference 399: ",
        "// Line_Reference 400:             $(window).on(\"load\", function()",
        "// Line_Reference 401:             {",
        "// Line_Reference 402:                 $(\".navigrid-item-buttonset\").each(function(i, el)",
        "// Line_Reference 403:                 {",
        "// Line_Reference 404:                     $(el).hide().css(\"visibility\", \"visible\");",
        "// Line_Reference 405:                     $(el).fadeIn();",
        "// Line_Reference 406:                     $(\".navigrid-extensions-disable\").addClass(\"ui-corner-right\");",
        "// Line_Reference 407:                 });",
        "// Line_Reference 408:             });",
        "// Line_Reference 409: ",
        "// Line_Reference 410:             function navitable_quicksearch(value)",
        "// Line_Reference 411:             {",
        "// Line_Reference 412:                 $(\".navigrid-item\").hide();",
        "// Line_Reference 413: ",
        "// Line_Reference 414:                 if(value==\"\")",
        "// Line_Reference 415:                     $(\".navigrid-item\").show();",
        "// Line_Reference 416:                 else",
        "// Line_Reference 417:                 {",
        "// Line_Reference 418:                     $(\".navigrid-item\").each(function(i, el)",
        "// Line_Reference 419:                     {",
        "// Line_Reference 420:                         var item_text = $(el).text().toLowerCase();",
        "// Line_Reference 421:                         if( item_text.indexOf(value.toLowerCase()) >= 0 )",
        "// Line_Reference 422:                             $(el).fadeIn();",
        "// Line_Reference 423:                     });",
        "// Line_Reference 424:                 }",
        "// Line_Reference 425:             }",
        "// Line_Reference 426: ",
        "// Line_Reference 427:             $(\"#extension-upload-button\").on(\"click\", function()",
        "// Line_Reference 428:             {",
        "// Line_Reference 429:                 $(\"#extension-upload-button\").parent().find(\"form\").remove();",
        "// Line_Reference 430:                 $(\"#extension-upload-button\").after(\\'<form action=\"?fid=extensions&act=extension_upload\" enctype=\"multipart/form-data\" method=\"post\"><input type=\"file\" name=\"extension-upload\" style=\" display: none;\" /><input type=\"hidden\" id=\"_nv_csrf_token\" name=\"_nv_csrf_token\" value=\"\\'+navigatecms.csrf_token+\\'\" /></form>\\');",
        "// Line_Reference 431:                 $(\"#extension-upload-button\").next().find(\"input\").on(\"change\", function()",
        "// Line_Reference 432:                 {",
        "// Line_Reference 433:                     if($(this).val()!=\"\")",
        "// Line_Reference 434:                         $(this).parent().submit();",
        "// Line_Reference 435:                 });",
        "// Line_Reference 436:                 $(\"#extension-upload-button\").next().find(\"input\").trigger(\"click\");",
        "// Line_Reference 437: ",
        "// Line_Reference 438:                 return false;",
        "// Line_Reference 439:             });",
        "// Line_Reference 440: "
    ]
}
