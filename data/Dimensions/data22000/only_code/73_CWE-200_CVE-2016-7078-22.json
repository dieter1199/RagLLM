assert_difference 'Environment.count' do
env = Environment.find(environment.id)
assert_difference('Environment.count', -1) do
assert Environment.find_by_name("env1").puppetclasses.map(&:name).sort == ["a", "b", "c"]
envs = Environment.find_by_name("env1").puppetclasses.map(&:name).sort
assert envs == ["a", "b", "c"]
assert Environment.find_by_name("env3").puppetclasses.map(&:name).sort == []
{"obsolete" =>
{"env1"  => '["a","b","c","_destroy_"]'}
}
}, set_session_user
assert Environment.find_by_name("env1").hosts.count > 0
assert Environment.find_by_name("env1")
{"changed" =>
{"new" =>
{"new" => '{"a":{"new":{}}}'}
}
}, set_session_user
assert(Environment.all.map(&:name).include?('new'), 'Should include environment with name "new"')