{
    "cve_id": "CVE-2021-43403",
    "cve_description": "An issue was discovered in FusionPBX before 4.5.30. The log_viewer.php Log View page allows an authenticated user to choose an arbitrary filename for download (i.e., not necessarily freeswitch.log in the intended directory).",
    "cve_publish_date": "2022-09-29",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "Add better log filename validation.\n\nThis was needed after the a previous pull request that allowed selecting a log file to download.",
    "type_of_change": "Modification",
    "filename_of_changes": "log_viewer.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "47",
    "number_of_lines_deleted_vulnerable_to_cve": "25",
    "vulnerable_lines": [
        "// Line_Reference 20: \tPortions created by the Initial Developer are Copyright (C) 2008-2019",
        "// Line_Reference 47: \tif (!isset($_POST['line_number']) || $_POST['line_number'] == '') { $_POST['line_number'] = 0; }",
        "// Line_Reference 50: \tif (!isset($_POST['sort']) || $_POST['sort'] == '') { $_POST['sort'] = \"asc\"; }",
        "// Line_Reference 53: \tif (!isset($_POST['size']) || strlen($_POST['size']) == 0) { $_POST['size'] = \"32\"; }",
        "// Line_Reference 56: \tif (!isset($_POST['filter'])) { $_POST['filter'] = \"\"; }",
        "// Line_Reference 59: \tif (!isset($_POST['log_file']) || substr($_POST['log_file'],0,14) != \"freeswitch.log\") { $_POST['log_file'] = \"freeswitch.log\"; }",
        "// Line_Reference 63: \t\tif (isset($_GET['n']) && substr($_GET['n'],0,14) == \"freeswitch.log\") {",
        "// Line_Reference 64: \t\t\t$dir = $_SESSION['switch']['log']['dir'];",
        "// Line_Reference 65: \t\t\t$filename = $_GET['n'];",
        "// Line_Reference 66: \t\t\tsession_cache_limiter('public');",
        "// Line_Reference 67: \t\t\t$fd = fopen($dir.\"/\".$filename, \"rb\");",
        "// Line_Reference 68: \t\t\theader(\"Content-Type: binary/octet-stream\");",
        "// Line_Reference 69: \t\t\theader(\"Content-Length: \" . filesize($tmp.\"/\".$filename));",
        "// Line_Reference 70: \t\t\theader('Content-Disposition: attachment; filename=\"'.$filename.'\"');",
        "// Line_Reference 71: \t\t\tfpassthru($fd);",
        "// Line_Reference 72: \t\t\texit;",
        "// Line_Reference 86: \t$files = scandir($_SESSION['switch']['log']['dir']);",
        "// Line_Reference 87: \tforeach($files as $file) if (substr($file,0,14) == \"freeswitch.log\") {",
        "// Line_Reference 88: \t\t\t$selected = ($file == $_POST['log_file']) ? \"selected='selected'\" : \"\";",
        "// Line_Reference 89: \t\t\techo \"\t\t\t<option value='\".$file.\"'\".$selected.\">\".$file.\"</option>\";",
        "// Line_Reference 98: \t\techo button::create(['type'=>'button','label'=>$text['button-download'],'icon'=>$_SESSION['theme']['button_icon_download'],'style'=>'margin-left: 15px;','link'=>'log_viewer.php?a=download&n='.$_POST['log_file']]);",
        "// Line_Reference 118: \t\tif (substr($_POST['log_file'],0,14) == \"freeswitch.log\") {",
        "// Line_Reference 119: \t\t\t$log_file = $_SESSION['switch']['log']['dir'].\"/\".$_POST['log_file'];",
        "// Line_Reference 120: \t\t}",
        "// Line_Reference 299: ?>"
    ]
}
