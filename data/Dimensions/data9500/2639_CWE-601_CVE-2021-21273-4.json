{
    "cve_id": "CVE-2021-21273",
    "cve_description": "Synapse is a Matrix reference homeserver written in python (pypi package matrix-synapse). Matrix is an ecosystem for open federated Instant Messaging and VoIP. In Synapse before version 1.25.0, requests to user provided domains were not restricted to external IP addresses when calculating the key validity for third-party invite events and sending push notifications. This could cause Synapse to make requests to internal infrastructure. The type of request was not controlled by the user, although limited modification of request bodies was possible. For the most thorough protection server administrators should remove the deprecated `federation_ip_range_blacklist` from their settings after upgrading to Synapse v1.25.0 which will result in Synapse using the improved default IP address restrictions. See the new `ip_range_blacklist` and `ip_range_whitelist` settings if more specific control is necessary.",
    "cve_publish_date": "2021-02-26",
    "cwe_id": "CWE-601",
    "cwe_name": "URL Redirection to Untrusted Site ('Open Redirect')",
    "cwe_description": "A web application accepts a user-controlled input that specifies a link to an external site, and uses that link in a Redirect. This simplifies phishing attacks.",
    "commit_message": "Apply an IP range blacklist to push and key revocation requests. (#8821)\n\nReplaces the `federation_ip_range_blacklist` configuration setting with an\r\n`ip_range_blacklist` setting with wider scope. It now applies to:\r\n\r\n* Federation\r\n* Identity servers\r\n* Push notifications\r\n* Checking key validitity for third-party invite events\r\n\r\nThe old `federation_ip_range_blacklist` setting is still honored if present, but\r\nwith reduced scope (it only applies to federation and identity servers).",
    "type_of_change": "Modification",
    "filename_of_changes": "federation.py",
    "code_language": "Python",
    "number_of_lines_added_for_mitigation": "25",
    "number_of_lines_deleted_vulnerable_to_cve": "15",
    "vulnerable_lines": [
        "// Line_Reference 39:         self.federation_ip_range_blacklist = config.get(",
        "// Line_Reference 40:             \"federation_ip_range_blacklist\", []",
        "// Line_Reference 41:         )",
        "// Line_Reference 45:             self.federation_ip_range_blacklist = IPSet(",
        "// Line_Reference 46:                 self.federation_ip_range_blacklist",
        "// Line_Reference 47:             )",
        "// Line_Reference 48: ",
        "// Line_Reference 49:             # Always blacklist 0.0.0.0, ::",
        "// Line_Reference 50:             self.federation_ip_range_blacklist.update([\"0.0.0.0\", \"::\"])",
        "// Line_Reference 79:         # Prevent federation requests from being sent to the following",
        "// Line_Reference 80:         # blacklist IP address CIDR ranges. If this option is not specified, or",
        "// Line_Reference 81:         # specified with an empty list, no ip range blacklist will be enforced.",
        "// Line_Reference 83:         # As of Synapse v1.4.0 this option also affects any outbound requests to identity",
        "// Line_Reference 84:         # servers provided by user input.",
        "// Line_Reference 89:         federation_ip_range_blacklist:"
    ]
}
