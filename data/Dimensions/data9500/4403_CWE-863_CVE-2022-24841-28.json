{
    "cve_id": "CVE-2022-24841",
    "cve_description": "fleetdm/fleet is an open source device management, built on osquery. All versions of fleet making use of the teams feature are affected by this authorization bypass issue. Fleet instances without teams, or with teams but without restricted team accounts are not affected. In affected versions a team admin can erroneously add themselves as admin, maintainer or observer on other teams. Users are advised to upgrade to version 4.13. There are no known workarounds for this issue.",
    "cve_publish_date": "2022-04-18",
    "cwe_id": "CWE-863",
    "cwe_name": "Incorrect Authorization",
    "cwe_description": "The product performs an authorization check when an actor attempts to access a resource or perform an action, but it does not correctly perform the check. This allows attackers to bypass intended access restrictions.",
    "commit_message": "Merge pull request from GHSA-pr2g-j78h-84cr\n\n* Fix access control issues with users\n\n* Fix access control issues with packs\n\n* Fix access control issues with software\n\n* Changes suggested by Martin\n\n* All users can access the global schedule\n\n* Restrict access to activities\n\n* Add explicit test for team admin escalation vuln\n\n* All global users should be able to read all software\n\n* Handbook editor pass - Security - GitHub Security (#5108)\n\n* Update security.md\r\n\r\nAll edits are recorded by line:\r\n\r\n395 replaced “open-source” with “open source”\r\n411 replaced “open-source” with “open source”\r\n439 added “the” before “comment”; replaced “repositories,” with “repositories”\r\n445 deleted “being” before “located”\r\n458 added “and” after “PR”\r\n489 replaced “on” with “in”\r\n493 replaced “open-source” with “open source”; Replaced “privileges,” with “privileges”\r\n\r\n* Update security.md\r\n\r\nline 479\r\n\r\n* Update security.md\r\n\r\nadded (static analysis tools used to identify problems in code) to line 479\n\n* Fix UI\n\n* Fix UI\n\n* revert api v1 to latest in documentation (#5149)\n\n* revert api v1 to latest in documentation\r\n\r\n* Update fleetctl doc page\r\n\r\nCo-authored-by: Noah Talerman <noahtal@umich.edu>\n\n* Add team admin team policy automation; fix e2e\n\n* Update to company page of the handbook (#5164)\n\nUpdated \"Why do we use a wireframe-first approach?\" section of company.md\n\n* removed extra data on smaller screens (#5154)\n\n* Update for team automations; e2e\n\n* Jira Integration: Cypress e2e tests only (#5055)\n\n* Update company.md (#5170)\n\nThis is to update the formatting under \"empathy\" and to fix the spelling of \"help text.\"\r\nThis was done as per @mikermcneil .\r\nThis is related to #https://github.com/fleetdm/fleet/pull/4941 and https://github.com/fleetdm/fleet/issues/4902\n\n* fix update updated_at for aggregated_stats (#5112)\n\nUpdate the updated_at column when using ON DUPLICATE UPDATE so that\r\nthe counts_updated_at is up to date\r\n\r\n* basic sql formatting in code ie whitespace around operators\n\n* Fix e2e test\n\n* Fix tests in server/authz\n\nCo-authored-by: gillespi314 <73313222+gillespi314@users.noreply.github.com>\nCo-authored-by: Desmi-Dizney <99777687+Desmi-Dizney@users.noreply.github.com>\nCo-authored-by: Michal Nicpon <39177923+michalnicp@users.noreply.github.com>\nCo-authored-by: Noah Talerman <noahtal@umich.edu>\nCo-authored-by: Mike Thomas <78363703+mike-j-thomas@users.noreply.github.com>\nCo-authored-by: Martavis Parker <47053705+martavis@users.noreply.github.com>\nCo-authored-by: RachelElysia <71795832+RachelElysia@users.noreply.github.com>",
    "type_of_change": "Modification",
    "filename_of_changes": "users.go",
    "code_language": "Go",
    "number_of_lines_added_for_mitigation": "64",
    "number_of_lines_deleted_vulnerable_to_cve": "21",
    "vulnerable_lines": [
        "// Line_Reference 143: \tif err := svc.authz.Authorize(ctx, &fleet.User{}, fleet.ActionRead); err != nil {",
        "// Line_Reference 220: \tif err := svc.authz.Authorize(ctx, &fleet.User{ID: id}, fleet.ActionRead); err != nil {",
        "// Line_Reference 221: \t\treturn nil, err",
        "// Line_Reference 224: \treturn svc.ds.UserByID(ctx, id)",
        "// Line_Reference 254: \tif err := svc.authz.Authorize(ctx, &fleet.User{}, fleet.ActionRead); err != nil {",
        "// Line_Reference 255: \t\treturn nil, err",
        "// Line_Reference 256: \t}",
        "// Line_Reference 257: ",
        "// Line_Reference 329: \t\t\treturn nil, ctxerr.New(ctx, \"Cannot edit global role as a team member\")",
        "// Line_Reference 339: \t\t\treturn nil, ctxerr.New(ctx, \"Cannot modify teams in that way\")",
        "// Line_Reference 382: \tif err := svc.authz.Authorize(ctx, &fleet.User{ID: id}, fleet.ActionWrite); err != nil {",
        "// Line_Reference 385: ",
        "// Line_Reference 620: \t// If the user is of the right global role, then they can modify the teams",
        "// Line_Reference 621: \tif currentUser.GlobalRole != nil && (*currentUser.GlobalRole == fleet.RoleAdmin || *currentUser.GlobalRole == fleet.RoleMaintainer) {",
        "// Line_Reference 625: \t// otherwise, gather the resulting teams",
        "// Line_Reference 626: \tresultingTeams := make(map[uint]string)",
        "// Line_Reference 628: \t\tresultingTeams[team.ID] = team.Role",
        "// Line_Reference 631: \t// and see which ones were removed or changed from the original",
        "// Line_Reference 634: \t\tif resultingTeams[team.ID] != team.Role {",
        "// Line_Reference 639: \t// then gather the teams the current user is admin for",
        "// Line_Reference 647: \t// and let's check that the teams that were either removed or changed are also teams this user is an admin of"
    ]
}
