{
    "cve_id": "CVE-2024-28195",
    "cve_description": "your_spotify is an open source, self hosted Spotify tracking dashboard. YourSpotify versions < 1.9.0 do not protect the API and login flow against Cross-Site Request Forgery (CSRF). Attackers can use this to execute CSRF attacks on victims, allowing them to retrieve, modify or delete data on the affected YourSpotify instance. Using repeated CSRF attacks, it is also possible to create a new user on the victim instance and promote the new user to instance administrator if a legitimate administrator visits a website prepared by an attacker. Note: Real-world exploitability of this vulnerability depends on the browser version and browser settings in use by the victim. This issue has been addressed in version 1.9.0. Users are advised to upgrade. There are no known workarounds for this vulnerability.",
    "cve_publish_date": "2024-03-13",
    "cwe_id": "NVD-CWE-noinfo",
    "commit_message": "Merge pull request from GHSA-hfgf-99p3-6fjj\n\n* More secure OAuth, fixed frame ancestors\n\n* Change generateRandomString to return base64-encoded entropy\n\nWhile the old implementation also seems to yield correct results, it is\n(at least in my opinion) not obvious that it is correct and sufficiently\nsecure for the following reasons:\n\n1. It takes the output string length as a parameter instead of the\n   required amount of entropy.\n   For cryptographic applications, it is important to know how much\n   entropy any generated secret contains. Therefore, the input to the\n   function should be the required bytes of entropy instead of the\n   output string length.\n\n2. While it uses a rather simple algorithm to convert the entropy bytes\n   to a string, using a well-known and dead simple encoding such as\n   base64 (or hexadecimal, but base64 is more compact) is even easier to\n   verify as \"obviously correct\". In this case URL-safe base64 is chosen\n   because the values are also used in URLs.\n\nAll usages of the function were also changed to accomodate the parameter\nchange to requested bytes of entropy. For all of them 32 bytes (256\nbits) of entropy were chosen, which nicely fits the purpose of being\nused for SHA256 and is definitely enough entropy for things like OAuth\n'state'.\n\n* Apply more restrictive CSP and prevent MIME sniffing for backend\n\nAs the backend doesn't show HTML pages to users, a very restrictive CSP\ncan be used. I'm currently not aware of any active issues, but being as\nrestrictive as possible doesn't hurt, which is what default-src 'none'\ndoes.\n\nAlso, set \"X-Content-Type-Options: nosniff\" to prevent MIME sniffing in\nbrowsers, which can also be an issue in certain circumstances.\n\n* Implement a basic Content-Security-Policy in the client\n\nThis commit implements a basic CSP in the client by setting it as a\n<meta> tag in index.html. Normally it would be preferred to set the CSP\nin a HTTP header, but the react dev server does not seem to support\nthat. However, it is very important to have the CSP active during\ndevelopment to catch errors caused by a restrictive CSP before deploying\nto production.\n\nNote that a header-based CSP is still required to set\n\"frame-ancestors 'none'\" to prevent clickjacking. It is perfectly fine\nto set the CSP both in the <meta> tag and in the HTTP header, both CSPs\nwill be applied.\n\nThere is still room for improvement in the CSP. With some effort, the\nscript-src could be further restricted using a combination of hashes or\nnonces and 'strict-dynamic' to get rid of 'self'. The connect-src could\nalso be restricted to only the backend origin.\n\nThat being said, this is still a very good starting point and much\nbetter than not having a CSP at all.\n\n* Prevent MIME sniffing for the client in production\n\nPrevent MIME sniffing for the client in production by setting the header\n\"X-Content-Type-Options: nosniff\".\n\n* Use only the origin of CLIENT_ENDPOINT for CORS policy\n\nWhen the full CLIENT_ENDPOINT is used to set the CORS policy, the policy\ndoes not get applied correctly when the client is served under a\nsubdirectory. Always using the origin fixes this.\n\n* removed pkce, connect-src is dynamic\n\n* ensuring API_ENDPOINT ends with a /\n\n* make sure api endpoint ends with a slash, updated CORS notice\n\n* fixed comment on index.html\n\n---------\n\nCo-authored-by: Marius Renner <marius@mariusrenner.de>",
    "type_of_change": "Modification",
    "filename_of_changes": "search.ts",
    "code_language": "TypeScript",
    "number_of_lines_added_for_mitigation": "8",
    "number_of_lines_deleted_vulnerable_to_cve": "8",
    "vulnerable_lines": [
        "// Line_Reference 1: import { Router } from 'express';",
        "// Line_Reference 2: import { z } from 'zod';",
        "// Line_Reference 3: import { searchArtist, searchTrack } from '../database';",
        "// Line_Reference 4: import { logger } from '../tools/logger';",
        "// Line_Reference 5: import { isLoggedOrGuest, validating } from '../tools/middleware';",
        "// Line_Reference 6: import { TypedPayload } from '../tools/types';",
        "// Line_Reference 7: import { searchAlbum } from '../database/queries/album';",
        "// Line_Reference 26:         searchAlbum(query)"
    ]
}
