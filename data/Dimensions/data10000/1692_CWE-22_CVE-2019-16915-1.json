{
    "cve_id": "CVE-2019-16915",
    "cve_description": "An issue was discovered in pfSense through 2.4.4-p3. widgets/widgets/picture.widget.php uses the widgetkey parameter directly without sanitization (e.g., a basename call) for a pathname to file_get_contents or file_put_contents.",
    "cve_publish_date": "2019-09-26",
    "cwe_id": "CWE-22",
    "cwe_name": "Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
    "cwe_description": "The product uses external input to construct a pathname that is intended to identify a file or directory that is located underneath a restricted parent directory, but the product does not properly neutralize special elements within the pathname that can cause the pathname to resolve to a location that is outside of the restricted directory.",
    "commit_message": "Picture widget corrections. Fixes #9610\n\n* Sanitize user input before using as path/filenames\n* Use a more accurate method of determining image type on read\n* More sanity checks before reading images.",
    "type_of_change": "Modification",
    "filename_of_changes": "picture.widget.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "34",
    "number_of_lines_deleted_vulnerable_to_cve": "9",
    "vulnerable_lines": [
        "// Line_Reference 28: \t$pic_type_s = explode(\".\", $user_settings['widgets'][$_GET['widgetkey']]['picturewidget_filename']);",
        "// Line_Reference 29: \t$pic_type = $pic_type_s[1];",
        "// Line_Reference 31: \tif ($user_settings['widgets'][$_GET['widgetkey']]['picturewidget']) {",
        "// Line_Reference 32: \t\tif (file_exists(\"/conf/widget_image.\" . $_GET['widgetkey'])) {",
        "// Line_Reference 33: \t\t\t$data = file_get_contents(\"/conf/widget_image.\" . $_GET['widgetkey']);",
        "// Line_Reference 39: \theader(\"Content-Disposition: inline; filename=\\\"{$user_settings['widgets'][$_GET['widgetkey']]['picturewidget_filename']}\\\"\");",
        "// Line_Reference 69: \t\t\t$user_settings['widgets'][$_POST['widgetkey']]['picturewidget'] = \"/conf/widget_image\";",
        "// Line_Reference 70: \t\t\tfile_put_contents(\"/conf/widget_image.\" . $_POST['widgetkey'], $data);",
        "// Line_Reference 71: \t\t\t$user_settings['widgets'][$_POST['widgetkey']]['picturewidget_filename'] = $_FILES['pictfile']['name'];"
    ]
}
