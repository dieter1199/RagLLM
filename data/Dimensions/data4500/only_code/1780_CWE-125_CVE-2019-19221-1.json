size_t wcs_length = len;
if (NULL == archive_wstring_ensure(dest, dest->length + wcs_length + 1))
r = mbrtowc(wcs, mbs, wcs_length, &shift_state);
r = mbtowc(wcs, mbs, wcs_length);
if (errno == EILSEQ) {
++mbs;
--mbs_length;
continue;
} else
break;
wcs_length--;