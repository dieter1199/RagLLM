{
    "cve_id": "CVE-2022-42703",
    "cve_description": "mm/rmap.c in the Linux kernel before 5.19.7 has a use-after-free related to leaf anon_vma double reuse.",
    "cve_publish_date": "2022-10-09",
    "cwe_id": "CWE-416",
    "cwe_name": "Use After Free",
    "cwe_description": "The product reuses or references memory after it has been freed. At some point afterward, the memory may be allocated again and saved in another pointer, while the original pointer references a location somewhere within the new allocation. Any operations using the original pointer are no longer valid because the memory \"belongs\" to the code that operates on the new pointer.",
    "commit_message": "mm/rmap: Fix anon_vma->degree ambiguity leading to double-reuse\n\nanon_vma->degree tracks the combined number of child anon_vmas and VMAs\nthat use the anon_vma as their ->anon_vma.\n\nanon_vma_clone() then assumes that for any anon_vma attached to\nsrc->anon_vma_chain other than src->anon_vma, it is impossible for it to\nbe a leaf node of the VMA tree, meaning that for such VMAs ->degree is\nelevated by 1 because of a child anon_vma, meaning that if ->degree\nequals 1 there are no VMAs that use the anon_vma as their ->anon_vma.\n\nThis assumption is wrong because the ->degree optimization leads to leaf\nnodes being abandoned on anon_vma_clone() - an existing anon_vma is\nreused and no new parent-child relationship is created.  So it is\npossible to reuse an anon_vma for one VMA while it is still tied to\nanother VMA.\n\nThis is an issue because is_mergeable_anon_vma() and its callers assume\nthat if two VMAs have the same ->anon_vma, the list of anon_vmas\nattached to the VMAs is guaranteed to be the same.  When this assumption\nis violated, vma_merge() can merge pages into a VMA that is not attached\nto the corresponding anon_vma, leading to dangling page->mapping\npointers that will be dereferenced during rmap walks.\n\nFix it by separately tracking the number of child anon_vmas and the\nnumber of VMAs using the anon_vma as their ->anon_vma.\n\nFixes: 7a3ef208e662 (\"mm: prevent endless growth of anon_vma hierarchy\")\nCc: stable@kernel.org\nAcked-by: Michal Hocko <mhocko@suse.com>\nAcked-by: Vlastimil Babka <vbabka@suse.cz>\nSigned-off-by: Jann Horn <jannh@google.com>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
    "type_of_change": "Modification",
    "filename_of_changes": "rmap.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "16",
    "number_of_lines_deleted_vulnerable_to_cve": "13",
    "vulnerable_lines": [
        "// Line_Reference 96: \t\tanon_vma->degree = 1;\t/* Reference for first vma */",
        "// Line_Reference 213: \t\t/* vma reference or self-parent link for new root */",
        "// Line_Reference 214: \t\tanon_vma->degree++;",
        "// Line_Reference 299: \t\t * Reuse existing anon_vma if its degree lower than two,",
        "// Line_Reference 300: \t\t * that means it has no vma and only one anon_vma child.",
        "// Line_Reference 302: \t\t * Do not choose parent anon_vma, otherwise first child",
        "// Line_Reference 303: \t\t * will always reuse it. Root anon_vma is never reused:",
        "// Line_Reference 307: \t\t    anon_vma != src->anon_vma && anon_vma->degree < 2)",
        "// Line_Reference 311: \t\tdst->anon_vma->degree++;",
        "// Line_Reference 381: \tanon_vma->parent->degree++;",
        "// Line_Reference 413: \t\t\tanon_vma->parent->degree--;",
        "// Line_Reference 421: \t\tvma->anon_vma->degree--;",
        "// Line_Reference 439: \t\tVM_WARN_ON(anon_vma->degree);"
    ]
}
