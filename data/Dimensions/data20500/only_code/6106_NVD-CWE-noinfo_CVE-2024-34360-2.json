func TestForIDsByEpochEarlyStop(t *testing.T) {
db := sql.InMemory()
e1 := types.EpochID(1)
m := make(map[types.ATXID]struct{})
for i := 0; i < 4; i++ {
sig, err := signing.NewEdSigner()
require.NoError(t, err)
atx, err := newAtx(sig, withPublishEpoch(e1))
require.NoError(t, err)
require.NoError(t, atxs.Add(db, atx))
m[atx.ID()] = struct{}{}
}
n := 0
err := atxs.IterateIDsByEpoch(db, e1, func(total int, id types.ATXID) error {
require.Equal(t, 4, total)
delete(m, id)
n++
if n >= 2 {
return errors.New("test error")
}
return nil
})
require.ErrorContains(t, err, "test error")
require.Equal(t, 2, n)
require.Len(t, m, 2)
}
