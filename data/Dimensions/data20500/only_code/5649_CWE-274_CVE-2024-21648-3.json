// Update the archive
context.getWiki().getVersioningStore().saveXWikiDocArchive(archive, true, context);
// Make sure the cached document archive is updated too
XWikiDocument cachedDocument =
context.getWiki().getDocument(document.getDocumentReferenceWithLocale(), context);
cachedDocument.setDocumentArchive(archive);
context.getWiki().rollback(document, previousVersion.toString(), false, context);