{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "ViewSchedule.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "166",
    "number_of_lines_deleted_vulnerable_to_cve": "132",
    "vulnerable_lines": [
        "// Line_Reference 34: DrawBC(\"\"._scheduling.\" > \" . ProgramTitle());",
        "// Line_Reference 36: ",
        "// Line_Reference 45: ",
        "// Line_Reference 59:         DrawHeaderHome('<div class=\"panel\"><div class=\"panel-heading\"><h6 class=\"panel-title\">'._selectedStudent.' ' . $RET[1]['FIRST_NAME'] . '&nbsp;' . ($RET[1]['MIDDLE_NAME'] ? $RET[1]['MIDDLE_NAME'] . ' ' : '') . $RET[1]['LAST_NAME'] . '&nbsp;' . $RET[1]['NAME_SUFFIX'] . '</h6> <div class=\"heading-elements clearfix\"><span class=\"heading-text\"> <A HREF=Modules.php?modname=' . $_REQUEST['modname'] . '&search_modfunc=list&next_modname=students/Student.php&ajax=true&bottom_back=true&return_session=true target=body><i class=\"icon-square-left\"></i>'._selectedStudent.'</A></span> <div class=\"btn-group heading-btn\"><A HREF=Side.php?student_id=new&modcat=' . $_REQUEST['modcat'] . ' class=\"btn btn-danger btn-xs\">'._deselect.'</A></div></div></div></div>');",
        "// Line_Reference 61:         DrawHeaderHome('<div class=\"panel\"><div class=\"panel-heading\"><h6 class=\"panel-title\">'._selectedStudent.' ' . $RET[1]['FIRST_NAME'] . '&nbsp;' . ($RET[1]['MIDDLE_NAME'] ? $RET[1]['MIDDLE_NAME'] . ' ' : '') . $RET[1]['LAST_NAME'] . '&nbsp;' . $RET[1]['NAME_SUFFIX'] . '</h6> <div class=\"heading-elements clearfix\"><div class=\"btn-group heading-btn\"> <A HREF=Side.php?student_id=new&modcat=' . $_REQUEST['modcat'] . ' class=\"btn btn-danger btn-xs\">'._deselect.'</A></div></div></div></div>');",
        "// Line_Reference 83: ",
        "// Line_Reference 86: ",
        "// Line_Reference 112:     echo \"<FORM name=modify class=no-padding id=modify action=Modules.php?modname=\" . strip_tags(trim($_REQUEST[modname])) . \" &modfunc=modify METHOD=POST>\";",
        "// Line_Reference 138: ",
        "// Line_Reference 139:     echo '<div class=\"panel panel-default\">';",
        "// Line_Reference 153:                 DrawHeader('<div class=\"form-inline\"><div class=\"input-group\">' . PrepareDateSchedule($date, '_date', false, array('submit' => true)) . '<span class=\"input-group-btn\"><INPUT type=submit class=\"btn btn-primary\" value='._go.'></span></div><div class=\"form-group\"><label class=\"control-label\">&nbsp;</label><div class=\"checkbox\"><label><INPUT type=checkbox name=include_inactive value=Y' . ($_REQUEST['include_inactive'] == 'Y' ? \" CHECKED onclick='document.location.href=\\\"\" . PreparePHP_SELF($tmp_REQUEST) . \"&include_inactive=\\\";'\" : \" onclick='document.location.href=\\\"\" . PreparePHP_SELF($tmp_REQUEST) . \"&include_inactive=Y\\\";'\") . '> '._includeInactiveCourses.'</label></div></div></div>', '<div class=\"form-inline\"><div class=\"input-group\"><span class=\"input-group-addon\" id=\"marking_period_id\">'._markingPeriod.'</span>' . $mp . '</div><div class=\"input-group\"><span class=\"input-group-addon\" id=\"view_mode\">'._calendarView.'</span>' . $view_mode . '</div></div>');",
        "// Line_Reference 156:                 DrawHeader('<div class=\"form-inline\"><div class=\"input-group\">' . PrepareDateSchedule($date, '_date', false, array('submit' => true)) . '<span class=\"input-group-btn\"><INPUT type=submit class=\"btn btn-primary\" value='._go.'></span></div></div>', '<div class=\"form-inline\"><div class=\"input-group\"><span class=\"input-group-addon\" id=\"marking_period_id\">'._markingPeriod.' :</span>' . $mp . '</div><div class=\"input-group\"><span class=\"input-group-addon\" id=\"view_mode\">'._calendarView.'</span>' . $view_mode . '</div></div>');",
        "// Line_Reference 164: ",
        "// Line_Reference 165: ",
        "// Line_Reference 166: ",
        "// Line_Reference 172:         s.COURSE_ID,",
        "// Line_Reference 173:         s.COURSE_PERIOD_ID,",
        "// Line_Reference 174:         s.MARKING_PERIOD_ID,",
        "// Line_Reference 175:         s.START_DATE,",
        "// Line_Reference 176:         s.END_DATE,",
        "// Line_Reference 177:         UNIX_TIMESTAMP(s.START_DATE) AS START_EPOCH,",
        "// Line_Reference 178:         UNIX_TIMESTAMP(s.END_DATE) AS END_EPOCH,",
        "// Line_Reference 179:         sp.PERIOD_ID,CONCAT(sp.START_TIME,\\'' . ' - ' . '\\',sp.END_TIME) AS TIME_PERIOD,",
        "// Line_Reference 180:         cpv.PERIOD_ID,",
        "// Line_Reference 181:         cp.MARKING_PERIOD_ID as COURSE_MARKING_PERIOD_ID,",
        "// Line_Reference 182:         cp.MP,",
        "// Line_Reference 183:         sp.SORT_ORDER,",
        "// Line_Reference 184:         c.TITLE,",
        "// Line_Reference 185:         cp.COURSE_PERIOD_ID AS PERIOD_PULLDOWN,",
        "// Line_Reference 186:         s.STUDENT_ID,",
        "// Line_Reference 187:         r.TITLE AS ROOM,",
        "// Line_Reference 188:         cpv.DAYS,",
        "// Line_Reference 189:         SCHEDULER_LOCK",
        "// Line_Reference 190: ",
        "// Line_Reference 191:         FROM schedule s,courses c,course_periods cp,school_periods sp,course_period_var cpv,rooms r",
        "// Line_Reference 192: ",
        "// Line_Reference 193:         WHERE s.COURSE_ID = c.COURSE_ID",
        "// Line_Reference 194:         AND cp.COURSE_PERIOD_ID=cpv.COURSE_PERIOD_ID",
        "// Line_Reference 195:         AND r.ROOM_ID=cpv.ROOM_ID",
        "// Line_Reference 196:         AND s.COURSE_ID = cp.COURSE_ID",
        "// Line_Reference 197:         AND s.COURSE_PERIOD_ID = cp.COURSE_PERIOD_ID",
        "// Line_Reference 198:         AND s.SCHOOL_ID = sp.SCHOOL_ID",
        "// Line_Reference 199:         AND s.SYEAR = c.SYEAR",
        "// Line_Reference 200:         AND sp.PERIOD_ID = cpv.PERIOD_ID",
        "// Line_Reference 201:         AND (cp.MARKING_PERIOD_ID IN (' . implode(',', $mp_ids_arr) . ') OR (cp.MARKING_PERIOD_ID IS NULL AND cp.BEGIN_DATE<=\\'' . date('Y-m-d', strtotime($date)) . '\\' AND cp.END_DATE>=\\'' . date('Y-m-d', strtotime($date)) . '\\'))",
        "// Line_Reference 202:         AND POSITION(\\'' . $day . '\\' IN cpv.days)>0",
        "// Line_Reference 203:         AND s.STUDENT_ID=\\'' . UserStudentID() . '\\'",
        "// Line_Reference 204:         AND s.SYEAR=\\'' . UserSyear() . '\\'",
        "// Line_Reference 205:         AND s.SCHOOL_ID = \\'' . UserSchool() . '\\'",
        "// Line_Reference 206:         AND (cpv.COURSE_PERIOD_DATE=\\'' . date('Y-m-d', strtotime($date)) . '\\' OR cpv.COURSE_PERIOD_DATE IS NULL)",
        "// Line_Reference 207:         AND (\\'' . date('Y-m-d', strtotime($date)) . '\\' BETWEEN cp.BEGIN_DATE AND cp.END_DATE) ';",
        "// Line_Reference 230:                 $columns = array('TIME_PERIOD' => _period,",
        "// Line_Reference 231:                  'TITLE' => _course,",
        "// Line_Reference 232:                  'PERIOD_PULLDOWN' => _periodTeacher,",
        "// Line_Reference 233:                  'ROOM' => _room,",
        "// Line_Reference 234:                  'DAYS' => _daysOfWeek,",
        "// Line_Reference 235:                  'COURSE_MARKING_PERIOD_ID' => _term,",
        "// Line_Reference 236:                  'START_DATE' => _enrolled,",
        "// Line_Reference 237:                  'END_DATE' => _endDateDropDate,",
        "// Line_Reference 238:                  'SCHEDULE_ID' => _moreInfo,",
        "// Line_Reference 243:                 $columns = array('TIME_PERIOD' => _period,",
        "// Line_Reference 244:                  'TITLE' => _course,",
        "// Line_Reference 245:                  'PERIOD_PULLDOWN' => _periodTeacher,",
        "// Line_Reference 246:                  'ROOM' => _room,",
        "// Line_Reference 247:                  'DAYS' => _daysOfWeek,",
        "// Line_Reference 248:                  'COURSE_MARKING_PERIOD_ID' => _term,",
        "// Line_Reference 251: ",
        "// Line_Reference 252: ",
        "// Line_Reference 253: ",
        "// Line_Reference 267:                 DrawHeader($week_range, '<div class=\"form-inline\"><label class=\"control-label\">&nbsp;</label><div class=\"checkbox\"><label><INPUT type=checkbox name=include_inactive value=Y' . ($_REQUEST['include_inactive'] == 'Y' ? \" CHECKED onclick='document.location.href=\\\"\" . PreparePHP_SELF($tmp_REQUEST) . \"&include_inactive=\\\";'\" : \" onclick='document.location.href=\\\"\" . PreparePHP_SELF($tmp_REQUEST) . \"&include_inactive=Y\\\";'\") . '> '._includeInactiveCourses.'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label></div><div class=\"input-group\"><span class=\"input-group-addon\" id=\"marking_period_id\">'._includeInactiveCourses.':</span>' . $mp . '</div><div class=\"input-group\"><span class=\"input-group-addon\" id=\"view_mode\">Calendar View :</span>' . $view_mode . '</div></div>');",
        "// Line_Reference 269:                 DrawHeader($week_range, '<div class=\"form-inline\"><div class=\"input-group\"><span class=\"input-group-addon\" id=\"marking_period_id\">'._markingPeriod.':</span>' . $mp . '</div><div class=\"input-group\"><span class=\"input-group-addon\" id=\"view_mode\">'._markingPeriod.':</span>' . $view_mode . '</div></div>');",
        "// Line_Reference 284:             $mp_start_date=DBGET(DBQuery('SELECT start_date FROM marking_periods WHERE MARKING_PERIOD_ID = '.$_REQUEST['marking_period_id']));",
        "// Line_Reference 287:             $sql_week='SELECT acc.SCHOOL_DATE,cp.TITLE,cp.COURSE_PERIOD_ID,cp.TEACHER_ID,cpv.PERIOD_ID",
        "// Line_Reference 300: ",
        "// Line_Reference 302: ",
        "// Line_Reference 306: ",
        "// Line_Reference 308: ",
        "// Line_Reference 311: ",
        "// Line_Reference 318:             $sql_custom_schedule='SELECT cp.COURSE_PERIOD_ID FROM course_periods cp,schedule s WHERE cp.MARKING_PERIOD_ID IS NULL AND cp.MARKING_PERIOD_ID IS NULL AND cp.BEGIN_DATE<=\\'' . date('Y-m-d', strtotime($date)) . '\\' AND cp.END_DATE>=\\'' . date('Y-m-d', strtotime($date)) . '\\' AND cp.COURSE_PERIOD_ID=s.COURSE_PERIOD_ID ';",
        "// Line_Reference 323: ",
        "// Line_Reference 325: ",
        "// Line_Reference 328: ",
        "// Line_Reference 331: ",
        "// Line_Reference 349:                         if (in_array(date('Y-m-d', $j), $week_RET[date('Y-m-d', $j)][$course['PERIOD_ID']][1])) {",
        "// Line_Reference 352: ",
        "// Line_Reference 354:                             (cpv.COURSE_PERIOD_DATE=\\'' . date('Y-m-d', $j) . '\\' OR cpv.COURSE_PERIOD_DATE IS NULL) AND sch.START_DATE<=  \\'' . date('Y-m-d', $j) . '\\' AND (sch.END_DATE>=\\'' . date('Y-m-d', $j) . '\\' OR sch.END_DATE IS NULL) AND \\'' . date('Y-m-d', $j) . '\\' BETWEEN mp.START_DATE AND mp.END_DATE AND  cpv.PERIOD_ID =\\'' . $course[PERIOD_ID] . '\\'  AND r.ROOM_ID=cpv.ROOM_ID AND sch.STUDENT_ID=\\'' . UserStudentID() . '\\' AND POSITION(\\'' . get_db_day($day) . '\\' IN cpv.days)>0'));",
        "// Line_Reference 358:                                 if (count($custom_schedule) > 0 && count($custom_schedule_cpid) > 0)",
        "// Line_Reference 360:                                 (cpv.COURSE_PERIOD_DATE=\\'' . date('Y-m-d', $j) . '\\' OR cpv.COURSE_PERIOD_DATE IS NULL) AND cpv.PERIOD_ID =\\'' . $course[PERIOD_ID] . '\\'  AND r.ROOM_ID=cpv.ROOM_ID AND POSITION(\\'' . get_db_day($day) . '\\' IN cpv.days)>0 AND cp.COURSE_PERIOD_ID IN (' . $custom_schedule_cpid . ')'));",
        "// Line_Reference 362:                                 if (count($day_RET_custom) > 0)",
        "// Line_Reference 381:                 DrawHeader($month_str, '<div class=\"form-inline\"><label class=\"control-label\">&nbsp;</label><div class=\"checkbox\"><label><INPUT type=checkbox name=include_inactive value=Y' . ($_REQUEST['include_inactive'] == 'Y' ? \" CHECKED onclick='document.location.href=\\\"\" . PreparePHP_SELF($tmp_REQUEST) . \"&include_inactive=\\\";'\" : \" onclick='document.location.href=\\\"\" . PreparePHP_SELF($tmp_REQUEST) . \"&include_inactive=Y\\\";'\") . '> '._includeInactiveCourses.' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label></div><div class=\"input-group\"><span class=\"input-group-addon\" id=\"marking_period_id\">'._includeInactiveCourses.'</span>' . $mp . '</div><div class=\"input-group\"><span class=\"input-group-addon\" id=\"view_mode\">'._includeInactiveCourses.'</span>' . $view_mode . '</div></div>');",
        "// Line_Reference 383:                 DrawHeader($month_str, '<div class=\"form-inline\"><div class=\"input-group\"><span class=\"input-group-addon\" id=\"marking_period_id\">'._markingPeriod.'</span>' . $mp . '</div><div class=\"input-group\"><span class=\"input-group-addon\" id=\"view_mode\">'._markingPeriod.'</span>' . $view_mode . '</div></div>');",
        "// Line_Reference 403:             echo '<div class=\"table-responsive\">';",
        "// Line_Reference 404:             echo \"<TABLE class=\\\"table table-bordered\\\" style=\\\"table-layout: fixed;\\\"><thead><TR align=center>\";",
        "// Line_Reference 405:             echo \"<TD style=\\\"width: 14.25%;\\\">\"._monday.\"</TD><TD style=\\\"width: 14.25%;\\\">\"._tuesday.\"</TD><TD style=\\\"width: 14.25%;\\\">\"._wednesday.\"</TD><TD style=\\\"width: 14.25%;\\\">\"._thursday.\"</TD><TD style=\\\"width: 14.25%;\\\">\"._friday.\"</TD><TD style=\\\"width: 14.25%;\\\">\"._saturday.\"</TD><TD style=\\\"width: 14.25%;\\\">\"._sunday.\"</TD>\";",
        "// Line_Reference 460: ",
        "// Line_Reference 463:                         echo \"<ul class=\\\"list list-square mt-10 no-margin-bottom\\\">\";",
        "// Line_Reference 465:                             $cp_link['START_TIME'] = date(\"g:i A\", strtotime($cp_link[START_TIME]));",
        "// Line_Reference 466:                             echo \"<li><a class=\\\"text-primary\\\" HREF=# title=Details onclick='javascript:window.open(\\\"ForWindow.php?modname=$_REQUEST[modname]&modfunc=detail&date=$date&marking_period_id=$_REQUEST[marking_period_id]&period=$cp_link[PERIOD_ID]\\\",\\\"blank\\\",\\\"width=600,height=450,scrollbars=1\\\"); return false;'>\" . $cp_link[START_TIME] . ' - ' . $cp_link[TITLE] . \"<a></li>\";",
        "// Line_Reference 468:                         echo '</ul>';",
        "// Line_Reference 470:                         echo '<div class=\"text-muted mt-10\">'._scheduleNotAvailable.'</div>';",
        "// Line_Reference 472:                     echo '<font class=text-danger>'._holiday.'</font>';",
        "// Line_Reference 512:                                                                         AND sp.PERIOD_ID=\\'' . $_REQUEST[period] . '\\'",
        "// Line_Reference 516: ",
        "// Line_Reference 519:         }",
        "// Line_Reference 534:             $columns = array('TIME_PERIOD' => _period,",
        "// Line_Reference 535:              'TITLE' => _course,",
        "// Line_Reference 536:              'PERIOD_PULLDOWN' => _periodTeacher,",
        "// Line_Reference 537:              'ROOM' => _room,",
        "// Line_Reference 538:              'DAYS' => _daysOfWeek,",
        "// Line_Reference 539:              'COURSE_MARKING_PERIOD_ID' => _term,",
        "// Line_Reference 540:              'START_DATE' => _enrolled,",
        "// Line_Reference 541:              'END_DATE' => _endDateDropDate,",
        "// Line_Reference 546:             $columns = array('TIME_PERIOD' => _period,",
        "// Line_Reference 547:              'TITLE' => _course,",
        "// Line_Reference 548:              'PERIOD_PULLDOWN' => _periodTeacher,",
        "// Line_Reference 549:              'ROOM' => _room,",
        "// Line_Reference 550:              'DAYS' => _daysOfWeek,",
        "// Line_Reference 551:              'COURSE_MARKING_PERIOD_ID' => _term,",
        "// Line_Reference 558:             echo '<div class=\"panel-body\"><input type=\"button\" class=\"btn btn-default pull-right\" value=\"'._close.'\" onclick=\"window.close();\"></div>';",
        "// Line_Reference 563:         echo ProgramLinkforExport('scheduling/PrintSchedules.php', '<b><i class=\"icon-printer4\"></i></b>'._printSchedule.'', '&modfunc=save&st_arr[]=' . UserStudentID() . '&mp_id=' . $mp_id . '&include_inactive=' . $_REQUEST['include_inactive'] . '&date1=' . $date1 . '&_openSIS_PDF=true', 'target=\"_blank\" class=\"btn btn-success btn-labeled\"') . '</div>';",
        "// Line_Reference 575:     echo '<h5 class=\"modal-title\">'._moreInfo.'</h5>';",
        "// Line_Reference 586: ",
        "// Line_Reference 615:     $sql = 'SELECT cp.COURSE_PERIOD_ID,cp.PARENT_ID,cp.TITLE,cp.MARKING_PERIOD_ID,COALESCE(cp.TOTAL_SEATS-cp.FILLED_SEATS,0) AS AVAILABLE_SEATS FROM course_periods cp,school_periods sp,course_period_var cpv WHERE sp.PERIOD_ID=cpv.PERIOD_ID AND cp.COURSE_PERIOD_ID=cpv.COURSE_PERIOD_ID AND cp.COURSE_ID=\\'' . $THIS_RET[COURSE_ID] . '\\' ORDER BY sp.SORT_ORDER';",
        "// Line_Reference 654:     if ($column == 'END_DATE' && $THIS_RET[END_DATE] != '') {",
        "// Line_Reference 656:         return '<div style=\"white-space: nowrap;\">' . DateInputAY($value != \"\" ? $value : \"\", \"schedule[$THIS_RET[COURSE_PERIOD_ID]][$THIS_RET[START_DATE]][$column]\", $counter . $THIS_RET[COURSE_PERIOD_ID], '', true, $allow_na) . '</div>';",
        "// Line_Reference 660:         return '<div style=\"white-space: nowrap;\">' . DateInputAY($value != \"\" ? $value : \"\", \"schedule[$THIS_RET[COURSE_PERIOD_ID]][$THIS_RET[START_DATE]][$column]\", $counter . $THIS_RET[COURSE_PERIOD_ID], '', true, $allow_na) . '</div>';",
        "// Line_Reference 674:     if ($column == 'END_DATE' && $THIS_RET[END_DATE] != '') {",
        "// Line_Reference 702: ",
        "// Line_Reference 734:     $html .= '<option value=\"day_view\" ' . ($_REQUEST['view_mode'] == 'day_view' ? 'selected' : '') . ' >'._day.'</option>';",
        "// Line_Reference 735:     $html .= '<option value=\"week_view\" ' . ($_REQUEST['view_mode'] == 'week_view' ? 'selected' : '') . '>'._week.'</option>';",
        "// Line_Reference 736:     $html .= '<option value=\"month_view\" ' . ($_REQUEST['view_mode'] == 'month_view' ? 'selected' : '') . '>'._month.'</option>';",
        "// Line_Reference 793:         $html .= \"<a href='javascript:void(0);' class=\\\"text-primary\\\" title=Previous onClick=\\\"window.location='\" . $link . $prev . \"';\\\"><i class=\\\"fa fa-angle-left\\\"></i> \"._prev.\"</a> &nbsp; &nbsp; <span>\" . properDate($_REQUEST[week_range]) . \"&nbsp; - &nbsp;\" . properDate($upper) . \"</span> &nbsp; &nbsp; <a href='javascript:void(0);' title=Next onClick=\\\"window.location='\" . $link . $next . \"';\\\" class=\\\"text-primary\\\">\"._prev.\" <i class=\\\"fa fa-angle-right\\\"></i></a>\";"
    ]
}
