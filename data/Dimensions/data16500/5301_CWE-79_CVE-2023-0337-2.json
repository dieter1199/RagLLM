{
    "cve_id": "CVE-2023-0337",
    "cve_description": "Cross-site Scripting (XSS) - Reflected in GitHub repository lirantal/daloradius prior to master-branch.",
    "cve_publish_date": "2023-01-17",
    "cwe_id": "CWE-79",
    "cwe_name": "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "cwe_description": "The product does not neutralize or incorrectly neutralizes user-controllable input before it is placed in output that is used as a web page that is served to other users.",
    "commit_message": "Fixed acct and hs management (#341)\n\n* Fixed bugs in some accounting related feature\r\n\r\n* Fixed hs management ui components",
    "type_of_change": "Modification",
    "filename_of_changes": "acct-maintenance-cleanup.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "190",
    "number_of_lines_deleted_vulnerable_to_cve": "138",
    "vulnerable_lines": [
        "// Line_Reference 25:     include (\"library/checklogin.php\");",
        "// Line_Reference 30:     isset($_REQUEST['username']) ? $username = trim($_REQUEST['username']) : $username = '';",
        "// Line_Reference 31:     isset($_REQUEST['enddate']) ? $enddate = trim($_REQUEST['enddate']) : $enddate = \"\";",
        "// Line_Reference 32: ",
        "// Line_Reference 33:     $logAction = '';",
        "// Line_Reference 34:     $logDebugSQL = '';",
        "// Line_Reference 35: ",
        "// Line_Reference 36:     if (isset($_POST['submit'])) {",
        "// Line_Reference 37: ",
        "// Line_Reference 38:         if ($username != '') {",
        "// Line_Reference 39: ",
        "// Line_Reference 40:             include 'library/opendb.php';",
        "// Line_Reference 41: ",
        "// Line_Reference 42:             $sql = 'SELECT count(*) FROM ' . $configValues['CONFIG_DB_TBL_RADACCT'] .",
        "// Line_Reference 43:                    ' WHERE username = \"' . $username . '\" AND acctstoptime is NULL;';",
        "// Line_Reference 44: ",
        "// Line_Reference 45:             $res = $dbSocket->query($sql);",
        "// Line_Reference 46: ",
        "// Line_Reference 47:             $logDebugSQL .= $sql . \"\\n\";",
        "// Line_Reference 48: ",
        "// Line_Reference 49:             $row = $res->fetchRow();",
        "// Line_Reference 50: ",
        "// Line_Reference 51:             if($row[0] > 0) {",
        "// Line_Reference 53:                 $sql = 'UPDATE ' . $configValues['CONFIG_DB_TBL_RADACCT'] .",
        "// Line_Reference 54:                        ' SET acctstoptime = NOW(), acctterminatecause = \"Admin-Reset\"'.",
        "// Line_Reference 55:                        ' WHERE username = \"' . $username . '\" AND acctstoptime is NULL;';",
        "// Line_Reference 59:                 $logDebugSQL .= $sql . \"\\n\";",
        "// Line_Reference 60: ",
        "// Line_Reference 61:                 $successMsg = \"Cleaned up stale sessions for username: <b> $username </b>\";",
        "// Line_Reference 62:                 $logAction .= \"Successfully cleaned up stale sessions for username [$username] on page: \";",
        "// Line_Reference 63:             }",
        "// Line_Reference 64:             else {",
        "// Line_Reference 65: ",
        "// Line_Reference 66:                 $failureMsg = \"There are no stale sessions for user [$username]\";",
        "// Line_Reference 67:                 $logAction .= \"Failed performing close stale sessions on user [$username] because there are no stale sessions for that user on page: \";",
        "// Line_Reference 69: ",
        "// Line_Reference 70:             include 'library/closedb.php';",
        "// Line_Reference 71:         }",
        "// Line_Reference 72:         else if ($enddate != '') {",
        "// Line_Reference 73: ",
        "// Line_Reference 74:             include 'library/opendb.php';",
        "// Line_Reference 75: ",
        "// Line_Reference 76:             // delete all stale sessions in the database that occur until $enddate",
        "// Line_Reference 77:             $sql = \"DELETE FROM \".$configValues['CONFIG_DB_TBL_RADACCT'].",
        "// Line_Reference 78:                     \" WHERE AcctStartTime<'\".$dbSocket->escapeSimple($enddate).\"'\".",
        "// Line_Reference 79:                     \" AND (AcctStopTime='0000-00-00 00:00:00' OR AcctStopTime IS NULL)\";",
        "// Line_Reference 80:             $res = $dbSocket->query($sql);",
        "// Line_Reference 81:             $logDebugSQL .= $sql . \"\\n\";",
        "// Line_Reference 82: ",
        "// Line_Reference 83:             $successMsg = \"Cleaned up stale sessions until date: <b> $enddate </b>\";",
        "// Line_Reference 84:             $logAction .= \"Successfully cleaned up stale sessions until date [$enddate] on page: \";",
        "// Line_Reference 85: ",
        "// Line_Reference 86:             include 'library/closedb.php';",
        "// Line_Reference 87: ",
        "// Line_Reference 88:         }",
        "// Line_Reference 89:         else {",
        "// Line_Reference 90:             $failureMsg = \"No username or ending date was entered, please specify a username or ending date for cleaning up stale sessions from the database\";",
        "// Line_Reference 91:             $logAction .= \"Failed cleaning up stale sessions due to lack of username or ending date on page: \";",
        "// Line_Reference 95:     include_once('library/config_read.php');",
        "// Line_Reference 96:     $log = \"visited page: \";",
        "// Line_Reference 97: ",
        "// Line_Reference 98:     include_once(\"lang/main.php\");",
        "// Line_Reference 99: ",
        "// Line_Reference 100:     include(\"library/layout.php\");",
        "// Line_Reference 125:     $navbuttons = array(",
        "// Line_Reference 126:                           'CleanupRecordsByUsername-tab' => t('title','CleanupRecordsByUsername'),",
        "// Line_Reference 127:                           'CleanupRecordsByDate-tab' => t('title','CleanupRecordsByDate'),",
        "// Line_Reference 128:                        );",
        "// Line_Reference 129: ",
        "// Line_Reference 130:     print_tab_navbuttons($navbuttons);",
        "// Line_Reference 131: ?>",
        "// Line_Reference 132: ",
        "// Line_Reference 133: ",
        "// Line_Reference 134:         <form action=\"<?php echo $_SERVER['PHP_SELF']; ?>\" method=\"post\">",
        "// Line_Reference 135: ",
        "// Line_Reference 136: ",
        "// Line_Reference 138:                 <div class=\"tabcontent\" id=\"CleanupRecordsByUsername-tab\" style=\"display: block\">",
        "// Line_Reference 139: ",
        "// Line_Reference 140:                     <fieldset>",
        "// Line_Reference 141: ",
        "// Line_Reference 142:                         <h302> <?php echo t('title','CleanupRecordsByUsername'); ?> </h302>",
        "// Line_Reference 143:                         <br/>",
        "// Line_Reference 144: ",
        "// Line_Reference 145:                         <label for='username' class='form'><?php echo t('all','Username')?></label>",
        "// Line_Reference 146:                         <input name=\"username\" type=\"text\" id=\"usernameEdit\" autocomplete=\"off\"",
        "// Line_Reference 147:                         tooltipText='<?php echo t('Tooltip','Username'); ?> <br/>'",
        "// Line_Reference 148:                         value=\"<?php if (isset($username)) echo $username; ?>\" tabindex=100>",
        "// Line_Reference 150: <?php",
        "// Line_Reference 151:     include_once(\"include/management/autocomplete.php\");",
        "// Line_Reference 152: ",
        "// Line_Reference 153:     if ($autoComplete) {",
        "// Line_Reference 154:         echo \"<script type=\\\"text/javascript\\\">",
        "// Line_Reference 155:                 /** Making usernameEdit interactive **/",
        "// Line_Reference 156:                 autoComEdit = new DHTMLSuite.autoComplete();",
        "// Line_Reference 157:                 autoComEdit.add('usernameEdit','include/management/dynamicAutocomplete.php','_small','getAjaxAutocompleteUsernames');",
        "// Line_Reference 158:                 </script>\";",
        "// Line_Reference 160: ?>",
        "// Line_Reference 161:                         <br/><br/>",
        "// Line_Reference 162:                         <hr><br/>",
        "// Line_Reference 163: ",
        "// Line_Reference 164:                         <input type='submit' name='submit' value='<?php echo t('buttons','apply') ?>' class='button' />",
        "// Line_Reference 165: ",
        "// Line_Reference 166:                     </fieldset>",
        "// Line_Reference 167: ",
        "// Line_Reference 168:                 </div>",
        "// Line_Reference 169: ",
        "// Line_Reference 170:                 <div class=\"tabcontent\" id=\"CleanupRecordsByDate-tab\">",
        "// Line_Reference 171: ",
        "// Line_Reference 172:                     <fieldset>",
        "// Line_Reference 173:                         <h302> <?php echo t('title','CleanupRecordsByDate') ?> </h302>",
        "// Line_Reference 174:                         <br/>",
        "// Line_Reference 175: ",
        "// Line_Reference 176:                         <label for='enddate' class='form'><?php echo t('all','CleanupSessions')?></label>",
        "// Line_Reference 177:                         <input name='enddate' type='text' id='enddate' value='<?php echo $enddate ?>' tabindex=100 />",
        "// Line_Reference 178:                         <img src=\"library/js_date/calendar.gif\" onclick=",
        "// Line_Reference 179:                         \"showChooser(this, 'enddate', 'chooserSpan', 1950, <?php echo date('Y', time());?>, 'Y-m-d H:i:s', true);\" >",
        "// Line_Reference 180: ",
        "// Line_Reference 181:                         <br/><br/>",
        "// Line_Reference 182:                         <hr><br/>",
        "// Line_Reference 183:                         <input type=\"submit\" name=\"submit\" value=\"<?php echo t('buttons','apply') ?>\" tabindex=1000 class='button' />",
        "// Line_Reference 184:                     </fieldset>",
        "// Line_Reference 185: ",
        "// Line_Reference 186:                     <div id=\"chooserSpan\" class=\"dateChooser select-free\"",
        "// Line_Reference 187:                         style=\"display: none; visibility: hidden; width: 160px;\">",
        "// Line_Reference 188:                     </div>",
        "// Line_Reference 190:                 </div>",
        "// Line_Reference 193:     </form>",
        "// Line_Reference 195:         </div><!-- #contentnorightbar -->",
        "// Line_Reference 196: ",
        "// Line_Reference 197:         <div id=\"footer\">",
        "// Line_Reference 198: <?php",
        "// Line_Reference 200:     include('page-footer.php');",
        "// Line_Reference 201: ?>",
        "// Line_Reference 202:         </div><!-- #footer -->",
        "// Line_Reference 203:     </div>",
        "// Line_Reference 204: </div>",
        "// Line_Reference 206: </body>",
        "// Line_Reference 207: </html>"
    ]
}
