global $DB;
if (!\Session::haveRight(\Planning::$rightname, \Planning::READALL)
&& empty($_SESSION['glpigroups'])) {
// User cannot read planning of everyone and has no groups.
break;
}
$groups_criteria = getEntitiesRestrictCriteria(
\Group::getTable(),
'entities_id',
$_SESSION['glpiactiveentities'],
true
);
// Limit to groups visible in planning (see Planning::showAddGroupForm())
$groups_criteria['is_task'] = 1;
// Limit to users groups if user cannot read planning of everyone
if (!\Session::haveRight(\Planning::$rightname, \Planning::READALL)) {
$groups_criteria['id'] = $_SESSION['glpigroups'];
}
$groups_iterator = $DB->request(
[
'FROM'  => \Group::getTable(),
'WHERE' => $groups_criteria,
]
);
if (!\Session::haveRightsOr(\Planning::$rightname, [\Planning::READALL, \Planning::READGROUP])) {
// Can see only personnal planning
$rights = 'id';
} else if (\Session::haveRight(\Planning::$rightname, \Planning::READGROUP)
&& !\Session::haveRight(\Planning::$rightname, \Planning::READALL)) {
// Can see only planning from users sharing same groups
$rights = 'groups';
} else {
// Can see planning from users having rights on planning elements
$rights = ['change', 'problem', 'reminder', 'task', 'projecttask'];
}
$users_iterator = \User::getSqlSearchResult(false, $rights);
