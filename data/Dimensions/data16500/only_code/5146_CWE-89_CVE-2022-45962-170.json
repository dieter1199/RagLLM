error_reporting(1);
ini_set('session.cookie_httponly', 1);
include_once("functions/DelDirectoryFnc.php");
include_once("functions/ParamLibFnc.php");
require_once("functions/PragRepFnc.php");
include_once("RemoveBackup.php");
include('lang/language.php');
include_once("functions/PasswordHashFnc.php");
$error[] = ""._eitherYourAccountIsInactiveOrYourAccessPermissionHasBeenRevoked."."._pleaseContactTheSchoolAdministration.".";
if ($install == 'comp') {
if (is_dir('install')) {
$dir = 'install/'; // IMPORTANT: with '/' at the end
$remove_directory = delete_directory($dir);
}
}
$username = mysqli_real_escape_string($connection,trim(optional_param('USERNAME', '', PARAM_RAW)));
$arr_cookie_options = array (
'expires' => time() + 60*60*24*100,
if($_REQUEST['remember'])
{
$cName='remember_me_name';
$cPwd='remember_me_pwd';
$cLang='remember_me_lang';
setcookie($cPwd, cryptor(optional_param('PASSWORD','',PARAM_RAW), 'ENC'), $arr_cookie_options);
setcookie($cLang, optional_param('language','',PARAM_RAW), time()+60*60*24*100, "/");
}
else
{
setcookie('remember_me_name', 'gone', time()-60*60*24*100, "/");
setcookie('remember_me_pwd', 'gone', time()-60*60*24*100, "/");
setcookie('remember_me_lang', 'gone', time()-60*60*24*100, "/");
$password = str_replace("\'", "",(mysqli_real_escape_string($connection,optional_param('PASSWORD', '', PARAM_RAW))));
$password = str_replace("&", "",(mysqli_real_escape_string($connection,optional_param('PASSWORD', '', PARAM_RAW))));
$password = str_replace("\\", "",(mysqli_real_escape_string($connection,optional_param('PASSWORD', '', PARAM_RAW))));
$login_status = VerifyHash($password,$user_password);
if($login_status==1) {  $login_uniform = $validate_username; }
else { $login_uniform = []; }
$error[] = " "._incorrectUsernameOrPassword.". "._pleaseTryAgain.".";
$error[] = " "._incorrectUsernameOrPassword.". "._pleaseTryAgain.".";
if ($maintain['SYSTEM_MAINTENANCE_SWITCH'] == Y && ( $login_RET || $student_RET)) {
$log_as_admin =[];
foreach($superadmin_login as $val)
{
$login_status = VerifyHash($password,$super_admin_password);
if($login_status==1)
{
$log_as_admin = DBGet(DBQuery("SELECT USER_ID,PROFILE_ID FROM login_authentication WHERE USER_ID=$super_admin_userid AND PROFILE_ID=0"));
}
$error[] = " "._incorrectUsernameOrPassword.". "._pleaseTryAgain.".";
$admin_RET =[];
$admin_RET_Validation = DBGet(DBQuery("SELECT STAFF_ID,la.USERNAME,la.FAILED_LOGIN,la.LAST_LOGIN,la.PROFILE_ID,la.PASSWORD FROM staff s,login_authentication la WHERE PROFILE='$username' AND s.STAFF_ID=la.USER_ID"));
foreach($admin_RET_Validation as $val)
{
$login_status = VerifyHash($password,$user_validate_password);
if($login_status==1)
{
$admin_RET = DBGet(DBQuery("SELECT STAFF_ID,la.USERNAME,la.FAILED_LOGIN,la.LAST_LOGIN,la.PROFILE_ID,la.PASSWORD FROM staff s,login_authentication la WHERE PROFILE='$username' AND s.STAFF_ID=$user_validate_id"));
}
/*$admin_RET = DBGet(DBQuery("SELECT STAFF_ID,la.USERNAME,la.FAILED_LOGIN,la.LAST_LOGIN,la.PROFILE_ID FROM staff s,login_authentication la WHERE PROFILE='$username' AND UPPER(la.PASSWORD)=UPPER('$password') AND s.STAFF_ID=la.USER_ID"));*/
$error[] = " "._incorrectUsernameOrPassword.". "._pleaseTryAgain.".";
$error[] = " "._incorrectUsernameOrPassword.". "._pleaseTryAgain.".";
$error[] = " "._incorrectUsernameOrPassword.". "._pleaseTryAgain.".";
$_SESSION['LAST_LOGIN'] = $login_RET[1]['LAST_LOGIN'];
################################## For Inserting into Log tables  ######################################
$fname_ins = singleQuoteReplace("'", "''", $_SESSION[FIRST_NAME]);
$lname_ins = singleQuoteReplace("'", "''", $_SESSION[LAST_NAME]);
$staff_info_password_status = VerifyHash($password,$staff_info_password);
if($staff_info_password_status==1) {  $staff_info = $validate_staff_info; }
else { $staff_info = []; }
############################################For Inserting into Log tables end################################################
}
elseif (($login_RET && $login_RET[1]['IS_DISABLE'] == 'Y') || ($student_RET && $student_RET[1]['IS_DISABLE'] == 'Y')) {
$error[] = ""._eitherYourAccountIsInactiveOrYourAccessPermissionHasBeenRevoked."."._pleaseContactTheSchoolAdministration.".";
else{
$check_acess=DBGet(DBQuery('SELECT OPENSIS_ACCESS FROM staff_school_info WHERE STAFF_ID='.$login_RET[1]['STAFF_ID']));
if($check_acess[1]['OPENSIS_ACCESS']=='N')
$error[] = "You do not have portal access. Contact the school administration to enable it.";
else
$error[] = "Your account has been disabled. Contact the school administration to enable your account.";
$error[] = ""._eitherYourAccountIsInactiveOrYourAccessPermissionHasBeenRevoked."."._pleaseContactTheSchoolAdministration.".";
}
elseif ($student_RET) {
DBQuery("INSERT INTO login_records (SYEAR,STAFF_ID,FIRST_NAME,LAST_NAME,PROFILE,USER_NAME,LOGIN_TIME,FAILLOG_COUNT,IP_ADDRESS,STATUS,SCHOOL_ID) values('" . $_SESSION['UserSyear'] . "','" . $student_RET[1][STUDENT_ID] . "','" . singleQuoteReplace("'", "''", $student_RET[1][FIRST_NAME]) . "','" . singleQuoteReplace("'", "''", $student_RET[1][LAST_NAME]) . "','Student','" . $student_RET[1][USERNAME] . "','$date','" . $student_RET[1][FAILED_LOGIN] . "','$ip','Success','" . $student_RET[1][SCHOOL_ID] . "')");
$_SESSION['LAST_LOGIN'] = $student_RET[1]['LAST_LOGIN'];
}
else {
$openSIS_uname=mysqli_real_escape_string($connection,trim(optional_param('USERNAME', 0, PARAM_RAW)));
DBQuery("UPDATE login_authentication SET FAILED_LOGIN=FAILED_LOGIN+1 WHERE UPPER(USERNAME)=UPPER('" . $openSIS_uname. "')");
$openSIS2_uname=mysqli_real_escape_string($connection,trim(optional_param('USERNAME', 0, PARAM_ALPHAEXT)));
$error[] = " "._incorrectUsernameOrPassword.". "._pleaseTryAgain.".";
$error[] = ""._dueToExcessiveIncorrectLoginAttemptsYourAccountHasBeenDisabled.". "._contactTheSchoolAdministrationToEnableYourAccount.".";
$error[] = " "._incorrectUsernameOrPassword.". "._pleaseTryAgain.".";
if ($_REQUEST[staff] == 'na') {
}
else {
$error[] = ""._pleaseProvideUsernameAndPassword.". "._pleaseTryAgain.".";
$error[] = ""._pleaseProvideUsername.". "._pleaseTryAgain.".";
$error[] = ""._pleaseProvidePassword.". "._pleaseTryAgain.".";
$note[] = ''._yourAccountHasBeenCreated.'.  '._youWillBeNotifiedByEmailWhenItIsVerifiedBySchoolAdministrationAndYouCanLogIn.'.';
?>
<?php
?>
