{
    "cve_id": "CVE-2021-41171",
    "cve_description": "eLabFTW is an open source electronic lab notebook manager for research teams. In versions of eLabFTW before 4.1.0, it allows attackers to bypass a brute-force protection mechanism by using many different forged PHPSESSID values in HTTP Cookie header. This issue has been addressed by implementing brute force login protection, as recommended by Owasp with Device Cookies. This mechanism will not impact users and will effectively thwart any brute-force attempts at guessing passwords. The only correct way to address this is to upgrade to version 4.1.0. Adding rate limitation upstream of the eLabFTW service is of course a valid option, with or without upgrading.",
    "cve_publish_date": "2021-10-22",
    "cwe_id": "CWE-307",
    "cwe_name": "Improper Restriction of Excessive Authentication Attempts",
    "cwe_description": "The product does not implement sufficient measures to prevent multiple failed authentication attempts within a short time frame, making it more susceptible to brute force attacks.",
    "commit_message": "Add JWT anti brute-force login protection (#2831)\n\n* WIP: better brute force login protection\r\n\r\n* split device token classes\r\n\r\n* mv schema to 63\r\n\r\n* use int(10) in schema too\r\n\r\n* add sysadmin action to clear locked users/devices\r\n\r\n* remove the FK on authfail\r\n\r\n* remove authfail users_id fk constraint in structure.sql\r\n\r\n* catch the invalid device token exception\r\n\r\n* remove the banned users stuff\r\n\r\n* change invalid token message\r\n\r\n* cleanup the exceptions a bit\r\n\r\n* get rid of the useless InvalidCsrfTokenException\r\n\r\n* remove unused js import\r\n\r\n* introduce the AuthenticatedUser and AnonymousUser classes\r\n\r\nand improve the App and init.inc.php files\r\n\r\n* remove the populateFromEmail method from Users\r\n\r\n* get rid of the useless SessionAuth\r\n\r\nand rearrange init Auth and App\r\n\r\n* be more specific about which kind of user can be loaded in App\r\n\r\n* change Update class signature\r\n\r\n* use init.inc.php in ApiController\r\n\r\n* don't store the whole teamconfigarr in app",
    "type_of_change": "Modification",
    "filename_of_changes": "Users.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "20",
    "number_of_lines_deleted_vulnerable_to_cve": "25",
    "vulnerable_lines": [
        "// Line_Reference 16: use Elabftw\\Exceptions\\ResourceNotFoundException;",
        "// Line_Reference 67:      * Create a new user. If no password is provided, it's because we create it from SAML.",
        "// Line_Reference 69:     public function create(string $email, array $teams, string $firstname = '', string $lastname = '', string $password = '', ?int $group = null, bool $forceValidation = false, bool $normalizeTeams = true, bool $alertAdmin = true): int",
        "// Line_Reference 70:     {",
        "// Line_Reference 76:         if ($normalizeTeams) {",
        "// Line_Reference 77:             $teams = $Teams->getTeamsFromIdOrNameOrOrgidArray($teams);",
        "// Line_Reference 78:         }",
        "// Line_Reference 190:     /**",
        "// Line_Reference 191:      * Select by email",
        "// Line_Reference 192:      */",
        "// Line_Reference 193:     public function populateFromEmail(string $email): void",
        "// Line_Reference 194:     {",
        "// Line_Reference 195:         $sql = 'SELECT userid",
        "// Line_Reference 196:             FROM users",
        "// Line_Reference 197:             WHERE email = :email AND archived = 0 AND validated = 1 LIMIT 1';",
        "// Line_Reference 198:         $req = $this->Db->prepare($sql);",
        "// Line_Reference 199:         $req->bindParam(':email', $email);",
        "// Line_Reference 200:         $this->Db->execute($req);",
        "// Line_Reference 201:         $res = $req->fetchColumn();",
        "// Line_Reference 202:         if ($res === false) {",
        "// Line_Reference 203:             throw new ResourceNotFoundException(_('Email not found in database!'));",
        "// Line_Reference 204:         }",
        "// Line_Reference 205:         $this->populate((int) $res);",
        "// Line_Reference 206:     }",
        "// Line_Reference 207: "
    ]
}
