{
    "cve_id": "CVE-2021-3817",
    "cve_description": "wbce_cms is vulnerable to Improper Neutralization of Special Elements used in an SQL Command",
    "cve_publish_date": "2021-12-09",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "add captcha for login forgot",
    "type_of_change": "Modification",
    "filename_of_changes": "form_forgot.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "92",
    "number_of_lines_deleted_vulnerable_to_cve": "69",
    "vulnerable_lines": [
        "// Line_Reference 23:     if($admin->validate_email($sEmail) == false) {",
        "// Line_Reference 24:         $oMsgBox->error($MESSAGE['USERS_INVALID_EMAIL']);",
        "// Line_Reference 25:         $sEmail  = '';",
        "// Line_Reference 27:         // Check if the email exists in the database",
        "// Line_Reference 28:         $sSql  = \"SELECT * FROM `{TP}users` WHERE `email`='\".$sEmail.\"'\";",
        "// Line_Reference 30:         if(($rRow = $database->query($sSql))){",
        "// Line_Reference 31:             if($aUser = $rRow->fetchRow(MYSQLI_ASSOC)) {",
        "// Line_Reference 32:                 if(strlen($aUser['signup_confirmcode']) > 25){",
        "// Line_Reference 33:                     header(\"Location: \".ACCOUNT_URL.\"/signup_continue_page.php?switch=wrong_inputs\");",
        "// Line_Reference 34:                     exit(0); // break up the script here",
        "// Line_Reference 35:                 }",
        "// Line_Reference 36:                 $iUserID = (int) $aUser['user_id'];",
        "// Line_Reference 37:                 // Get the id, username, email, and last_reset from the above db query",
        "// Line_Reference 39:                 // Check if the password has been reset in the last 2 hours",
        "// Line_Reference 40:                 if( ( time() - intval($aUser['last_reset']) ) < (2 * 3600) ) {",
        "// Line_Reference 41:                     // Tell the user that their password cannot be reset more than once per hour",
        "// Line_Reference 42:                     $oMsgBox->error($MESSAGE['FORGOT_PASS_ALREADY_RESET']);",
        "// Line_Reference 43:                 } else {",
        "// Line_Reference 44:                     // current password",
        "// Line_Reference 45:                     $sCurrentPw = $aUser['password'];",
        "// Line_Reference 47:                     // generate new password",
        "// Line_Reference 48:                     $sNewPasswordRaw = $oAccounts->GenerateRandomPassword();",
        "// Line_Reference 49:                     $sNewPasswordEnc = $oAccounts->doPasswordEncode($sNewPasswordRaw);",
        "// Line_Reference 51:                     // prepare E-Mail with login details to send to the user via email",
        "// Line_Reference 52:                     $aTokenReplace = array(",
        "// Line_Reference 53:                         'LOGIN_DISPLAY_NAME'  => $aUser['display_name'],",
        "// Line_Reference 54:                         'LOGIN_NAME'          => $aUser['username'],",
        "// Line_Reference 55:                         'LOGIN_WEBSITE_TITLE' => WEBSITE_TITLE,",
        "// Line_Reference 56:                         'LOGIN_PASSWORD'      => $sNewPasswordRaw,",
        "// Line_Reference 57:                         'LOGIN_URL'           => ACCOUNT_URL . '/login.php'",
        "// Line_Reference 58:                     );",
        "// Line_Reference 60:                     $sOnScreenSwitch    = 'forgot_login_details_sent';",
        "// Line_Reference 61:                     $sEmailTemplateName = 'password_recovery_mail';",
        "// Line_Reference 62:                     $sEmailSubject      = '';",
        "// Line_Reference 63:                     $sMailTo            = $sEmail;",
        "// Line_Reference 65:                     $checkSend = $oAccounts->sendEmail($sMailTo, $aTokenReplace, $sEmailTemplateName, $sEmailSubject);",
        "// Line_Reference 66:                     if ($checkSend === true) {",
        "// Line_Reference 67:                         // update the new password in the database",
        "// Line_Reference 68:                         $aUpdateUser = array(",
        "// Line_Reference 69:                             'user_id'    => $iUserID,",
        "// Line_Reference 70:                             'password'   => $sNewPasswordEnc,",
        "// Line_Reference 71:                             'last_reset' => time(),",
        "// Line_Reference 72:                         );",
        "// Line_Reference 74:                         if($database->updateRow('{TP}users', 'user_id', $aUpdateUser)){",
        "// Line_Reference 75:                             header(\"Location: \".ACCOUNT_URL.\"/signup_continue_page.php?lc=\".$sLC.\"&switch=\".$sOnScreenSwitch.\"&email=\".$sMailTo);",
        "// Line_Reference 76:                             exit(0);",
        "// Line_Reference 77:                         } else {",
        "// Line_Reference 78:                             // Error updating database",
        "// Line_Reference 79:                             $oMsgBox->error($MESSAGE['RECORD_MODIFIED_FAILED']);",
        "// Line_Reference 80:                             if(WB_DEBUG) {",
        "// Line_Reference 81:                                 $oMsgBox->error($database->get_error().'<br />'.$sSql);",
        "// Line_Reference 83:                         }",
        "// Line_Reference 85:                     } else {",
        "// Line_Reference 86:                         // tell user: WRONG INPUTS",
        "// Line_Reference 87:                         $aUpdateUser = array(",
        "// Line_Reference 88:                             'user_id'    => $aUser['user_id'],",
        "// Line_Reference 89:                             'password'   => $sCurrentPw",
        "// Line_Reference 90:                         );",
        "// Line_Reference 91:                         $database->updateRow('{TP}users', 'user_id', $aUpdateUser);",
        "// Line_Reference 92:                         header(\"Location: \".ACCOUNT_URL.\"/signup_continue_page.php?lc=\".$sLC.\"&switch=wrong_inputs&from=resend_forgot_pass&mail_err=\".$checkSend);",
        "// Line_Reference 93:                         exit(0);",
        "// Line_Reference 96:             } else { // no record found - Email doesn't exist, so tell the user",
        "// Line_Reference 97:                 $oMsgBox->error($MESSAGE['FORGOT_PASS_EMAIL_NOT_FOUND']);",
        "// Line_Reference 98:             }",
        "// Line_Reference 99:         } else {",
        "// Line_Reference 100:             // Query failed",
        "// Line_Reference 101:             if(WB_DEBUG) {",
        "// Line_Reference 102:                 $oMsgBox->error('SystemError:: Database query failed!');",
        "// Line_Reference 103:                 $oMsgBox->error($database->get_error().'<br />'.$sSql);"
    ]
}
