{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "ReportCards.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "92",
    "number_of_lines_deleted_vulnerable_to_cve": "93",
    "vulnerable_lines": [
        "// Line_Reference 34: if(isset($_SESSION['student_id']) && $_SESSION['student_id'] != '')",
        "// Line_Reference 35: {",
        "// Line_Reference 47:     if (count($_REQUEST['mp_arr']) && count($_REQUEST['st_arr'])) {",
        "// Line_Reference 48: //    if (count($_REQUEST['mp_arr']) && count($_REQUEST['unused'])) {",
        "// Line_Reference 52: //        $st_list = '\\'' . implode('\\',\\'', $_REQUEST['unused']) . '\\'';",
        "// Line_Reference 54: ",
        "// Line_Reference 58:         if (($_REQUEST['elements']['period_absences'] == 'Y' && !$_REQUEST['elements']['grade_type']) || ($_REQUEST['elements']['period_absences'] == 'Y' && $_REQUEST['elements']['grade_type'] && $_REQUEST['elements']['percents'] ))",
        "// Line_Reference 65:             $extra['SELECT'] .=\",sg1.weighted_gp as GPA\";",
        "// Line_Reference 66:         if (($_REQUEST['elements']['comments'] == 'Y' && !$_REQUEST['elements']['grade_type'] ) || ($_REQUEST['elements']['comments'] == 'Y' && $_REQUEST['elements']['grade_type'] && $_REQUEST['elements']['percents']))",
        "// Line_Reference 81:         if (($_REQUEST['elements']['comments'] == 'Y') || ($_REQUEST['elements']['comments'] == 'Y' && $_REQUEST['elements']['percents'] )) {",
        "// Line_Reference 97:         if ((($_REQUEST['elements']['mp_tardies'] == 'Y' || $_REQUEST['elements']['ytd_tardies'] == 'Y') && !$_REQUEST['elements']['grade_type']) || (($_REQUEST['elements']['mp_tardies'] == 'Y' || $_REQUEST['elements']['ytd_tardies'] == 'Y') && $_REQUEST['elements']['grade_type'] && $_REQUEST['elements']['percents'] )) {",
        "// Line_Reference 120:             $columns = array('COURSE_TITLE' =>_course);",
        "// Line_Reference 122:                 $columns += array('TEACHER' =>_teacher);",
        "// Line_Reference 146:                     echo \"<tr><td width=105>\" . DrawLogo() . \"</td><td  style=\\\"font-size:15px; font-weight:bold; padding-top:20px;\\\">\" . GetSchool(UserSchool()) . ' (' . $cur_session . ')' . \"<div style=\\\"font-size:12px;\\\">\"._studentReportCard.\"</div></td><td align=right style=\\\"padding-top:20px\\\">\" . ProperDate(DBDate()) . \"<br \\>\"._poweredByOpenSis.\"</td></tr><tr><td colspan=3 style=\\\"border-top:1px solid #333;\\\">&nbsp;</td></tr></table>\";",
        "// Line_Reference 150:                         $comments_arr_key = count($all_commentsA_RET) > 0;",
        "// Line_Reference 155:                         $commentc='';",
        "// Line_Reference 159:                             $commentc=$mps[$last_mp][1]['COMMENT_TITLE'];",
        "// Line_Reference 169:                                 $total_grade_point += ($mps[$mpkey][1]['WEIGHTED_GP'] * $mps[$mpkey][1]['CREDIT_ATTEMPTED'] );",
        "// Line_Reference 171:                             }",
        "// Line_Reference 172:                             elseif ($mps[key($mps)][1]['UNWEIGHTED_GP']) {",
        "// Line_Reference 176:                                     $mpkey = key($mps);",
        "// Line_Reference 177:                                 $total_grade_point += ($mps[$mpkey][1]['UNWEIGHTED_GP'] * $mps[$mpkey][1]['CREDIT_ATTEMPTED'] );",
        "// Line_Reference 196: //                                               if(count($config_RET))",
        "// Line_Reference 197: //\t\t\tforeach($config_RET as $title=>$value)",
        "// Line_Reference 198: //                        {",
        "// Line_Reference 199: //                                $unused_var=explode('_',$value[1]['VALUE']);",
        "// Line_Reference 200: //                                $programconfig[$staff_id][$title] =$unused_var[0];",
        "// Line_Reference 201: ////\t\t\t\t$programconfig[$staff_id][$title] = rtrim($value[1]['VALUE'],'_'.$course_period_id);",
        "// Line_Reference 202: //                        }",
        "// Line_Reference 203: //\t\telse",
        "// Line_Reference 204: //\t\t\t$programconfig[$staff_id] = true;",
        "// Line_Reference 240:                                     }",
        "// Line_Reference 241:                                     else {",
        "// Line_Reference 251: //                                                        if($_SESSION['ROUNDING']=='UP')",
        "// Line_Reference 252: //                                                            $mps[$mp][1]['GRADE_PERCENT'] = ceil($mps[$mp][1]['GRADE_PERCENT']);",
        "// Line_Reference 253: //                                                    elseif($_SESSION['ROUNDING']=='DOWN')",
        "// Line_Reference 254: //                                                            $mps[$mp][1]['GRADE_PERCENT'] = floor($mps[$mp][1]['GRADE_PERCENT']);",
        "// Line_Reference 255: //                                                    elseif($_SESSION['ROUNDING']=='NORMAL')",
        "// Line_Reference 256: //                                                            $mps[$mp][1]['GRADE_PERCENT'] = round($mps[$mp][1]['GRADE_PERCENT']);",
        "// Line_Reference 260: //",
        "// Line_Reference 286:                                 if($commentc!='')",
        "// Line_Reference 287:                                 $grades_RET[$i]['COMMENT'] .= $sep .$commentc;",
        "// Line_Reference 289:                                  //   $grades_RET[$i]['COMMENT'] .= $sep . $mps[$last_mp][1]['COMMENT_TITLE'];",
        "// Line_Reference 308:                             echo '<tr><td><strong>'._studentName.' :</strong></td>';",
        "// Line_Reference 310:                             echo '<tr><td><strong>'._studentId.' :</strong></td>';",
        "// Line_Reference 312:                             echo '<tr><td><strong>'._alternateId.' :</strong></td>';",
        "// Line_Reference 314:                             echo '<tr><td><strong>'._studentGrade.' :</strong></td>';",
        "// Line_Reference 324:                                 $mp_absences = '<strong>'._dailyAbsencesThis.' ' . GetMP($last_mp, 'TITLE') . ' :</strong> ' . $count;",
        "// Line_Reference 332:                                 echo '<td><strong>'._yearToDateDailyAbsences.' :</strong> ' . $count.'</td>';",
        "// Line_Reference 333:                                 echo '<td align=\"right\">'.$mp_absences.'</td>';",
        "// Line_Reference 362:                             ListOutputPrint($grades_RET, $columns, '', '', array(), array(), array('print' =>false));",
        "// Line_Reference 366:                                 $personalizations = array('^n' => ($mps[key($mps)][1]['NICKNAME'] ? $mps[key($mps)][1]['NICKNAME'] : $mps[key($mps)][1]['FIRST_NAME']),",
        "// Line_Reference 367:                                     '^s' => ($gender == 'M' ? 'his' : ($gender == 'F' ? 'her' : 'his/her')));",
        "// Line_Reference 369:                                 echo '<TABLE width=100%><TR><TD colspan=2><b>'._explanationOfCommentCodes.'</b></TD>';",
        "// Line_Reference 398:                             } echo '<br/><br/>';",
        "// Line_Reference 416: ",
        "// Line_Reference 421:     DrawBC(\"\"._gradebook.\" > \" . ProgramTitle());",
        "// Line_Reference 424:         echo \"<FORM action=ForExport.php?modname=\" . strip_tags(trim($_REQUEST[modname])) . \"&modfunc=save&include_inactive=\" . strip_tags(trim($_REQUEST[include_inactive])) . \"&_openSIS_PDF=true&head_html=Student+Report+Card method=POST target=_blank>\";",
        "// Line_Reference 429:         $extra['extra_header_left'] = '<h5 class=\"text-primary no-margin-top\">'._includeOnReportCard.':</h5>';",
        "// Line_Reference 431:         $extra['extra_header_left'] .= '<div class=\"col-md-6 col-lg-4\"><div class=\"form-group\"><div class=\"checkbox checkbox-switch switch-success switch-xs\"><label><INPUT type=checkbox name=elements[teacher] value=Y CHECKED><span></span>'._teacher.'</label></div></div></div>';",
        "// Line_Reference 432:         $extra['extra_header_left'] .= '<div class=\"col-md-6 col-lg-4\"><div class=\"form-group\"><div class=\"checkbox checkbox-switch switch-success switch-xs\"><label><INPUT type=checkbox name=elements[signature] value=Y><span></span>'._includeSignatureLine.'</label></div></div></div>';",
        "// Line_Reference 433:         $extra['extra_header_left'] .= '<div class=\"col-md-6 col-lg-4\"><div class=\"form-group\"><div class=\"checkbox checkbox-switch switch-success switch-xs\"><label><INPUT type=checkbox name=elements[comments] value=Y CHECKED><span></span>'._comments.'</label></div></div></div>';",
        "// Line_Reference 434:         $extra['extra_header_left'] .= '<div class=\"col-md-6 col-lg-4\"><div class=\"form-group\"><div class=\"checkbox checkbox-switch switch-success switch-xs\"><label><INPUT type=checkbox name=elements[percents] value=Y><span></span>'._percents.'</label></div></div></div>';",
        "// Line_Reference 435:         $extra['extra_header_left'] .= '<div class=\"col-md-6 col-lg-4\"><div class=\"form-group\"><div class=\"checkbox checkbox-switch switch-success switch-xs\"><label><INPUT type=checkbox name=elements[ytd_absences] value=Y CHECKED><span></span>'._yearToDateDailyAbsences.'</label></div></div></div>';",
        "// Line_Reference 436:         $extra['extra_header_left'] .= '<div class=\"col-md-6 col-lg-4\"><div class=\"form-group\"><div class=\"checkbox checkbox-switch switch-success switch-xs\"><label><INPUT type=checkbox name=elements[mp_absences] value=Y' . (GetMP(UserMP(), 'SORT_ORDER') != 1 ? ' CHECKED' : '') . '><span></span>'._dailyAbsencesThisMarkingPeriod.'</label></div></div></div>';",
        "// Line_Reference 437:         $extra['extra_header_left'] .= '<div class=\"col-md-6 col-lg-4 form-inline\"><div class=\"form-group\"><div class=\"checkbox checkbox-switch switch-success switch-xs\"><label><INPUT type=checkbox name=elements[ytd_tardies] value=Y><span></span>'._otherAttendanceYearToDate.' :</label></div> <SELECT name=\"ytd_tardies_code\" class=\"form-control input-xs\">';",
        "// Line_Reference 441:         $extra['extra_header_left'] .= '<div class=\"col-md-6 col-lg-4 form-inline\"><div class=\"form-group\"><div class=\"checkbox checkbox-switch switch-success switch-success switch-xs\"><label><INPUT type=checkbox name=elements[mp_tardies] value=Y><span></span>'._otherAttendanceThisMarkingPeriod.':</label></div> <SELECT class=\"form-control input-xs\" name=\"mp_tardies_code\">';",
        "// Line_Reference 445:         $extra['extra_header_left'] .= '<div class=\"col-md-6 col-lg-4\"><div class=\"form-group\"><div class=\"checkbox checkbox-switch switch-success switch-xs\"><label><INPUT type=checkbox name=elements[period_absences] value=Y><span></span>'._periodByPeriodAbsences.'</label></div></div></div>';",
        "// Line_Reference 446:         $extra['extra_header_left'] .= '<div class=\"col-md-6 col-lg-4\"><div class=\"form-group\"><div class=\"checkbox checkbox-switch switch-success switch-xs\"><label><INPUT type=checkbox name=elements[gpa] value=Y><span></span>'._gpa.'</label></div></div></div>';",
        "// Line_Reference 459:         $extra['extra_header_left'] .= '<h5 class=\"text-primary\">'._markingPeriods.'</h5>';",
        "// Line_Reference 464:                 $qtr1=$qtr['MARKING_PERIOD_ID'];",
        "// Line_Reference 473: ",
        "// Line_Reference 475:                 $extra['extra_header_left'] .= '<label class=\"checkbox-inline\"><INPUT class=\"styled\" type=checkbox name=mp_arr[] value=E' . $qtr1 . ' onclick=\"reportCardGpaChk();\">' . GetMP($qtr1, 'SHORT_NAME') . ' Exam</label>';",
        "// Line_Reference 476:                 }",
        "// Line_Reference 495:     $extra['link'] = array('FULL_NAME' =>false);",
        "// Line_Reference 497:     if(isset($_SESSION['student_id']) && $_SESSION['student_id'] != '')",
        "// Line_Reference 498:     {",
        "// Line_Reference 502: //    $extra['columns_before'] = array('CHECKBOX' => '</A><INPUT type=checkbox value=Y name=controller checked onclick=\"checkAll(this.form,this.form.controller.checked,\\'st_arr\\');\"><A>');",
        "// Line_Reference 503:     $extra['columns_before'] = array('CHECKBOX' => '</A><INPUT type=checkbox value=Y name=controller onclick=\"checkAll(this.form,this.form.controller.checked,\\'st_arr\\');\"><A>');",
        "// Line_Reference 504: //    $extra['columns_before'] = array('CHECKBOX' => '</A><INPUT type=checkbox value=Y name=controller onclick=\"checkAllDtMod(this,\\'st_arr\\');\"><A>');",
        "// Line_Reference 539:             echo '<div class=\"text-right p-b-20 p-r-20\"><INPUT type=submit class=\"btn btn-primary\" value=\\''._createReportCardsForSelectedStudents.'\\'></div>';",
        "// Line_Reference 552:     echo '<h4 class=\"modal-title\">'._chooseCourse.'</h4>';",
        "// Line_Reference 563:     echo '<h6>' . count($subjects_RET) . ((count($subjects_RET) == 1) ? ' '._subjectWas : ' '._subjectsWere) . ' '._found.'.</h6>';",
        "// Line_Reference 565:         echo '<table class=\"table table-bordered\"><thead><tr class=\"alpha-grey\"><th>'._subject.'</th></tr></thead><tbody>';",
        "// Line_Reference 581: function _makeChooseCheckbox($value, $title) {",
        "// Line_Reference 583: ",
        "// Line_Reference 584: ",
        "// Line_Reference 585:     return '<INPUT type=checkbox name=st_arr[] value=' . $value . '>';",
        "// Line_Reference 586: ",
        "// Line_Reference 587: //    return \"<input name=unused_var[$THIS_RET[STUDENT_ID]] value=\" . $THIS_RET[STUDENT_ID] . \"  type='checkbox' id=$THIS_RET[STUDENT_ID] onClick='setHiddenCheckboxStudents(\\\"st_arr[$THIS_RET[STUDENT_ID]]\\\",this,$THIS_RET[STUDENT_ID]);' />\";",
        "// Line_Reference 590: function _makeTeacher($teacher, $column) {",
        "// Line_Reference 596: ",
        "// Line_Reference 597: ?>"
    ]
}
