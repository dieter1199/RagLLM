cur.execute("SELECT 1 FROM pg_database WHERE datname='{}';".format(db_name))
cur.execute("SELECT 1 FROM pg_roles WHERE rolname='{}';".format(db_user))
create_role = "CREATE USER {db_username} WITH PASSWORD '{db_pwd}';".format(**connection_dict)
drop_role = "DROP ROLE {db_username};".format(**connection_dict)
grant_role = 'GRANT {db_username} TO "{postgraas_user}";'.format(
db_username=connection_dict['db_username'], postgraas_user=get_normalized_username(config['username'])
)
create_database = "CREATE DATABASE {db_name} OWNER {db_username};".format(**connection_dict)
cur.execute(create_role)
cur.execute(grant_role)
# saidly 'CREATE DATABASE' cannot run inside a transaction block
cur.execute(create_database)
cur.execute(drop_role)