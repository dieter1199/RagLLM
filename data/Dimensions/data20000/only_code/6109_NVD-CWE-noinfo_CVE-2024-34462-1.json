{
response = error; /* return 304 or 416 */
}
{
//   [self debugWithFormat: @"should fetch body part: %@",
data = [self fetchBLOB];
if (data)
{
//   [self debugWithFormat:@"  fetched %d bytes: %@", [data length],
// 	[self partInfo]];
response = [localContext response];
mimeType = [self davContentType];
if ([mimeType isEqualToString: @"application/x-xpinstall"])
mimeType = @"application/octet-stream";
else if (!asAttachment)
mimeType = [self contentTypeForBodyPartInfo: [self partInfo]];
[response setHeader: mimeType forKey: @"content-type"];
[response setHeader: [NSString stringWithFormat:@"%d", (int)[data length]]
forKey: @"content-length"];
if (asAttachment)
{
fileName = [self filename];
if ([fileName length])
[response setHeader: [NSString stringWithFormat: @"attachment; filename*=\"utf-8''%@\"",
[fileName stringByEscapingURL]]
forKey: @"content-disposition"];
}
etag = [self davEntityTag];
if (etag)
[response setHeader: etag forKey: @"etag"];
[response setContent: data];
}
response = [NSException exceptionWithHTTPStatus: 404 /* not found */
reason: @"did not find body part"];
}
