$dbh->do("update users set magic=$magic where id=$uid");
$dbh->do("update users set session_stamp=now() where id=$uid");
my $sth = $dbh->prepare("select magic, UNIX_TIMESTAMP(now())-UNIX_TIMESTAMP(session_stamp) as elapsed from users where id=$uid");
$sth->execute;
$dbh->do("update users set session_stamp=now(), magic=$new_magic where id=$uid");
# Put magic into cgi query.
#    my $vars = $q->Vars;
#    $vars->{'magic'} = $new_magic;
# Successfully continued session...
my $sth = $dbh->prepare("select access from users where id=$uid");
$sth->execute;
my $sth = $dbh->prepare("insert into log (user,action,cdata1) values($uid,'accessdenied','$action')");
$sth->execute;
my $sth = $dbh->prepare("select magic from users where id=$uid");
$sth->execute;