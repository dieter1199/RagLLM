{
    "cve_id": "CVE-2018-20836",
    "cve_description": "An issue was discovered in the Linux kernel before 4.20. There is a race condition in smp_task_timedout() and smp_task_done() in drivers/scsi/libsas/sas_expander.c, leading to a use-after-free.",
    "cve_publish_date": "2019-05-07",
    "cwe_id": "CWE-362",
    "cwe_name": "Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')",
    "cwe_description": "The product contains a code sequence that can run concurrently with other code, and the code sequence requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code sequence that is operating concurrently.",
    "commit_message": "scsi: libsas: fix a race condition when smp task timeout\n\nWhen the lldd is processing the complete sas task in interrupt and set the\ntask stat as SAS_TASK_STATE_DONE, the smp timeout timer is able to be\ntriggered at the same time. And smp_task_timedout() will complete the task\nwheter the SAS_TASK_STATE_DONE is set or not. Then the sas task may freed\nbefore lldd end the interrupt process. Thus a use-after-free will happen.\n\nFix this by calling the complete() only when SAS_TASK_STATE_DONE is not\nset. And remove the check of the return value of the del_timer(). Once the\nLLDD sets DONE, it must call task->done(), which will call\nsmp_task_done()->complete() and the task will be completed and freed\ncorrectly.\n\nReported-by: chenxiang <chenxiang66@hisilicon.com>\nSigned-off-by: Jason Yan <yanaijie@huawei.com>\nCC: John Garry <john.garry@huawei.com>\nCC: Johannes Thumshirn <jthumshirn@suse.de>\nCC: Ewan Milne <emilne@redhat.com>\nCC: Christoph Hellwig <hch@lst.de>\nCC: Tomas Henzl <thenzl@redhat.com>\nCC: Dan Williams <dan.j.williams@intel.com>\nCC: Hannes Reinecke <hare@suse.com>\nReviewed-by: Hannes Reinecke <hare@suse.com>\nReviewed-by: John Garry <john.garry@huawei.com>\nReviewed-by: Johannes Thumshirn <jthumshirn@suse.de>\nSigned-off-by: Martin K. Petersen <martin.petersen@oracle.com>",
    "type_of_change": "Modification",
    "filename_of_changes": "sas_expander.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "4",
    "number_of_lines_deleted_vulnerable_to_cve": "5",
    "vulnerable_lines": [
        "// Line_Reference 51: \tif (!(task->task_state_flags & SAS_TASK_STATE_DONE))",
        "// Line_Reference 54: ",
        "// Line_Reference 55: \tcomplete(&task->slow_task->completion);",
        "// Line_Reference 60: \tif (!del_timer(&task->slow_task->timer))",
        "// Line_Reference 61: \t\treturn;"
    ]
}
