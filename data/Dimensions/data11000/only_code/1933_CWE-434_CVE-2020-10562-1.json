* Dernière modification : $Date: 2020-01-28 11:10$
{
$dest = '../images/';
$ok1 = false;
if ($f = @fopen("$dest/.test", "w"))
{
@fputs($f, '<'.'?php $ok1 = true; ?'.'>');
@fclose($f);
include("$dest/.test");
}
if (!$ok1)
{
$msg .= "L\'image n\'a pas pu etre supprimee : probleme d\'écriture sur le repertoire. Veuillez signaler ce problème à l\'administrateur du serveur.\\n";
$ok = 'no';
}
else
{
if (@file_exists($dest."img_".TABLE_PREFIX."".$room.".jpg"))
unlink($dest."img_".TABLE_PREFIX."".$room.".jpg");
if (@file_exists($dest."img_".TABLE_PREFIX."".$room.".png"))
unlink($dest."img_".TABLE_PREFIX."".$room.".png");
if (@file_exists($dest."img_".TABLE_PREFIX."".$room.".gif"))
unlink($dest."img_".TABLE_PREFIX."".$room.".gif");
$picture_room = "";
}
}
if (empty($capacity))
$doc_file = isset($_FILES["doc_file"]) ? $_FILES["doc_file"] : NULL;
if (preg_match("`\.([^.]+)$`", $doc_file['name'], $match))
{
$ext = strtolower($match[1]);
if ($ext != 'jpg' && $ext != 'png'&& $ext != 'gif')
{
$msg .= "L\'image n\'a pas pu etre enregistree : les seules extentions autorisees sont gif, png et jpg.\\n";
$ok = 'no';
}
else
{
$dest = '../images/';
$ok1 = false;
if ($f = @fopen("$dest/.test", "w"))
{
@fputs($f, '<'.'?php $ok1 = true; ?'.'>');
@fclose($f);
include("$dest/.test");
}
if (!$ok1)
{
$msg .= "L\'image n\'a pas pu etre enregistree : probleme d\'ecriture sur le repertoire IMAGES. Veuillez signaler ce probleme e l\'administrateur du serveur.\\n";
$ok = 'no';
}
else
{
$ok1 = @copy($doc_file['tmp_name'], $dest.$doc_file['name']);
if (!$ok1)
$ok1 = @move_uploaded_file($doc_file['tmp_name'], $dest.$doc_file['name']);
if (!$ok1)
{
$msg .= "L\'image n\'a pas pu etre enregistree : probleme de transfert. Le fichier n\'a pas pu etre transfere sur le repertoire IMAGES. Veuillez signaler ce probleme e l\'administrateur du serveur.\\n";
$ok = 'no';
}
else
{
$tab = explode(".", $doc_file['name']);
$ext = strtolower($tab[1]);
if (@file_exists($dest."img_".TABLE_PREFIX."".$room.".".$ext))
@unlink($dest."img_".TABLE_PREFIX."".$room.".".$ext);
rename($dest.$doc_file['name'],$dest."img_".TABLE_PREFIX."".$room.".".$ext);
@chmod($dest."img_".TABLE_PREFIX."".$room.".".$ext, 0666);
$picture_room = "img_".TABLE_PREFIX."".$room.".".$ext;
$sql_picture = "UPDATE ".TABLE_PREFIX."_room SET picture_room='".protect_data_sql($picture_room)."' WHERE id=".$room;
if (grr_sql_command($sql_picture) < 0)
{
fatal_error(0, get_vocab('update_room_failed') . grr_sql_error());
$ok = 'no';
}
}
}
}
}
else if ($doc_file['name'] != '')
{
$msg .= "L\'image n\'a pas pu etre enregistree : le fichier image selectionne n'est pas valide !\\n";
$ok = 'no';
}
$msg .= get_vocab("message_records");
// Definition des jours de la semaine e afficher sur les plannings et calendriers