{
    "cve_id": "CVE-2024-37899",
    "cve_description": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. When an admin disables a user account, the user's profile is executed with the admin's rights. This allows a user to place malicious code in the user profile before getting an admin to disable the user account. To reproduce, as a user without script nor programming rights, edit the about section of your user profile and add `{{groovy}}services.logging.getLogger(\"attacker\").error(\"Hello from Groovy!\"){{/groovy}}`.\nAs an admin, go to the user profile and click the \"Disable this account\" button. Then, reload the page. If the logs show `attacker - Hello from Groovy!` then the instance is vulnerable. This has been patched in XWiki 14.10.21, 15.5.5, 15.10.6 and 16.0.0. Users are advised to upgrade. There are no known workarounds for this vulnerability.\n\n### Workarounds\nWe're not aware of any workaround except upgrading.\n\n### References\n* https://jira.xwiki.org/browse/XWIKI-21611\n* https://github.com/xwiki/xwiki-platform/commit/f89c8f47fad6e5cc7e68c69a7e0acde07f5eed5a\n",
    "cve_publish_date": "2024-06-20",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "XWIKI-21611: Set right author when disabling/enabling an account\n\n* Set only the original metadata author in XWikiUser.setDisabled\n* Use the same disable/enable action everywhere\n* Remove no longer needed request parameters",
    "type_of_change": "Modification",
    "filename_of_changes": "XWikiUserTest.java",
    "code_language": "Java",
    "number_of_lines_added_for_mitigation": "102",
    "number_of_lines_deleted_vulnerable_to_cve": "85",
    "vulnerable_lines": [
        "// Line_Reference 62:     private DocumentReference userClassReference = new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiUsers\");",
        "// Line_Reference 64:     private DocumentReference userReference = new DocumentReference(\"xwiki\", \"XWiki\", \"Foo\");",
        "// Line_Reference 69:         when(mockitoOldcore.getSpyXWiki().getDocument(userReference, mockitoOldcore.getXWikiContext()))",
        "// Line_Reference 70:             .thenReturn(userDocument);",
        "// Line_Reference 71:         when(userDocument.getDocumentReference()).thenReturn(userReference);",
        "// Line_Reference 72:         when(userDocument.getDocumentReferenceWithLocale()).thenReturn(userReference);",
        "// Line_Reference 73:         when(userDocument.clone()).thenReturn(userDocument);",
        "// Line_Reference 98:         XWikiUser user = new XWikiUser(userReference);",
        "// Line_Reference 99:         when(userDocument.getIntValue(userClassReference, XWikiUser.ACTIVE_PROPERTY, 1)).thenReturn(1);",
        "// Line_Reference 100:         assertFalse(user.isDisabled(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 102:         when(userDocument.getIntValue(userClassReference, XWikiUser.ACTIVE_PROPERTY, 1)).thenReturn(0);",
        "// Line_Reference 103:         assertTrue(user.isDisabled(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 106:         assertFalse(user.isDisabled(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 109:         assertFalse(user.isDisabled(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 115:         XWikiUser user = new XWikiUser(userReference);",
        "// Line_Reference 116:         user.setDisabled(false, mockitoOldcore.getXWikiContext());",
        "// Line_Reference 117:         verify(userDocument, times(1)).setIntValue(userClassReference, XWikiUser.ACTIVE_PROPERTY, 1);",
        "// Line_Reference 118:         verify(mockitoOldcore.getSpyXWiki(), times(1))",
        "// Line_Reference 119:             .saveDocument(same(userDocument), any(String.class), same(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 125:         XWikiUser user = new XWikiUser(userReference);",
        "// Line_Reference 126:         user.setDisabled(true, mockitoOldcore.getXWikiContext());",
        "// Line_Reference 127:         verify(userDocument, times(1)).setIntValue(userClassReference, XWikiUser.ACTIVE_PROPERTY, 0);",
        "// Line_Reference 128:         verify(mockitoOldcore.getSpyXWiki(), times(1))",
        "// Line_Reference 129:             .saveDocument(same(userDocument), any(String.class), same(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 137:         user.setDisabled(true, mockitoOldcore.getXWikiContext());",
        "// Line_Reference 138:         verify(userDocument, never())",
        "// Line_Reference 139:             .setIntValue(same(userClassReference), any(String.class), any(Integer.class));",
        "// Line_Reference 140:         verify(mockitoOldcore.getSpyXWiki(), never())",
        "// Line_Reference 141:             .saveDocument(any(XWikiDocument.class), any(String.class), same(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 142: ",
        "// Line_Reference 143:         user.setDisabled(false, mockitoOldcore.getXWikiContext());",
        "// Line_Reference 144:         verify(userDocument, never())",
        "// Line_Reference 145:             .setIntValue(same(userClassReference), any(String.class), any(Integer.class));",
        "// Line_Reference 146:         verify(mockitoOldcore.getSpyXWiki(), never())",
        "// Line_Reference 147:             .saveDocument(any(XWikiDocument.class), any(String.class), same(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 151:         user.setDisabled(true, mockitoOldcore.getXWikiContext());",
        "// Line_Reference 152:         verify(userDocument, never())",
        "// Line_Reference 153:             .setIntValue(same(userClassReference), any(String.class), any(Integer.class));",
        "// Line_Reference 154:         verify(mockitoOldcore.getSpyXWiki(), never())",
        "// Line_Reference 155:             .saveDocument(any(XWikiDocument.class), any(String.class), same(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 156: ",
        "// Line_Reference 157:         user.setDisabled(false, mockitoOldcore.getXWikiContext());",
        "// Line_Reference 158:         verify(userDocument, never())",
        "// Line_Reference 159:             .setIntValue(same(userClassReference), any(String.class), any(Integer.class));",
        "// Line_Reference 160:         verify(mockitoOldcore.getSpyXWiki(), never())",
        "// Line_Reference 161:             .saveDocument(any(XWikiDocument.class), any(String.class), same(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 167:         XWikiUser user = new XWikiUser(userReference);",
        "// Line_Reference 168:         when(userDocument.getIntValue(userClassReference, XWikiUser.EMAIL_CHECKED_PROPERTY, 1)).thenReturn(1);",
        "// Line_Reference 169:         assertTrue(user.isEmailChecked(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 171:         when(userDocument.getIntValue(userClassReference, XWikiUser.EMAIL_CHECKED_PROPERTY, 1)).thenReturn(0);",
        "// Line_Reference 172:         assertFalse(user.isEmailChecked(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 175:         assertTrue(user.isEmailChecked(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 178:         assertTrue(user.isEmailChecked(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 184:         XWikiUser user = new XWikiUser(userReference);",
        "// Line_Reference 185:         user.setEmailChecked(false, mockitoOldcore.getXWikiContext());",
        "// Line_Reference 186:         verify(userDocument, times(1)).setIntValue(userClassReference, XWikiUser.EMAIL_CHECKED_PROPERTY, 0);",
        "// Line_Reference 187:         verify(mockitoOldcore.getSpyXWiki(), times(1))",
        "// Line_Reference 188:             .saveDocument(same(userDocument), any(String.class), same(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 194:         XWikiUser user = new XWikiUser(userReference);",
        "// Line_Reference 195:         user.setEmailChecked(true, mockitoOldcore.getXWikiContext());",
        "// Line_Reference 196:         verify(userDocument, times(1)).setIntValue(userClassReference, XWikiUser.EMAIL_CHECKED_PROPERTY, 1);",
        "// Line_Reference 197:         verify(mockitoOldcore.getSpyXWiki(), times(1))",
        "// Line_Reference 198:             .saveDocument(same(userDocument), any(String.class), same(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 206:         user.setEmailChecked(true, mockitoOldcore.getXWikiContext());",
        "// Line_Reference 207:         verify(userDocument, never())",
        "// Line_Reference 208:             .setIntValue(same(userClassReference), any(String.class), any(Integer.class));",
        "// Line_Reference 209:         verify(mockitoOldcore.getSpyXWiki(), never())",
        "// Line_Reference 210:             .saveDocument(any(XWikiDocument.class), any(String.class), same(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 211: ",
        "// Line_Reference 212:         user.setEmailChecked(false, mockitoOldcore.getXWikiContext());",
        "// Line_Reference 213:         verify(userDocument, never())",
        "// Line_Reference 214:             .setIntValue(same(userClassReference), any(String.class), any(Integer.class));",
        "// Line_Reference 215:         verify(mockitoOldcore.getSpyXWiki(), never())",
        "// Line_Reference 216:             .saveDocument(any(XWikiDocument.class), any(String.class), same(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 220:         user.setEmailChecked(true, mockitoOldcore.getXWikiContext());",
        "// Line_Reference 221:         verify(userDocument, never())",
        "// Line_Reference 222:             .setIntValue(same(userClassReference), any(String.class), any(Integer.class));",
        "// Line_Reference 223:         verify(mockitoOldcore.getSpyXWiki(), never())",
        "// Line_Reference 224:             .saveDocument(any(XWikiDocument.class), any(String.class), same(mockitoOldcore.getXWikiContext()));",
        "// Line_Reference 225: ",
        "// Line_Reference 226:         user.setEmailChecked(false, mockitoOldcore.getXWikiContext());",
        "// Line_Reference 227:         verify(userDocument, never())",
        "// Line_Reference 228:             .setIntValue(same(userClassReference), any(String.class), any(Integer.class));",
        "// Line_Reference 229:         verify(mockitoOldcore.getSpyXWiki(), never())",
        "// Line_Reference 230:             .saveDocument(any(XWikiDocument.class), any(String.class), same(mockitoOldcore.getXWikiContext()));"
    ]
}
