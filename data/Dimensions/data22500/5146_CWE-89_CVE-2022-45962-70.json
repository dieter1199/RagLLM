{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "Grades.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "137",
    "number_of_lines_deleted_vulnerable_to_cve": "140",
    "vulnerable_lines": [
        "// Line_Reference 32: // echo \"<PRE>\";",
        "// Line_Reference 33: // print_r($_REQUEST);",
        "// Line_Reference 34: // echo \"<PRE>\";",
        "// Line_Reference 35: ",
        "// Line_Reference 44: if (count($config_RET))",
        "// Line_Reference 113:     if (count($assignments_RET)) {",
        "// Line_Reference 153:         if (count($assignments_RET)) {",
        "// Line_Reference 156:                 $extra['SELECT'] .= ',\\'' . $id . '\\' AS G' . $id . ',\\'' . $assignment[DUE] . '\\' AS D' . $id . ',\\'' . $assignment[DUE_DATE] . '\\' AS DUE_' . $id . '';",
        "// Line_Reference 176:         if (count($assignments_RET)) {",
        "// Line_Reference 189: //\t\t\t$extra['functions'] = array('POINTS'=>'_makeExtraAssnCols','LETTER_GRADE'=>'_makeExtraAssnCols','WEIGHT_GRADE'=>'_makeWtg');",
        "// Line_Reference 190: //\t\t\t$LO_columns += array('POINTS'=>'Points','LETTER_GRADE'=>'Grade','WEIGHT_GRADE'=>'WEIGHT GRADE');",
        "// Line_Reference 201: )  ) ', \"'0'\", 'ga.POINTS')) . ') AS PARTIAL_TOTAL, gt.FINAL_GRADE_PERCENT FROM students s JOIN schedule ss ON (ss.STUDENT_ID=s.STUDENT_ID AND ss.COURSE_PERIOD_ID=\\'' . $course_period_id . '\\') JOIN gradebook_assignments ga ON ((ga.COURSE_PERIOD_ID=ss.COURSE_PERIOD_ID OR ga.COURSE_ID=\\'' . $course_id . '\\' AND ga.STAFF_ID=\\'' . User('STAFF_ID') . '\\') AND ga.MARKING_PERIOD_ID=\\'' . (GetCpDet($course_period_id, 'MARKING_PERIOD_ID') != '' ? UserMP() : GetMPId('FY')) . '\\') LEFT OUTER JOIN gradebook_grades gg ON (gg.STUDENT_ID=s.STUDENT_ID AND gg.ASSIGNMENT_ID=ga.ASSIGNMENT_ID AND gg.COURSE_PERIOD_ID=ss.COURSE_PERIOD_ID)",
        "// Line_Reference 235: //                        print_r($current_RET);",
        "// Line_Reference 241: if (clean_param($_REQUEST['values'], PARAM_NOTAGS) && ($_POST['values'] || $_REQUEST['ajax']) && $_SESSION['assignment_id'] == clean_param($_REQUEST['assignment_id'], PARAM_INT)) {",
        "// Line_Reference 286: //                DBQuery('UPDATE gradebook_assignments SET UNGRADED=2 WHERE ASSIGNMENT_ID IN (SELECT ASSIGNMENT_ID FROM gradebook_grades WHERE POINTS IS NULL OR POINTS=\\'\\') OR ASSIGNMENT_ID NOT IN (SELECT ASSIGNMENT_ID FROM gradebook_grades WHERE POINTS IS NOT NULL OR POINTS!=\\'\\')');",
        "// Line_Reference 291:         $current_RET[$_REQUEST['student_id']] = DBGet(DBQuery('SELECT g.ASSIGNMENT_ID FROM gradebook_grades g,gradebook_assignments a WHERE a.ASSIGNMENT_ID=g.ASSIGNMENT_ID AND a.MARKING_PERIOD_ID=\\'' . (GetCpDet($course_period_id, 'MARKING_PERIOD_ID') != '' ? UserMP() : GetMPId('FY')) . '\\' AND g.STUDENT_ID=\\'' . $_REQUEST[student_id] . '\\' AND g.COURSE_PERIOD_ID=\\'' . $course_period_id . '\\'' . ($_REQUEST['assignment_id'] == 'all' ? '' : ' AND g.ASSIGNMENT_ID=\\'' . $_REQUEST[assignment_id] . '\\'')), array(), array('ASSIGNMENT_ID'));",
        "// Line_Reference 295:         $current_RET = DBGet(DBQuery('SELECT STUDENT_ID,POINTS,COMMENT,ASSIGNMENT_ID FROM gradebook_grades WHERE ASSIGNMENT_ID=\\'' . $_REQUEST[assignment_id] . '\\' AND COURSE_PERIOD_ID=\\'' . $course_period_id . '\\''), array(), array('STUDENT_ID', 'ASSIGNMENT_ID'));",
        "// Line_Reference 306: $assignment_select = '<SELECT name=assignment_id class=\"form-control\" onchange=\"document.location.href=\\'Modules.php?modname=' . $_REQUEST['modname'] . '&include_inactive=' . $_REQUEST['include_inactive'] . '&cpv_id=' . CpvId() . '&assignment_id=\\'+this.options[selectedIndex].value\"><OPTION value=\"\">'._totals.'</OPTION><OPTION value=\"all\"' . (($_REQUEST['assignment_id'] == 'all' && !$_REQUEST['student_id']) ? ' SELECTED' : '') . '>'._all.'</OPTION>';",
        "// Line_Reference 312: echo '<div class=\"panel-body\">';",
        "// Line_Reference 313: echo \"<FORM class='m-b-0' action=Modules.php?modname=\" . strip_tags(trim($_REQUEST[modname])) . \"&student_id=\" . strip_tags(trim($_REQUEST[student_id])) . \"&cpv_id=\" . CpvId() . \" method=POST>\";",
        "// Line_Reference 317: if (count($stu_RET) == 0 && !$_REQUEST['student_id'])",
        "// Line_Reference 321:         echo '<div class=\"form-inline\">' . $assignment_select . ' &nbsp; &nbsp; <label class=\"checkbox checkbox-inline checkbox-switch switch-success switch-xs\"><INPUT type=checkbox name=include_inactive value=Y' . ($_REQUEST['include_inactive'] == 'Y' ? \" CHECKED onclick='document.location.href=\\\"\" . PreparePHP_SELF($tmp_REQUEST) . \"&include_inactive=\\\";'\" : \" onclick='document.location.href=\\\"\" . PreparePHP_SELF($tmp_REQUEST) . \"&include_inactive=Y\\\";'\") . '><span></span> &nbsp; '._includeInactiveStudents.'</label> &nbsp; ' . ($_REQUEST['assignment_id'] ? SubmitButton(_save, '', 'class=\"btn btn-primary pull-right\" onclick=\"self_disable(this);\"') : '') . '</div>';",
        "// Line_Reference 323:         echo '<div class=\"form-inline\">' . $assignment_select . ' &nbsp; ' . ($_REQUEST['assignment_id'] ? SubmitButton(_save, '', 'class=\"btn btn-primary pull-right\" onclick=\"self_disable(this);\"') : '') . '</div>';",
        "// Line_Reference 327: ",
        "// Line_Reference 335: if (count($assignments_RET) != 0)",
        "// Line_Reference 336:     echo $_REQUEST['assignment_id'] ? '<CENTER>' . SubmitButton(_save, '', 'class=\"btn btn-primary\" onclick=\"self_disable(this);\"') . '</CENTER>' : '';",
        "// Line_Reference 382:     if (count($rounding))",
        "// Line_Reference 389:                 if (count($points_RET[$THIS_RET['STUDENT_ID']])) {",
        "// Line_Reference 414:                 if (count($points_RET[$THIS_RET['STUDENT_ID']])) {",
        "// Line_Reference 517:     if (count($rounding))",
        "// Line_Reference 578:         global $THIS_RET,$total_points,$current_RET,$points_RET,$tabindex,$max_allowed;",
        "// Line_Reference 580:         if(clean_param($_REQUEST['assignment_id'],PARAM_INT)=='' && substr($_REQUEST['assignment_id'],0,1)!='t' && !$_REQUEST['student_id'])",
        "// Line_Reference 581: \t\t\t{",
        "// Line_Reference 582: ",
        "// Line_Reference 583: \t\t\t\tif(count($current_RET[$THIS_RET['STUDENT_ID']]))",
        "// Line_Reference 584: \t\t\t\t{",
        "// Line_Reference 585:                                             $total = $total_percent = 0;",
        "// Line_Reference 586:                                             $assign_typ_wg=array();",
        "// Line_Reference 587:                                             $tot_weight_grade='';",
        "// Line_Reference 588:                                             $tot_weighted_percent=array();",
        "// Line_Reference 589:                                             $assignment_type_count=array();",
        "// Line_Reference 591:                                             foreach($current_RET[$THIS_RET['STUDENT_ID']] as $partial_points)",
        "// Line_Reference 592:                                             {",
        "// Line_Reference 593: ",
        "// Line_Reference 594: ",
        "// Line_Reference 595:                                                $THIS_RET['STUDENT_ID']['flag']=0;",
        "// Line_Reference 596:                                                     if( $partial_points['LETTERWTD_GRADE']!=-1.00 && $partial_points['LETTERWTD_GRADE']!='')",
        "// Line_Reference 597:                                                     {",
        "// Line_Reference 598:                                                         $wper = explode('%', $partial_points['LETTER_GRADE']);",
        "// Line_Reference 599: ",
        "// Line_Reference 600:                                                         if ($tot_weighted_percent[$partial_points['ASSIGNMENT_TYPE_ID']] != '')",
        "// Line_Reference 601:                                                             $tot_weighted_percent[$partial_points['ASSIGNMENT_TYPE_ID']] = $tot_weighted_percent[$partial_points['ASSIGNMENT_TYPE_ID']] + $wper[0];",
        "// Line_Reference 602:                                                         else",
        "// Line_Reference 603:                                                             $tot_weighted_percent[$partial_points['ASSIGNMENT_TYPE_ID']] = $wper[0];",
        "// Line_Reference 604:                                                         if ($assignment_type_count[$partial_points['ASSIGNMENT_TYPE_ID']] != '')",
        "// Line_Reference 605:                                                             $assignment_type_count[$partial_points['ASSIGNMENT_TYPE_ID']] = $assignment_type_count[$partial_points['ASSIGNMENT_TYPE_ID']] + 1;",
        "// Line_Reference 606:                                                         else",
        "// Line_Reference 607:                                                             $assignment_type_count[$partial_points['ASSIGNMENT_TYPE_ID']] = 1;",
        "// Line_Reference 608:                                                         if ($partial_points['ASSIGN_TYP_WG'] != '')",
        "// Line_Reference 609:                                                             $assign_typ_wg[$partial_points['ASSIGNMENT_TYPE_ID']] = substr($partial_points['ASSIGN_TYP_WG'], 0, -2);",
        "// Line_Reference 610: ",
        "// Line_Reference 611: //                                                            $total += (($partial_points['PARTIAL_POINTS']/$partial_points['PARTIAL_TOTAL']))*$partial_points['FINAL_GRADE_PERCENT'];",
        "// Line_Reference 612:                                                             //$total_percent += $partial_points['PARTIAL_TOTAL'];",
        "// Line_Reference 613: ",
        "// Line_Reference 614:                                                       $THIS_RET['STUDENT_ID']['flag']=1;",
        "// Line_Reference 615:                                                     }",
        "// Line_Reference 616:                                             }",
        "// Line_Reference 618:                                                             $total_weightage = 0;",
        "// Line_Reference 619: //                                                            print_r($assignment_type_count);",
        "// Line_Reference 620:                  foreach ($assignment_type_count as $assign_key => $value) {",
        "// Line_Reference 621:                             $total_weightage = $total_weightage + $assign_typ_wg[$assign_key];",
        "// Line_Reference 622:                             if ($tot_weight_grade == '')",
        "// Line_Reference 623:                             {",
        "// Line_Reference 624:                                             $tot_weight_grade = round((round(($tot_weighted_percent[$assign_key] / $value), 2) * $assign_typ_wg[$assign_key]) / 100, 2);",
        "// Line_Reference 625:                                             //echo $tot_weight_grade .'= round((round(('.$tot_weighted_percent[$assign_key].' / '.$value.'), 2) * '.$assign_typ_wg[$assign_key].') / 100, 2)----new<br/><br/>';",
        "// Line_Reference 626: ",
        "// Line_Reference 627:                             }else{",
        "// Line_Reference 628:                                             $tot_weight_grade = $tot_weight_grade + (round((round(($tot_weighted_percent[$assign_key] / $value), 2) * $assign_typ_wg[$assign_key]) / 100, 2));",
        "// Line_Reference 629:                                             //echo $tot_weight_grade .'= '.$tot_weight_grade.' + (round((round(('.$tot_weighted_percent[$assign_key].' / '.$value.'), 2) * '.$assign_typ_wg[$assign_key].') / 100, 2))----old<br/><br/>';",
        "// Line_Reference 630: ",
        "// Line_Reference 631: ",
        "// Line_Reference 632:                             }",
        "// Line_Reference 633:                  }",
        "// Line_Reference 634:                                 $tot_weight_grade = $tot_weight_grade / 100;",
        "// Line_Reference 636:                                                         //$tot_weight_grade=$tot_weight_grade/100;",
        "// Line_Reference 637: //                                            if($total_percent!=0)",
        "// Line_Reference 638: //\t\t\t\t\t\t$total = ($total/$total_percent)*$partial_points;",
        "// Line_Reference 639: ",
        "// Line_Reference 640: ",
        "// Line_Reference 641: \t\t\t\t}",
        "// Line_Reference 642: \t\t\t\telse",
        "// Line_Reference 643: \t\t\t\t\t$total = 0;",
        "// Line_Reference 644:                                 $tot_weight_grade = ($tot_weight_grade / $total_weightage) * 100;",
        "// Line_Reference 645:                                // return (($current_RET[$THIS_RET['STUDENT_ID']][1]['LETTERWTD_GRADE']!=-1.00 && $current_RET[$THIS_RET['STUDENT_ID']][1]['LETTERWTD_GRADE']!='' && $current_RET[$THIS_RET['STUDENT_ID']][1]['ASSIGN_TYP_WG']!='N/A') ?_makeLetterGrade($tot_weight_grade,\"\",User('STAFF_ID'),'%').'% <B>'._makeLetterGrade($tot_weight_grade,\"\",User('STAFF_ID'),'').'</B>':'N/A');",
        "// Line_Reference 646:                                return (($THIS_RET['STUDENT_ID']['flag']==1) ?_makeLetterGrade($tot_weight_grade,\"\",User('STAFF_ID'),'%').'% <B>'._makeLetterGrade($tot_weight_grade,\"\",User('STAFF_ID'),'').'</B>':'N/A');",
        "// Line_Reference 647: //                                $ppercent= _makeLetterGrade($total,\"\",User('STAFF_ID'),\"%\");",
        "// Line_Reference 648: //                                if($points_RET[$THIS_RET['STUDENT_ID']][1]['PARTIAL_POINTS']!='')",
        "// Line_Reference 649: //                                    return ($total>$max_allowed?'<FONT color=red>':'').$ppercent.($total>$max_allowed?'</FONT>':'').'% &nbsp;<B>'._makeLetterGrade($total,\"\",User('STAFF_ID')).'</B>';",
        "// Line_Reference 650: //                                else",
        "// Line_Reference 651: //\t\t\t\t\treturn 'Not Graded';",
        "// Line_Reference 652: \t\t\t}",
        "// Line_Reference 653: \t\t\telse if(clean_param($_REQUEST['assignment_id'],PARAM_INT)!='' && substr($_REQUEST['assignment_id'],0,1)!='t' && !$_REQUEST['student_id'])",
        "// Line_Reference 654: \t\t\t{",
        "// Line_Reference 655: \t\t\t\t$points = $points_RET[$THIS_RET['STUDENT_ID']][1]['POINTS'];",
        "// Line_Reference 656: \t\t\t\t\tif($points!='-1')",
        "// Line_Reference 657:                                         {",
        "// Line_Reference 658:                                             if($points!='')",
        "// Line_Reference 659:                                             {",
        "// Line_Reference 660:                                                 foreach($points_RET[$THIS_RET['STUDENT_ID']] as $partial_points)",
        "// Line_Reference 661:                                                     if($partial_points['TOTAL_POINTS']!=0 && $partial_points['POINTS']!=-1.00 && $partial_points['POINTS']!='')",
        "// Line_Reference 662:                                                     {",
        "// Line_Reference 663:                                                         $pnt=(($partial_points['POINTS']/$partial_points['TOTAL_POINTS'])*100)*$partial_points['FINAL_GRADE_PERCENT'];",
        "// Line_Reference 664:                                                         $pnt=$pnt/100;",
        "// Line_Reference 665:                                                         return (($points_RET[$THIS_RET['STUDENT_ID']][1]['LETTERWTD_GRADE']!=-1.00 && $points_RET[$THIS_RET['STUDENT_ID']][1]['LETTERWTD_GRADE']!='' && $points_RET[$THIS_RET['STUDENT_ID']][1]['ASSIGN_TYP_WG']!='N/A') ?_makeLetterGrade($pnt,\"\",User('STAFF_ID'),'%').'% <B>'._makeLetterGrade($pnt,\"\",User('STAFF_ID'),'').'</B>':'N/A');",
        "// Line_Reference 666: //",
        "// Line_Reference 667:                                                     }",
        "// Line_Reference 668:                                                     else",
        "// Line_Reference 669:                                                     return 'N/A';",
        "// Line_Reference 670: ",
        "// Line_Reference 671:                                             }",
        "// Line_Reference 672:                                             else",
        "// Line_Reference 673:                                                     return 'N/A';",
        "// Line_Reference 674:                                         }",
        "// Line_Reference 675: //",
        "// Line_Reference 676:                                             else",
        "// Line_Reference 677:                                                 return 'N/A';",
        "// Line_Reference 678: //                                        }",
        "// Line_Reference 679: //\t\t\t\t\telse",
        "// Line_Reference 680: //\t\t\t\t\t\treturn 'N/A&nbsp;N/A';",
        "// Line_Reference 681: //                                }",
        "// Line_Reference 682: //\t\t\t\telse",
        "// Line_Reference 683: //\t\t\t\t\treturn 'E/C';",
        "// Line_Reference 684: \t\t\t}",
        "// Line_Reference 685:                         else",
        "// Line_Reference 686:                         {",
        "// Line_Reference 687: ",
        "// Line_Reference 688:                             $wtdper=($THIS_RET['POINTS']/$THIS_RET['TOTAL_POINTS'])*$THIS_RET['FINAL_GRADE_PERCENT'];",
        "// Line_Reference 689:                             return (($THIS_RET['LETTERWTD_GRADE']!=-1.00 && $THIS_RET['LETTERWTD_GRADE']!='' && $THIS_RET['ASSIGN_TYP_WG']!='N/A') ?_makeLetterGrade($wtdper,\"\",User('STAFF_ID'),'%').'% <B>'._makeLetterGrade($wtdper,\"\",User('STAFF_ID'),'').'</B>':'N/A');",
        "// Line_Reference 690:                         }",
        "// Line_Reference 691: "
    ]
}
