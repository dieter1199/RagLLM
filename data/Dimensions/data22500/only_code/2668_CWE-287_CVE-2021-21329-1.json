#TODO: These fields don't do anything yet, but they will eventually correlate to the kwargs in login_user
username = serializers.CharField(max_length=50)
password = serializers.CharField(max_length=50)
otp = serializers.CharField(max_length=6)
def login_user(self, username, password, otp, context, **kwargs):
if user.totp_status == TOTPStatus.ENABLED:
if not otp or otp == '':
login_reject.send(sender=self.__class__, username=username, reason='no_2fa')
raise FormattedException(m='2fa_required', d={'reason': '2fa_required'},
status_code=HTTP_401_UNAUTHORIZED)
totp = pyotp.TOTP(user.totp_secret)
if not totp.verify(otp, valid_window=1):
login_reject.send(sender=self.__class__, username=username, reason='incorrect_2fa')
raise FormattedException(m='incorrect_2fa', d={'reason': 'incorrect_2fa'},
status_code=HTTP_401_UNAUTHORIZED)
