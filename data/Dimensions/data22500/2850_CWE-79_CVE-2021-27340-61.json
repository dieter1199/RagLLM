{
    "cve_id": "CVE-2021-27340",
    "cve_description": "OpenSIS Community Edition version <= 7.6 is affected by a reflected XSS vulnerability in EmailCheck.php via the \"opt\" parameter.",
    "cve_publish_date": "2021-09-16",
    "cwe_id": "CWE-79",
    "cwe_name": "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "cwe_description": "The product does not neutralize or incorrectly neutralizes user-controllable input before it is placed in output that is used as a web page that is served to other users.",
    "commit_message": "Commit with security and bug fixes",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "PasswordCheck.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "113",
    "number_of_lines_deleted_vulnerable_to_cve": "94",
    "vulnerable_lines": [
        "// Line_Reference 33: {",
        "// Line_Reference 34: \tglobal $DatabaseServer, $DatabaseUsername, $DatabasePassword, $DatabaseName, $DatabasePort, $DatabaseType;",
        "// Line_Reference 36: \tswitch ($DatabaseType) {",
        "// Line_Reference 38: \t\t\t$connection = new mysqli($DatabaseServer, $DatabaseUsername, $DatabasePassword, $DatabaseName, $DatabasePort);",
        "// Line_Reference 39: \t\t\tbreak;",
        "// Line_Reference 42: \tif ($connection === false) {",
        "// Line_Reference 43: \t\tswitch ($DatabaseType) {",
        "// Line_Reference 46: \t\t\t\tbreak;",
        "// Line_Reference 48: \t\tdb_show_error(\"\", \"\" . _couldNotConnectToDatabase . \": $DatabaseServer\", $errormessage);",
        "// Line_Reference 56: {",
        "// Line_Reference 57: \tglobal $DatabaseType, $_openSIS;",
        "// Line_Reference 61: \tswitch ($DatabaseType) {",
        "// Line_Reference 68: \t\t\t$sql = par_rep(\"/([,\\(=])[\\r\\n\\t ]*''/\", '\\\\1NULL', $sql);",
        "// Line_Reference 69: \t\t\tif (preg_match_all(\"/'(\\d\\d-[A-Za-z]{3}-\\d{2,4})'/\", $sql, $matches)) {",
        "// Line_Reference 70: \t\t\t\tforeach ($matches[1] as $match) {",
        "// Line_Reference 71: \t\t\t\t\t$dt = date('Y-m-d', strtotime($match));",
        "// Line_Reference 72: \t\t\t\t\t$sql = par_rep(\"/'$match'/\", \"'$dt'\", $sql);",
        "// Line_Reference 74: \t\t\t}",
        "// Line_Reference 75: \t\t\tif (substr($sql, 0, 6) == \"BEGIN;\") {",
        "// Line_Reference 76: \t\t\t\t$array = explode(\";\", $sql);",
        "// Line_Reference 77: \t\t\t\tforeach ($array as $value) {",
        "// Line_Reference 78: \t\t\t\t\tif ($value != \"\") {",
        "// Line_Reference 79: \t\t\t\t\t\t$result = $connection->query($value);",
        "// Line_Reference 80: \t\t\t\t\t\tif (!$result) {",
        "// Line_Reference 81: \t\t\t\t\t\t\t$connection->query(\"ROLLBACK\");",
        "// Line_Reference 82: \t\t\t\t\t\t\tdie(db_show_error($sql, _dbExecuteFailed, mysql_error()));",
        "// Line_Reference 86: \t\t\t} else {",
        "// Line_Reference 87: \t\t\t\t$result = $connection->query($sql) or die(db_show_error($sql, _dbExecuteFailed, mysql_error()));",
        "// Line_Reference 89: \t\t\tbreak;",
        "// Line_Reference 95: {",
        "// Line_Reference 96: \tglobal $DatabaseType;",
        "// Line_Reference 98: \tswitch ($DatabaseType) {",
        "// Line_Reference 101: \t\t\tif (is_array($return)) {",
        "// Line_Reference 102: \t\t\t\tforeach ($return as $key => $value) {",
        "// Line_Reference 103: \t\t\t\t\tif (is_int($key))",
        "// Line_Reference 107: \t\t\tbreak;",
        "// Line_Reference 109: \treturn @array_change_key_case($return, CASE_UPPER);",
        "// Line_Reference 114: {",
        "// Line_Reference 115: \tglobal $DatabaseType;",
        "// Line_Reference 116: ",
        "// Line_Reference 117: \tif ($DatabaseType == 'mysqli')",
        "// Line_Reference 118: \t\t$seq = \"fn_\" . strtolower($seqname) . \"()\";",
        "// Line_Reference 124: {",
        "// Line_Reference 125: \tglobal $DatabaseType;",
        "// Line_Reference 127: \t$counter = 0;",
        "// Line_Reference 128: \tif ($DatabaseType == 'mysqli') {",
        "// Line_Reference 129: \t\t$array_count = count($array);",
        "// Line_Reference 133: \t\tfor ($i = 1; $i < $arr_count; $i++) {",
        "// Line_Reference 136: \t\t\tif ($value == \"''\" && substr($string, -1) == '=') {",
        "// Line_Reference 138: \t\t\t\t$string = substr($string, 0, -1);",
        "// Line_Reference 141: \t\t\t$string .= \"$value\";",
        "// Line_Reference 142: \t\t\tif ($counter == ($array_count - 2) && $array_count % 2 == 0)",
        "// Line_Reference 143: \t\t\t\t$string .= \" ELSE \";",
        "// Line_Reference 144: \t\t\telseif ($counter == ($array_count - 1))",
        "// Line_Reference 145: \t\t\t\t$string .= \" END \";",
        "// Line_Reference 146: \t\t\telseif ($counter % 2 == 0)",
        "// Line_Reference 147: \t\t\t\t$string .= \" WHEN $array[0]=\";",
        "// Line_Reference 148: \t\t\telseif ($counter % 2 == 1)",
        "// Line_Reference 149: \t\t\t\t$string .= \" THEN \";",
        "// Line_Reference 154: ",
        "// Line_Reference 159: {",
        "// Line_Reference 160: \tglobal $DatabaseType, $DatabaseUsername;",
        "// Line_Reference 162: \tswitch ($DatabaseType) {",
        "// Line_Reference 165: \t\t\twhile ($row = db_fetch_row($result)) {",
        "// Line_Reference 166: \t\t\t\t$properties[strtoupper($row['FIELD'])]['TYPE'] = strtoupper($row['TYPE'], strpos($row['TYPE'], '('));",
        "// Line_Reference 167: \t\t\t\tif (!$pos = strpos($row['TYPE'], ','))",
        "// Line_Reference 168: \t\t\t\t\t$pos = strpos($row['TYPE'], ')');",
        "// Line_Reference 170: \t\t\t\t\t$properties[strtoupper($row['FIELD'])]['SCALE'] = substr($row['TYPE'], $pos + 1);",
        "// Line_Reference 172: \t\t\t\t$properties[strtoupper($row['FIELD'])]['SIZE'] = substr($row['TYPE'], strpos($row['TYPE'], '(') + 1, $pos);",
        "// Line_Reference 174: \t\t\t\tif ($row['NULL'] != '')",
        "// Line_Reference 179: \t\t\tbreak;",
        "// Line_Reference 183: function db_show_error($sql, $failnote, $additional = '')",
        "// Line_Reference 184: {",
        "// Line_Reference 185: \tglobal $openSISTitle, $openSISVersion, $openSISNotifyAddress, $openSISMode;",
        "// Line_Reference 186: ",
        "// Line_Reference 190: ",
        "// Line_Reference 191: \techo \"",
        "// Line_Reference 194:                             <TD><pre>\" . date(\"m/d/Y h:i:s\") . \"</pre></TD>",
        "// Line_Reference 211: ",
        "// Line_Reference 212: \techo \"",
        "// Line_Reference 215: \t\t\t<TD><pre>\" . date(\"m/d/Y h:i:s\") . \"</pre></TD>",
        "// Line_Reference 231: ",
        "// Line_Reference 234: \tif ($openSISNotifyAddress) {",
        "// Line_Reference 236: \t\t$message .= \"Date: \" . date(\"m/d/Y h:i:s\") . \"\\n\";",
        "// Line_Reference 237: \t\t$message .= \"Page: \" . $_SERVER['PHP_SELF'] . ' ' . ProgramTitle() . \" \\n\\n\";",
        "// Line_Reference 241: \t\t$message .= \"Request Array: \\n\" . ShowVar($_REQUEST, 'Y', 'N');",
        "// Line_Reference 242: \t\t$message .= \"\\n\\nSession Array: \\n\" . ShowVar($_SESSION, 'Y', 'N');",
        "// Line_Reference 243: \t\tmail($openSISNotifyAddress, 'openSIS Database Error', $message);",
        "// Line_Reference 249: $res_pass_chk = DBGet(DBQuery(\"SELECT * FROM login_authentication WHERE PASSWORD = '\" . md5($_GET['password']) . \"' AND USERNAME!='\" . $_GET['usrid'] . \"' AND PROFILE_ID!='\" . $_GET['prof_id'] . \"'\"));",
        "// Line_Reference 250: if ($res_pass_chk[1]['USER_ID'] != '') {",
        "// Line_Reference 251: \techo '1';",
        "// Line_Reference 252: } else {",
        "// Line_Reference 253: \techo '0';",
        "// Line_Reference 254: }"
    ]
}
