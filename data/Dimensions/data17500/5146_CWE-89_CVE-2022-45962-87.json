{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "Modules.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "97",
    "number_of_lines_deleted_vulnerable_to_cve": "164",
    "vulnerable_lines": [
        "// Line_Reference 30: error_reporting(0);",
        "// Line_Reference 32: !empty($_SESSION['USERNAME']) or die('Access denied!');",
        "// Line_Reference 33: ",
        "// Line_Reference 71: // echo \"<script type='text/javascript'>",
        "// Line_Reference 72: //        function init(param,param2) {",
        "// Line_Reference 73: //            calendar.set('date_'+param);",
        "// Line_Reference 74: //            if(param2==2)",
        "// Line_Reference 75: //            {",
        "// Line_Reference 76: //                document.getElementById('date_'+param).style.display ='block';",
        "// Line_Reference 77: //                document.getElementById('date_div_'+param).style.display ='none';",
        "// Line_Reference 78: //            }",
        "// Line_Reference 79: //            document.getElementById('date_'+param).click();",
        "// Line_Reference 80: //        }",
        "// Line_Reference 81: // </script>\";",
        "// Line_Reference 82: ",
        "// Line_Reference 83: error_reporting(1);",
        "// Line_Reference 84: ",
        "// Line_Reference 94: ",
        "// Line_Reference 127:     echo '<script type=\"text/javascript\" src=\"assets/js/plugins/media/cropper.min.js\"></script>';",
        "// Line_Reference 145: ",
        "// Line_Reference 171: ",
        "// Line_Reference 178: echo '<div id=\"loading-image\"><i class=\"fa fa-cog fa-spin fa-lg fa-fw\"></i> '._loading.'...</div>';",
        "// Line_Reference 200:     $RET = DBGet(DBQuery('SELECT s.ID,s.TITLE FROM schools s,staff st INNER JOIN staff_school_relationship ssr USING(staff_id) WHERE s.id=ssr.school_id AND ssr.syear=\\'' . UserSyear() . '\\' AND st.staff_id=\\'' . $_SESSION[STAFF_ID] . '\\' AND (ssr.END_DATE>=curdate() OR ssr.END_DATE=\\'0000-00-00\\' OR ssr.END_DATE IS NULL)'));",
        "// Line_Reference 209: ",
        "// Line_Reference 214:         echo \"<OPTION value=$school_years[START_DATE]\" . ((UserSyear() == $school_years['START_DATE']) ? ' SELECTED' : '') . \">$school_years[START_DATE]\" . ($school_years[END_DATE] != $school_years[START_DATE] ? \"-\" . $school_years['END_DATE'] : '') . '</OPTION>';",
        "// Line_Reference 220: ",
        "// Line_Reference 307:         }",
        "// Line_Reference 308:         else {",
        "// Line_Reference 328:         }",
        "// Line_Reference 329:         else {",
        "// Line_Reference 403: }################## Porfile Not Teacher End ##########################################",
        "// Line_Reference 456: //===================================================================================================",
        "// Line_Reference 460:     $RET_temp= DBGet($course);",
        "// Line_Reference 461:     $ret_increment=1;",
        "// Line_Reference 462:     $RET=array();",
        "// Line_Reference 463:     foreach($RET_temp as $ret_courses)",
        "// Line_Reference 464:     {",
        "// Line_Reference 465:         $get_cps=DBGet(DBQuery(\"SELECT cpv.ID,cp.COURSE_PERIOD_ID,cp.MARKING_PERIOD_ID,cp.COURSE_ID,cp.TITLE,cp.SCHOOL_ID,cpv.PERIOD_ID FROM course_periods cp,course_period_var cpv WHERE cp.SYEAR='\" . UserSyear() . \"' AND cp.COURSE_PERIOD_ID=cpv.COURSE_PERIOD_ID AND cp.SCHOOL_ID='\" . UserSchool() . \"' AND cp.COURSE_ID='\" . $ret_courses['COURSE_ID'] . \"' AND (TEACHER_ID='\" . User('STAFF_ID') . \"' OR SECONDARY_TEACHER_ID='\" . User('STAFF_ID') . \"') AND (MARKING_PERIOD_ID IN (\" . GetAllMP($allMP, UserMP()) . \") OR (MARKING_PERIOD_ID IS NULL)) group by (cp.COURSE_PERIOD_ID)\"));",
        "// Line_Reference 466:         if(count($get_cps)>0)",
        "// Line_Reference 467:         {",
        "// Line_Reference 468:             $RET[$ret_increment]=$ret_courses;",
        "// Line_Reference 472: ",
        "// Line_Reference 485: //===================================================================================================",
        "// Line_Reference 540: ",
        "// Line_Reference 541:     if(User('PROFILE')=='student')",
        "// Line_Reference 542:     {",
        "// Line_Reference 543:     $img_info = DBGet(DBQuery('SELECT * FROM user_file_upload WHERE USER_ID=' . UserStudentID(). ' AND PROFILE_ID=3 AND SCHOOL_ID=' . UserSchool() . ' AND SYEAR=' . UserSyear() . ' AND FILE_INFO=\\'stuimg\\''));",
        "// Line_Reference 544:     $img_info=$img_info[1]['CONTENT'];",
        "// Line_Reference 545:     }",
        "// Line_Reference 546:     else",
        "// Line_Reference 547:     {",
        "// Line_Reference 548:     $img_info= DBGet(DBQuery('SELECT * FROM staff WHERE STAFF_ID=' .UserID()));",
        "// Line_Reference 549:     $img_info=$img_info[1]['IMG_CONTENT'];",
        "// Line_Reference 551:     if($img_info!='')",
        "// Line_Reference 552:       $user_picture = '<a href=\"javascript:void(0)\"><IMG src=\"data:image/jpeg;base64,'. base64_encode($img_info) . '\" class=\"img-circle img-responsive\"></a>';",
        "// Line_Reference 555:    // if (($StudentPicturesPath . UserStudentID() . '.JPG' || ($UserPicturesPath . UserID() . '.JPG'))) {",
        "// Line_Reference 556:    //     if (UserStudentID())",
        "// Line_Reference 557:    //         $picture_path = $StudentPicturesPath . UserStudentID() . '.JPG';",
        "// Line_Reference 558:    //     if (UserID())",
        "// Line_Reference 559:    //         $picture_path = $UserPicturesPath . UserID() . '.JPG';",
        "// Line_Reference 560:    //     if (file_exists($picture_path)) {",
        "// Line_Reference 561:    //         $user_picture = '<a href=\"javascript:void(0)\"><img src=\"' . $picture_path . '\"  alt=\"\" class=\"img-circle img-responsive\"></a>';",
        "// Line_Reference 562:    //     } else {",
        "// Line_Reference 563:    //         $user_picture = '<a href=\"javascript:void(0)\"><IMG SRC=\"assets/no_avtar.png\" class=\"img-circle img-responsive\"></a>';",
        "// Line_Reference 564:    //     }",
        "// Line_Reference 565:    // } else {",
        "// Line_Reference 566:    //     $user_picture = '<a href=\"javascript:void(0)\"><IMG SRC=\"assets/no_avtar.png\" class=\"img-circle img-responsive\"></a>';",
        "// Line_Reference 567:    // }",
        "// Line_Reference 570: //$user_picture .= '<input type=\"file\" name=\"\"  />';",
        "// Line_Reference 571: // echo User('PROFILE');",
        "// Line_Reference 572: // if(User('PROFILE') == \"Super Administrator\")",
        "// Line_Reference 573: // {",
        "// Line_Reference 574: //     $userProfile = _superAdministrator;",
        "// Line_Reference 575: ",
        "// Line_Reference 576: // }elseif(User('PROFILE') == \"Administrator\")",
        "// Line_Reference 577: // {",
        "// Line_Reference 578: //     $userProfile = _administrator;",
        "// Line_Reference 579: ",
        "// Line_Reference 580: // }elseif(User('PROFILE') == \"Teacher\")",
        "// Line_Reference 581: // {",
        "// Line_Reference 582: //     $userProfile = _teacher;",
        "// Line_Reference 583: ",
        "// Line_Reference 584: // }elseif(User('PROFILE') == \"Student\")",
        "// Line_Reference 585: // {",
        "// Line_Reference 586: //     $userProfile = _student;",
        "// Line_Reference 587: ",
        "// Line_Reference 588: // }elseif(User('PROFILE') == \"Parent\"){",
        "// Line_Reference 589: //     $userProfile = _parent;",
        "// Line_Reference 590: ",
        "// Line_Reference 591: // }elseif(User('PROFILE') == \"Admin Asst\")",
        "// Line_Reference 592: // {",
        "// Line_Reference 593: //     $userProfile = _adminAsst;",
        "// Line_Reference 594: ",
        "// Line_Reference 595: // }",
        "// Line_Reference 624:                                             <a href=\"#user-nav\" data-toggle=\"collapse\"><span>'._myAccount.'</span> <i class=\"caret\"></i></a>",
        "// Line_Reference 631:                                             <li><a href=\"javascript:void(0)\" onclick=\"check_content(\\'Ajax.php?modname=messaging/Inbox.php\\');\"><i class=\"icon-comment-discussion\"></i> <span>'._messages.'</span></a></li>';",
        "// Line_Reference 632: if(User('PROFILE')!='student')",
        "// Line_Reference 633: echo'<li><a href=\"javascript:void(0)\" onclick=\"check_content(\\'Ajax.php?modname=users/Preferences.php\\');\"><i class=\"icon-equalizer\"></i> <span>'._preferences.'</span></a></li>';",
        "// Line_Reference 635:                                             echo'<li><a href=\"index.php?modfunc=logout\"><i class=\"icon-switch2\"></i> <span>'._logout.'</span></a></li>",
        "// Line_Reference 652: ",
        "// Line_Reference 653: ",
        "// Line_Reference 670: echo \"<li><a href='#' onmouseup='check_content(\\\"Ajax.php?modname=miscellaneous/Portal.php\\\");' onmousedown='document.getElementById(\\\"header\\\").innerHTML = \\\"Home\\\";document.getElementById(\\\"cframe\\\").src = \\\"Bottom.php?modcat=home\\\"'><i class=\\\"icon-home4\\\"></i><span>\" ._home . \"</span></a></li>\";",
        "// Line_Reference 686:             echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\"._schoolInfo.\"</span></a>\";",
        "// Line_Reference 688:             echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\"._myInfo.\"</span></a>\";",
        "// Line_Reference 691:             echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\"._myInfo.\"</span></a>\";",
        "// Line_Reference 693:             echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\"._schedule.\"</span></a>\";",
        "// Line_Reference 695:             echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\"._messaging.\"</span></a>\";",
        "// Line_Reference 699:                 echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\"._extracurricular.\"</span></a>\";",
        "// Line_Reference 701:                 echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\"._schoolSetup.\"</span></a>\";",
        "// Line_Reference 703:                 echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\" . ucfirst(str_replace('_', ' ', constant('_'.$modcat))) . \"</span></a>\";",
        "// Line_Reference 742:                                     echo \"<li  \" . (($current_menu == $title) ? 'class=\"current-submenu\"' : '') . \"><A id=hm HREF=javascript:void(0) onClick='check_content(\\\"Ajax.php?modname=\" . $file . \" \\\");'  onmousedown='document.getElementById(\\\"header\\\").innerHTML = \\\"\" . ($modcat == 'schoolsetup' ? schoolSetup : ucwords(constant($modcat))) . \" <i class=\\\"icon-arrow-right5\\\"></i> \" . \"$title\\\"' onmouseup=\\\"document.getElementById('cframe').src='Bottom.php?modname=\" . str_replace('&', '?', $file) . \"';\\\">$title</A>\";",
        "// Line_Reference 744:                                 echo \"<li  \" . (($current_menu == $title) ? 'class=\"current-submenu\"' : '') . \"><A id=hm HREF=javascript:void(0) onClick='check_content(\\\"Ajax.php?modname=\" . $file . \" \\\");'  onmousedown='$(\\\"#header\\\").html(\\\"\" . ($modcat == 'schoolsetup' ? schoolSetup : ucwords(constant($modcat))) . \" <i class=icon-arrow-right5></i> \" . $title.\"\\\");' onmouseup=\\\"$('#cframe').attr('src','Bottom.php?modname=\" . str_replace('&', '?', $file) . \"');\\\">$title</A>\";",
        "// Line_Reference 780:                                 echo \"<li \" . (($current_menu == $title) ? 'class=\"current-submenu\"' : '') . \"><A id=dd HREF=javascript:void(0) onClick='check_content(\\\"Ajax.php?modname=\" . $file . \" \\\");'  onmousedown='document.getElementById(\\\"header\\\").innerHTML = \\\"\" . ($modcat == 'schoolsetup' ? schoolSetup : ucwords(constant($modcat))) . \" <i class=\\\"icon-arrow-right5\\\"></i> \" . \"$title\\\"' onmouseup=\\\"document.getElementById('cframe').src='Bottom.php?modname=\" . $file . \"';\\\">$title</A>\";",
        "// Line_Reference 783:                             echo \"<li \" . (($current_menu == $title) ? 'class=\"current-submenu\"' : '') . \"><A id=dd HREF=javascript:void(0) onClick='check_content(\\\"Ajax.php?modname=\" . $file . \" \\\");'  onmousedown='document.getElementById(\\\"header\\\").innerHTML = \\\"\" . ($modcat == 'schoolsetup' ? schoolSetup : ucwords(constant($modcat))) . \" <i class=\\\"icon-arrow-right5\\\"></i> \" . \"$title\\\"' onmouseup=\\\"document.getElementById('cframe').src='Bottom.php?modname=\" . $file . \"';\\\">$title</A>\";",
        "// Line_Reference 785:                 }",
        "// Line_Reference 786:                 elseif ($keys[$key_index + 1] && !is_numeric($keys[$key_index + 1])) {",
        "// Line_Reference 794: ",
        "// Line_Reference 795:                 /* echo '<script type=\"text/javascript\">",
        "// Line_Reference 796:                   createmenu(\"mm_' . $modcat . '_' . $menumm . '\", \"menu_child_' . $modcat . '_' . $menumm . '\", \"hover\", \"y\", \"pointer\");",
        "// Line_Reference 797:                   </script>'; */",
        "// Line_Reference 847:         $admin_COMMON_FROM .=\" ,student_mp_comments smc\";",
        "// Line_Reference 848:         $admin_COMMON_WHERE .=\" AND smc.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 853:         $admin_COMMON_FROM .=\" ,student_goal g \";",
        "// Line_Reference 854:         $admin_COMMON_WHERE .=\" AND g.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 859:         $admin_COMMON_FROM .=\" ,student_goal_progress p \";",
        "// Line_Reference 860:         $admin_COMMON_WHERE .=\" AND p.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 865:         $admin_COMMON_FROM .=\" ,student_medical_notes smn \";",
        "// Line_Reference 866:         $admin_COMMON_WHERE .=\" AND smn.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 872:         $admin_COMMON_FROM .=\" ,student_immunization sm \";",
        "// Line_Reference 873:         $admin_COMMON_WHERE .=\" AND sm.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 879:         $admin_COMMON_FROM .=\" ,student_medical_alerts sma  \";",
        "// Line_Reference 880:         $admin_COMMON_WHERE .=\" AND sma.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 885:         $admin_COMMON_FROM .=\" ,student_medical_visits smv   \";",
        "// Line_Reference 886:         $admin_COMMON_WHERE .=\" AND smv.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 901:         $teacher_COMMON_FROM .=\" ,student_mp_comments smc\";",
        "// Line_Reference 902:         $teacher_COMMON_WHERE .=\" AND smc.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 907:         $teacher_COMMON_FROM .=\" ,student_goal g \";",
        "// Line_Reference 908:         $teacher_COMMON_WHERE .=\" AND g.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 913:         $teacher_COMMON_FROM .=\" ,student_goal_progress p \";",
        "// Line_Reference 914:         $teacher_COMMON_WHERE .=\" AND p.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 919:         $teacher_COMMON_FROM .=\" ,student_medical_notes smn \";",
        "// Line_Reference 920:         $teacher_COMMON_WHERE .=\" AND smn.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 926:         $teacher_COMMON_FROM .=\" ,student_immunization sm \";",
        "// Line_Reference 927:         $teacher_COMMON_WHERE .=\" AND sm.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 932:         $teacher_COMMON_FROM .=\" ,student_medical_alerts sma  \";",
        "// Line_Reference 933:         $teacher_COMMON_WHERE .=\" AND sma.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 938:         $teacher_COMMON_FROM .=\" ,student_medical_visits smv   \";",
        "// Line_Reference 939:         $teacher_COMMON_WHERE .=\" AND smv.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 1003: ",
        "// Line_Reference 1009:     if(!empty($check_backups))",
        "// Line_Reference 1010:     {",
        "// Line_Reference 1011:         foreach($check_backups as $each_backups)",
        "// Line_Reference 1012:         {",
        "// Line_Reference 1013:             $filename = $each_backups['TITLE'].'.sql';",
        "// Line_Reference 1015:             if(file_exists($filename))",
        "// Line_Reference 1016:             {",
        "// Line_Reference 1019:                 DBQuery(\"DELETE FROM `program_config` WHERE `program` = 'DB_BACKUP' AND `value` = '\".$each_backups['VALUE'].\"'\");",
        "// Line_Reference 1025: ",
        "// Line_Reference 1056:     }",
        "// Line_Reference 1057:     else {",
        "// Line_Reference 1059:             echo \"\"._youReNotAllowedToUseThisProgram.\"! \"._thisAttemptedViolationHasBeenLoggedAndYourIpAddressWasCaptured.\".\";",
        "// Line_Reference 1139:                             '._footerText.'",
        "// Line_Reference 1144:                             Version <b>' . $get_app_details[1][VALUE] . '</b>",
        "// Line_Reference 1154: ?>"
    ]
}
