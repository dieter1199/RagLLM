{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "UserFields.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "186",
    "number_of_lines_deleted_vulnerable_to_cve": "122",
    "vulnerable_lines": [
        "// Line_Reference 31: DrawBC(\"\"._users.\" > \" . ProgramTitle());",
        "// Line_Reference 42:                 echo \"<div class='alert alert-danger'>\"._unableToSaveDataBecauseTitleCanNotBeBlank.\"</div>\";",
        "// Line_Reference 49:                 if ($_REQUEST['DEFAULT_DATATYPE_'.$id] == 'multiple' && $columns['DEFAULT_SELECTION'] != '') {",
        "// Line_Reference 50:                     $columns['DEFAULT_SELECTION'] = '||'.$columns['DEFAULT_SELECTION'].'||';",
        "// Line_Reference 53:                 if ($_REQUEST['DEFAULT_DATATYPE_'.$id] == 'numeric' && $columns['REQUIRED'] == 'Y' && ($columns['DEFAULT_SELECTION'] == NULL || $columns['DEFAULT_SELECTION'] == '')) {",
        "// Line_Reference 69:         }",
        "// Line_Reference 70:         else {",
        "// Line_Reference 86:                     $columns['DEFAULT_SELECTION'] = '||'.$columns['DEFAULT_SELECTION'].'||';",
        "// Line_Reference 89:                 $id = DBGet(DBQuery('SHOW TABLE STATUS LIKE \\'' . 'people_fields' . '\\''));",
        "// Line_Reference 90:                 $id[1]['ID'] = $id[1]['AUTO_INCREMENT'];",
        "// Line_Reference 91:                 $id = $id[1]['ID'];",
        "// Line_Reference 94:                 $_REQUEST['id'] = $id;",
        "// Line_Reference 140:                     $Sql_add_column.=' NOT NULL ';",
        "// Line_Reference 142:                     $Sql_add_column.=' NULL ';",
        "// Line_Reference 145:                     $Sql_add_column.=' DEFAULT  \\'' . $columns['DEFAULT_SELECTION'] . '\\' ';",
        "// Line_Reference 152:             elseif ($table == 'people_field_categories') {",
        "// Line_Reference 153: ",
        "// Line_Reference 154:                 $id = DBGet(DBQuery('SHOW TABLE STATUS LIKE \\'' . 'people_field_categories' . '\\''));",
        "// Line_Reference 155:                 $id[1]['ID'] = $id[1]['AUTO_INCREMENT'];",
        "// Line_Reference 156:                 $id = $id[1]['ID'];",
        "// Line_Reference 157:                 $fields = '';",
        "// Line_Reference 158:                 $values = '';",
        "// Line_Reference 159:                 $_REQUEST['category_id'] = $id;",
        "// Line_Reference 160:                 // add to profile or permissions of user creating it",
        "// Line_Reference 161:                 if (User('PROFILE_ID') != '')",
        "// Line_Reference 162:                     DBQuery('INSERT INTO profile_exceptions (PROFILE_ID,MODNAME,CAN_USE,CAN_EDIT) values(\\'' . User('PROFILE_ID') . '\\',\\'users/User.php&category_id=' . $id . '\\',\\'Y\\',\\'Y\\')');",
        "// Line_Reference 163:                 else",
        "// Line_Reference 164:                     DBQuery('INSERT INTO staff_exceptions (USER_ID,MODNAME,CAN_USE,CAN_EDIT) values(\\'' . User('STAFF_ID') . '\\',\\'users/User.php&category_id=' . $id . '\\',\\'Y\\',\\'Y\\')');",
        "// Line_Reference 165:             }",
        "// Line_Reference 166: ",
        "// Line_Reference 167:             $go = false;",
        "// Line_Reference 168: ",
        "// Line_Reference 169:             foreach ($columns as $column => $value) {",
        "// Line_Reference 170:                 if ($value) {",
        "// Line_Reference 171:                     if ($column == 'TITLE' && $value != '') {",
        "// Line_Reference 172:                         $value = str_replace(\"'\", \"''\", clean_param(trim($value), PARAM_SPCL));",
        "// Line_Reference 173:                     }",
        "// Line_Reference 174:                     $fields .= $column . ',';",
        "// Line_Reference 175:                     $values .= '\\'' . $value . '\\',';",
        "// Line_Reference 176:                     $go = true;",
        "// Line_Reference 177:                 }",
        "// Line_Reference 178:             }",
        "// Line_Reference 179:             $sql .= '(' . substr($fields, 0, -1) . ') values(' . substr($values, 0, -1) . ')';",
        "// Line_Reference 182:         if ($go)",
        "// Line_Reference 183:             DBQuery($sql);",
        "// Line_Reference 184: ",
        "// Line_Reference 232:                 $Sql_modify_column.=' NOT NULL ';",
        "// Line_Reference 234:                 $Sql_modify_column.=' NULL ';",
        "// Line_Reference 237:                 $Sql_modify_column.=' DEFAULT  \\'' . $custom_update['DEFAULT_SELECTION'] . '\\' ';",
        "// Line_Reference 239:                 $existing_column_updt = 'UPDATE `people` SET CUSTOM_'.$id.' = \\''.$custom_update['DEFAULT_SELECTION'].'\\' WHERE (CUSTOM_'.$id.' IS NULL OR CUSTOM_'.$id.' = \"\")';",
        "// Line_Reference 244:             if($existing_column_updt)",
        "// Line_Reference 274:                 $fields = DBGet(DBQuery('SELECT ID FROM people_fields WHERE CATEGORY_ID=\\'' . $_REQUEST[category_id] . '\\''));",
        "// Line_Reference 279:                 DBQuery('DELETE FROM people_field_categories WHERE ID=\\'' . $_REQUEST[category_id] . '\\'');",
        "// Line_Reference 281:                 DBQuery('DELETE FROM profile_exceptions WHERE MODNAME=\\'users/User/Student.php&category_id=' . $_REQUEST[category_id] . '\\'');",
        "// Line_Reference 296:         $delete_button = \"<INPUT type=button class=\\\"btn btn-danger m-r-10\\\" value='\"._delete.\"' onClick='javascript:window.location=\\\"Modules.php?modname=$_REQUEST[modname]&modfunc=delete&category_id=$_REQUEST[category_id]&id=$_REQUEST[id]\\\"'> \";",
        "// Line_Reference 300:         $sql = 'SELECT CATEGORY_ID,TITLE,TYPE,SELECT_OPTIONS,DEFAULT_SELECTION,SORT_ORDER,REQUIRED,REQUIRED,(SELECT TITLE FROM people_field_categories WHERE ID=CATEGORY_ID) AS CATEGORY_TITLE FROM people_fields WHERE ID=\\'' . $_REQUEST[id] . '\\'';",
        "// Line_Reference 307: \t\t\t\tWHERE ID=\\'' . $_REQUEST[category_id] . '\\'';",
        "// Line_Reference 318: ",
        "// Line_Reference 341:         $header .= '<div class=\"form-group\">' . SelectInput($RET['TYPE'], 'tables[' . $_REQUEST['id'] . '][TYPE]', _dataType . '<br>(' . ($_REQUEST['id'] != 'new' ? _thisValueCantBeChanged : _enterThisValueCarefullyAsThisCantBeChangedLater) . ')', $type_options, false, 'id=type onchange=\"formcheck_student_studentField_F1_defalut();\" '. ($_REQUEST['id'] != 'new' ? 'disabled' : '')) . '</div>';",
        "// Line_Reference 344:         $header .= '<input id=\"DEFAULT_DATATYPE_'.$_REQUEST['id'].'\" name=\"DEFAULT_DATATYPE_'.$_REQUEST['id'].'\" type=\"hidden\" value=\"'.$RET['TYPE'].'\">';",
        "// Line_Reference 354:         $header .= '<div class=\"form-group\"><label class=\"control-label text-right col-md-4\">'._userFieldCategory.'</label><div class=\"col-md-8\">' . SelectInput($RET['CATEGORY_ID'] ? $RET['CATEGORY_ID'] : $_REQUEST['category_id'], 'tables[' . $_REQUEST['id'] . '][CATEGORY_ID]', '', $categories_options, false, 'onchange=\"formcheck_student_studentField_F1_defalut();\"') . '</div></div>';",
        "// Line_Reference 373:                 $exampleText = _example.':<br/>Good<br/>Bad<br/>etc.';",
        "// Line_Reference 375:                 $exampleText = _example.':<br/>0|Good<br/>1|Bad<br/>etc.';",
        "// Line_Reference 376:             }",
        "// Line_Reference 387: ",
        "// Line_Reference 404:                         $defaultMessage = '<span class=\"text-warning\"><b>'._warning.'!</b> '._defaultValueDoesNotMatchWithTheValuesOfPullDown.'!</span>';",
        "// Line_Reference 409:             $exampleText = _example.':<br/>Good<br/>Bad<br/>etc.';",
        "// Line_Reference 415:             $header .= '<div class=\"col-md-6\" id=\"show_textarea\" style=\"display:block\"><label class=\"control-label col-lg-4 text-right\">'._pullDown.'/'._autoPullDown.'/'._codedPullDown.'/'._selectMultipleChoices.'</label><div class=\"col-lg-8\">' . TextAreaInput($RET['SELECT_OPTIONS'], 'tables[' . $_REQUEST['id'] . '][SELECT_OPTIONS]', '', 'rows=7 cols=40 onkeyup=checkValidDefaultValue()') . '<p class=\"help-block\">* '.ucfirst(_onePerLine).'</p><p id=\"exmp\" class=\"help-block\">' . $exampleText . '</p></div></div>';",
        "// Line_Reference 418:             $header .= '<div style=\"display:none;\"><textarea id=\"SELECT_OPTIONS_VALUE_'.$_REQUEST['id'].'\">'.$RET['SELECT_OPTIONS'].'</textarea></div>';",
        "// Line_Reference 429:             $header .= '<div class=\"form-group\"><label class=\"col-lg-4 text-right control-label\">'._default.'<br>('._enterThisValueCarefullyAsThisCantBeChangedLater.')</label><div class=\"col-lg-8\">' . TextInput($RET['DEFAULT_SELECTION'], 'tables[' . $_REQUEST['id'] . '][DEFAULT_SELECTION]', '', $defaultValueFunc) . '<p class=\"help-block\">* '._forDatesYyyyMmDdForCheckboxesYAmpForLongTextItWillBeIgnored.'</p><p id=\"helpBlock\" class=\"help-block\"></p></div></div>';",
        "// Line_Reference 431:             $header .= '<div class=\"form-group\"><label class=\"col-lg-4 text-right control-label\">'._default.'<br>('._thisValueCantBeChanged.')</label><div class=\"col-lg-8\">' . TextInput($RET['DEFAULT_SELECTION'], 'tables[' . $_REQUEST['id'] . '][DEFAULT_SELECTION]', '', $defaultValueFunc.' disabled') . '<p id=\"helpBlock\" class=\"help-block\">'.$defaultMessage.'</p></div></div>';",
        "// Line_Reference 434:         $header .= '<input id=\"DEFAULT_VALUE_'.$_REQUEST['id'].'\" type=\"hidden\" value=\"'.$RET['DEFAULT_SELECTION'].'\">';",
        "// Line_Reference 460: ",
        "// Line_Reference 473:         $header .= '<label class=\"control-label col-md-2 text-right\">'._profiles.'</label>';",
        "// Line_Reference 478:         $header .= (($RET['ID'] > 2 || $RET['ID'] == '') ? CheckboxInput($RET['PARENT'], 'tables[' . $_REQUEST['category_id'] . '][PARENT]', ($_REQUEST['category_id'] == '1' && !$RET['PARENT'] ? '<FONT color=red>' : '') . 'Parent' . ($_REQUEST['category_id'] == '1' && !$RET['TEACHER'] ? '</FONT>' : ''), '', $new, '<i class=\"icon-checkbox-checked\"></i>', '<i class=\"icon-checkbox-unchecked\"></i>') : '<span>' . ($RET['PARENT'] == 'Y' ? '<i class=\"icon-checkbox-checked\"></i>' : '<i class=\"icon-checkbox-unchecked\"></i>') . ' &nbsp; '._parent.'</span> &nbsp; &nbsp; ');",
        "// Line_Reference 480:         $header .= (($RET['ID'] > 2 || $RET['ID'] == '') ? CheckboxInput($RET['NONE'], 'tables[' . $_REQUEST['category_id'] . '][NONE]', ($_REQUEST['category_id'] == '1' && !$RET['NONE'] ? '<FONT color=red>' : '') . 'No Access' . ($_REQUEST['category_id'] == '1' && !$RET['TEACHER'] ? '</FONT>' : ''), '', $new, '<i class=\"icon-checkbox-checked\"></i>', '<i class=\"icon-checkbox-unchecked\"></i>') : '<span>' . ($RET['NONE'] == 'Y' ? '<i class=\"icon-checkbox-checked\"></i>' : '<i class=\"icon-checkbox-unchecked\"></i>') . ' &nbsp; '._noAccess.'</span> &nbsp; &nbsp;');",
        "// Line_Reference 496:     $LO_options = array('save' =>false, 'search' =>false, 'add' =>true);",
        "// Line_Reference 500:     if (count($categories_RET)) {",
        "// Line_Reference 511:     $columns = array('TITLE' =>_category,",
        "// Line_Reference 512:      'SORT_ORDER' =>_order,",
        "// Line_Reference 547:                 $categories_RET[$key]['TITLE'] = $value['TITLE'] ;",
        "// Line_Reference 549:             // case 'Demographic Info':",
        "// Line_Reference 550:             //     $categories_RET[$key]['TITLE'] = _demographicInfo;",
        "// Line_Reference 551:             //     break;",
        "// Line_Reference 552:             // case 'Addresses &amp; Contacts':",
        "// Line_Reference 553:             //     $categories_RET[$key]['TITLE'] = _addressesContacts;",
        "// Line_Reference 554:             //     break;",
        "// Line_Reference 555:             // case 'School Information':",
        "// Line_Reference 556:             //     $categories_RET[$key]['TITLE'] = _schoolInformation;",
        "// Line_Reference 557:             //     break;",
        "// Line_Reference 558:             // case 'Certification Information':",
        "// Line_Reference 559:             //     $categories_RET[$key]['TITLE'] = _certificationInformation;",
        "// Line_Reference 560:             //     break;",
        "// Line_Reference 561:             // case 'Schedule':",
        "// Line_Reference 562:             //     $categories_RET[$key]['TITLE'] = _schedule;",
        "// Line_Reference 563:             //     break;",
        "// Line_Reference 568: ",
        "// Line_Reference 576:         if (count($fields_RET)) {",
        "// Line_Reference 587:         $columns = array('TITLE' =>_userField,",
        "// Line_Reference 588:          'SORT_ORDER' =>_order,",
        "// Line_Reference 589:          'TYPE' =>_dataType,",
        "// Line_Reference 601:         switch ($_REQUEST[category_id]) {",
        "// Line_Reference 604:                  _name,",
        "// Line_Reference 605:                  _emailAddress,",
        "// Line_Reference 606:                  _disableUser,",
        "// Line_Reference 607:                  _userId,",
        "// Line_Reference 608:                  _homePhone,",
        "// Line_Reference 609:                  _workPhone,",
        "// Line_Reference 610:                  _cellPhone,",
        "// Line_Reference 611:                  _userProfile,",
        "// Line_Reference 612:                  _username,",
        "// Line_Reference 613:                  _password,",
        "// Line_Reference 622:                  _address,",
        "// Line_Reference 623:                  _street,",
        "// Line_Reference 624:                  _city,",
        "// Line_Reference 625:                  _state,",
        "// Line_Reference 626:                  _zipCode,",
        "// Line_Reference 646:             $fields_RET1[$count] = array('ID' => '', 'SORT_ORDER' => ($key + 1), 'TITLE' => $value, 'TYPE' => '<span style=\"color:#ea8828;\">'._default.'</span>');",
        "// Line_Reference 658: ",
        "// Line_Reference 671: function _makeType($value, $name) {",
        "// Line_Reference 675: ",
        "// Line_Reference 676: ?>"
    ]
}
