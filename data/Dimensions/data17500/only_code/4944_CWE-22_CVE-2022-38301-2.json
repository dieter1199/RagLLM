LockUtils.write(getBuild().getArtifactsLockKey(), new Callable<Void>() {
@Override
public Void call() throws Exception {
File artifactsDir = getBuild().getArtifactsDir();
for (FileUpload upload: uploads) {
String filePath = FilenameUtils.sanitizeFilename(upload.getFileName());
if (directory != null)
filePath = directory + "/" + filePath;
File file = new File(artifactsDir, filePath);
FileUtils.createDir(file.getParentFile());
try (	InputStream is = upload.getInputStream();
OutputStream os = new FileOutputStream(file)) {
IOUtils.copy(is, os);
} finally {
upload.release();
return null;
}
});
onUploaded(target);
