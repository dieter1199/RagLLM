{
    "cve_id": "CVE-2018-13982",
    "cve_description": "Smarty_Security::isTrustedResourceDir() in Smarty before 3.1.33 is prone to a path traversal vulnerability due to insufficient template code sanitization. This allows attackers controlling the executed template code to bypass the trusted directory security restriction and read arbitrary files.",
    "cve_publish_date": "2018-09-18",
    "cwe_id": "CWE-22",
    "cwe_name": "Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
    "cwe_description": "The product uses external input to construct a pathname that is intended to identify a file or directory that is located underneath a restricted parent directory, but the product does not properly neutralize special elements within the pathname that can cause the pathname to resolve to a location that is outside of the restricted directory.",
    "commit_message": "- bugfix  possible Security Vulnerability in Smarty_Security class.",
    "type_of_change": "Modification",
    "filename_of_changes": "smarty_security.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "55",
    "number_of_lines_deleted_vulnerable_to_cve": "52",
    "vulnerable_lines": [
        "// Line_Reference 517:             foreach ($this->_include_dir as $directory) {",
        "// Line_Reference 518:                 unset($this->_resource_dir[ $directory ]);",
        "// Line_Reference 519:             }",
        "// Line_Reference 520:             if ($this->smarty->use_include_path) {",
        "// Line_Reference 521:                 $this->_include_dir = array();",
        "// Line_Reference 522:                 $_dirs = $this->smarty->ext->_getIncludePath->getIncludePathDirs($this->smarty);",
        "// Line_Reference 523:                 foreach ($_dirs as $directory) {",
        "// Line_Reference 524:                     $this->_include_dir[] = $directory;",
        "// Line_Reference 525:                     $this->_resource_dir[ $directory ] = true;",
        "// Line_Reference 526:                 }",
        "// Line_Reference 530:         if ($isConfig !== true &&",
        "// Line_Reference 531:             (!isset($this->smarty->_cache[ 'template_dir_new' ]) || $this->smarty->_cache[ 'template_dir_new' ])",
        "// Line_Reference 532:         ) {",
        "// Line_Reference 535:                 foreach ($this->_template_dir as $directory) {",
        "// Line_Reference 536:                     unset($this->_resource_dir[ $directory ]);",
        "// Line_Reference 537:                 }",
        "// Line_Reference 538:                 foreach ($_dir as $directory) {",
        "// Line_Reference 539:                     $this->_resource_dir[ $directory ] = true;",
        "// Line_Reference 540:                 }",
        "// Line_Reference 543:             $this->smarty->_cache[ 'template_dir_new' ] = false;",
        "// Line_Reference 545:         if ($isConfig !== false &&",
        "// Line_Reference 546:             (!isset($this->smarty->_cache[ 'config_dir_new' ]) || $this->smarty->_cache[ 'config_dir_new' ])",
        "// Line_Reference 547:         ) {",
        "// Line_Reference 550:                 foreach ($this->_config_dir as $directory) {",
        "// Line_Reference 551:                     unset($this->_resource_dir[ $directory ]);",
        "// Line_Reference 552:                 }",
        "// Line_Reference 553:                 foreach ($_dir as $directory) {",
        "// Line_Reference 554:                     $this->_resource_dir[ $directory ] = true;",
        "// Line_Reference 555:                 }",
        "// Line_Reference 558:             $this->smarty->_cache[ 'config_dir_new' ] = false;",
        "// Line_Reference 560:         if ($this->_secure_dir !== (array) $this->secure_dir) {",
        "// Line_Reference 561:             foreach ($this->_secure_dir as $directory) {",
        "// Line_Reference 562:                 unset($this->_resource_dir[ $directory ]);",
        "// Line_Reference 564:             foreach ((array) $this->secure_dir as $directory) {",
        "// Line_Reference 565:                 $directory = $this->smarty->_realpath($directory . DIRECTORY_SEPARATOR, true);",
        "// Line_Reference 566:                 $this->_resource_dir[ $directory ] = true;",
        "// Line_Reference 567:             }",
        "// Line_Reference 568:             $this->_secure_dir = (array) $this->secure_dir;",
        "// Line_Reference 570:         $this->_resource_dir = $this->_checkDir($filepath, $this->_resource_dir);",
        "// Line_Reference 625: ",
        "// Line_Reference 626:         $this->_php_resource_dir =",
        "// Line_Reference 627:             $this->_checkDir($this->smarty->_realpath($filepath, true), $this->_php_resource_dir);",
        "// Line_Reference 628:         return true;",
        "// Line_Reference 637:      * @return array",
        "// Line_Reference 645:             // remember the directory to add it to _resource_dir in case we're successful",
        "// Line_Reference 646:             $_directory[ $directory ] = true;",
        "// Line_Reference 647:             // test if the directory is trusted",
        "// Line_Reference 649:                 // merge sub directories of current $directory into _resource_dir to speed up subsequent lookup",
        "// Line_Reference 650:                 $dirs = array_merge($dirs, $_directory);",
        "// Line_Reference 651: ",
        "// Line_Reference 652:                 return $dirs;",
        "// Line_Reference 658:             // bubble up one level"
    ]
}
