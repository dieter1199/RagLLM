{
    "cve_id": "CVE-2016-7798",
    "cve_description": "The openssl gem for Ruby uses the same initialization vector (IV) in GCM Mode (aes-*-gcm) when the IV is set before the key, which makes it easier for context-dependent attackers to bypass the encryption protection mechanism.",
    "cve_publish_date": "2017-01-30",
    "cwe_id": "CWE-326",
    "cwe_name": "Inadequate Encryption Strength",
    "cwe_description": "The product stores or transmits sensitive data using an encryption scheme that is theoretically sound, but is not strong enough for the level of protection required.",
    "commit_message": "cipher: don't set dummy encryption key in Cipher#initialize\n\nRemove the encryption key initialization from Cipher#initialize. This\nis effectively a revert of r32723 (\"Avoid possible SEGV from AES\nencryption/decryption\", 2011-07-28).\n\nr32723, which added the key initialization, was a workaround for\nRuby Bug #2768. For some certain ciphers, calling EVP_CipherUpdate()\nbefore setting an encryption key caused segfault. It was not a problem\nuntil OpenSSL implemented GCM mode - the encryption key could be\noverridden by repeated calls of EVP_CipherInit_ex(). But, it is not the\ncase for AES-GCM ciphers. Setting a key, an IV, a key, in this order\ncauses the IV to be reset to an all-zero IV.\n\nThe problem of Bug #2768 persists on the current versions of OpenSSL.\nSo, make Cipher#update raise an exception if a key is not yet set by the\nuser. Since encrypting or decrypting without key does not make any\nsense, this should not break existing applications.\n\nUsers can still call Cipher#key= and Cipher#iv= multiple times with\ntheir own responsibility.\n\nReference: https://bugs.ruby-lang.org/issues/2768\nReference: https://bugs.ruby-lang.org/issues/8221\nReference: https://github.com/ruby/openssl/issues/49",
    "type_of_change": "Modification",
    "filename_of_changes": "ossl_cipher.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "13",
    "number_of_lines_deleted_vulnerable_to_cve": "12",
    "vulnerable_lines": [
        "// Line_Reference 39: static ID id_auth_tag_len;",
        "// Line_Reference 121:     unsigned char dummy_key[EVP_MAX_KEY_LENGTH] = { 0 };",
        "// Line_Reference 132:     /*",
        "// Line_Reference 133:      * EVP_CipherInit_ex() allows to specify NULL to key and IV, however some",
        "// Line_Reference 134:      * ciphers don't handle well (OpenSSL's bug). [Bug #2768]",
        "// Line_Reference 135:      *",
        "// Line_Reference 136:      * The EVP which has EVP_CIPH_RAND_KEY flag (such as DES3) allows",
        "// Line_Reference 137:      * uninitialized key, but other EVPs (such as AES) does not allow it.",
        "// Line_Reference 138:      * Calling EVP_CipherUpdate() without initializing key causes SEGV so we",
        "// Line_Reference 139:      * set the data filled with \"\\0\" as the key by default.",
        "// Line_Reference 140:      */",
        "// Line_Reference 141:     if (EVP_CipherInit_ex(ctx, cipher, NULL, dummy_key, NULL, -1) != 1)"
    ]
}
