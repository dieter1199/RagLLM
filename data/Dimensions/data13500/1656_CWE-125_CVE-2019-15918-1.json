{
    "cve_id": "CVE-2019-15918",
    "cve_description": "An issue was discovered in the Linux kernel before 5.0.10. SMB2_negotiate in fs/cifs/smb2pdu.c has an out-of-bounds read because data structures are incompletely updated after a change from smb30 to smb21.",
    "cve_publish_date": "2019-09-04",
    "cwe_id": "CWE-125",
    "cwe_name": "Out-of-bounds Read",
    "cwe_description": "The product reads data past the end, or before the beginning, of the intended buffer.",
    "commit_message": "cifs: Fix lease buffer length error\n\nThere is a KASAN slab-out-of-bounds:\nBUG: KASAN: slab-out-of-bounds in _copy_from_iter_full+0x783/0xaa0\nRead of size 80 at addr ffff88810c35e180 by task mount.cifs/539\n\nCPU: 1 PID: 539 Comm: mount.cifs Not tainted 4.19 #10\nHardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS\n            rel-1.12.0-0-ga698c8995f-prebuilt.qemu.org 04/01/2014\nCall Trace:\n dump_stack+0xdd/0x12a\n print_address_description+0xa7/0x540\n kasan_report+0x1ff/0x550\n check_memory_region+0x2f1/0x310\n memcpy+0x2f/0x80\n _copy_from_iter_full+0x783/0xaa0\n tcp_sendmsg_locked+0x1840/0x4140\n tcp_sendmsg+0x37/0x60\n inet_sendmsg+0x18c/0x490\n sock_sendmsg+0xae/0x130\n smb_send_kvec+0x29c/0x520\n __smb_send_rqst+0x3ef/0xc60\n smb_send_rqst+0x25a/0x2e0\n compound_send_recv+0x9e8/0x2af0\n cifs_send_recv+0x24/0x30\n SMB2_open+0x35e/0x1620\n open_shroot+0x27b/0x490\n smb2_open_op_close+0x4e1/0x590\n smb2_query_path_info+0x2ac/0x650\n cifs_get_inode_info+0x1058/0x28f0\n cifs_root_iget+0x3bb/0xf80\n cifs_smb3_do_mount+0xe00/0x14c0\n cifs_do_mount+0x15/0x20\n mount_fs+0x5e/0x290\n vfs_kern_mount+0x88/0x460\n do_mount+0x398/0x31e0\n ksys_mount+0xc6/0x150\n __x64_sys_mount+0xea/0x190\n do_syscall_64+0x122/0x590\n entry_SYSCALL_64_after_hwframe+0x44/0xa9\n\nIt can be reproduced by the following step:\n  1. samba configured with: server max protocol = SMB2_10\n  2. mount -o vers=default\n\nWhen parse the mount version parameter, the 'ops' and 'vals'\nwas setted to smb30,  if negotiate result is smb21, just\nupdate the 'ops' to smb21, but the 'vals' is still smb30.\nWhen add lease context, the iov_base is allocated with smb21\nops, but the iov_len is initiallited with the smb30. Because\nthe iov_len is longer than iov_base, when send the message,\ncopy array out of bounds.\n\nwe need to keep the 'ops' and 'vals' consistent.\n\nFixes: 9764c02fcbad (\"SMB3: Add support for multidialect negotiate (SMB2.1 and later)\")\nFixes: d5c7076b772a (\"smb3: add smb3.1.1 to default dialect list\")\n\nSigned-off-by: ZhangXiaoxu <zhangxiaoxu5@huawei.com>\nSigned-off-by: Steve French <stfrench@microsoft.com>\nCC: Stable <stable@vger.kernel.org>\nReviewed-by: Pavel Shilovsky <pshilov@microsoft.com>",
    "type_of_change": "Modification",
    "filename_of_changes": "smb2pdu.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "4",
    "number_of_lines_deleted_vulnerable_to_cve": "1",
    "vulnerable_lines": [
        "// Line_Reference 835: \t\t} else if (rsp->DialectRevision == cpu_to_le16(SMB311_PROT_ID))"
    ]
}
