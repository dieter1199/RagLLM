{
    "cve_id": "CVE-2021-3817",
    "cve_description": "wbce_cms is vulnerable to Improper Neutralization of Special Elements used in an SQL Command",
    "cve_publish_date": "2021-12-09",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "add captcha for login forgot",
    "type_of_change": "Modification",
    "filename_of_changes": "index.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "101",
    "number_of_lines_deleted_vulnerable_to_cve": "75",
    "vulnerable_lines": [
        "// Line_Reference 25: if (isset($_POST['email']) and $_POST['email'] != \"\") {",
        "// Line_Reference 27:     if ($admin->validate_email($email) == false) {",
        "// Line_Reference 28:         $oMsgBox->error($MESSAGE['USERS_INVALID_EMAIL']);",
        "// Line_Reference 31: ",
        "// Line_Reference 32:     // Check if the email exists in the database",
        "// Line_Reference 33:     $sSql = \"SELECT * FROM `{TP}users` WHERE `email` = '\" . $email . \"'\";",
        "// Line_Reference 34:     $rRow = $database->query($sSql);",
        "// Line_Reference 35:     if ($rRow->numRows() > 0) {",
        "// Line_Reference 36: ",
        "// Line_Reference 37:         // Get the id, username, email, and last_reset from the above db query",
        "// Line_Reference 38:         $aUser = $rRow->fetchRow();",
        "// Line_Reference 39:         if (strlen($aUser['signup_confirmcode']) > 25) {",
        "// Line_Reference 40:             header(\"Location: \" . WB_URL . \"/account/signup_continue_page.php?switch=wrong_inputs\");",
        "// Line_Reference 41:             exit(0); // break up the script here",
        "// Line_Reference 42:         }",
        "// Line_Reference 43: ",
        "// Line_Reference 44: ",
        "// Line_Reference 45:         // Check if the password has been reset in the last 2 hours",
        "// Line_Reference 46:         if ((time() - intval($aUser['last_reset'])) < (2 * 3600)) {",
        "// Line_Reference 47:             // Tell the user that their password cannot be reset more than once per hour",
        "// Line_Reference 48:             $oMsgBox->error($MESSAGE['FORGOT_PASS_ALREADY_RESET']);",
        "// Line_Reference 49:         } else {",
        "// Line_Reference 50:             $sCurrentPw = $aUser['password'];",
        "// Line_Reference 51: ",
        "// Line_Reference 52:             // Generate a random password then update the database with it",
        "// Line_Reference 53:             $sNewPw = '';",
        "// Line_Reference 54:             $salt = \"abchefghjkmnpqrstuvwxyz0123456789\";",
        "// Line_Reference 55:             srand((double)microtime() * 1000000);",
        "// Line_Reference 56:             $i = 0;",
        "// Line_Reference 57:             while ($i <= 7) {",
        "// Line_Reference 58:                 $num = rand() % 33;",
        "// Line_Reference 59:                 $tmp = substr($salt, $num, 1);",
        "// Line_Reference 60:                 $sNewPw = $sNewPw . $tmp;",
        "// Line_Reference 61:                 $i++;",
        "// Line_Reference 64:             // update the new password in the database",
        "// Line_Reference 65:             $aUpdateUser = array(",
        "// Line_Reference 66:                 'user_id' => $aUser['user_id'],",
        "// Line_Reference 67:                 'password' => $wb->doPasswordEncode($sNewPw),",
        "// Line_Reference 68:                 'last_reset' => time(),",
        "// Line_Reference 69:             );",
        "// Line_Reference 70:             $database->updateRow('{TP}users', 'user_id', $aUpdateUser);",
        "// Line_Reference 71: ",
        "// Line_Reference 72:             if ($database->is_error()) {",
        "// Line_Reference 73:                 // Error updating database",
        "// Line_Reference 74:                 $oMsgBox->error($database->get_error());",
        "// Line_Reference 75:             } else {",
        "// Line_Reference 76:                 // Setup email to send",
        "// Line_Reference 77:                 $mail_to = $email;",
        "// Line_Reference 78:                 $mail_subject = $MESSAGE['SIGNUP2_SUBJECT_LOGIN_INFO'];",
        "// Line_Reference 79: ",
        "// Line_Reference 80:                 // Replace placeholders from language variable with values",
        "// Line_Reference 81:                 $search = array('{LOGIN_DISPLAY_NAME}', '{LOGIN_WEBSITE_TITLE}', '{LOGIN_NAME}', '{LOGIN_PASSWORD}');",
        "// Line_Reference 82:                 $replace = array($aUser['display_name'], WEBSITE_TITLE, $aUser['username'], $sNewPw);",
        "// Line_Reference 83: ",
        "// Line_Reference 84:                 $aTokenReplace = array(",
        "// Line_Reference 85:                     '{LOGIN_DISPLAY_NAME}' => $aUser['display_name'],",
        "// Line_Reference 86:                     '{LOGIN_NAME}' => $aUser['username'],",
        "// Line_Reference 87:                     '{LOGIN_WEBSITE_TITLE}' => WEBSITE_TITLE,",
        "// Line_Reference 88:                     '{LOGIN_PASSWORD}' => $sNewPw",
        "// Line_Reference 89:                 );",
        "// Line_Reference 92:                 $mail_message = strtr($MESSAGE['SIGNUP2_BODY_LOGIN_FORGOT'], $aTokenReplace);",
        "// Line_Reference 94:                 // Try sending the email",
        "// Line_Reference 95:                 if ($admin->mail(SERVER_EMAIL, $mail_to, $mail_subject, $mail_message)) {",
        "// Line_Reference 96:                     $oMsgBox->error($MESSAGE['FORGOT_PASS_PASSWORD_RESET']);",
        "// Line_Reference 97:                     $display_form = false;",
        "// Line_Reference 99:                     $aUpdateUser = array(",
        "// Line_Reference 100:                         'user_id' => $aUser['user_id'],",
        "// Line_Reference 101:                         'password' => $sCurrentPw",
        "// Line_Reference 103:                     $database->updateRow('{TP}users', 'user_id', $aUpdateUser);",
        "// Line_Reference 104:                     $oMsgBox->error($MESSAGE['FORGOT_PASS_CANNOT_EMAIL']);",
        "// Line_Reference 108:     } else {",
        "// Line_Reference 109:         // Email doesn't exist, so tell the user",
        "// Line_Reference 110:         $oMsgBox->error($MESSAGE['FORGOT_PASS_EMAIL_NOT_FOUND']);",
        "// Line_Reference 111:         // and delete the wrong Email",
        "// Line_Reference 112:         $email = '';"
    ]
}
