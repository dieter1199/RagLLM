{
    "cve_id": "CVE-2017-15052",
    "cve_description": "TeamPass before 2.1.27.9 does not properly enforce manager access control when requesting users.queries.php. It is then possible for a manager user to delete an arbitrary user (including admin), or modify attributes of any arbitrary user except administrator. To exploit the vulnerability, an authenticated attacker must have the manager rights on the application, then tamper with the requests sent directly, for example by changing the \"id\" parameter when invoking \"delete_user\" on users.queries.php.",
    "cve_publish_date": "2017-11-27",
    "cwe_id": "CWE-269",
    "cwe_name": "Improper Privilege Management",
    "cwe_description": "The product does not properly assign, modify, track, or check privileges for an actor, creating an unintended sphere of control for that actor.",
    "commit_message": "2.1.27\n\nImproved checks to perform operation on Items and Users",
    "type_of_change": "Modification",
    "filename_of_changes": "users.load.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "23",
    "number_of_lines_deleted_vulnerable_to_cve": "142",
    "vulnerable_lines": [
        "// Line_Reference 149:                     if (data.error == \"not_allowed\") {",
        "// Line_Reference 211:     $(\"#change_user_functions\").dialog({",
        "// Line_Reference 212:         bgiframe: true,",
        "// Line_Reference 213:         modal: true,",
        "// Line_Reference 214:         autoOpen: false,",
        "// Line_Reference 215:         width: 400,",
        "// Line_Reference 216:         height: 400,",
        "// Line_Reference 217:         title: \"<?php echo $LANG['change_user_functions_title']; ?>\",",
        "// Line_Reference 218:         buttons: {",
        "// Line_Reference 219:             \"<?php echo $LANG['save_button']; ?>\": function() {",
        "// Line_Reference 220:                 Change_user_rights(document.getElementById(\"selected_user\").value,\"functions\");",
        "// Line_Reference 221:                 $(this).dialog(\"close\");",
        "// Line_Reference 222:             },",
        "// Line_Reference 223:             \"<?php echo $LANG['cancel_button']; ?>\": function() {",
        "// Line_Reference 224:                 $(this).dialog(\"close\");",
        "// Line_Reference 225:             }",
        "// Line_Reference 226:         }",
        "// Line_Reference 227:     });",
        "// Line_Reference 228: ",
        "// Line_Reference 229:     $(\"#change_user_autgroups\").dialog({",
        "// Line_Reference 230:         bgiframe: true,",
        "// Line_Reference 231:         modal: true,",
        "// Line_Reference 232:         autoOpen: false,",
        "// Line_Reference 233:         width: 400,",
        "// Line_Reference 234:         height: 400,",
        "// Line_Reference 235:         title: \"<?php echo $LANG['change_user_autgroups_title']; ?>\",",
        "// Line_Reference 236:         buttons: {",
        "// Line_Reference 237:             \"<?php echo $LANG['save_button']; ?>\": function() {",
        "// Line_Reference 238:                 Change_user_rights(document.getElementById(\"selected_user\").value,\"autgroups\");",
        "// Line_Reference 239:                 $(this).dialog(\"close\");",
        "// Line_Reference 240:             },",
        "// Line_Reference 241:             \"<?php echo $LANG['cancel_button']; ?>\": function() {",
        "// Line_Reference 242:                 $(this).dialog(\"close\");",
        "// Line_Reference 243:             }",
        "// Line_Reference 244:         }",
        "// Line_Reference 245:     });",
        "// Line_Reference 246: ",
        "// Line_Reference 247:     $(\"#change_user_forgroups\").dialog({",
        "// Line_Reference 248:         bgiframe: true,",
        "// Line_Reference 249:         modal: true,",
        "// Line_Reference 250:         autoOpen: false,",
        "// Line_Reference 251:         width: 400,",
        "// Line_Reference 252:         height: 400,",
        "// Line_Reference 253:         title: \"<?php echo $LANG['change_user_forgroups_title']; ?>\",",
        "// Line_Reference 254:         buttons: {",
        "// Line_Reference 255:             \"<?php echo $LANG['save_button']; ?>\": function() {",
        "// Line_Reference 256:                 Change_user_rights(document.getElementById(\"selected_user\").value,\"forgroups\");",
        "// Line_Reference 257:                 $(this).dialog(\"close\");",
        "// Line_Reference 258:             },",
        "// Line_Reference 259:             \"<?php echo $LANG['cancel_button']; ?>\": function() {",
        "// Line_Reference 260:                 $(this).dialog(\"close\");",
        "// Line_Reference 261:             }",
        "// Line_Reference 262:         }",
        "// Line_Reference 263:     });;",
        "// Line_Reference 264: ",
        "// Line_Reference 265:     $(\"#change_user_adminby\").dialog({",
        "// Line_Reference 266:         bgiframe: true,",
        "// Line_Reference 267:         modal: true,",
        "// Line_Reference 268:         autoOpen: false,",
        "// Line_Reference 269:         width: 400,",
        "// Line_Reference 270:         height: 200,",
        "// Line_Reference 271:         title: \"<?php echo $LANG['is_administrated_by_role']; ?>\",",
        "// Line_Reference 272:         buttons: {",
        "// Line_Reference 273:             \"<?php echo $LANG['save_button']; ?>\": function() {",
        "// Line_Reference 274:                 $.post(",
        "// Line_Reference 275:                     \"sources/users.queries.php\",",
        "// Line_Reference 276:                     {",
        "// Line_Reference 277:                         type    :\"change_user_adminby\",",
        "// Line_Reference 278:                         userId : $(\"#selected_user\").val(),",
        "// Line_Reference 279:                         isAdministratedByRole : $(\"#user_admin_by\").val(),",
        "// Line_Reference 280:                         key    : \"<?php echo $_SESSION['key']; ?>\"",
        "// Line_Reference 281:                     },",
        "// Line_Reference 282:                     function(data) {",
        "// Line_Reference 283:                         if ($(\"#user_admin_by\").val() == \"0\") {",
        "// Line_Reference 284:                             $(\"#list_adminby_\"+$(\"#selected_user\").val()).",
        "// Line_Reference 285:                             html(\"<?php echo $LANG['admin_small']; ?>\");",
        "// Line_Reference 286:                         } else {",
        "// Line_Reference 287:                             $(\"#list_adminby_\"+$(\"#selected_user\").val()).",
        "// Line_Reference 288:                             html($(\"#user_admin_by option:selected\").text().match(/\"([^\"]+)\"/)[1]);",
        "// Line_Reference 289:                         }",
        "// Line_Reference 290:                         $(\"#change_user_adminby\").dialog(\"close\");",
        "// Line_Reference 291:                     }",
        "// Line_Reference 292:                )",
        "// Line_Reference 293:             },",
        "// Line_Reference 294:             \"<?php echo $LANG['cancel_button']; ?>\": function() {",
        "// Line_Reference 295:                 $(this).dialog(\"close\");",
        "// Line_Reference 296:             }",
        "// Line_Reference 297:         }",
        "// Line_Reference 298:     });",
        "// Line_Reference 299: ",
        "// Line_Reference 352:                             if (data[0].error == \"no\") {",
        "// Line_Reference 387:                         type    : \"delete_user\",",
        "// Line_Reference 388:                         id        : $(\"#delete_user_id\").val(),",
        "// Line_Reference 389:                         action    : $(\"#delete_user_action\").val(),",
        "// Line_Reference 390:                         key        : \"<?php echo $_SESSION['key']; ?>\"",
        "// Line_Reference 393:                         window.location.href = \"index.php?page=manage_users\";",
        "// Line_Reference 638:                     id   : $('#user_edit_id').val(),",
        "// Line_Reference 642:                     if (data.error == \"no\") {",
        "// Line_Reference 671:                         $(\"#user_edit_error\").html(\"<?php echo $LANG['error_unknown']; ?>\")",
        "// Line_Reference 727:                         if (data[0].error == \"no\") {",
        "// Line_Reference 728: ",
        "// Line_Reference 730:                         // refresh table content",
        "// Line_Reference 731:                         tableUsers.api().ajax.reload();",
        "// Line_Reference 732:                         $(\"#user_management_dialog\").dialog(\"close\");",
        "// Line_Reference 1004: function Change_user_rights(id,type)",
        "// Line_Reference 1005: {",
        "// Line_Reference 1006:     var list = \"\";",
        "// Line_Reference 1007:     if (type == \"functions\") var form = document.forms.tmp_functions;",
        "// Line_Reference 1008:     if (type == \"autgroups\") var form = document.forms.tmp_autgroups;",
        "// Line_Reference 1009:     if (type == \"forgroups\") var form = document.forms.tmp_forgroups;",
        "// Line_Reference 1010: ",
        "// Line_Reference 1011:     $(\"#div_loading\").show();",
        "// Line_Reference 1012: ",
        "// Line_Reference 1013:     for (i=0 ; i<= form.length-1 ; i++) {",
        "// Line_Reference 1014:         if (form[i].type == \"checkbox\" && form[i].checked) {",
        "// Line_Reference 1015:             function_id = form[i].id.split(\"-\")",
        "// Line_Reference 1016:             if (list == \"\") list = function_id[1];",
        "// Line_Reference 1017:             else list = list + \";\" + function_id[1];",
        "// Line_Reference 1018:         }",
        "// Line_Reference 1019:     }",
        "// Line_Reference 1020: ",
        "// Line_Reference 1021:     $.post(\"sources/users.queries.php\",",
        "// Line_Reference 1022:         {",
        "// Line_Reference 1023:             type    : \"change_user_\"+type,",
        "// Line_Reference 1024:             id      : id,",
        "// Line_Reference 1025:             list    : list,",
        "// Line_Reference 1026:             key     : \"<?php echo $_SESSION['key']; ?>\"",
        "// Line_Reference 1027:         },",
        "// Line_Reference 1028:         function(data) {",
        "// Line_Reference 1029:             if (type == \"functions\") {",
        "// Line_Reference 1030:                 $(\"#list_function_user_\"+id).html(data[0].text);",
        "// Line_Reference 1031:             } else if (type == \"autgroups\") {",
        "// Line_Reference 1032:                 $(\"#list_autgroups_user_\"+id).html(data[0].text);",
        "// Line_Reference 1033:             } else if (type == \"forgroups\") {",
        "// Line_Reference 1034:                 $(\"#list_forgroups_user_\"+id).html(data[0].text);",
        "// Line_Reference 1035:             }",
        "// Line_Reference 1036:             $(\"#div_loading\").hide();",
        "// Line_Reference 1037:         },",
        "// Line_Reference 1038:         \"json\"",
        "// Line_Reference 1039:    );",
        "// Line_Reference 1040: }",
        "// Line_Reference 1041: "
    ]
}
