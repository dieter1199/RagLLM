{
    "cve_id": "CVE-2021-3429",
    "cve_description": "When instructing cloud-init to set a random password for a new user account, versions before 21.2 would write that password to the world-readable log file /var/log/cloud-init-output.log. This could allow a local user to log in as another user.",
    "cve_publish_date": "2023-04-19",
    "cwe_id": "CWE-532",
    "cwe_name": "Insertion of Sensitive Information into Log File",
    "cwe_description": "Information written to log files can be of a sensitive nature and give valuable guidance to an attacker or expose sensitive user information.",
    "commit_message": "write passwords only to serial console, lock down cloud-init-output.log (#847)\n\nPrior to this commit, when a user specified configuration which would\r\ngenerate random passwords for users, cloud-init would cause those\r\npasswords to be written to the serial console by emitting them on\r\nstderr.  In the default configuration, any stdout or stderr emitted by\r\ncloud-init is also written to `/var/log/cloud-init-output.log`.  This\r\nfile is world-readable, meaning that those randomly-generated passwords\r\nwere available to be read by any user with access to the system.  This\r\npresents an obvious security issue.\r\n\r\nThis commit responds to this issue in two ways:\r\n\r\n* We address the direct issue by moving from writing the passwords to\r\n  sys.stderr to writing them directly to /dev/console (via\r\n  util.multi_log); this means that the passwords will never end up in\r\n  cloud-init-output.log\r\n* To avoid future issues like this, we also modify the logging code so\r\n  that any files created in a log sink subprocess will only be\r\n  owner/group readable and, if it exists, will be owned by the adm\r\n  group.  This results in `/var/log/cloud-init-output.log` no longer\r\n  being world-readable, meaning that if there are other parts of the\r\n  codebase that are emitting sensitive data intended for the serial\r\n  console, that data is no longer available to all users of the system.\r\n\r\nLP: #1918303",
    "type_of_change": "Modification",
    "filename_of_changes": "test_set_passwords.py",
    "code_language": "Python",
    "number_of_lines_added_for_mitigation": "30",
    "number_of_lines_deleted_vulnerable_to_cve": "10",
    "vulnerable_lines": [
        "// Line_Reference 77:     def setUp(self):",
        "// Line_Reference 78:         super(TestSetPasswordsHandle, self).setUp()",
        "// Line_Reference 79:         self.add_patch('cloudinit.config.cc_set_passwords.sys.stderr', 'm_err')",
        "// Line_Reference 80: ",
        "// Line_Reference 134:     def test_handle_on_chpasswd_list_creates_random_passwords(self, m_subp,",
        "// Line_Reference 135:                                                               m_is_bsd):",
        "// Line_Reference 149:         self.assertNotEqual(",
        "// Line_Reference 150:             [mock.call(['chpasswd'],",
        "// Line_Reference 151:              '\\n'.join(valid_random_pwds) + '\\n')],",
        "// Line_Reference 152:             m_subp.call_args_list)"
    ]
}
