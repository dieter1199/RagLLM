{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "Export.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "117",
    "number_of_lines_deleted_vulnerable_to_cve": "141",
    "vulnerable_lines": [
        "// Line_Reference 50:         $fields_list = array('FULL_NAME' => (Preferences('NAME') == 'Common' ? _lastCommon : _lastFirstM),",
        "// Line_Reference 51:          'FIRST_NAME' =>_first,",
        "// Line_Reference 52:          'FIRST_INIT' =>_firstInitial,",
        "// Line_Reference 53:          'LAST_NAME' =>_last,",
        "// Line_Reference 54:          'MIDDLE_NAME' =>_middle,",
        "// Line_Reference 55:          'ETHNICITY_ID' =>_ethnicity,",
        "// Line_Reference 56:         'LANGUAGE_ID'=>_language,",
        "// Line_Reference 57:         'NAME_SUFFIX' =>_suffix,",
        "// Line_Reference 58:          'GENDER'=>_gender,",
        "// Line_Reference 59:         'STUDENT_ID' =>_studentId,",
        "// Line_Reference 60:          'GRADE_ID' =>_grade,",
        "// Line_Reference 61:         'SECTION_ID' =>_section,",
        "// Line_Reference 62:          'SCHOOL_ID' =>_school,",
        "// Line_Reference 63:          'NEXT_SCHOOL' =>_rollingRetentionOptions,",
        "// Line_Reference 64:          'CALENDAR_ID' =>_calendar,",
        "// Line_Reference 65:          'USERNAME' =>_username,",
        "// Line_Reference 66:          'PASSWORD' =>_password,",
        "// Line_Reference 67:          'ALT_ID' =>_alternateId,",
        "// Line_Reference 68:          'BIRTHDATE' =>_dob,",
        "// Line_Reference 69:          'EMAIL' =>_emailId,",
        "// Line_Reference 70:          'ADDRESS' =>_address,",
        "// Line_Reference 71:          'CITY' =>_city,",
        "// Line_Reference 72:          'STATE' =>_state,",
        "// Line_Reference 73:          'ZIPCODE' =>_zipCode,",
        "// Line_Reference 74:          'PHONE' =>_phone,",
        "// Line_Reference 75:          'MAIL_ADDRESS' =>_mailingAddress,",
        "// Line_Reference 76:          'MAIL_CITY' =>_mailingCity,",
        "// Line_Reference 77:          'MAIL_STATE' =>_mailingState,",
        "// Line_Reference 78:          'MAIL_ZIPCODE' =>_mailingZipcode,",
        "// Line_Reference 79:          'PARENTS' => contacts",
        "// Line_Reference 129:     if ($_REQUEST['fields']['USERNAME'] == 'Y')",
        "// Line_Reference 130:     {",
        "// Line_Reference 131: $extra['SELECT'] .= ',la.username';",
        "// Line_Reference 132: $extra['FROM'].=', login_authentication la';",
        "// Line_Reference 133: $extra['WHERE'].=' AND la.USER_ID=s.STUDENT_ID AND la.profile_id=3  ';",
        "// Line_Reference 158: //        echo '<pre>';",
        "// Line_Reference 159: //        print_r($RET);",
        "// Line_Reference 160: //        echo $RET[1]['ETHNICITY_ID'];",
        "// Line_Reference 161: //        exit;",
        "// Line_Reference 162:         $i=1;",
        "// Line_Reference 164:             if($RET[$i]['LANGUAGE_ID'] != ''){",
        "// Line_Reference 165:             $sql_language= DBGet(DBQuery(\"SELECT language_name FROM language WHERE language_id=\".$RET[$i]['LANGUAGE_ID']));",
        "// Line_Reference 166:             $RET[$i]['LANGUAGE_ID']=$sql_language[1]['LANGUAGE_NAME'];",
        "// Line_Reference 168:              if($RET[$i]['ETHNICITY_ID'] != ''){",
        "// Line_Reference 169:             $sql_ethinicity= DBGet(DBQuery(\"SELECT ethnicity_name FROM ethnicity WHERE ethnicity_id=\".$RET[$i]['ETHNICITY_ID']));",
        "// Line_Reference 170:             $RET[$i]['ETHNICITY_ID']= $sql_ethinicity[1]['ETHNICITY_NAME'];",
        "// Line_Reference 172:             $i=$i+1;",
        "// Line_Reference 179: ",
        "// Line_Reference 180: ",
        "// Line_Reference 181:         foreach($columns as $stu_indx=> $stu_data)",
        "// Line_Reference 182:                     {",
        "// Line_Reference 183:             $f=0;",
        "// Line_Reference 184: ",
        "// Line_Reference 185:                     if(!in_array($stu_indx,$list_attr_val))",
        "// Line_Reference 186:                     {",
        "// Line_Reference 187:                       $f=1;",
        "// Line_Reference 189:                     }",
        "// Line_Reference 190:  else {",
        "// Line_Reference 191:      $f=0;",
        "// Line_Reference 192:      break;",
        "// Line_Reference 193:  }",
        "// Line_Reference 194:                    }",
        "// Line_Reference 201:                  $add_reslt = \"SELECT CASE WHEN (sa.STREET_ADDRESS_1 IS NOT NULL && sa.STREET_ADDRESS_2 IS NOT NULL) THEN CONCAT(sa.STREET_ADDRESS_1,' ,',sa.STREET_ADDRESS_2) ELSE sa.STREET_ADDRESS_1 END as ADDRESS, sa.CITY,sa.STATE,sa.ZIPCODE,COALESCE((SELECT STREET_ADDRESS_1 FROM student_address WHERE student_id=\" . $stu_val['STUDENT_ID'] . \" AND TYPE='MAIL' ORDER BY syear DESC LIMIT 0,1),sa.STREET_ADDRESS_1) AS MAIL_ADDRESS,COALESCE((SELECT CITY FROM student_address WHERE student_id=\" . $stu_val['STUDENT_ID'] . \" AND TYPE='MAIL' ORDER BY syear DESC LIMIT 0,1),sa.CITY) AS MAIL_CITY,COALESCE((SELECT STATE FROM student_address WHERE student_id=\" . $stu_val['STUDENT_ID'] . \" AND TYPE='MAIL' ORDER BY syear DESC LIMIT 0,1),sa.STATE) AS MAIL_STATE,COALESCE((SELECT ZIPCODE FROM student_address WHERE student_id=\" . $stu_val['STUDENT_ID'] . \" AND TYPE='MAIL' ORDER BY syear DESC LIMIT 0,1),sa.ZIPCODE) AS MAIL_ZIPCODE  from student_address sa WHERE sa.TYPE='HOME ADDRESS' AND sa.STUDENT_ID = '\" . $stu_val['STUDENT_ID'] .\"' ORDER BY syear DESC\";",
        "// Line_Reference 202: ",
        "// Line_Reference 205:                     foreach ($res[1] as $add_key => $add_val) {",
        "// Line_Reference 206:                         $RET[$stu_key][$add_key] = $add_val;",
        "// Line_Reference 207: ",
        "// Line_Reference 208:                     }",
        "// Line_Reference 209: ",
        "// Line_Reference 210:                         if(empty($res[1]) && $f==1)",
        "// Line_Reference 211:                             unset($RET[$stu_key]);",
        "// Line_Reference 212: ",
        "// Line_Reference 214:         } echo \"<br><br>\";",
        "// Line_Reference 219: ",
        "// Line_Reference 220:         ListOutputPrint_Report($RET, $columns, $extra['singular'] ? $extra['singular'] : student, $extra['plural'] ? $extra['plural'] : students, array(), $extra['LO_group'], $extra['LO_options']);",
        "// Line_Reference 224: }",
        "// Line_Reference 225: else {",
        "// Line_Reference 228:             $fields_list['General'] = array('FULL_NAME' => (Preferences('NAME') == 'Common' ? _lastCommon : _lastFirstM),",
        "// Line_Reference 229:              'FIRST_NAME' =>_first,",
        "// Line_Reference 230:              'FIRST_INIT' =>_firstInitial,",
        "// Line_Reference 231:              'LAST_NAME' =>_last,",
        "// Line_Reference 232:              'MIDDLE_NAME' =>_middle,",
        "// Line_Reference 233:              'ETHNICITY_ID' =>_ethnicity,",
        "// Line_Reference 234:              'LANGUAGE_ID'=>_language,",
        "// Line_Reference 235:              'NAME_SUFFIX' =>_suffix,",
        "// Line_Reference 236:              'GENDER' =>_gender,",
        "// Line_Reference 237:              'STUDENT_ID' =>_studentId,",
        "// Line_Reference 238:              'GRADE_ID' =>_grade,",
        "// Line_Reference 239:              'SECTION_ID' =>_section,",
        "// Line_Reference 240:              'SCHOOL_ID' =>_school,",
        "// Line_Reference 241:              'NEXT_SCHOOL' =>_rollingRetentionOptions,",
        "// Line_Reference 242:              'CALENDAR_ID' =>_calendar,",
        "// Line_Reference 243:              'USERNAME' =>_username,",
        "// Line_Reference 244:              'ALT_ID' =>_alternateId,",
        "// Line_Reference 245:              'BIRTHDATE' =>_dob,",
        "// Line_Reference 246:              'EMAIL' =>_emailId,",
        "// Line_Reference 247:              'PHONE' =>_phone,",
        "// Line_Reference 248:         );",
        "// Line_Reference 250:             $fields_list['Address'] = array('ADDRESS' =>_address,",
        "// Line_Reference 251:              'CITY' =>_city,",
        "// Line_Reference 252:              'STATE' =>_state,",
        "// Line_Reference 253:              'ZIPCODE' =>_zipCode,",
        "// Line_Reference 254:              'MAIL_ADDRESS' =>_mailingAddress,",
        "// Line_Reference 255:              'MAIL_CITY' =>_mailingCity,",
        "// Line_Reference 256:              'MAIL_STATE' =>_mailingState,",
        "// Line_Reference 257:              'MAIL_ZIPCODE' =>_mailingZipcode,",
        "// Line_Reference 282:                 if($fields_list[generalInfo] !=''){",
        "// Line_Reference 283:                     $fields_list['General']+=$fields_list[generalInfo];",
        "// Line_Reference 289:     $periods_RET = DBGet(DBQuery('SELECT TITLE,PERIOD_ID FROM school_periods WHERE SYEAR=\\'' . UserSyear() . '\\' AND SCHOOL_ID=\\'' . UserSchool() . '\\''.($_REQUEST['period_id']!=''?\" AND PERIOD_ID=\".$_REQUEST['period_id'].\"\":\"\").' ORDER BY SORT_ORDER'));",
        "// Line_Reference 294:         $fields_list['Food_Service'] = array('FS_ACCOUNT_ID' => ''._accountID.'', 'FS_DISCOUNT' => ''._discount.'', 'FS_STATUS' => ''._status.'', 'FS_BARCODE' => ''._barcode.'', 'FS_BALANCE' => ''._balance.'');",
        "// Line_Reference 299:     PopTable_wo_header('header', '<i class=\"glyphicon glyphicon-tasks\"></i> &nbsp;'._selectFieldsToGenerateReport.'');",
        "// Line_Reference 336:                 $categoryTitle = $category ;",
        "// Line_Reference 338:             // case 'Demographic Info':",
        "// Line_Reference 339:             //     $categoryTitle = _demographicInfo;",
        "// Line_Reference 340:             //     break;",
        "// Line_Reference 341:             // case 'Addresses &amp; Contacts':",
        "// Line_Reference 342:             //     $categoryTitle = _addressesContacts;",
        "// Line_Reference 343:             //     break;",
        "// Line_Reference 344:             // case 'School Information':",
        "// Line_Reference 345:             //     $categoryTitle = _schoolInformation;",
        "// Line_Reference 346:             //     break;",
        "// Line_Reference 347:             // case 'Certification Information':",
        "// Line_Reference 348:             //     $categoryTitle = _certificationInformation;",
        "// Line_Reference 349:             //     break;",
        "// Line_Reference 350:             // case 'Schedule':",
        "// Line_Reference 351:             //     $categoryTitle = _schedule;",
        "// Line_Reference 352:             //     break;",
        "// Line_Reference 358:             }elseif($i == 1 && $j > 1){",
        "// Line_Reference 361:             echo '<div class=\"col-md-6\"><div class=\"checkbox\"><label><INPUT type=checkbox onclick=\"addHTML(\\'<li class=col-lg-6>' . $title . '</li>\\',\\'names_div\\',false);addHTML(\\'<INPUT type=hidden name=fields[' . $field . '] value=Y>\\',\\'fields_div\\',false);addHTML(\\'\\',\\'names_div_none\\',true);this.disabled=true\">' . $title . '</label></div>' . ($field == 'PARENTS' ? '<BR>(<small>'._relation.': </small><input type=text id=relation name=relation size=8>)' : '') . '</div>';",
        "// Line_Reference 362:             //if ($i % 2 == 0)",
        "// Line_Reference 363:             //echo '</TR><TR>';",
        "// Line_Reference 385:     echo '<h6 class=\"panel-title text-pink text-uppercase\"><i class=\"glyphicon glyphicon-saved\"></i> &nbsp;'._selectedFields.'</h6>';",
        "// Line_Reference 389:     echo '<div class=\"well\"><div id=\"names_div_none\" class=\"error_msg\" style=\"padding:6px 0px 0px 6px;\">'._noFieldsSelected.'</div><ol id=names_div class=row></ol></div>';",
        "// Line_Reference 401:   if($value!='')",
        "// Line_Reference 402:   {",
        "// Line_Reference 403:   $section=DBGet(DBQuery('SELECT * FROM school_gradelevel_sections WHERE ID='.$value));",
        "// Line_Reference 404:   $section=$section[1]['NAME'];",
        "// Line_Reference 405:   }",
        "// Line_Reference 406:   else",
        "// Line_Reference 407:       $section='';",
        "// Line_Reference 410: ?>"
    ]
}
