{
    "cve_id": "CVE-2021-3976",
    "cve_description": "kimai2 is vulnerable to Cross-Site Request Forgery (CSRF)",
    "cve_publish_date": "2021-11-19",
    "cwe_id": "CWE-352",
    "cwe_name": "Cross-Site Request Forgery (CSRF)",
    "cwe_description": "The web application does not, or can not, sufficiently verify whether a well-formed, valid, consistent request was intentionally provided by the user who submitted the request.",
    "commit_message": "version 1.16.2 (#2942)\n\n* bump version\r\n* include calendar week in week chooser\r\n* table names in SQL\r\n* show save flash message\r\n* prevent migration warning\r\n* drop default value to prevent error when server version is not set\r\n* csrf token for duplicate actions\r\n* updated translations",
    "type_of_change": "Modification",
    "filename_of_changes": "Version20181031220003.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "18",
    "number_of_lines_deleted_vulnerable_to_cve": "28",
    "vulnerable_lines": [
        "// Line_Reference 25:         $timesheet = 'kimai2_timesheet';",
        "// Line_Reference 26:         $projects = 'kimai2_projects';",
        "// Line_Reference 27:         $activities = 'kimai2_activities';",
        "// Line_Reference 28:         $users = 'kimai2_users';",
        "// Line_Reference 29:         $customers = 'kimai2_customers';",
        "// Line_Reference 30: ",
        "// Line_Reference 32:         $this->addSql('ALTER TABLE ' . $projects . ' DROP FOREIGN KEY FK_407F12069395C3F3');",
        "// Line_Reference 33:         $this->addSql('ALTER TABLE ' . $projects . ' CHANGE customer_id customer_id INT NOT NULL');",
        "// Line_Reference 34:         $this->addSql('ALTER TABLE ' . $projects . ' ADD CONSTRAINT FK_407F12069395C3F3 FOREIGN KEY (customer_id) REFERENCES ' . $customers . ' (id) ON DELETE CASCADE');",
        "// Line_Reference 36:         $this->addSql('ALTER TABLE ' . $timesheet . ' ADD project_id INT DEFAULT NULL AFTER activity_id');",
        "// Line_Reference 37:         $this->addSql('CREATE INDEX IDX_4F60C6B1166D1F9C ON ' . $timesheet . ' (project_id)');",
        "// Line_Reference 40:         $this->addSql('UPDATE ' . $timesheet . ' SET project_id = (SELECT project_id FROM ' . $activities . ' WHERE id = activity_id)');",
        "// Line_Reference 43:         $this->addSql('ALTER TABLE ' . $timesheet . ' DROP FOREIGN KEY FK_4F60C6B18D93D649');",
        "// Line_Reference 44:         $this->addSql('ALTER TABLE ' . $timesheet . ' DROP FOREIGN KEY FK_4F60C6B181C06096');",
        "// Line_Reference 45:         $this->addSql('ALTER TABLE ' . $timesheet . ' CHANGE project_id project_id INT NOT NULL, CHANGE user user INT NOT NULL, CHANGE activity_id activity_id INT NOT NULL');",
        "// Line_Reference 46:         $this->addSql('ALTER TABLE ' . $timesheet . ' ADD CONSTRAINT FK_4F60C6B1166D1F9C FOREIGN KEY (project_id) REFERENCES ' . $projects . ' (id) ON DELETE CASCADE');",
        "// Line_Reference 47:         $this->addSql('ALTER TABLE ' . $timesheet . ' ADD CONSTRAINT FK_4F60C6B18D93D649 FOREIGN KEY (user) REFERENCES ' . $users . ' (id) ON DELETE CASCADE');",
        "// Line_Reference 48:         $this->addSql('ALTER TABLE ' . $timesheet . ' ADD CONSTRAINT FK_4F60C6B181C06096 FOREIGN KEY (activity_id) REFERENCES ' . $activities . ' (id) ON DELETE CASCADE');",
        "// Line_Reference 53:         $timesheet = 'kimai2_timesheet';",
        "// Line_Reference 54:         $projects = 'kimai2_projects';",
        "// Line_Reference 55:         $customers = 'kimai2_customers';",
        "// Line_Reference 56: ",
        "// Line_Reference 58:         $this->addSql('ALTER TABLE ' . $projects . ' DROP FOREIGN KEY FK_407F12069395C3F3');",
        "// Line_Reference 59:         $this->addSql('ALTER TABLE ' . $projects . ' CHANGE customer_id customer_id INT DEFAULT NULL');",
        "// Line_Reference 60:         $this->addSql('ALTER TABLE ' . $projects . ' ADD CONSTRAINT FK_407F12069395C3F3 FOREIGN KEY (customer_id) REFERENCES ' . $customers . ' (id) ON DELETE CASCADE');",
        "// Line_Reference 62:         $this->addSql('ALTER TABLE ' . $timesheet . ' DROP FOREIGN KEY FK_4F60C6B1166D1F9C');",
        "// Line_Reference 63:         $this->addSql('DROP INDEX IDX_4F60C6B1166D1F9C ON ' . $timesheet);",
        "// Line_Reference 64:         $this->addSql('ALTER TABLE ' . $timesheet . ' DROP project_id, CHANGE user user INT DEFAULT NULL, CHANGE activity_id activity_id INT DEFAULT NULL');"
    ]
}
