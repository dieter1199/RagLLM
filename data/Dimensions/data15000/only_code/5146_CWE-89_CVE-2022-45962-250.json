session_start();
$_SESSION['db'] = clean_param($_REQUEST["db"], PARAM_DATA);
$newdb = clean_param($_REQUEST["newdb"], PARAM_ALPHA);
$purgedb = clean_param($_REQUEST["purgedb"], PARAM_ALPHA); // Added variable to check for removing existing data.
$dbconn = new mysqli($_SESSION['server'], $_SESSION['username'], $_SESSION['password'], $_SESSION['db'], $_SESSION['port']);
if ($dbconn->connect_errno == 0) {
if (!empty($newdb)) {
header('Location: Step2.php?err=Database Exists. Enter a different name to create a new database or use the remove data from existing database checkbox.');
exit;
if (empty($purgedb)) {
$sql = "SHOW TABLES";
$num_tables = $dbconn->query($sql);
$rows = $num_tables->num_rows;
// Get tables, loop thru the tables and drop each table.
$sql = "SHOW TABLES";
$num_tables = $dbconn->query($sql);
while ($row = $num_tables->fetch_row()) {
// Drop all tables.
$delete_table = $dbconn->query("DROP TABLE IF EXISTS $row[0]");
// Separate Drop for VIEWs is needed due to mysql syntax for views.
$delete_view = $dbconn->query("DROP VIEW IF EXISTS $row[0]");
// There is currently no way to drop functions without knowing
// the functions name and doing a DROP FUNCTION name
// so we have to modify the mysql file to remove functions first
// before trying to add them or else an error will occur.
if (!$delete_table) {
echo 'Unable to remove ' . $row[0] . '<br>';
}
// Free result set to clear memory
//        mysql_free_result($num_tables);
//This begins the add portion
$myFile = "OpensisSchemaMysqlInc.sql";
executeSQL($myFile);
$myFile = "OpensisProcsMysqlInc.sql";
executeSQL($myFile);
createUpdatedByTriggers();
$dbconn->close();
header('Location: Step3.php');
}
} else {
if (empty($newdb)) {
header('Location: Step2.php?err=Database does not exist. Enter a different database or use the create a new database checkbox.');
exit;
} else {
$dbconn = new mysqli($_SESSION['server'], $_SESSION['username'], $_SESSION['password'], '', $_SESSION['port']);
$sql = "CREATE DATABASE `" . $_SESSION['db'] . "` CHARACTER SET=utf8;";
$result = $dbconn->query($sql);
if (!$result) {
echo "<h2>" . $dbconn->error . "</h2>\n";
exit;
}
$myFile = "OpensisSchemaMysqlInc.sql";
executeSQL($myFile);
$myFile = "OpensisProcsMysqlInc.sql";
executeSQL($myFile);
createUpdatedByTriggers();
$dbconn->close();
// edited installation
header('Location: Step3.php');
}
}
