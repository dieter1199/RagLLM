{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "AdminProgressReports.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "84",
    "number_of_lines_deleted_vulnerable_to_cve": "43",
    "vulnerable_lines": [
        "// Line_Reference 135:                                                     AND s.COURSE_ID = cp.COURSE_ID AND ga.assignment_id = g.assignment_id AND (ga.MARKING_PERIOD_ID=\\''.UserMP().'\\' OR ga.MARKING_PERIOD_ID=\\''.$fy_mp_id.'\\') and  g.STUDENT_ID=\\''.$student[STUDENT_ID].'\\' and s.syear=\\''.UserSyear().'\\' group by cp.COURSE_PERIOD_ID'));",
        "// Line_Reference 165:                              $course_period_title=DBGet(DBQuery('SELECT TITLE FROM course_periods WHERE COURSE_PERIOD_ID=\\''.$course_period_id.'\\' '));",
        "// Line_Reference 166:                       echo '<table border=0 style=\\\"font-size:12px;\\\">';",
        "// Line_Reference 167:                       echo \"<tr><td>\"._course.\":</td><td>\".$course_title .\"</td></tr>\";",
        "// Line_Reference 168:                       echo \"<tr><td>\"._coursePeriod.\":</td><td>\".$course_period_title[1]['TITLE'].\"</td></tr>\";",
        "// Line_Reference 170: \t\t\tif($program_config[$course['TEACHER_ID']][$course_period_id]['WEIGHT']=='Y'){",
        "// Line_Reference 171:                                 $course_periods = DBGet(DBQuery('select marking_period_id from course_periods where course_period_id='.$course_period_id));",
        "// Line_Reference 172:                                 if($course_periods[1]['MARKING_PERIOD_ID']==NULL){",
        "// Line_Reference 173:                                     $assignment_type_ids = DBGet(DBQuery('SELECT group_concat(distinct(assignment_type_id)) AS assignment_type_ids FROM gradebook_assignments a JOIN gradebook_grades g ON (a.ASSIGNMENT_ID = g.ASSIGNMENT_ID AND g.STUDENT_ID=\\'' . $student['STUDENT_ID'] . '\\' AND g.COURSE_PERIOD_ID=\\'' . $course_period_id . '\\') WHERE (a.COURSE_PERIOD_ID=\\'' . $course_period_id . '\\' OR a.COURSE_ID=\\'' . $course_id . '\\') AND (a.MARKING_PERIOD_ID=\\'' . UserMP() . '\\' OR a.MARKING_PERIOD_ID=\\'' . $fy_mp_id . '\\')'));",
        "// Line_Reference 175:                                     $assignment_type_weight = DBGet(DBQuery('SELECT SUM(FINAL_GRADE_PERCENT) AS FINAL_GRADE_PERCENT FROM gradebook_assignment_types WHERE assignment_type_id IN (' . $assignment_type_ids[1]['ASSIGNMENT_TYPE_IDS'] . ')'));",
        "// Line_Reference 176:                                     $assignment_type_weight = $assignment_type_weight[1]['FINAL_GRADE_PERCENT'];",
        "// Line_Reference 178:                                     $school_years = DBGet(DBQuery('select marking_period_id from  school_years where  syear='.UserSyear().' and school_id='.UserSchool()));",
        "// Line_Reference 179:                                     $fy_mp_id = $school_years[1]['MARKING_PERIOD_ID'];",
        "// Line_Reference 180:                                     // $sql = 'SELECT '.$course_period_id.' as COURSE_PERIOD_ID,a.TITLE,t.TITLE AS ASSIGN_TYP,a.ASSIGNED_DATE,a.DUE_DATE,      t.ASSIGNMENT_TYPE_ID, (t.FINAL_GRADE_PERCENT / (SELECT SUM(FINAL_GRADE_PERCENT) FROM gradebook_assignment_types WHERE COURSE_ID = \\''.$course_id.'\\')) as FINAL_GRADE_PERCENT,(t.FINAL_GRADE_PERCENT / (SELECT SUM(FINAL_GRADE_PERCENT) FROM gradebook_assignment_types WHERE COURSE_ID = \\''.$course_id.'\\')) as ASSIGN_TYP_WG,t.FINAL_GRADE_PERCENT AS WEIGHT_GRADE  ,g.POINTS,a.POINTS AS TOTAL_POINTS,g.COMMENT,g.POINTS AS LETTER_GRADE,g.POINTS AS LETTERWTD_GRADE,'.$course['TEACHER_ID'].' AS CP_TEACHER_ID,CASE WHEN (a.ASSIGNED_DATE IS NULL OR CURRENT_DATE>=a.ASSIGNED_DATE) AND (a.DUE_DATE IS NULL OR CURRENT_DATE>=a.DUE_DATE) THEN \\'Y\\' ELSE NULL END AS DUE FROM gradebook_assignment_types t,gradebook_assignments a",
        "// Line_Reference 181:                                     //     LEFT OUTER JOIN gradebook_grades g ON (a.ASSIGNMENT_ID=g.ASSIGNMENT_ID AND g.STUDENT_ID=\\''.$student['STUDENT_ID'].'\\' AND g.COURSE_PERIOD_ID=\\''.$course_period_id.'\\')",
        "// Line_Reference 182:                                     //          WHERE   a.ASSIGNMENT_TYPE_ID=t.ASSIGNMENT_TYPE_ID AND (a.COURSE_PERIOD_ID=\\''.$course_period_id.'\\' OR a.COURSE_ID=\\''.$course_id.'\\' ) AND t.COURSE_ID=\\''.$course_id.'\\' AND (a.MARKING_PERIOD_ID=\\''.UserMP().'\\' OR a.MARKING_PERIOD_ID=\\''.$fy_mp_id.'\\')';",
        "// Line_Reference 184:                                     $sql = 'SELECT '.$course_period_id.' as COURSE_PERIOD_ID,a.TITLE,t.TITLE AS ASSIGN_TYP,a.ASSIGNED_DATE,a.DUE_DATE, t.ASSIGNMENT_TYPE_ID, (t.FINAL_GRADE_PERCENT / '.$assignment_type_weight.') as FINAL_GRADE_PERCENT,t.FINAL_GRADE_PERCENT as ASSIGN_TYP_WG,t.FINAL_GRADE_PERCENT AS WEIGHT_GRADE  ,g.POINTS,a.POINTS AS TOTAL_POINTS,g.COMMENT,g.POINTS AS LETTER_GRADE,g.POINTS AS LETTERWTD_GRADE,'.$course['TEACHER_ID'].' AS CP_TEACHER_ID,CASE WHEN (a.ASSIGNED_DATE IS NULL OR CURRENT_DATE>=a.ASSIGNED_DATE) AND (a.DUE_DATE IS NULL OR CURRENT_DATE>=a.DUE_DATE) THEN \\'Y\\' ELSE NULL END AS DUE FROM gradebook_assignment_types t,gradebook_assignments a LEFT OUTER JOIN gradebook_grades g ON (a.ASSIGNMENT_ID=g.ASSIGNMENT_ID AND g.STUDENT_ID=\\''.$student['STUDENT_ID'].'\\' AND g.COURSE_PERIOD_ID=\\''.$course_period_id.'\\') WHERE   a.ASSIGNMENT_TYPE_ID=t.ASSIGNMENT_TYPE_ID AND (a.COURSE_PERIOD_ID=\\''.$course_period_id.'\\' OR a.COURSE_ID=\\''.$course_id.'\\' ) AND t.COURSE_ID=\\''.$course_id.'\\' AND (a.MARKING_PERIOD_ID=\\''.UserMP().'\\' OR a.MARKING_PERIOD_ID=\\''.$fy_mp_id.'\\')';",
        "// Line_Reference 186:                                     }",
        "// Line_Reference 187:                             else{",
        "// Line_Reference 188:                                 $assignment_type_ids = DBGet(DBQuery('SELECT group_concat(distinct(assignment_type_id)) AS assignment_type_ids FROM gradebook_assignments a JOIN gradebook_grades g ON (a.ASSIGNMENT_ID = g.ASSIGNMENT_ID AND g.STUDENT_ID=\\'' . $student['STUDENT_ID'] . '\\' AND g.COURSE_PERIOD_ID=\\'' . $course_period_id . '\\') WHERE (a.COURSE_PERIOD_ID=\\'' . $course_period_id . '\\' OR a.COURSE_ID=\\'' . $course_id . '\\') AND (a.MARKING_PERIOD_ID=\\'' . UserMP() . '\\')'));",
        "// Line_Reference 190:                             $assignment_type_weight = DBGet(DBQuery('SELECT SUM(FINAL_GRADE_PERCENT) AS FINAL_GRADE_PERCENT FROM gradebook_assignment_types WHERE assignment_type_id IN ('.$assignment_type_ids[1]['ASSIGNMENT_TYPE_IDS'].')'));",
        "// Line_Reference 191:                             $assignment_type_weight = $assignment_type_weight[1]['FINAL_GRADE_PERCENT'];",
        "// Line_Reference 207:                                     $sql = 'SELECT '.$course_period_id.' as COURSE_PERIOD_ID,a.TITLE,t.TITLE AS ASSIGN_TYP,a.ASSIGNED_DATE,a.DUE_DATE,\\'-1\\' AS ASSIGNMENT_TYPE_ID,\\'1\\' AS FINAL_GRADE_PERCENT,\\'N/A\\' as ASSIGN_TYP_WG,\\'N/A\\' as WEIGHT_GRADE,g.POINTS,a.POINTS AS TOTAL_POINTS,g.COMMENT,g.POINTS AS LETTER_GRADE,g.POINTS AS LETTERWTD_GRADE,'.$course['TEACHER_ID'].' AS CP_TEACHER_ID,CASE WHEN (a.ASSIGNED_DATE IS NULL OR CURRENT_DATE>=a.ASSIGNED_DATE) AND (a.DUE_DATE IS NULL OR CURRENT_DATE>=a.DUE_DATE) THEN \\'Y\\' ELSE NULL END AS DUE FROM    gradebook_assignment_types t,gradebook_assignments a",
        "// Line_Reference 211:                                     }",
        "// Line_Reference 212:                             else{",
        "// Line_Reference 213:                                 $sql = 'SELECT '.$course_period_id.' as COURSE_PERIOD_ID,a.TITLE,t.TITLE AS ASSIGN_TYP,a.ASSIGNED_DATE,a.DUE_DATE,\\'-1\\' AS ASSIGNMENT_TYPE_ID,\\'1\\' AS FINAL_GRADE_PERCENT,\\'N/A\\' as ASSIGN_TYP_WG,\\'N/A\\' as WEIGHT_GRADE,g.POINTS,a.POINTS AS TOTAL_POINTS,g.COMMENT,g.POINTS AS LETTER_GRADE,g.POINTS AS LETTERWTD_GRADE,'.$course['TEACHER_ID'].' AS CP_TEACHER_ID,CASE WHEN (a.ASSIGNED_DATE IS NULL OR CURRENT_DATE>=a.ASSIGNED_DATE) AND (a.DUE_DATE IS NULL OR CURRENT_DATE>=a.DUE_DATE) THEN \\'Y\\' ELSE NULL END AS DUE FROM    gradebook_assignment_types t,gradebook_assignments a",
        "// Line_Reference 216:                             }",
        "// Line_Reference 217:                         }",
        "// Line_Reference 226:                         if(count($percent_weights))",
        "// Line_Reference 244:                            $tot_weight_grade='';",
        "// Line_Reference 270:                                    if($tot_weight_grade=='')",
        "// Line_Reference 278:                             $tot_weight_grade=($tot_weight_grade/$total_weightage)*100;",
        "// Line_Reference 279: //                            $link['add']['html'] = array('TITLE'=>'<B>Total</B>','LETTER_GRADE'=>'( '.$total_stpoints.' / '.$total_asgnpoints.' ) '._makeLetterGrade(($total_stpoints/$total_asgnpoints),$course_period_id,  $course['TEACHER_ID'],\"%\").'%&nbsp;'._makeLetterGrade(($total_stpoints/$total_asgnpoints),$course_period_id,  $course['TEACHER_ID']),'WEIGHT_GRADE'=>$programconfig[$course['TEACHER_ID']][$course_period_id]['WEIGHT']=='Y'?_makeLetterGrade($tot_weight_grade,\"\",$course['TEACHER_ID'],'%').'%&nbsp;'._makeLetterGrade($tot_weight_grade,$course_period_id,$course['TEACHER_ID']):'N/A');",
        "// Line_Reference 280:                             $link['add']['html'] = array('TITLE'=>'<font style=\"font-size:13;font-weight:bold;\"><B>Total</B></font>','POINTS'=>'<font style=\"font-size:13;font-weight:bold;\">'.$total_stpoints.' / '.$total_asgnpoints.'</font>','LETTER_GRADE'=>'<font style=\"font-size:13;font-weight:bold;\">'._makeLetterGrade(($total_stpoints/$total_asgnpoints),$course_period_id,  $course['TEACHER_ID'],\"%\").'%&nbsp;'._makeLetterGrade(($total_stpoints/$total_asgnpoints),$course_period_id,  $course['TEACHER_ID']).'</font>','WEIGHT_GRADE'=>'<font style=\"font-size:13;font-weight:bold;\">'.($program_config[$course['TEACHER_ID']][$course_period_id]['WEIGHT']=='Y'?_makeLetterGrade($tot_weight_grade,\"\",$course['TEACHER_ID'],'%').'%&nbsp;'._makeLetterGrade($tot_weight_grade,$course_period_id,$course['TEACHER_ID']):'N/A').'</font>');",
        "// Line_Reference 291:                           echo '<tr><td> '._total.':</td><td>'._makeLetterGrade(($total_stpoints/$total_asgnpoints),$course_period_id,$course['TEACHER_ID'],\"%\").'%&nbsp;'._makeLetterGrade(($total_stpoints/$total_asgnpoints),$course_period_id,$course['TEACHER_ID']).'</td> </tr>';",
        "// Line_Reference 327: \t\techo \"<FORM id=F1 action=ForExport.php?modname=\".strip_tags(trim($_REQUEST[modname])).\"&modfunc=save&include_inactive=\".strip_tags(trim($_REQUEST[include_inactive])).\"&_openSIS_PDF=true method=POST target=_blank>\";",
        "// Line_Reference 330: \t\t$extra['extra_header_left'] .= '<label class=\"checkbox-inline\"><INPUT type=checkbox value=Y name=assigned_date>'._assignedDate.'</label>';",
        "// Line_Reference 332: \t\t$extra['extra_header_left'] .= '<label class=\"checkbox-inline\"><INPUT type=checkbox value=Y name=due_date checked>'._dueDate.'</label>';",
        "// Line_Reference 335:                 $extra['extra_header_left'] .= '<label class=\"radio-inline\"><INPUT type=radio value=detail name=list_type checked=true>'._withAssignmentDetails.'</label>';",
        "// Line_Reference 336:                 $extra['extra_header_left'] .= '<label class=\"radio-inline\"><INPUT type=radio value=total name=list_type>'._totalsOnly.'</label>';",
        "// Line_Reference 380: \t\t\t\treturn '<TABLE border=0 cellspacing=0 cellpadding=0 class=LO_field><TR><TD><font size=-1>'.(rtrim(rtrim($value,'0'),'.')+0).'</font></TD><TD><font size=-1>&nbsp;/&nbsp;</font></TD><TD><font size=-1>'.$THIS_RET['TOTAL_POINTS'].'</font></TD></TR></TABLE>';",
        "// Line_Reference 387: \t\t\treturn '<TABLE border=0 cellspacing=0 cellpadding=0 class=LO_field><TR><TD><font size=-1>'.(rtrim(rtrim($value,'0'),'.')+0).'</font></TD><TD><font size=-1>&nbsp;/&nbsp;</font></TD><TD><font size=-1>'.$THIS_RET['TOTAL_POINTS'].'</font></TD></TR></TABLE>';",
        "// Line_Reference 425:         return \"<input  class=fd name=unused_var[$THIS_RET[STUDENT_ID]] value=\" . $THIS_RET[STUDENT_ID] . \" type='checkbox' id=$THIS_RET[STUDENT_ID] onClick='setHiddenCheckboxStudents(\\\"st_arr[$THIS_RET[STUDENT_ID]]\\\",this,$THIS_RET[STUDENT_ID]);' />\";"
    ]
}
