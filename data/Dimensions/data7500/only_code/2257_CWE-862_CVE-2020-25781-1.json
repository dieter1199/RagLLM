$t_attachments_view_threshold = config_get( 'view_attachments_threshold' );
for( $i = 0;$i < $t_attachments_count;$i++ ) {
$t_row = $t_attachment_rows[$i];
# This covers access checks for issue attachments
if( !file_can_view_bug_attachments( $p_bug_id, $t_user_id ) ) {
# This covers access checks for issue note attachments
$t_attachment_note_id = (int)$t_row['bugnote_id'];
if( $t_attachment_note_id !== 0 ) {
if( bugnote_get_field( $t_attachment_note_id, 'view_state' ) != VS_PUBLIC ) {
if( !access_has_bugnote_level( $t_attachments_view_threshold, $t_attachment_note_id ) ) {
continue;
}
}
}
$t_filesize = $t_row['filesize'];
$t_attachment['size'] = (int)$t_filesize;
$t_attachment['bugnote_id'] = (int)$t_row['bugnote_id'];
$t_attachment['can_download'] = file_can_download_bug_attachments( $p_bug_id, (int)$t_row['user_id'] );
$t_attachment['can_delete'] = file_can_delete_bug_attachments( $p_bug_id, (int)$t_row['user_id'] );
