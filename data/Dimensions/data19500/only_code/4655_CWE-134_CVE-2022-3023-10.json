"net/url"
func (param *MySQLConnectParam) ToDSN() string {
hostPort := net.JoinHostPort(param.Host, strconv.Itoa(param.Port))
dsn := fmt.Sprintf("%s:%s@tcp(%s)/?charset=utf8mb4&sql_mode='%s'&maxAllowedPacket=%d&tls=%s",
param.User, param.Password, hostPort,
param.SQLMode, param.MaxAllowedPacket, param.TLS)
dsn += fmt.Sprintf("&%s='%s'", k, url.QueryEscape(v))
return dsn
func tryConnectMySQL(dsn string) (*sql.DB, error) {
driverName := "mysql"
failpoint.Inject("MockMySQLDriver", func(val failpoint.Value) {
driverName = val.(string)
db, err := sql.Open(driverName, dsn)
func ConnectMySQL(dsn string) (*sql.DB, error) {
cfg, err := mysql.ParseDSN(dsn)
if err != nil {
return nil, errors.Trace(err)
}
db, firstErr := tryConnectMySQL(dsn)
db, err = tryConnectMySQL(cfg.FormatDSN())
return db, nil
db, err := ConnectMySQL(param.ToDSN())
