{
    "cve_id": "CVE-2021-27340",
    "cve_description": "OpenSIS Community Edition version <= 7.6 is affected by a reflected XSS vulnerability in EmailCheck.php via the \"opt\" parameter.",
    "cve_publish_date": "2021-09-16",
    "cwe_id": "CWE-79",
    "cwe_name": "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "cwe_description": "The product does not neutralize or incorrectly neutralizes user-controllable input before it is placed in output that is used as a web page that is served to other users.",
    "commit_message": "Commit with security and bug fixes",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "ForgotPassUserName.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "157",
    "number_of_lines_deleted_vulnerable_to_cve": "124",
    "vulnerable_lines": [
        "// Line_Reference 33: {",
        "// Line_Reference 34: \tglobal $DatabaseServer, $DatabaseUsername, $DatabasePassword, $DatabaseName, $DatabasePort, $DatabaseType;",
        "// Line_Reference 36: \tswitch ($DatabaseType) {",
        "// Line_Reference 38: \t\t\t$connection = new mysqli($DatabaseServer, $DatabaseUsername, $DatabasePassword, $DatabaseName, $DatabasePort);",
        "// Line_Reference 39: \t\t\tbreak;",
        "// Line_Reference 43: \tif ($connection === false) {",
        "// Line_Reference 44: \t\tswitch ($DatabaseType) {",
        "// Line_Reference 47: \t\t\t\tbreak;",
        "// Line_Reference 49: \t\tdb_show_error(\"\", \"\" . _couldNotConnectToDatabase . \": $DatabaseServer\", $errormessage);",
        "// Line_Reference 58: {",
        "// Line_Reference 59: \tglobal $DatabaseType, $_openSIS;",
        "// Line_Reference 63: \tswitch ($DatabaseType) {",
        "// Line_Reference 70: \t\t\t$sql = par_rep(\"/([,\\(=])[\\r\\n\\t ]*''/\", '\\\\1NULL', $sql);",
        "// Line_Reference 71: \t\t\tif (preg_match_all(\"/'(\\d\\d-[A-Za-z]{3}-\\d{2,4})'/\", $sql, $matches)) {",
        "// Line_Reference 72: \t\t\t\tforeach ($matches[1] as $match) {",
        "// Line_Reference 73: \t\t\t\t\t$dt = date('Y-m-d', strtotime($match));",
        "// Line_Reference 74: \t\t\t\t\t$sql = par_rep(\"/'$match'/\", \"'$dt'\", $sql);",
        "// Line_Reference 76: \t\t\t}",
        "// Line_Reference 77: \t\t\tif (substr($sql, 0, 6) == \"BEGIN;\") {",
        "// Line_Reference 78: \t\t\t\t$array = explode(\";\", $sql);",
        "// Line_Reference 79: \t\t\t\tforeach ($array as $value) {",
        "// Line_Reference 80: \t\t\t\t\tif ($value != \"\") {",
        "// Line_Reference 81: \t\t\t\t\t\t$result = $connection->query($value);",
        "// Line_Reference 82: \t\t\t\t\t\tif (!$result) {",
        "// Line_Reference 83: \t\t\t\t\t\t\t$connection->query(\"ROLLBACK\");",
        "// Line_Reference 84: \t\t\t\t\t\t\tdie(db_show_error($sql, _dbExecuteFailed, mysql_error()));",
        "// Line_Reference 88: \t\t\t} else {",
        "// Line_Reference 89: \t\t\t\t$result = $connection->query($sql) or die(db_show_error($sql, _dbExecuteFailed, mysql_error()));",
        "// Line_Reference 91: \t\t\tbreak;",
        "// Line_Reference 98: {",
        "// Line_Reference 99: \tglobal $DatabaseType;",
        "// Line_Reference 101: \tswitch ($DatabaseType) {",
        "// Line_Reference 103: \t\t\t$return = $result->fetch_assoc();",
        "// Line_Reference 104: \t\t\tif (is_array($return)) {",
        "// Line_Reference 105: \t\t\t\tforeach ($return as $key => $value) {",
        "// Line_Reference 106: \t\t\t\t\tif (is_int($key))",
        "// Line_Reference 110: \t\t\tbreak;",
        "// Line_Reference 112: \treturn @array_change_key_case($return, CASE_UPPER);",
        "// Line_Reference 117: {",
        "// Line_Reference 118: \tglobal $DatabaseType;",
        "// Line_Reference 120: \tif ($DatabaseType == 'mysqli')",
        "// Line_Reference 121: \t\t$seq = \"fn_\" . strtolower($seqname) . \"()\";",
        "// Line_Reference 126: {",
        "// Line_Reference 127: \tglobal $DatabaseType;",
        "// Line_Reference 128: \t$counter = 0;",
        "// Line_Reference 129: \tif ($DatabaseType == 'mysqli') {",
        "// Line_Reference 130: \t\t$array_count = count($array);",
        "// Line_Reference 134: \t\tfor ($i = 1; $i < $arr_count; $i++) {",
        "// Line_Reference 137: \t\t\tif ($value == \"''\" && substr($string, -1) == '=') {",
        "// Line_Reference 139: \t\t\t\t$string = substr($string, 0, -1);",
        "// Line_Reference 142: \t\t\t$string .= \"$value\";",
        "// Line_Reference 143: \t\t\tif ($counter == ($array_count - 2) && $array_count % 2 == 0)",
        "// Line_Reference 144: \t\t\t\t$string .= \" ELSE \";",
        "// Line_Reference 145: \t\t\telseif ($counter == ($array_count - 1))",
        "// Line_Reference 146: \t\t\t\t$string .= \" END \";",
        "// Line_Reference 147: \t\t\telseif ($counter % 2 == 0)",
        "// Line_Reference 148: \t\t\t\t$string .= \" WHEN $array[0]=\";",
        "// Line_Reference 149: \t\t\telseif ($counter % 2 == 1)",
        "// Line_Reference 150: \t\t\t\t$string .= \" THEN \";",
        "// Line_Reference 155: ",
        "// Line_Reference 160: {",
        "// Line_Reference 161: \tglobal $DatabaseType, $DatabaseUsername;",
        "// Line_Reference 163: \tswitch ($DatabaseType) {",
        "// Line_Reference 166: \t\t\twhile ($row = db_fetch_row($result)) {",
        "// Line_Reference 167: \t\t\t\t$properties[strtoupper($row['FIELD'])]['TYPE'] = strtoupper($row['TYPE'], strpos($row['TYPE'], '('));",
        "// Line_Reference 168: \t\t\t\tif (!$pos = strpos($row['TYPE'], ','))",
        "// Line_Reference 169: \t\t\t\t\t$pos = strpos($row['TYPE'], ')');",
        "// Line_Reference 171: \t\t\t\t\t$properties[strtoupper($row['FIELD'])]['SCALE'] = substr($row['TYPE'], $pos + 1);",
        "// Line_Reference 173: \t\t\t\t$properties[strtoupper($row['FIELD'])]['SIZE'] = substr($row['TYPE'], strpos($row['TYPE'], '(') + 1, $pos);",
        "// Line_Reference 175: \t\t\t\tif ($row['NULL'] != '')",
        "// Line_Reference 180: \t\t\tbreak;",
        "// Line_Reference 185: function db_show_error($sql, $failnote, $additional = '')",
        "// Line_Reference 186: {",
        "// Line_Reference 187: \tglobal $openSISTitle, $openSISVersion, $openSISNotifyAddress, $openSISMode;",
        "// Line_Reference 188: ",
        "// Line_Reference 192: ",
        "// Line_Reference 193: \techo \"",
        "// Line_Reference 196:                             <TD><pre>\" . date(\"m/d/Y h:i:s\") . \"</pre></TD>",
        "// Line_Reference 213: ",
        "// Line_Reference 214: \techo \"",
        "// Line_Reference 217: \t\t\t<TD><pre>\" . date(\"m/d/Y h:i:s\") . \"</pre></TD>",
        "// Line_Reference 233: ",
        "// Line_Reference 236: \tif ($openSISNotifyAddress) {",
        "// Line_Reference 238: \t\t$message .= \"Date: \" . date(\"m/d/Y h:i:s\") . \"\\n\";",
        "// Line_Reference 239: \t\t$message .= \"Page: \" . $_SERVER['PHP_SELF'] . ' ' . ProgramTitle() . \" \\n\\n\";",
        "// Line_Reference 243: \t\t$message .= \"Request Array: \\n\" . ShowVar($_REQUEST, 'Y', 'N');",
        "// Line_Reference 244: \t\t$message .= \"\\n\\nSession Array: \\n\" . ShowVar($_SESSION, 'Y', 'N');",
        "// Line_Reference 245: \t\tmail($openSISNotifyAddress, 'openSIS Database Error', $message);",
        "// Line_Reference 250: $used_for = $_GET['used_for'];",
        "// Line_Reference 251: if ($used_for == 'username') {",
        "// Line_Reference 252: \t$username = $_GET['u'];",
        "// Line_Reference 253: \t$usr_type = $_GET['user_type'];",
        "// Line_Reference 254: \t$found = false;",
        "// Line_Reference 255: \tif ($usr_type == 'student') {",
        "// Line_Reference 256: \t\t$check_uname =  DBGet(DBQuery('SELECT * FROM login_authentication WHERE USERNAME = \\'' . $username . '\\'  AND PROFILE_ID IN (SELECT ID FROM user_profiles WHERE PROFILE=\\'student\\')'));",
        "// Line_Reference 257: \t} elseif ($usr_type == 'staff') {",
        "// Line_Reference 258: \t\t$check_uname =  DBGet(DBQuery('SELECT * FROM login_authentication WHERE USERNAME = \\'' . $username . '\\'  AND PROFILE_ID IN (SELECT ID FROM user_profiles WHERE ID NOT IN (0,3,4))'));",
        "// Line_Reference 259: \t} else {",
        "// Line_Reference 260: \t\t$check_uname =  DBGet(DBQuery('SELECT * FROM login_authentication WHERE USERNAME = \\'' . $username . '\\'  AND PROFILE_ID IN (SELECT ID FROM user_profiles WHERE PROFILE=\\'parent\\')'));",
        "// Line_Reference 261: \t}",
        "// Line_Reference 262: \tif ($check_uname[1]['USERNAME'] != '') {",
        "// Line_Reference 263: \t\techo '1';",
        "// Line_Reference 264: \t} else",
        "// Line_Reference 265: \t\techo '0';",
        "// Line_Reference 266: } else {",
        "// Line_Reference 267: \t$email = $_GET['u'];",
        "// Line_Reference 268: \t$usr_type = $_GET['user_type'];",
        "// Line_Reference 269: \t$found = false;",
        "// Line_Reference 270: \tif ($usr_type == 'staff') {",
        "// Line_Reference 271: \t\tif ($_GET['username'] != '')",
        "// Line_Reference 272: \t\t\t$check_email =  DBGet(DBQuery('SELECT * FROM staff s,login_authentication la WHERE EMAIL = \\'' . $email . '\\' AND s.STAFF_ID=la.USER_ID AND la.username=\\'' . $_GET['username'] . '\\''));",
        "// Line_Reference 273: \t\telse",
        "// Line_Reference 274: \t\t\t$check_email =  DBGet(DBQuery('SELECT * FROM staff WHERE EMAIL = \\'' . $email . '\\''));",
        "// Line_Reference 275: \t} else {",
        "// Line_Reference 276: \t\tif ($_GET['username'] != '')",
        "// Line_Reference 277: \t\t\t$check_email =  DBGet(DBQuery('SELECT * FROM people p,login_authentication la WHERE EMAIL = \\'' . $email . '\\' AND p.STAFF_ID=la.USER_ID AND la.username=\\'' . $_GET['username'] . '\\''));",
        "// Line_Reference 278: \t\telse",
        "// Line_Reference 279: \t\t\t$check_email =  DBGet(DBQuery('SELECT * FROM people WHERE EMAIL = \\'' . $email . '\\''));",
        "// Line_Reference 280: \t}",
        "// Line_Reference 281: \tif ($check_email[1]['EMAIL'] != '') {",
        "// Line_Reference 282: \t\techo '1~' . $_GET['form'];",
        "// Line_Reference 283: \t} else",
        "// Line_Reference 284: \t\techo '0~' . $_GET['form'];",
        "// Line_Reference 285: }"
    ]
}
