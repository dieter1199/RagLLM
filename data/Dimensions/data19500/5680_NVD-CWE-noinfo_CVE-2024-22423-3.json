{
    "cve_id": "CVE-2024-22423",
    "cve_description": "yt-dlp is a youtube-dl fork with additional features and fixes. The patch that addressed CVE-2023-40581 attempted to prevent RCE when using `--exec` with `%q` by replacing double quotes with two double quotes. However, this escaping is not sufficient, and still allows expansion of environment variables. Support for output template expansion in `--exec`, along with this vulnerable behavior, was added to `yt-dlp` in version 2021.04.11. yt-dlp version 2024.04.09 fixes this issue by properly escaping `%`. It replaces them with `%%cd:~,%`, a variable that expands to nothing, leaving only the leading percent. It is recommended to upgrade yt-dlp to version 2024.04.09 as soon as possible. Also, always be careful when using `--exec`, because while this specific vulnerability has been patched, using unvalidated input in shell commands is inherently dangerous. For Windows users who are not able to upgrade, avoid using any output template expansion in `--exec` other than `{}` (filepath); if expansion in `--exec` is needed, verify the fields you are using do not contain `\"`, `|` or `&`; and/or instead of using `--exec`, write the info json and load the fields from it instead.",
    "cve_publish_date": "2024-04-09",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "[core] Prevent RCE when using `--exec` with `%q` (CVE-2024-22423)\n\nThe shell escape function now properly escapes `%`, `\\\\` and `\\n`. `utils.Popen` as well as `%q` output template expansion have been patched accordingly.\n\nPrior to this fix using `--exec` together with `%q` when on Windows could cause remote code to execute. See https://github.com/yt-dlp/yt-dlp/security/advisories/GHSA-hjq6-52gw-2g7p for more details.\n\nAuthored by: Grub4K",
    "type_of_change": "Modification",
    "filename_of_changes": "_utils.py",
    "code_language": "Python",
    "number_of_lines_added_for_mitigation": "37",
    "number_of_lines_deleted_vulnerable_to_cve": "13",
    "vulnerable_lines": [
        "// Line_Reference 53:     compat_shlex_quote,",
        "// Line_Reference 839:                 args = ' '.join(compat_shlex_quote(a) for a in args)",
        "// Line_Reference 841:             args = f'{self.__comspec()} /Q /S /D /V:OFF /C \"{args}\"'",
        "// Line_Reference 1640: def shell_quote(args):",
        "// Line_Reference 1641:     quoted_args = []",
        "// Line_Reference 1642:     encoding = get_filesystem_encoding()",
        "// Line_Reference 1643:     for a in args:",
        "// Line_Reference 1644:         if isinstance(a, bytes):",
        "// Line_Reference 1645:             # We may get a filename encoded with 'encodeFilename'",
        "// Line_Reference 1646:             a = a.decode(encoding)",
        "// Line_Reference 1647:         quoted_args.append(compat_shlex_quote(a))",
        "// Line_Reference 1648:     return ' '.join(quoted_args)",
        "// Line_Reference 2852:     return ' '.join(compat_shlex_quote(a) for a in args)"
    ]
}
