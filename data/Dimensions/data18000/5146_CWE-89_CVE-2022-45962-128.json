{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "SearchStaffInc.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "71",
    "number_of_lines_deleted_vulnerable_to_cve": "82",
    "vulnerable_lines": [
        "// Line_Reference 31: if (strpos($_REQUEST['modname'], 'users/TeacherPrograms.php') !== false)",
        "// Line_Reference 32: {",
        "// Line_Reference 36:     if(empty($_SESSION['staf_search']) && !empty($_SESSION['staf_search_hold']))",
        "// Line_Reference 37:     {",
        "// Line_Reference 59:         echo '<div class=\"form-group\"><label class=\"control-label col-lg-4\">'._lastName.'</label><div class=\"col-lg-8\"><INPUT type=text placeholder=\"'._lastName.'\" class=form-control name=last></div></div>';",
        "// Line_Reference 61:         echo '<div class=\"form-group\"><label class=\"control-label col-lg-4\">'._firstName.'</label><div class=\"col-lg-8\"><INPUT type=text placeholder=\"'._firstName.'\" class=form-control name=first></div></div>';",
        "// Line_Reference 64: ",
        "// Line_Reference 67:         echo '<div class=\"form-group\"><label class=\"control-label col-lg-4\">'._username.'</label><div class=\"col-lg-8\"><INPUT type=text placeholder=\"'._username.'\" class=form-control name=username></div></div>';",
        "// Line_Reference 69: ",
        "// Line_Reference 98:             }",
        "// Line_Reference 99:             else",
        "// Line_Reference 103:         echo '<div class=\"form-group\"><label class=\"control-label col-lg-4\">'._profile.'</label><div class=\"col-lg-8\"><SELECT class=\"form-control\" name=profile>';",
        "// Line_Reference 111: ",
        "// Line_Reference 115: ",
        "// Line_Reference 119:             echo '<label class=\"checkbox-inline\"><INPUT class=\"styled\" type=checkbox name=_search_all_schools value=Y' . (Preferences('DEFAULT_ALL_SCHOOLS') == 'Y' ? ' CHECKED' : '') . '> '._searchAllSchools.'</label>';",
        "// Line_Reference 120:         echo '<label class=\"checkbox-inline\"><INPUT class=\"styled\" type=checkbox name=_dis_user value=Y>'._includeDisabledStaff.'</label>';",
        "// Line_Reference 123: ",
        "// Line_Reference 125:         echo \"<div class=\\\"text-right\\\"><INPUT type=SUBMIT class='btn btn-primary' value='\"._submit.\"' onclick=\\\"self_disable(this);\\\"> &nbsp; <INPUT type=RESET class=\\\"btn btn-default\\\" value='\"._reset.\"'></div>\";",
        "// Line_Reference 140: ",
        "// Line_Reference 148: ",
        "// Line_Reference 149:         if($_REQUEST['_search_all_schools']=='Y')",
        "// Line_Reference 150:         {",
        "// Line_Reference 151:         $extra['SELECT'].=',s.STAFF_ID as STF_ID';",
        "// Line_Reference 152:         $extra['functions']=array('STF_ID'=>makeStaffAllSchool);",
        "// Line_Reference 154: //        else",
        "// Line_Reference 155: //        {",
        "// Line_Reference 156:         $extra['SELECT'].=',s.STAFF_ID as CATEGORY,la.LAST_LOGIN';",
        "// Line_Reference 157:         $extra['functions']=array('CATEGORY'=>StaffCategory);",
        "// Line_Reference 158:         // }",
        "// Line_Reference 159: ",
        "// Line_Reference 160:         if (strpos($_REQUEST['modname'], 'users/TeacherPrograms.php') !== false)",
        "// Line_Reference 161:         {",
        "// Line_Reference 162:             $extra['WHERE'] .= ' AND s.PROFILE_ID NOT IN(0,1) ';",
        "// Line_Reference 165: \t\t$staff_RET = GetUserStaffList($extra);",
        "// Line_Reference 166:       if($_REQUEST['_dis_user']=='Y')",
        "// Line_Reference 167:       {",
        "// Line_Reference 168:         $last_log_sql='SELECT DISTINCT CONCAT(s.LAST_NAME,  \\' \\' ,s.FIRST_NAME) AS FULL_NAME,",
        "// Line_Reference 170: \t\t\t\t\t((s.PROFILE_ID!=4 AND s.PROFILE_ID!=3) OR s.PROFILE_ID IS NULL) AND '.($_REQUEST['first']?' UPPER(s.FIRST_NAME) LIKE \\''.singleQuoteReplace(\"'\",\"\\'\",strtoupper($_REQUEST['first'])).'%\\' AND ':'').($_REQUEST['last']?' UPPER(s.LAST_NAME) LIKE \\''.singleQuoteReplace(\"'\",\"\\'\",strtoupper($_REQUEST['last'])).'%\\' AND ':'').' ssr.SYEAR=\\''.UserSyear().'\\'  AND s.STAFF_ID NOT IN (SELECT USER_ID FROM login_authentication WHERE PROFILE_ID NOT IN (3,4)) '.($_REQUEST['username']?' AND s.STAFF_ID IN (SELECT USER_ID FROM login_authentication WHERE UPPER(USERNAME) LIKE \\''.singleQuoteReplace(\"'\",\"\\'\",strtoupper($_REQUEST['username'])).'%\\' AND PROFILE_ID NOT IN (3,4)) ':'');",
        "// Line_Reference 171:                 $last_log=DBGet(DBQuery($last_log_sql));",
        "// Line_Reference 172: ",
        "// Line_Reference 173:                 foreach($last_log as $li=>$ld)",
        "// Line_Reference 174:                 {",
        "// Line_Reference 175:                     $staff_RET[]=$ld;",
        "// Line_Reference 176:                 }",
        "// Line_Reference 177:       }",
        "// Line_Reference 178: ",
        "// Line_Reference 179:                 $_SESSION['count_stf'] =  count($staff_RET);",
        "// Line_Reference 193:             $columns = array('FULL_NAME' => $singular, 'STAFF_ID' =>_staffId);",
        "// Line_Reference 198:                 $columns = array('FULL_NAME' =>_name,",
        "// Line_Reference 199:                  'CATEGORY' =>_category,",
        "// Line_Reference 200:                 'PROFILE' =>_profile,",
        "// Line_Reference 201:                  'STAFF_ID' =>_staffId,",
        "// Line_Reference 202:                  'Status' =>_status,",
        "// Line_Reference 204: //                $columns = array('FULL_NAME' => 'Staff Member',",
        "// Line_Reference 205:                 // 'CATEGORY' => 'Category',",
        "// Line_Reference 206:                 // 'PROFILE' => 'Profile',",
        "// Line_Reference 207:                 // 'STAFF_ID' =>_staffId,",
        "// Line_Reference 208:                 // 'Status' => 'Status',",
        "// Line_Reference 209:                 // );",
        "// Line_Reference 211:                 $columns = array('FULL_NAME' =>_name,",
        "// Line_Reference 212:                   'CATEGORY' =>_category,",
        "// Line_Reference 213:                 'PROFILE' =>_profile,",
        "// Line_Reference 214:                  'STAFF_ID' =>_staffId,",
        "// Line_Reference 216: //                $columns = array('FULL_NAME' => 'Staff Member',  'CATEGORY' => 'Category','PROFILE' => 'Profile', 'STAFF_ID' =>_staffId);",
        "// Line_Reference 217: ",
        "// Line_Reference 218:             if($_REQUEST['_search_all_schools']=='Y')",
        "// Line_Reference 219:             {",
        "// Line_Reference 220:             $columns+= array('STF_ID' => 'School Name');",
        "// Line_Reference 221:             }",
        "// Line_Reference 240:                 if (($d['END_DATE'] == '0000-00-00' || $d['END_DATE'] >= date('Y-m-d') || $d['END_DATE'] == NULL) && $d['IS_DISABLE'] != 'Y' && $d['PROFILE_ID']!='')",
        "// Line_Reference 246: ",
        "// Line_Reference 255: function makeLogin($value) {",
        "// Line_Reference 260:     $schools=DBGet(DBQuery('SELECT * FROM staff_school_relationship WHERE (END_DATE=\\'0000-00-00\\' OR END_DATE IS NULL OR END_DATE>=\\''.date('y-m-d').'\\') AND SYEAR='.UserSyear().' AND STAFF_ID='.$value));",
        "// Line_Reference 261:     $return_name=array();",
        "// Line_Reference 262:     foreach($schools as $s)",
        "// Line_Reference 263:     {",
        "// Line_Reference 264:         $name=DBGet(DBQuery('SELECT TITLE FROM schools WHERE ID='.$s['SCHOOL_ID']));",
        "// Line_Reference 265:         $return_name[]=$name[1]['TITLE'];",
        "// Line_Reference 266: ",
        "// Line_Reference 268:     return implode(',',$return_name);",
        "// Line_Reference 269: ",
        "// Line_Reference 271: ?>"
    ]
}
