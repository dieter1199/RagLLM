{
    "cve_id": "CVE-2018-10021",
    "cve_description": "drivers/scsi/libsas/sas_scsi_host.c in the Linux kernel before 4.16 allows local users to cause a denial of service (ata qc leak) by triggering certain failure conditions. NOTE: a third party disputes the relevance of this report because the failure can only occur for physically proximate attackers who unplug SAS Host Bus Adapter cables",
    "cve_publish_date": "2018-04-11",
    "cwe_id": "NVD-CWE-noinfo",
    "cwe_name": "Insufficient Information",
    "cwe_description": "There is insufficient information about the issue to classify it; details are unkown or unspecified.",
    "commit_message": "scsi: libsas: defer ata device eh commands to libata\n\nWhen ata device doing EH, some commands still attached with tasks are\nnot passed to libata when abort failed or recover failed, so libata did\nnot handle these commands. After these commands done, sas task is freed,\nbut ata qc is not freed. This will cause ata qc leak and trigger a\nwarning like below:\n\nWARNING: CPU: 0 PID: 28512 at drivers/ata/libata-eh.c:4037\nata_eh_finish+0xb4/0xcc\nCPU: 0 PID: 28512 Comm: kworker/u32:2 Tainted: G     W  OE 4.14.0#1\n......\nCall trace:\n[<ffff0000088b7bd0>] ata_eh_finish+0xb4/0xcc\n[<ffff0000088b8420>] ata_do_eh+0xc4/0xd8\n[<ffff0000088b8478>] ata_std_error_handler+0x44/0x8c\n[<ffff0000088b8068>] ata_scsi_port_error_handler+0x480/0x694\n[<ffff000008875fc4>] async_sas_ata_eh+0x4c/0x80\n[<ffff0000080f6be8>] async_run_entry_fn+0x4c/0x170\n[<ffff0000080ebd70>] process_one_work+0x144/0x390\n[<ffff0000080ec100>] worker_thread+0x144/0x418\n[<ffff0000080f2c98>] kthread+0x10c/0x138\n[<ffff0000080855dc>] ret_from_fork+0x10/0x18\n\nIf ata qc leaked too many, ata tag allocation will fail and io blocked\nfor ever.\n\nAs suggested by Dan Williams, defer ata device commands to libata and\nmerge sas_eh_finish_cmd() with sas_eh_defer_cmd(). libata will handle\nata qcs correctly after this.\n\nSigned-off-by: Jason Yan <yanaijie@huawei.com>\nCC: Xiaofei Tan <tanxiaofei@huawei.com>\nCC: John Garry <john.garry@huawei.com>\nCC: Dan Williams <dan.j.williams@intel.com>\nReviewed-by: Dan Williams <dan.j.williams@intel.com>\nSigned-off-by: Martin K. Petersen <martin.petersen@oracle.com>",
    "type_of_change": "Modification",
    "filename_of_changes": "sas_scsi_host.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "13",
    "number_of_lines_deleted_vulnerable_to_cve": "20",
    "vulnerable_lines": [
        "// Line_Reference 241: static void sas_eh_defer_cmd(struct scsi_cmnd *cmd)",
        "// Line_Reference 242: {",
        "// Line_Reference 243: \tstruct domain_device *dev = cmd_to_domain_dev(cmd);",
        "// Line_Reference 244: \tstruct sas_ha_struct *ha = dev->port->ha;",
        "// Line_Reference 245: \tstruct sas_task *task = TO_SAS_TASK(cmd);",
        "// Line_Reference 246: ",
        "// Line_Reference 247: \tif (!dev_is_sata(dev)) {",
        "// Line_Reference 248: \t\tsas_eh_finish_cmd(cmd);",
        "// Line_Reference 249: \t\treturn;",
        "// Line_Reference 250: \t}",
        "// Line_Reference 251: ",
        "// Line_Reference 252: \t/* report the timeout to libata */",
        "// Line_Reference 253: \tsas_end_task(cmd, task);",
        "// Line_Reference 254: \tlist_move_tail(&cmd->eh_entry, &ha->eh_ata_q);",
        "// Line_Reference 255: }",
        "// Line_Reference 256: ",
        "// Line_Reference 264: \t\t\tsas_eh_defer_cmd(cmd);",
        "// Line_Reference 621: \t\t\tsas_eh_defer_cmd(cmd);",
        "// Line_Reference 626: \t\t\tsas_eh_defer_cmd(cmd);",
        "// Line_Reference 637: \t\t\t\tsas_eh_defer_cmd(cmd);"
    ]
}
