{
    "cve_id": "CVE-2017-8062",
    "cve_description": "drivers/media/usb/dvb-usb/dw2102.c in the Linux kernel 4.9.x and 4.10.x before 4.10.4 interacts incorrectly with the CONFIG_VMAP_STACK option, which allows local users to cause a denial of service (system crash or memory corruption) or possibly have unspecified other impact by leveraging use of more than one virtual page for a DMA scatterlist.",
    "cve_publish_date": "2017-04-23",
    "cwe_id": "CWE-119",
    "cwe_name": "Improper Restriction of Operations within the Bounds of a Memory Buffer",
    "cwe_description": "The product performs operations on a memory buffer, but it reads from or writes to a memory location outside the buffer's intended boundary. This may result in read or write operations on unexpected memory locations that could be linked to other variables, data structures, or internal program data.",
    "commit_message": "[media] dw2102: don't do DMA on stack\n\nOn Kernel 4.9, WARNINGs about doing DMA on stack are hit at\nthe dw2102 driver: one in su3000_power_ctrl() and the other in tt_s2_4600_frontend_attach().\n\nBoth were due to the use of buffers on the stack as parameters to\ndvb_usb_generic_rw() and the resulting attempt to do DMA with them.\n\nThe device was non-functional as a result.\n\nSo, switch this driver over to use a buffer within the device state\nstructure, as has been done with other DVB-USB drivers.\n\nTested with TechnoTrend TT-connect S2-4600.\n\n[mchehab@osg.samsung.com: fixed a warning at su3000_i2c_transfer() that\n state var were dereferenced before check 'd']\nSigned-off-by: Jonathan McDowell <noodles@earth.li>\nCc: <stable@vger.kernel.org>\nSigned-off-by: Mauro Carvalho Chehab <mchehab@s-opensource.com>",
    "type_of_change": "Modification",
    "filename_of_changes": "dw2102.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "145",
    "number_of_lines_deleted_vulnerable_to_cve": "99",
    "vulnerable_lines": [
        "// Line_Reference 664: \tu8 obuf[0x40], ibuf[0x40];",
        "// Line_Reference 675: \t\t\tobuf[0] = msg[0].buf[0] + 0x36;",
        "// Line_Reference 676: \t\t\tobuf[1] = 3;",
        "// Line_Reference 677: \t\t\tobuf[2] = 0;",
        "// Line_Reference 678: \t\t\tif (dvb_usb_generic_rw(d, obuf, 3, ibuf, 0, 0) < 0)",
        "// Line_Reference 682: \t\t\tobuf[0] = 0x10;",
        "// Line_Reference 683: \t\t\tif (dvb_usb_generic_rw(d, obuf, 1, ibuf, 2, 0) < 0)",
        "// Line_Reference 685: \t\t\tmsg[0].buf[1] = ibuf[0];",
        "// Line_Reference 686: \t\t\tmsg[0].buf[0] = ibuf[1];",
        "// Line_Reference 690: \t\t\tobuf[0] = 0x08;",
        "// Line_Reference 691: \t\t\tobuf[1] = msg[0].addr;",
        "// Line_Reference 692: \t\t\tobuf[2] = msg[0].len;",
        "// Line_Reference 694: \t\t\tmemcpy(&obuf[3], msg[0].buf, msg[0].len);",
        "// Line_Reference 696: \t\t\tif (dvb_usb_generic_rw(d, obuf, msg[0].len + 3,",
        "// Line_Reference 697: \t\t\t\t\t\tibuf, 1, 0) < 0)",
        "// Line_Reference 704: \t\tobuf[0] = 0x09;",
        "// Line_Reference 705: \t\tobuf[1] = msg[0].len;",
        "// Line_Reference 706: \t\tobuf[2] = msg[1].len;",
        "// Line_Reference 707: \t\tobuf[3] = msg[0].addr;",
        "// Line_Reference 708: \t\tmemcpy(&obuf[4], msg[0].buf, msg[0].len);",
        "// Line_Reference 709: ",
        "// Line_Reference 710: \t\tif (dvb_usb_generic_rw(d, obuf, msg[0].len + 4,",
        "// Line_Reference 711: \t\t\t\t\tibuf, msg[1].len + 1, 0) < 0)",
        "// Line_Reference 714: \t\tmemcpy(msg[1].buf, &ibuf[1], msg[1].len);",
        "// Line_Reference 847: \tu8 obuf[] = {0xde, 0};",
        "// Line_Reference 854: \t\treturn dvb_usb_generic_rw(d, obuf, 2, NULL, 0, 0);",
        "// Line_Reference 857: \treturn 0;",
        "// Line_Reference 1312: static int su3000_frontend_attach(struct dvb_usb_adapter *d)",
        "// Line_Reference 1314: \tu8 obuf[3] = { 0xe, 0x80, 0 };",
        "// Line_Reference 1315: \tu8 ibuf[] = { 0 };",
        "// Line_Reference 1317: \tif (dvb_usb_generic_rw(d->dev, obuf, 3, ibuf, 1, 0) < 0)",
        "// Line_Reference 1320: \tobuf[0] = 0xe;",
        "// Line_Reference 1321: \tobuf[1] = 0x02;",
        "// Line_Reference 1322: \tobuf[2] = 1;",
        "// Line_Reference 1324: \tif (dvb_usb_generic_rw(d->dev, obuf, 3, ibuf, 1, 0) < 0)",
        "// Line_Reference 1328: \tobuf[0] = 0xe;",
        "// Line_Reference 1329: \tobuf[1] = 0x83;",
        "// Line_Reference 1330: \tobuf[2] = 0;",
        "// Line_Reference 1332: \tif (dvb_usb_generic_rw(d->dev, obuf, 3, ibuf, 1, 0) < 0)",
        "// Line_Reference 1335: \tobuf[0] = 0xe;",
        "// Line_Reference 1336: \tobuf[1] = 0x83;",
        "// Line_Reference 1337: \tobuf[2] = 1;",
        "// Line_Reference 1339: \tif (dvb_usb_generic_rw(d->dev, obuf, 3, ibuf, 1, 0) < 0)",
        "// Line_Reference 1342: \tobuf[0] = 0x51;",
        "// Line_Reference 1344: \tif (dvb_usb_generic_rw(d->dev, obuf, 1, ibuf, 1, 0) < 0)",
        "// Line_Reference 1347: \td->fe_adap[0].fe = dvb_attach(ds3000_attach, &su3000_ds3000_config,",
        "// Line_Reference 1348: \t\t\t\t\t&d->dev->i2c_adap);",
        "// Line_Reference 1349: \tif (d->fe_adap[0].fe == NULL)",
        "// Line_Reference 1352: \tif (dvb_attach(ts2020_attach, d->fe_adap[0].fe,",
        "// Line_Reference 1354: \t\t\t\t&d->dev->i2c_adap)) {",
        "// Line_Reference 1363: static int t220_frontend_attach(struct dvb_usb_adapter *d)",
        "// Line_Reference 1365: \tu8 obuf[3] = { 0xe, 0x87, 0 };",
        "// Line_Reference 1366: \tu8 ibuf[] = { 0 };",
        "// Line_Reference 1368: \tif (dvb_usb_generic_rw(d->dev, obuf, 3, ibuf, 1, 0) < 0)",
        "// Line_Reference 1371: \tobuf[0] = 0xe;",
        "// Line_Reference 1372: \tobuf[1] = 0x86;",
        "// Line_Reference 1373: \tobuf[2] = 1;",
        "// Line_Reference 1375: \tif (dvb_usb_generic_rw(d->dev, obuf, 3, ibuf, 1, 0) < 0)",
        "// Line_Reference 1378: \tobuf[0] = 0xe;",
        "// Line_Reference 1379: \tobuf[1] = 0x80;",
        "// Line_Reference 1380: \tobuf[2] = 0;",
        "// Line_Reference 1382: \tif (dvb_usb_generic_rw(d->dev, obuf, 3, ibuf, 1, 0) < 0)",
        "// Line_Reference 1387: \tobuf[0] = 0xe;",
        "// Line_Reference 1388: \tobuf[1] = 0x80;",
        "// Line_Reference 1389: \tobuf[2] = 1;",
        "// Line_Reference 1391: \tif (dvb_usb_generic_rw(d->dev, obuf, 3, ibuf, 1, 0) < 0)",
        "// Line_Reference 1394: \tobuf[0] = 0x51;",
        "// Line_Reference 1396: \tif (dvb_usb_generic_rw(d->dev, obuf, 1, ibuf, 1, 0) < 0)",
        "// Line_Reference 1399: \td->fe_adap[0].fe = dvb_attach(cxd2820r_attach, &cxd2820r_config,",
        "// Line_Reference 1400: \t\t\t\t\t&d->dev->i2c_adap, NULL);",
        "// Line_Reference 1401: \tif (d->fe_adap[0].fe != NULL) {",
        "// Line_Reference 1402: \t\tif (dvb_attach(tda18271_attach, d->fe_adap[0].fe, 0x60,",
        "// Line_Reference 1403: \t\t\t\t\t&d->dev->i2c_adap, &tda18271_config)) {",
        "// Line_Reference 1413: static int m88rs2000_frontend_attach(struct dvb_usb_adapter *d)",
        "// Line_Reference 1415: \tu8 obuf[] = { 0x51 };",
        "// Line_Reference 1416: \tu8 ibuf[] = { 0 };",
        "// Line_Reference 1418: \tif (dvb_usb_generic_rw(d->dev, obuf, 1, ibuf, 1, 0) < 0)",
        "// Line_Reference 1421: \td->fe_adap[0].fe = dvb_attach(m88rs2000_attach, &s421_m88rs2000_config,",
        "// Line_Reference 1422: \t\t\t\t\t&d->dev->i2c_adap);",
        "// Line_Reference 1424: \tif (d->fe_adap[0].fe == NULL)",
        "// Line_Reference 1427: \tif (dvb_attach(ts2020_attach, d->fe_adap[0].fe,",
        "// Line_Reference 1429: \t\t\t\t&d->dev->i2c_adap)) {",
        "// Line_Reference 1442: \tu8 obuf[3] = { 0xe, 0x80, 0 };",
        "// Line_Reference 1443: \tu8 ibuf[] = { 0 };",
        "// Line_Reference 1450: \tif (dvb_usb_generic_rw(d, obuf, 3, ibuf, 1, 0) < 0)",
        "// Line_Reference 1453: \tobuf[0] = 0xe;",
        "// Line_Reference 1454: \tobuf[1] = 0x02;",
        "// Line_Reference 1455: \tobuf[2] = 1;",
        "// Line_Reference 1457: \tif (dvb_usb_generic_rw(d, obuf, 3, ibuf, 1, 0) < 0)",
        "// Line_Reference 1461: \tobuf[0] = 0xe;",
        "// Line_Reference 1462: \tobuf[1] = 0x83;",
        "// Line_Reference 1463: \tobuf[2] = 0;",
        "// Line_Reference 1465: \tif (dvb_usb_generic_rw(d, obuf, 3, ibuf, 1, 0) < 0)",
        "// Line_Reference 1468: \tobuf[0] = 0xe;",
        "// Line_Reference 1469: \tobuf[1] = 0x83;",
        "// Line_Reference 1470: \tobuf[2] = 1;",
        "// Line_Reference 1472: \tif (dvb_usb_generic_rw(d, obuf, 3, ibuf, 1, 0) < 0)",
        "// Line_Reference 1475: \tobuf[0] = 0x51;",
        "// Line_Reference 1477: \tif (dvb_usb_generic_rw(d, obuf, 1, ibuf, 1, 0) < 0)"
    ]
}
