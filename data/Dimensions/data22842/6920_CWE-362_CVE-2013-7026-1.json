{
    "cve_id": "CVE-2013-7026",
    "cve_description": "Multiple race conditions in ipc/shm.c in the Linux kernel before 3.12.2 allow local users to cause a denial of service (use-after-free and system crash) or possibly have unspecified other impact via a crafted application that uses shmctl IPC_RMID operations in conjunction with other shm system calls.",
    "cve_publish_date": "2013-12-09",
    "cwe_id": "CWE-362",
    "cwe_name": "Concurrent Execution using Shared Resource with Improper Synchronization ('Race Condition')",
    "cwe_description": "The product contains a code sequence that can run concurrently with other code, and the code sequence requires temporary, exclusive access to a shared resource, but a timing window exists in which the shared resource can be modified by another code sequence that is operating concurrently.",
    "commit_message": "ipc,shm: fix shm_file deletion races\n\nWhen IPC_RMID races with other shm operations there's potential for\nuse-after-free of the shm object's associated file (shm_file).\n\nHere's the race before this patch:\n\n  TASK 1                     TASK 2\n  ------                     ------\n  shm_rmid()\n    ipc_lock_object()\n                             shmctl()\n                             shp = shm_obtain_object_check()\n\n    shm_destroy()\n      shum_unlock()\n      fput(shp->shm_file)\n                             ipc_lock_object()\n                             shmem_lock(shp->shm_file)\n                             <OOPS>\n\nThe oops is caused because shm_destroy() calls fput() after dropping the\nipc_lock.  fput() clears the file's f_inode, f_path.dentry, and\nf_path.mnt, which causes various NULL pointer references in task 2.  I\nreliably see the oops in task 2 if with shmlock, shmu\n\nThis patch fixes the races by:\n1) set shm_file=NULL in shm_destroy() while holding ipc_object_lock().\n2) modify at risk operations to check shm_file while holding\n   ipc_object_lock().\n\nExample workloads, which each trigger oops...\n\nWorkload 1:\n  while true; do\n    id=$(shmget 1 4096)\n    shm_rmid $id &\n    shmlock $id &\n    wait\n  done\n\n  The oops stack shows accessing NULL f_inode due to racing fput:\n    _raw_spin_lock\n    shmem_lock\n    SyS_shmctl\n\nWorkload 2:\n  while true; do\n    id=$(shmget 1 4096)\n    shmat $id 4096 &\n    shm_rmid $id &\n    wait\n  done\n\n  The oops stack is similar to workload 1 due to NULL f_inode:\n    touch_atime\n    shmem_mmap\n    shm_mmap\n    mmap_region\n    do_mmap_pgoff\n    do_shmat\n    SyS_shmat\n\nWorkload 3:\n  while true; do\n    id=$(shmget 1 4096)\n    shmlock $id\n    shm_rmid $id &\n    shmunlock $id &\n    wait\n  done\n\n  The oops stack shows second fput tripping on an NULL f_inode.  The\n  first fput() completed via from shm_destroy(), but a racing thread did\n  a get_file() and queued this fput():\n    locks_remove_flock\n    __fput\n    ____fput\n    task_work_run\n    do_notify_resume\n    int_signal\n\nFixes: c2c737a0461e (\"ipc,shm: shorten critical region for shmat\")\nFixes: 2caacaa82a51 (\"ipc,shm: shorten critical region for shmctl\")\nSigned-off-by: Greg Thelen <gthelen@google.com>\nCc: Davidlohr Bueso <davidlohr@hp.com>\nCc: Rik van Riel <riel@redhat.com>\nCc: Manfred Spraul <manfred@colorfullife.com>\nCc: <stable@vger.kernel.org>  # 3.10.17+ 3.11.6+\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
    "type_of_change": "Modification",
    "filename_of_changes": "shm.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "23",
    "number_of_lines_deleted_vulnerable_to_cve": "5",
    "vulnerable_lines": [
        "// Line_Reference 214: \tif (!is_file_hugepages(shp->shm_file))",
        "// Line_Reference 215: \t\tshmem_lock(shp->shm_file, 0, shp->mlock_user);",
        "// Line_Reference 217: \t\tuser_shm_unlock(file_inode(shp->shm_file)->i_size,",
        "// Line_Reference 218: \t\t\t\t\t\tshp->mlock_user);",
        "// Line_Reference 219: \tfput (shp->shm_file);"
    ]
}
