taxonomy_join_table = :taxable_taxonomies
has_many taxonomy_join_table.to_sym, :dependent => :destroy, :as => :taxable
:through => taxonomy_join_table, :source => :taxonomy,
:through => taxonomy_join_table, :source => :taxonomy,
scope = block_given? ? yield : where('1=1')
if SETTINGS[:locations_enabled] && loc.present?
inner_ids_loc = if Location.ignore?(self.to_s)
self.unscoped.pluck("#{table_name}.id")
else
inner_select(loc, inner_method)
end
if SETTINGS[:organizations_enabled] && org.present?
inner_ids_org = if Organization.ignore?(self.to_s)
self.unscoped.pluck("#{table_name}.id")
else
inner_select(org, inner_method)
end
end
inner_ids   = inner_ids_loc & inner_ids_org if (inner_ids_loc && inner_ids_org)
inner_ids ||= inner_ids_loc if inner_ids_loc
inner_ids ||= inner_ids_org if inner_ids_org
# In the case of users we want the taxonomy scope to get both the users of the taxonomy and admins.
inner_ids.concat(admin_ids) if inner_ids && self == User
inner_ids