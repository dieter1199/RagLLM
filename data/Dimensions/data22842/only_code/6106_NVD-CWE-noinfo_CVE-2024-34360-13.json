"github.com/spacemeshos/go-spacemesh/activation/wire"
"github.com/spacemeshos/go-spacemesh/sql/builder"
// uncomment to verify ATXs signatures
// app.verifyDB(ctx)
// verifyDB performs a verification of ATX signatures in the database.
//
//lint:ignore U1000 This function is currently unused but is left here for future use.
func (app *App) verifyDB(ctx context.Context) {
app.eg.Go(func() error {
app.log.Info("checking ATX signatures")
count := 0
// check ATX signatures
atxs.IterateAtxsOps(app.cachedDB, builder.Operations{}, func(atx *types.VerifiedActivationTx) bool {
select {
case <-ctx.Done():
// stop on context cancellation
return false
default:
}
// verify atx signature
// TODO: use atx handler to verify signature
if !app.edVerifier.Verify(
signing.ATX,
atx.SmesherID, wire.ActivationTxToWireV1(atx.ActivationTx).SignedBytes(),
atx.Signature,
) {
app.log.With().Error("ATX signature verification failed",
log.Stringer("atx_id", atx.ID()),
log.Stringer("smesher", atx.SmesherID),
)
}
count++
if count%1000 == 0 {
app.log.With().Info("verifying ATX signatures", log.Int("count", count))
}
return true
})
app.log.With().Info("ATX signatures verified", log.Int("count", count))
return nil
})
}
