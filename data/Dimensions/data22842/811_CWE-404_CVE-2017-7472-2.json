{
    "cve_id": "CVE-2017-7472",
    "cve_description": "The KEYS subsystem in the Linux kernel before 4.10.13 allows local users to cause a denial of service (memory consumption) via a series of KEY_REQKEY_DEFL_THREAD_KEYRING keyctl_set_reqkey_keyring calls.",
    "cve_publish_date": "2017-05-11",
    "cwe_id": "CWE-404",
    "cwe_name": "Improper Resource Shutdown or Release",
    "cwe_description": "The product does not release or incorrectly releases a resource before it is made available for re-use.",
    "commit_message": "KEYS: fix keyctl_set_reqkey_keyring() to not leak thread keyrings\n\nThis fixes CVE-2017-7472.\n\nRunning the following program as an unprivileged user exhausts kernel\nmemory by leaking thread keyrings:\n\n\t#include <keyutils.h>\n\n\tint main()\n\t{\n\t\tfor (;;)\n\t\t\tkeyctl_set_reqkey_keyring(KEY_REQKEY_DEFL_THREAD_KEYRING);\n\t}\n\nFix it by only creating a new thread keyring if there wasn't one before.\nTo make things more consistent, make install_thread_keyring_to_cred()\nand install_process_keyring_to_cred() both return 0 if the corresponding\nkeyring is already present.\n\nFixes: d84f4f992cbd (\"CRED: Inaugurate COW credentials\")\nCc: stable@vger.kernel.org # 2.6.29+\nSigned-off-by: Eric Biggers <ebiggers@google.com>\nSigned-off-by: David Howells <dhowells@redhat.com>",
    "type_of_change": "Modification",
    "filename_of_changes": "process_keys.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "27",
    "number_of_lines_deleted_vulnerable_to_cve": "17",
    "vulnerable_lines": [
        "// Line_Reference 131:  * Install a fresh thread keyring directly to new credentials.  This keyring is",
        "// Line_Reference 132:  * allowed to overrun the quota.",
        "// Line_Reference 150:  * Install a fresh thread keyring, discarding the old one.",
        "// Line_Reference 161: \tBUG_ON(new->thread_keyring);",
        "// Line_Reference 162: ",
        "// Line_Reference 173:  * Install a process keyring directly to a credentials struct.",
        "// Line_Reference 175:  * Returns -EEXIST if there was already a process keyring, 0 if one installed,",
        "// Line_Reference 176:  * and other value on any other error",
        "// Line_Reference 183: \t\treturn -EEXIST;",
        "// Line_Reference 197:  * Make sure a process keyring is installed for the current process.  The",
        "// Line_Reference 198:  * existing process keyring is not replaced.",
        "// Line_Reference 200:  * Returns 0 if there is a process keyring by the end of this function, some",
        "// Line_Reference 201:  * error otherwise.",
        "// Line_Reference 215: \t\treturn ret != -EEXIST ? ret : 0;",
        "// Line_Reference 222:  * Install a session keyring directly to a credentials struct.",
        "// Line_Reference 257:  * Install a session keyring, discarding the old one.  If a keyring is not",
        "// Line_Reference 258:  * supplied, an empty one is invented."
    ]
}
