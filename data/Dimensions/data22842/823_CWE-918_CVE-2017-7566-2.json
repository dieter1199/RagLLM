{
    "cve_id": "CVE-2017-7566",
    "cve_description": "MyBB before 1.8.11 allows remote attackers to bypass an SSRF protection mechanism.",
    "cve_publish_date": "2017-04-06",
    "cwe_id": "CWE-918",
    "cwe_name": "Server-Side Request Forgery (SSRF)",
    "cwe_description": "The web server receives a URL or similar request from an upstream component and retrieves the contents of this URL, but it does not sufficiently ensure that the request is being sent to the expected destination.",
    "commit_message": "MyBB 1.8.11",
    "type_of_change": "Modification",
    "filename_of_changes": "functions.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "144",
    "number_of_lines_deleted_vulnerable_to_cve": "43",
    "vulnerable_lines": [
        "// Line_Reference 6787: \t\t(!empty($url_components['port']) && !in_array($url_components['port'], array(80, 8080, 443))) ||",
        "// Line_Reference 6796: \t\t$addresses = gethostbynamel($url_components['host']);",
        "// Line_Reference 6797: \t\tif($addresses)",
        "// Line_Reference 6799: \t\t\tforeach($config['disallowed_remote_addresses'] as $disallowed_address)",
        "// Line_Reference 6801: \t\t\t\t$ip_range = fetch_ip_range($disallowed_address);",
        "// Line_Reference 6802: \t\t\t\tforeach($addresses as $address)",
        "// Line_Reference 6804: \t\t\t\t\t$packed_address = my_inet_pton($address);",
        "// Line_Reference 6805: ",
        "// Line_Reference 6806: \t\t\t\t\tif(is_array($ip_range))",
        "// Line_Reference 6807: \t\t\t\t\t{",
        "// Line_Reference 6808: \t\t\t\t\t\tif(strcmp($ip_range[0], $packed_address) <= 0 && strcmp($ip_range[1], $packed_address) >= 0)",
        "// Line_Reference 6809: \t\t\t\t\t\t{",
        "// Line_Reference 6810: \t\t\t\t\t\t\treturn false;",
        "// Line_Reference 6811: \t\t\t\t\t\t}",
        "// Line_Reference 6812: \t\t\t\t\t}",
        "// Line_Reference 6813: \t\t\t\t\telseif($address == $disallowed_address)",
        "// Line_Reference 6814: \t\t\t\t\t{",
        "// Line_Reference 6815: \t\t\t\t\t\treturn false;",
        "// Line_Reference 6816: \t\t\t\t\t}",
        "// Line_Reference 6834: \t\t$can_followlocation = @ini_get('open_basedir') === '' && !$mybb->safemode;",
        "// Line_Reference 6835: ",
        "// Line_Reference 6836: \t\t$request_header = $max_redirects != 0 && !$can_followlocation;",
        "// Line_Reference 6839: \t\tcurl_setopt($ch, CURLOPT_URL, $url);",
        "// Line_Reference 6840: \t\tcurl_setopt($ch, CURLOPT_HEADER, $request_header);",
        "// Line_Reference 6841: \t\tcurl_setopt($ch, CURLOPT_TIMEOUT, 10);",
        "// Line_Reference 6842: \t\tcurl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);",
        "// Line_Reference 6843: \t\tcurl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);",
        "// Line_Reference 6845: \t\tif($max_redirects != 0 && $can_followlocation)",
        "// Line_Reference 6847: \t\t\tcurl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);",
        "// Line_Reference 6848: \t\t\tcurl_setopt($ch, CURLOPT_MAXREDIRS, $max_redirects);",
        "// Line_Reference 6853: \t\t\tcurl_setopt($ch, CURLOPT_POST, 1);",
        "// Line_Reference 6854: \t\t\tcurl_setopt($ch, CURLOPT_POSTFIELDS, $post_body);",
        "// Line_Reference 6859: \t\tif($request_header)",
        "// Line_Reference 6889: \t\tif(!isset($url_components['port']))",
        "// Line_Reference 6890: \t\t{",
        "// Line_Reference 6891: \t\t\t$url_components['port'] = 80;",
        "// Line_Reference 6892: \t\t}",
        "// Line_Reference 6913: \t\t$fp = @fsockopen($scheme.$url_components['host'], $url_components['port'], $error_no, $error, 10);",
        "// Line_Reference 6965: \t\tif($max_redirects != 0 && (strstr($status_line, ' 301 ') || strstr($status_line, ' 302 ')))",
        "// Line_Reference 6981: \telse if(empty($post_data))",
        "// Line_Reference 6982: \t{",
        "// Line_Reference 6983: \t\treturn @implode(\"\", @file($url));",
        "// Line_Reference 6984: \t}"
    ]
}
