{
    "cve_id": "CVE-2020-10562",
    "cve_description": "An issue was discovered in DEVOME GRR before 3.4.1c. admin_edit_room.php mishandles file uploads.",
    "cve_publish_date": "2020-03-13",
    "cwe_id": "CWE-434",
    "cwe_name": "Unrestricted Upload of File with Dangerous Type",
    "cwe_description": "The product allows the upload or transfer of dangerous file types that are automatically processed within its environment.",
    "commit_message": "sous-version 3.4.1c : mise à jour de sécurité",
    "type_of_change": "Modification",
    "filename_of_changes": "admin_edit_room.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "130",
    "number_of_lines_deleted_vulnerable_to_cve": "87",
    "vulnerable_lines": [
        "// Line_Reference 6:  * Dernière modification : $Date: 2020-01-28 11:10$",
        "// Line_Reference 174: \t\t{",
        "// Line_Reference 175: \t\t\t$dest = '../images/';",
        "// Line_Reference 176: \t\t\t$ok1 = false;",
        "// Line_Reference 177: \t\t\tif ($f = @fopen(\"$dest/.test\", \"w\"))",
        "// Line_Reference 178: \t\t\t{",
        "// Line_Reference 179: \t\t\t\t@fputs($f, '<'.'?php $ok1 = true; ?'.'>');",
        "// Line_Reference 180: \t\t\t\t@fclose($f);",
        "// Line_Reference 181: \t\t\t\tinclude(\"$dest/.test\");",
        "// Line_Reference 182: \t\t\t}",
        "// Line_Reference 183: \t\t\tif (!$ok1)",
        "// Line_Reference 184: \t\t\t{",
        "// Line_Reference 185: \t\t\t\t$msg .= \"L\\'image n\\'a pas pu etre supprimee : probleme d\\'écriture sur le repertoire. Veuillez signaler ce problème à l\\'administrateur du serveur.\\\\n\";",
        "// Line_Reference 186: \t\t\t\t$ok = 'no';",
        "// Line_Reference 187: \t\t\t}",
        "// Line_Reference 188: \t\t\telse",
        "// Line_Reference 189: \t\t\t{",
        "// Line_Reference 190: \t\t\t\tif (@file_exists($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".jpg\"))",
        "// Line_Reference 191: \t\t\t\t\tunlink($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".jpg\");",
        "// Line_Reference 192: \t\t\t\tif (@file_exists($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".png\"))",
        "// Line_Reference 193: \t\t\t\t\tunlink($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".png\");",
        "// Line_Reference 194: \t\t\t\tif (@file_exists($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".gif\"))",
        "// Line_Reference 195: \t\t\t\t\tunlink($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".gif\");",
        "// Line_Reference 196: \t\t\t\t$picture_room = \"\";",
        "// Line_Reference 197: \t\t\t}",
        "// Line_Reference 198: \t\t}",
        "// Line_Reference 199: \t\tif (empty($capacity))",
        "// Line_Reference 283: \t\t$doc_file = isset($_FILES[\"doc_file\"]) ? $_FILES[\"doc_file\"] : NULL;",
        "// Line_Reference 284: \t\tif (preg_match(\"`\\.([^.]+)$`\", $doc_file['name'], $match))",
        "// Line_Reference 285: \t\t{",
        "// Line_Reference 286: \t\t\t$ext = strtolower($match[1]);",
        "// Line_Reference 287: \t\t\tif ($ext != 'jpg' && $ext != 'png'&& $ext != 'gif')",
        "// Line_Reference 288: \t\t\t{",
        "// Line_Reference 289: \t\t\t\t$msg .= \"L\\'image n\\'a pas pu etre enregistree : les seules extentions autorisees sont gif, png et jpg.\\\\n\";",
        "// Line_Reference 290: \t\t\t\t$ok = 'no';",
        "// Line_Reference 291: \t\t\t}",
        "// Line_Reference 292: \t\t\telse",
        "// Line_Reference 293: \t\t\t{",
        "// Line_Reference 294: \t\t\t\t$dest = '../images/';",
        "// Line_Reference 295: \t\t\t\t$ok1 = false;",
        "// Line_Reference 296: \t\t\t\tif ($f = @fopen(\"$dest/.test\", \"w\"))",
        "// Line_Reference 297: \t\t\t\t{",
        "// Line_Reference 298: \t\t\t\t\t@fputs($f, '<'.'?php $ok1 = true; ?'.'>');",
        "// Line_Reference 299: \t\t\t\t\t@fclose($f);",
        "// Line_Reference 300: \t\t\t\t\tinclude(\"$dest/.test\");",
        "// Line_Reference 301: \t\t\t\t}",
        "// Line_Reference 302: \t\t\t\tif (!$ok1)",
        "// Line_Reference 303: \t\t\t\t{",
        "// Line_Reference 304: \t\t\t\t\t$msg .= \"L\\'image n\\'a pas pu etre enregistree : probleme d\\'ecriture sur le repertoire IMAGES. Veuillez signaler ce probleme e l\\'administrateur du serveur.\\\\n\";",
        "// Line_Reference 305: \t\t\t\t\t$ok = 'no';",
        "// Line_Reference 306: \t\t\t\t}",
        "// Line_Reference 307: \t\t\t\telse",
        "// Line_Reference 308: \t\t\t\t{",
        "// Line_Reference 309: \t\t\t\t\t$ok1 = @copy($doc_file['tmp_name'], $dest.$doc_file['name']);",
        "// Line_Reference 310: \t\t\t\t\tif (!$ok1)",
        "// Line_Reference 311: \t\t\t\t\t\t$ok1 = @move_uploaded_file($doc_file['tmp_name'], $dest.$doc_file['name']);",
        "// Line_Reference 312: \t\t\t\t\tif (!$ok1)",
        "// Line_Reference 313: \t\t\t\t\t{",
        "// Line_Reference 314: \t\t\t\t\t\t$msg .= \"L\\'image n\\'a pas pu etre enregistree : probleme de transfert. Le fichier n\\'a pas pu etre transfere sur le repertoire IMAGES. Veuillez signaler ce probleme e l\\'administrateur du serveur.\\\\n\";",
        "// Line_Reference 315: \t\t\t\t\t\t$ok = 'no';",
        "// Line_Reference 316: \t\t\t\t\t}",
        "// Line_Reference 317: \t\t\t\t\telse",
        "// Line_Reference 318: \t\t\t\t\t{",
        "// Line_Reference 319: \t\t\t\t\t\t$tab = explode(\".\", $doc_file['name']);",
        "// Line_Reference 320: \t\t\t\t\t\t$ext = strtolower($tab[1]);",
        "// Line_Reference 321: \t\t\t\t\t\tif (@file_exists($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".\".$ext))",
        "// Line_Reference 322: \t\t\t\t\t\t\t@unlink($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".\".$ext);",
        "// Line_Reference 323: \t\t\t\t\t\trename($dest.$doc_file['name'],$dest.\"img_\".TABLE_PREFIX.\"\".$room.\".\".$ext);",
        "// Line_Reference 324: \t\t\t\t\t\t@chmod($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".\".$ext, 0666);",
        "// Line_Reference 325: \t\t\t\t\t\t$picture_room = \"img_\".TABLE_PREFIX.\"\".$room.\".\".$ext;",
        "// Line_Reference 326: \t\t\t\t\t\t$sql_picture = \"UPDATE \".TABLE_PREFIX.\"_room SET picture_room='\".protect_data_sql($picture_room).\"' WHERE id=\".$room;",
        "// Line_Reference 327: \t\t\t\t\t\tif (grr_sql_command($sql_picture) < 0)",
        "// Line_Reference 328: \t\t\t\t\t\t{",
        "// Line_Reference 329: \t\t\t\t\t\t\tfatal_error(0, get_vocab('update_room_failed') . grr_sql_error());",
        "// Line_Reference 330: \t\t\t\t\t\t\t$ok = 'no';",
        "// Line_Reference 331: \t\t\t\t\t\t}",
        "// Line_Reference 332: \t\t\t\t\t}",
        "// Line_Reference 333: \t\t\t\t}",
        "// Line_Reference 334: \t\t\t}",
        "// Line_Reference 335: \t\t}",
        "// Line_Reference 336: \t\telse if ($doc_file['name'] != '')",
        "// Line_Reference 337: \t\t{",
        "// Line_Reference 338: \t\t\t$msg .= \"L\\'image n\\'a pas pu etre enregistree : le fichier image selectionne n'est pas valide !\\\\n\";",
        "// Line_Reference 339: \t\t\t$ok = 'no';",
        "// Line_Reference 340: \t\t}",
        "// Line_Reference 341: \t\t$msg .= get_vocab(\"message_records\");",
        "// Line_Reference 1055: \t\t// Definition des jours de la semaine e afficher sur les plannings et calendriers"
    ]
}
