{
    "cve_id": "CVE-2021-3976",
    "cve_description": "kimai2 is vulnerable to Cross-Site Request Forgery (CSRF)",
    "cve_publish_date": "2021-11-19",
    "cwe_id": "CWE-352",
    "cwe_name": "Cross-Site Request Forgery (CSRF)",
    "cwe_description": "The web application does not, or can not, sufficiently verify whether a well-formed, valid, consistent request was intentionally provided by the user who submitted the request.",
    "commit_message": "version 1.16.2 (#2942)\n\n* bump version\r\n* include calendar week in week chooser\r\n* table names in SQL\r\n* show save flash message\r\n* prevent migration warning\r\n* drop default value to prevent error when server version is not set\r\n* csrf token for duplicate actions\r\n* updated translations",
    "type_of_change": "Modification",
    "filename_of_changes": "Version20180715160326.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "27",
    "number_of_lines_deleted_vulnerable_to_cve": "31",
    "vulnerable_lines": [
        "// Line_Reference 40:         $users = 'kimai2_users';",
        "// Line_Reference 41: ",
        "// Line_Reference 43:         $indexesOld = $schema->getTable($users)->getIndexes();",
        "// Line_Reference 47:                 $this->addSql('DROP INDEX ' . $index->getName() . ' ON ' . $users);",
        "// Line_Reference 51:         $this->addSql('ALTER TABLE ' . $users . ' CHANGE name username VARCHAR(180) NOT NULL, ADD username_canonical VARCHAR(180) NOT NULL, CHANGE mail email VARCHAR(180) NOT NULL, ADD email_canonical VARCHAR(180) NOT NULL, ADD salt VARCHAR(255) DEFAULT NULL, ADD last_login DATETIME DEFAULT NULL, ADD confirmation_token VARCHAR(180) DEFAULT NULL, ADD password_requested_at DATETIME DEFAULT NULL, CHANGE password password VARCHAR(255) NOT NULL, CHANGE alias alias VARCHAR(60) DEFAULT NULL, CHANGE registration_date registration_date DATETIME DEFAULT NULL, CHANGE title title VARCHAR(50) DEFAULT NULL, CHANGE avatar avatar VARCHAR(255) DEFAULT NULL, CHANGE roles roles LONGTEXT NOT NULL COMMENT \\'(DC2Type:array)\\', CHANGE active enabled TINYINT(1) NOT NULL');",
        "// Line_Reference 52:         $this->addSql('UPDATE ' . $users . ' set username_canonical = username');",
        "// Line_Reference 53:         $this->addSql('UPDATE ' . $users . ' set email_canonical = email');",
        "// Line_Reference 54: ",
        "// Line_Reference 55:         $this->addSql('UPDATE ' . $users . ' SET roles = \\'a:1:{i:0;s:16:\"ROLE_SUPER_ADMIN\";}\\' WHERE roles LIKE \\'%ROLE_SUPER_ADMIN%\\'');",
        "// Line_Reference 56:         $this->addSql('UPDATE ' . $users . ' SET roles = \\'a:1:{i:0;s:10:\"ROLE_ADMIN\";}\\' WHERE roles LIKE \\'%ROLE_ADMIN%\\'');",
        "// Line_Reference 57:         $this->addSql('UPDATE ' . $users . ' SET roles = \\'a:1:{i:0;s:13:\"ROLE_TEAMLEAD\";}\\' WHERE roles LIKE \\'%ROLE_TEAMLEAD%\\'');",
        "// Line_Reference 58:         $this->addSql('UPDATE ' . $users . ' SET roles = \\'a:0:{}\\' WHERE roles LIKE \\'%ROLE_USER%\\'');",
        "// Line_Reference 59:         $this->addSql('UPDATE ' . $users . ' SET roles = \\'a:1:{i:0;s:13:\"ROLE_CUSTOMER\";}\\' WHERE roles LIKE \\'%ROLE_CUSTOMER%\\'');",
        "// Line_Reference 60: ",
        "// Line_Reference 61:         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCE92FC23A8 ON ' . $users . ' (username_canonical)');",
        "// Line_Reference 62:         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCEA0D96FBF ON ' . $users . ' (email_canonical)');",
        "// Line_Reference 63:         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCEC05FB297 ON ' . $users . ' (confirmation_token)');",
        "// Line_Reference 64:         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCEF85E0677 ON ' . $users . ' (username)');",
        "// Line_Reference 65:         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCEE7927C74 ON ' . $users . ' (email)');",
        "// Line_Reference 75:         $users = 'kimai2_users';",
        "// Line_Reference 76: ",
        "// Line_Reference 79:             $this->addSql('DROP INDEX ' . $indexName . ' ON ' . $users);",
        "// Line_Reference 82:         $this->addSql('ALTER TABLE ' . $users . ' CHANGE username name VARCHAR(60) NOT NULL COLLATE utf8mb4_unicode_ci, CHANGE email mail VARCHAR(160) NOT NULL COLLATE utf8mb4_unicode_ci, DROP username_canonical, DROP email_canonical, DROP salt, DROP last_login, DROP confirmation_token, DROP password_requested_at, CHANGE password password VARCHAR(254) DEFAULT NULL COLLATE utf8mb4_unicode_ci, CHANGE roles roles LONGTEXT NOT NULL COMMENT \\'(DC2Type:array)\\', CHANGE alias alias VARCHAR(60) DEFAULT NULL COLLATE utf8mb4_unicode_ci, CHANGE registration_date registration_date DATETIME DEFAULT NULL, CHANGE title title VARCHAR(50) DEFAULT NULL COLLATE utf8mb4_unicode_ci, CHANGE avatar avatar VARCHAR(255) DEFAULT NULL COLLATE utf8mb4_unicode_ci, CHANGE enabled active TINYINT(1) NOT NULL');",
        "// Line_Reference 84:         $this->addSql('UPDATE ' . $users . ' SET roles = \\'[\"ROLE_SUPER_ADMIN\"]\\' WHERE roles LIKE \\'%ROLE_SUPER_ADMIN%\\'');",
        "// Line_Reference 85:         $this->addSql('UPDATE ' . $users . ' SET roles = \\'[\"ROLE_ADMIN\"]\\' WHERE roles LIKE \\'%ROLE_ADMIN%\\'');",
        "// Line_Reference 86:         $this->addSql('UPDATE ' . $users . ' SET roles = \\'[\"ROLE_TEAMLEAD\"]\\' WHERE roles LIKE \\'%ROLE_TEAMLEAD%\\'');",
        "// Line_Reference 87:         $this->addSql('UPDATE ' . $users . ' SET roles = \\'[\"ROLE_USER\"]\\' WHERE roles LIKE \\'%ROLE_USER%\\'');",
        "// Line_Reference 88:         $this->addSql('UPDATE ' . $users . ' SET roles = \\'[\"ROLE_CUSTOMER\"]\\' WHERE roles LIKE \\'%ROLE_CUSTOMER%\\'');",
        "// Line_Reference 90:         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCE5E237E06 ON ' . $users . ' (name)');",
        "// Line_Reference 91:         $this->addSql('CREATE UNIQUE INDEX UNIQ_B9AC5BCE5126AC48 ON ' . $users . ' (mail)');",
        "// Line_Reference 93:         $usersTable = $schema->getTable($users);"
    ]
}
