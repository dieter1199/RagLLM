func prepareRootfs(pipe io.ReadWriter, iConfig *initConfig) (err error) {
for _, m := range config.Mounts {
func prepareBindMount(m *configs.Mount, rootfs string) error {
stat, err := os.Stat(m.Source)
if err := checkProcMount(rootfs, dest, m.Source); err != nil {
err = mountPropagate(m, "/", mountLabel)
return mountPropagate(m, rootfs, "")
if err := mountPropagate(m, rootfs, ""); err != nil {
err = mountPropagate(m, rootfs, mountLabel)
if err := remount(m, rootfs); err != nil {
if err := prepareBindMount(m, rootfs); err != nil {
if err := mountPropagate(m, rootfs, mountLabel); err != nil {
if err := remount(m, rootfs); err != nil {
return mountPropagate(m, rootfs, mountLabel)
func remount(m *configs.Mount, rootfs string) error {
return mount(m.Source, m.Destination, procfd, m.Device, uintptr(m.Flags|unix.MS_REMOUNT), "")
func mountPropagate(m *configs.Mount, rootfs string, mountLabel string) error {
return mount(m.Source, m.Destination, procfd, m.Device, uintptr(flags), data)