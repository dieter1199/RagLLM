{
    "cve_id": "CVE-2023-6849",
    "cve_description": "A vulnerability was found in kalcaddle kodbox up to 1.48. It has been rated as critical. Affected by this issue is the function cover of the file plugins/fileThumb/app.php. The manipulation of the argument path leads to server-side request forgery. The attack may be launched remotely. The exploit has been disclosed to the public and may be used. Upgrading to version 1.48.04 is able to address this issue. The patch is identified as 63a4d5708d210f119c24afd941d01a943e25334c. It is recommended to upgrade the affected component. VDB-248210 is the identifier assigned to this vulnerability.",
    "cve_publish_date": "2023-12-16",
    "cwe_id": "CWE-918",
    "cwe_name": "Server-Side Request Forgery (SSRF)",
    "cwe_description": "The web server receives a URL or similar request from an upstream component and retrieves the contents of this URL, but it does not sufficiently ensure that the request is being sent to the expected destination.",
    "commit_message": "1.48.04 release",
    "type_of_change": "Modification",
    "filename_of_changes": "pclzip.class.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "192",
    "number_of_lines_deleted_vulnerable_to_cve": "145",
    "vulnerable_lines": [
        "// Line_Reference 39:     define( 'PCLZIP_READ_BLOCK_SIZE', 2048 );",
        "// Line_Reference 2915:     $v_size = $p_header['compressed_size'];",
        "// Line_Reference 2916:     while ($v_size != 0)",
        "// Line_Reference 3113: ",
        "// Line_Reference 3879:           $v_size = $p_entry['compressed_size'];",
        "// Line_Reference 3888:             @fwrite($v_dest_file, $v_buffer, $v_read_size);",
        "// Line_Reference 4051:     $v_size = $p_entry['compressed_size'];",
        "// Line_Reference 4084:     $v_size = $p_entry['size'];",
        "// Line_Reference 4441:   // --------------------------------------------------------------------------------",
        "// Line_Reference 4443:   //zip64 footer:extra data;add by warlee;",
        "// Line_Reference 4444:   //64位文件头读取处理",
        "// Line_Reference 4445:   function readZip64ExtraData(&$p_header){",
        "// Line_Reference 4446:     $size   = filesize($this->zipname);",
        "// Line_Reference 4447:     //不符合zip64 的大于4G的文件处理；溢出寻找标记头；",
        "// Line_Reference 4448:     if(!$this->zip64 && $size >= 0xFFFFFFFF){",
        "// Line_Reference 4449:       $zip  = fopen($this->zipname,'rb');",
        "// Line_Reference 4450:       $from = $p_header['offset'];",
        "// Line_Reference 4451:       while($from < $size){",
        "// Line_Reference 4452:         fseek($zip,$from);",
        "// Line_Reference 4453:         $sign = unpack('Vid',@fread($zip, 4));",
        "// Line_Reference 4454:         //pr($from,$sign,0x04034b50);",
        "// Line_Reference 4455:         if($sign['id'] == 0x04034b50){",
        "// Line_Reference 4456:           $p_header['offset'] = $from;",
        "// Line_Reference 4457:           break;",
        "// Line_Reference 4458:         }else{",
        "// Line_Reference 4459:           $from = $from + 0xFFFFFFFF + 1;//",
        "// Line_Reference 4460:         }",
        "// Line_Reference 4461:       }",
        "// Line_Reference 4462: ",
        "// Line_Reference 4463:       //mac下压缩大于4G的文件",
        "// Line_Reference 4464:       $from = 4+26+$p_header['compressed_size']+$p_header['filename_len']+$p_header['extra_len']+$p_header['comment_len']+20;",
        "// Line_Reference 4465:       $add  = 0;",
        "// Line_Reference 4466:       while($from < $size){",
        "// Line_Reference 4467:         fseek($zip,$from);",
        "// Line_Reference 4468:         $sign = unpack(\"Vid\",@fread($zip, 4));",
        "// Line_Reference 4469:         // pr($from,$p_header,str2hex(file_sub_str($this->zipname,$from,50)) );",
        "// Line_Reference 4470:         if($sign['id'] == 0x04034b50 || $sign['id'] == 0x02014b50 || $sign['id'] == 0x06054b50){",
        "// Line_Reference 4471:           $p_header['size'] += $add;",
        "// Line_Reference 4472:           $p_header['compressed_size'] += $add;",
        "// Line_Reference 4473:           break;",
        "// Line_Reference 4474:         }else{",
        "// Line_Reference 4475:           $add += 0xFFFFFFFF + 1;",
        "// Line_Reference 4476:           $from += $add;//",
        "// Line_Reference 4477:         }",
        "// Line_Reference 4478:       }",
        "// Line_Reference 4479:       fclose($zip);",
        "// Line_Reference 4480:     }",
        "// Line_Reference 4481: ",
        "// Line_Reference 4482:     if(!$this->zip64 || !$p_header['extra']){",
        "// Line_Reference 4483:       return;",
        "// Line_Reference 4484:     };",
        "// Line_Reference 4485:     //pr(strlen($p_header['extra']),str2hex($p_header['extra']));",
        "// Line_Reference 4486:     $p_extra_data = unpack('va/vb/Psize/Pcompressed_size/Poffset',$p_header['extra']);//2+2+8+8+8",
        "// Line_Reference 4487:     if(strlen($p_header['extra']) < 28){",
        "// Line_Reference 4488:         $p_extra_data = unpack('va/vb/Psize/Pcompressed_size',$p_header['extra']);",
        "// Line_Reference 4489:         $p_extra_data['offset'] = 0;",
        "// Line_Reference 4490:     }",
        "// Line_Reference 4491:     if(strlen($p_header['extra']) < 20){//变长",
        "// Line_Reference 4492:         $p_extra_data = unpack('va/vb/Psize',$p_header['extra']);",
        "// Line_Reference 4493:         $p_extra_data['compressed_size'] = 0;",
        "// Line_Reference 4494:         $p_extra_data['offset'] = 0;",
        "// Line_Reference 4495:     }",
        "// Line_Reference 4496: ",
        "// Line_Reference 4497:     //01 为zip64扩展数据标记",
        "// Line_Reference 4498:     if(!$p_extra_data || $p_extra_data['a'] != 0x01){",
        "// Line_Reference 4499:         if($p_header['size'] >= 0xFFFFFFFF){//兼容非zip64 文件超过4G的文件情况",
        "// Line_Reference 4500:           $this->privReadEndCentralDirZip4G($p_header);//校正偏移量;n*0xFFFFFFFF",
        "// Line_Reference 4501:         }",
        "// Line_Reference 4502:     \treturn;",
        "// Line_Reference 4503:     }",
        "// Line_Reference 4504:     if($p_header['offset'] == 0xffffffff){",
        "// Line_Reference 4505:         //var_dump(str2hex($v_binary_data),$p_header,str2hex($p_header['extra']),$p_extra_data);",
        "// Line_Reference 4506:     }",
        "// Line_Reference 4507:     if($p_header['compressed_size'] == 0xffffffff && $p_extra_data['compressed_size'] > 0 ){",
        "// Line_Reference 4508:         $p_header['compressed_size'] = $p_extra_data['compressed_size'];",
        "// Line_Reference 4509:     }",
        "// Line_Reference 4510:     //适配特殊情况; 顺序适配",
        "// Line_Reference 4511:     if($p_header['offset'] == 0xffffffff){",
        "// Line_Reference 4512:         if( $p_extra_data['offset'] >0 && $p_extra_data['offset']< 1024*1024*1024*1000){",
        "// Line_Reference 4513:             $p_header['offset'] = $p_extra_data['offset'];",
        "// Line_Reference 4514:         }else if($p_extra_data['size'] >= 0xffffffff){",
        "// Line_Reference 4515:             $p_header['offset'] = $p_extra_data['size'];",
        "// Line_Reference 4516:         }",
        "// Line_Reference 4517:     }",
        "// Line_Reference 4518:     if($p_header['size'] == 0xffffffff){",
        "// Line_Reference 4519:         $p_header['size'] = $p_extra_data['size'];",
        "// Line_Reference 4520:     }",
        "// Line_Reference 4521:   }",
        "// Line_Reference 4813: ",
        "// Line_Reference 4831:   //超过4G的文件；通过溢出查找偏移位置",
        "// Line_Reference 4832:   function privReadEndCentralDirZip4G(&$p_central_dir){",
        "// Line_Reference 4833:     $zip = fopen($this->zipname,'rb');",
        "// Line_Reference 4834:     $from   = $p_central_dir['offset'];",
        "// Line_Reference 4835:     $size   = filesize($this->zipname);",
        "// Line_Reference 4836:     while($from < $size){",
        "// Line_Reference 4837:       fseek($zip,$from);",
        "// Line_Reference 4838:       $sign = unpack('Vid',@fread($zip, 4));",
        "// Line_Reference 4839:       //debug_out($from,$sign,0x02014b50);",
        "// Line_Reference 4840:       if($sign['id'] == 0x02014b50){",
        "// Line_Reference 4841:         $p_central_dir['offset'] = $from;",
        "// Line_Reference 4842:         break;",
        "// Line_Reference 4843:       }else{",
        "// Line_Reference 4844:         $from = $from + 0xFFFFFFFF + 1;//",
        "// Line_Reference 4845:       }",
        "// Line_Reference 4846:     }",
        "// Line_Reference 4847:     fclose($zip);",
        "// Line_Reference 4848:     return 1;",
        "// Line_Reference 4849:   }",
        "// Line_Reference 4850: ",
        "// Line_Reference 4851:     // zip64 support;",
        "// Line_Reference 4852:     //https://blog.csdn.net/a200710716/article/details/51644421",
        "// Line_Reference 4853:     //https://github.com/brokencube/ZipStream64/blob/14087549a4914bfc441a396ca02849569145a273/src/ZipStream.php#L808",
        "// Line_Reference 4854:     //https://pkware.cachefly.net/webdocs/APPNOTE/APPNOTE-6.2.0.txt",
        "// Line_Reference 4855:     function privReadEndCentralDirZip64(&$p_central_dir,$cdr_data){",
        "// Line_Reference 4856:         $this->zip64 = true;",
        "// Line_Reference 4857:         //56 [zip64 end of central directory record]",
        "// Line_Reference 4858:             //Vzip64_cdr_eof/Pblow_offset/vversion/vversion_un/Vdisk/Vdisk_start/Pdisk_entries/Pentries/Psize/Poffset",
        "// Line_Reference 4859:         //20 [zip64 end of central directory locator]",
        "// Line_Reference 4860:             //Vzip64_cdr_loc_flag/Vdisk_num/Pcdr_offset/Vtotal_disk",
        "// Line_Reference 4861:         //22 [end of central directory record]",
        "// Line_Reference 4862:             //Vzip_cdr_eof/vdisk/vdisk_start/vdisk_entries/ventries/Vsize/Voffset/vcomment_size",
        "// Line_Reference 4863:         $offset_back = 56+20+22;",
        "// Line_Reference 4864:         $old_pose = ftell($this->zip_fd);",
        "// Line_Reference 4865:         fseek($this->zip_fd,$old_pose-$cdr_data['comment_size']-$offset_back);",
        "// Line_Reference 4866:         $v_bin  = fread($this->zip_fd, 56);",
        "// Line_Reference 4867:         $v_data  = unpack('Vzip64_cdr_eof/Pblow_offset/vversion/vversion_un/Vdisk/Vdisk_start/Pdisk_entries/Pentries/Psize/Poffset', $v_bin);",
        "// Line_Reference 4868:         if($v_data['zip64_cdr_eof'] != 0x06064b50){",
        "// Line_Reference 4869:             PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, \"Invalid End of Zip64 Central Dir Record error:\".json_encode($v_data));",
        "// Line_Reference 4870:             return PclZip::errorCode();",
        "// Line_Reference 4871:         }",
        "// Line_Reference 4872: ",
        "// Line_Reference 4873:         $loc_bin   = fread($this->zip_fd,20);",
        "// Line_Reference 4874:         $loc_data  = unpack('Vzip64_cdr_loc_flag/Vdisk_num/Pcdr_offset/Vtotal_disk', $loc_bin);",
        "// Line_Reference 4875:         if($loc_data['zip64_cdr_loc_flag'] != 0x07064b50){",
        "// Line_Reference 4876:             PclZip::privErrorLog(PCLZIP_ERR_BAD_FORMAT, \"Invalid End of Zip64 central directory locator error:\".json_encode($loc_data));",
        "// Line_Reference 4877:             return PclZip::errorCode();",
        "// Line_Reference 4878:         }",
        "// Line_Reference 4879:         $p_central_dir['entries'] = $v_data['entries'];",
        "// Line_Reference 4880:         $p_central_dir['disk_entries'] = $v_data['disk_entries'];",
        "// Line_Reference 4881:         $p_central_dir['offset'] = $v_data['offset'];",
        "// Line_Reference 4882:         $p_central_dir['size'] = $v_data['size'];",
        "// Line_Reference 4883:         fseek($this->zip_fd,$old_pose);",
        "// Line_Reference 4884:         return 1;",
        "// Line_Reference 4885:     }",
        "// Line_Reference 4886: "
    ]
}
