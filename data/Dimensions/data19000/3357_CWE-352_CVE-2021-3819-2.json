{
    "cve_id": "CVE-2021-3819",
    "cve_description": "firefly-iii is vulnerable to Cross-Site Request Forgery (CSRF)",
    "cve_publish_date": "2021-09-27",
    "cwe_id": "CWE-352",
    "cwe_name": "Cross-Site Request Forgery (CSRF)",
    "cwe_description": "The web application does not, or can not, sufficiently verify whether a well-formed, valid, consistent request was intentionally provided by the user who submitted the request.",
    "commit_message": "Convert GET routes to POST.",
    "type_of_change": "Modification",
    "filename_of_changes": "CurrencyController.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "53",
    "number_of_lines_deleted_vulnerable_to_cve": "39",
    "vulnerable_lines": [
        "// Line_Reference 216:     public function disableCurrency(Request $request, TransactionCurrency $currency)",
        "// Line_Reference 218:         app('preferences')->mark();",
        "// Line_Reference 220:         /** @var User $user */",
        "// Line_Reference 221:         $user = auth()->user();",
        "// Line_Reference 222:         if (!$this->userRepository->hasRole($user, 'owner')) {",
        "// Line_Reference 224:             $request->session()->flash('error', (string)trans('firefly.ask_site_owner', ['owner' => e(config('firefly.site_owner'))]));",
        "// Line_Reference 225:             Log::channel('audit')->info(sprintf('Tried to disable currency %s but is not site owner.', $currency->code));",
        "// Line_Reference 227:             return redirect(route('currencies.index'));",
        "// Line_Reference 229:         }",
        "// Line_Reference 231:         if ($this->repository->currencyInUse($currency)) {",
        "// Line_Reference 233:             $location = $this->repository->currencyInUseAt($currency);",
        "// Line_Reference 234:             $message  = (string)trans(sprintf('firefly.cannot_disable_currency_%s', $location), ['name' => e($currency->name)]);",
        "// Line_Reference 236:             $request->session()->flash('error', $message);",
        "// Line_Reference 237:             Log::channel('audit')->info(sprintf('Tried to disable currency %s but is in use.', $currency->code));",
        "// Line_Reference 239:             return redirect(route('currencies.index'));",
        "// Line_Reference 240:         }",
        "// Line_Reference 242:         $this->repository->disable($currency);",
        "// Line_Reference 243:         Log::channel('audit')->info(sprintf('Disabled currency %s.', $currency->code));",
        "// Line_Reference 244:         // if no currencies are enabled, enable the first one in the DB (usually the EUR)",
        "// Line_Reference 245:         if (0 === $this->repository->get()->count()) {",
        "// Line_Reference 246:             /** @var TransactionCurrency $first */",
        "// Line_Reference 247:             $first = $this->repository->getAll()->first();",
        "// Line_Reference 248:             if (null === $first) {",
        "// Line_Reference 249:                 throw new FireflyException('No currencies found.');",
        "// Line_Reference 250:             }",
        "// Line_Reference 251:             Log::channel('audit')->info(sprintf('Auto-enabled currency %s.', $first->code));",
        "// Line_Reference 252:             $this->repository->enable($first);",
        "// Line_Reference 253:             app('preferences')->set('currencyPreference', $first->code);",
        "// Line_Reference 254:             app('preferences')->mark();",
        "// Line_Reference 255:         }",
        "// Line_Reference 257:         if ('EUR' === $currency->code) {",
        "// Line_Reference 258:             session()->flash('warning', (string)trans('firefly.disable_EUR_side_effects'));",
        "// Line_Reference 259:         }",
        "// Line_Reference 261:         session()->flash('success', (string)trans('firefly.currency_is_now_disabled', ['name' => $currency->name]));",
        "// Line_Reference 314:     public function enableCurrency(TransactionCurrency $currency)",
        "// Line_Reference 316:         app('preferences')->mark();",
        "// Line_Reference 318:         $this->repository->enable($currency);",
        "// Line_Reference 319:         session()->flash('success', (string)trans('firefly.currency_is_now_enabled', ['name' => $currency->name]));",
        "// Line_Reference 320:         Log::channel('audit')->info(sprintf('Enabled currency %s.', $currency->code));"
    ]
}
