{
    "cve_id": "CVE-2021-27340",
    "cve_description": "OpenSIS Community Edition version <= 7.6 is affected by a reflected XSS vulnerability in EmailCheck.php via the \"opt\" parameter.",
    "cve_publish_date": "2021-09-16",
    "cwe_id": "CWE-79",
    "cwe_name": "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "cwe_description": "The product does not neutralize or incorrectly neutralizes user-controllable input before it is placed in output that is used as a web page that is served to other users.",
    "commit_message": "Commit with security and bug fixes",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "FilesInc.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "139",
    "number_of_lines_deleted_vulnerable_to_cve": "102",
    "vulnerable_lines": [
        "// Line_Reference 36: //        unlink($_REQUEST['file']);",
        "// Line_Reference 53: //    if (!file_exists($dir)) {",
        "// Line_Reference 54: //        mkdir($dir, 0777);",
        "// Line_Reference 55: //    }",
        "// Line_Reference 56:     if ($_FILES['uploadfile']['name']) {",
        "// Line_Reference 57:         $_FILES['uploadfile']['name'] = str_replace(\" \", \"opensis_space_here\", $_FILES['uploadfile']['name']);",
        "// Line_Reference 59:         $target_path = $dir . '/' . UserStudentID() . '-' . $_FILES['uploadfile']['name'];",
        "// Line_Reference 60:         if (file_exists($target_path)) {",
        "// Line_Reference 61:             $target_path = $dir . '/' . UserStudentID() . '-' . $_FILES['uploadfile']['name'] . \"-_\" . time();",
        "// Line_Reference 62:             $_SESSION['dup_file_name'] = $target_path;",
        "// Line_Reference 63:             $_SESSION['grid_msg'] = 'block';",
        "// Line_Reference 64:         }",
        "// Line_Reference 66:         $fileName = $_FILES['uploadfile']['name'];",
        "// Line_Reference 67:         $tmpName = $_FILES['uploadfile']['tmp_name'];",
        "// Line_Reference 68:         $fileSize = $_FILES['uploadfile']['size'];",
        "// Line_Reference 69:         $fileType = $_FILES['uploadfile']['type'];",
        "// Line_Reference 70:         $destination_path = $dir;",
        "// Line_Reference 71:         $upload = new upload();",
        "// Line_Reference 72:         $upload->target_path = $target_path;",
        "// Line_Reference 73:         $upload->destination_path = $destination_path;",
        "// Line_Reference 74:         $upload->name = $_FILES[\"uploadfile\"][\"name\"];",
        "// Line_Reference 75:         $upload->setFileExtension();",
        "// Line_Reference 76:         $upload->fileExtension;",
        "// Line_Reference 77:         $upload->allowExtension = $allowFiles;",
        "// Line_Reference 78:         $upload->validateImage();",
        "// Line_Reference 79:         if ($upload->wrongFormat == 1) {",
        "// Line_Reference 80:             $_FILES[\"uploadfile\"][\"error\"] = 1;",
        "// Line_Reference 81:         }",
        "// Line_Reference 82:         if ($_FILES[\"uploadfile\"][\"error\"] > 0) {",
        "// Line_Reference 83:             $msg = '<span style=\"color: #C90000; font-family: Arial, Helvetica, sans-serif; font-size: 11px;\">'._cannotUploadFileInvalidFileType.'</span>';",
        "// Line_Reference 84:         } else {",
        "// Line_Reference 86:             $fp = fopen($tmpName, 'r');",
        "// Line_Reference 87:             $content = fread($fp, filesize($tmpName));",
        "// Line_Reference 88:             $content = addslashes($content);",
        "// Line_Reference 89:             fclose($fp);",
        "// Line_Reference 91:             if (!get_magic_quotes_gpc()) {",
        "// Line_Reference 92:                 $fileName = addslashes($fileName);",
        "// Line_Reference 93:             }",
        "// Line_Reference 95:             DBQuery('INSERT INTO user_file_upload (USER_ID,PROFILE_ID,SCHOOL_ID,SYEAR,NAME, SIZE, TYPE, CONTENT,FILE_INFO) VALUES (' . UserStudentID() . ',\\'3\\',' . UserSchool() . ',' . UserSyear() . ',\\'' . $fileName . '\\', \\'' . $fileSize . '\\', \\'' . $fileType . '\\', \\'' . $content . '\\',\\'stufile\\')');",
        "// Line_Reference 96: ",
        "// Line_Reference 97:             $msg = '<span style=\"color: #669900; font-family: Arial, Helvetica, sans-serif; font-size: 11px;\">'._successfullyUploaded.'</span>';",
        "// Line_Reference 98: ",
        "// Line_Reference 99: //            if (!move_uploaded_file($_FILES[\"uploadfile\"][\"tmp_name\"], $upload->target_path))",
        "// Line_Reference 100: //                $msg = '<span style=\"color: #C90000; font-family: Arial, Helvetica, sans-serif; font-size: 11px;\">'._cannotUploadFileInvalidPermission.'</span>';",
        "// Line_Reference 101: //            else {",
        "// Line_Reference 102: //",
        "// Line_Reference 103: //                $target_path1 = $dir . '/' . UserStudentID() . '-' . $_FILES['uploadfile']['name'];",
        "// Line_Reference 104: //                if (file_exists($target_path1) && file_exists($_SESSION['dup_file_name'])) {",
        "// Line_Reference 105: //",
        "// Line_Reference 106: //                    $n = DuplicateFile(\"duplicate file\", $_SESSION['dup_file_name']);",
        "// Line_Reference 107: //                }",
        "// Line_Reference 108: //                $msg = '<span style=\"color: #669900; font-family: Arial, Helvetica, sans-serif; font-size: 11px;\">'._successfullyUploaded.'</span>';",
        "// Line_Reference 109: //            }",
        "// Line_Reference 117: ",
        "// Line_Reference 121:             echo '<div class=\"alert bg-primary alert-styled-left\">'._toUploadAdditionalFilesClickBrowseSelectFileGiveItAFileNameAndClickSave.'</div>';",
        "// Line_Reference 123:             echo '<div class=\"alert bg-primary alert-styled-left\">'._toViewACertainFileClickOnTheNameOfTheFile.'</div>';",
        "// Line_Reference 127:             echo '<input type=\"file\" name=\"uploadfile\" size=50 id=\"upfile\">';",
        "// Line_Reference 131: //        $dir = dir($dir);",
        "// Line_Reference 139: //        while ($filename = $dir->read()) {",
        "// Line_Reference 140: //",
        "// Line_Reference 141: //            if ($filename) {",
        "// Line_Reference 142: //                if ($filename == '.' || $filename == '..')",
        "// Line_Reference 143: //                    continue;",
        "// Line_Reference 144: //",
        "// Line_Reference 145: //                $student_id_up = explode('-', $filename);",
        "// Line_Reference 146: //",
        "// Line_Reference 147: //                if ($student_id_up[0] == UserStudentID()) {",
        "// Line_Reference 148: //                    $found = true;",
        "// Line_Reference 149: //",
        "// Line_Reference 150: //                    $sub = substr($filename, strpos($filename, '-') + 1);",
        "// Line_Reference 151: //",
        "// Line_Reference 152: //                    if (strstr($sub, '-_')) {",
        "// Line_Reference 153: //                        $file_display = substr($sub, 0, strrpos($sub, '-_'));",
        "// Line_Reference 154: //                    } else {",
        "// Line_Reference 155: //                        $file_display = $sub;",
        "// Line_Reference 156: //                    }",
        "// Line_Reference 157: //",
        "// Line_Reference 158: //                    echo '<tr class=\"' . $gridClass . '\">",
        "// Line_Reference 159: //                          <td><a target=\"new\" href=\"assets/studentfiles/' . $filename . '\">' . str_replace(\"opensis_space_here\", \" \", $file_display) . '</a></td>",
        "// Line_Reference 160: //                          ';",
        "// Line_Reference 161: //",
        "// Line_Reference 162: //                    if (AllowEdit()) {",
        "// Line_Reference 163: //                        echo '<td><input type=\"hidden\" name=\"del\" value=\"assets/studentfiles/' . $filename . '\"/ >",
        "// Line_Reference 164: //                          <a href=Modules.php?modname='.$_REQUEST['modname'].'&include=FilesInc&category_id='.$_REQUEST['category_id'].'&file=assets/studentfiles/' . urlencode($filename) . '&modfunc=delete><i class=\"fa fa-times\"></i></a>",
        "// Line_Reference 165: //                              </td>';",
        "// Line_Reference 166: //                    }",
        "// Line_Reference 167: //",
        "// Line_Reference 168: //                    echo ' </tr>';",
        "// Line_Reference 169: //                }",
        "// Line_Reference 170: //            }",
        "// Line_Reference 171: //        }",
        "// Line_Reference 182: //            $student_id_up = explode('-',$filename);",
        "// Line_Reference 183: //            if($student_id_up[0]==UserStudentID())",
        "// Line_Reference 184: //            {",
        "// Line_Reference 187: //                echo \"<br>\";",
        "// Line_Reference 188: //",
        "// Line_Reference 189: //                echo \"<br>\";",
        "// Line_Reference 215:                     echo '<td>';",
        "// Line_Reference 216:                     echo '<a href=\"DownloadWindow.php?down_id=' . $file_val['ID'] . '\">' . $fileIcon . ' &nbsp; '. str_replace(\"opensis_space_here\", \" \", $file_display) . '</a>';",
        "// Line_Reference 221:                         echo '<a href=Modules.php?modname=' . $_REQUEST[modname] . '&title=' . base64_encode($file_val['NAME']) . '&include=' . $_REQUEST['include'] . '&modfunc=delete&del=' . $file_val['ID'] . ' class=\"text-danger\"><i class=\"icon-cross2\"></i> Delete</a>",
        "// Line_Reference 229: //        $dir->close();",
        "// Line_Reference 233:             echo '<span class=\"text-danger\">'._noFilesFound.'.</span>';"
    ]
}
