{
    "cve_id": "CVE-2022-25299",
    "cve_description": "This affects the package cesanta/mongoose before 7.6. The unsafe handling of file names during upload using mg_http_upload() method may enable attackers to write files to arbitrary locations outside the designated target folder.",
    "cve_publish_date": "2022-02-18",
    "cwe_id": "CWE-552",
    "cwe_name": "Files or Directories Accessible to External Parties",
    "cwe_description": "The product makes files or directories accessible to unauthorized actors, even though they should not be.",
    "commit_message": "Protect against the directory traversal in mg_upload()",
    "type_of_change": "Modification",
    "filename_of_changes": "http.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "28",
    "number_of_lines_deleted_vulnerable_to_cve": "28",
    "vulnerable_lines": [
        "// Line_Reference 381: #if MG_ENABLE_FILE",
        "// Line_Reference 382: int mg_http_upload(struct mg_connection *c, struct mg_http_message *hm,",
        "// Line_Reference 383:                    const char *dir) {",
        "// Line_Reference 384:   char offset[40] = \"\", name[200] = \"\", path[256];",
        "// Line_Reference 385:   mg_http_get_var(&hm->query, \"offset\", offset, sizeof(offset));",
        "// Line_Reference 386:   mg_http_get_var(&hm->query, \"name\", name, sizeof(name));",
        "// Line_Reference 387:   if (name[0] == '\\0') {",
        "// Line_Reference 388:     mg_http_reply(c, 400, \"\", \"%s\", \"name required\");",
        "// Line_Reference 389:     return -1;",
        "// Line_Reference 390:   } else {",
        "// Line_Reference 391:     FILE *fp;",
        "// Line_Reference 392:     size_t oft = strtoul(offset, NULL, 0);",
        "// Line_Reference 393:     snprintf(path, sizeof(path), \"%s%c%s\", dir, MG_DIRSEP, name);",
        "// Line_Reference 394:     LOG(LL_DEBUG,",
        "// Line_Reference 395:         (\"%p %d bytes @ %d [%s]\", c->fd, (int) hm->body.len, (int) oft, name));",
        "// Line_Reference 396:     if ((fp = fopen(path, oft == 0 ? \"wb\" : \"ab\")) == NULL) {",
        "// Line_Reference 397:       mg_http_reply(c, 400, \"\", \"fopen(%s): %d\", name, errno);",
        "// Line_Reference 398:       return -2;",
        "// Line_Reference 399:     } else {",
        "// Line_Reference 400:       fwrite(hm->body.ptr, 1, hm->body.len, fp);",
        "// Line_Reference 401:       fclose(fp);",
        "// Line_Reference 402:       mg_http_reply(c, 200, \"\", \"\");",
        "// Line_Reference 403:       return (int) hm->body.len;",
        "// Line_Reference 404:     }",
        "// Line_Reference 405:   }",
        "// Line_Reference 406: }",
        "// Line_Reference 407: #endif",
        "// Line_Reference 408: "
    ]
}
