while (msg_len > 0) {