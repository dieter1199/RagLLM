from ._user import DuplicateSSHKeyError, UserObject  # noqa
def exists(column):
table_name = column.table.fullname
column_name = column.name
if 'SQLite' in connection.engine.dialect.__class__.__name__:
sql = "SELECT COUNT(*) FROM pragma_table_info('%s') WHERE LOWER(name)=LOWER('%s')" % (
table_name,
column_name,
)
else:
sql = "SELECT COUNT(*) FROM information_schema.columns WHERE table_name='%s' and column_name='%s'" % (
table_name,
column_name,
)
data = connection.engine.execute(sql).first()
return data[0] >= 1
def add_column(column):
if exists(column):
return
table_name = column.table.fullname
column_name = column.name
column_type = column.type.compile(connection.engine.dialect)
connection.engine.execute('ALTER TABLE %s ADD COLUMN %s %s' % (table_name, column_name, column_type))
add_column(RepoObject.__table__.c.Encoding)
add_column(RepoObject.__table__.c.keepdays)
if not exists(UserObject.__table__.c.role):
add_column(UserObject.__table__.c.role)
add_column(UserObject.__table__.c.fullname)
add_column(UserObject.__table__.c.mfa)
if not exists(SessionObject.__table__.c.Number):
