for (i = 0; i < hdr->n_segments && cursor < end; i++) {