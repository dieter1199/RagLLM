{
    "cve_id": "CVE-2022-25139",
    "cve_description": "njs through 0.7.0, used in NGINX, was discovered to contain a heap use-after-free in njs_await_fulfilled.",
    "cve_publish_date": "2022-02-14",
    "cwe_id": "CWE-416",
    "cwe_name": "Use After Free",
    "cwe_description": "The product reuses or references memory after it has been freed. At some point afterward, the memory may be allocated again and saved in another pointer, while the original pointer references a location somewhere within the new allocation. Any operations using the original pointer are no longer valid because the memory \"belongs\" to the code that operates on the new pointer.",
    "commit_message": "Fixed recursive async function calls.\n\nPreviously, PromiseCapability record was stored (function->context)\ndirectly in function object during a function invocation.  This is\nnot correct, because PromiseCapability record should be linked to\ncurrent execution context.  As a result, function->context is\noverwritten with consecutive recursive calls which results in\nuse-after-free.\n\nThis closes #451 issue on Github.",
    "type_of_change": "Modification",
    "filename_of_changes": "njs_async.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "2",
    "number_of_lines_deleted_vulnerable_to_cve": "13",
    "vulnerable_lines": [
        "// Line_Reference 32:     frame->function->context = capability;",
        "// Line_Reference 33: ",
        "// Line_Reference 34:     ret = njs_function_lambda_call(vm);",
        "// Line_Reference 66:     njs_function_t      *function;",
        "// Line_Reference 81:     function = async->function;",
        "// Line_Reference 82: ",
        "// Line_Reference 101:     function->context = ctx->capability;",
        "// Line_Reference 102:     function->await = ctx;",
        "// Line_Reference 103: ",
        "// Line_Reference 104:     ret = njs_vmcode_interpreter(vm, ctx->pc);",
        "// Line_Reference 105: ",
        "// Line_Reference 106:     function->context = NULL;",
        "// Line_Reference 107:     function->await = NULL;"
    ]
}
