{
    "cve_id": "CVE-2017-15054",
    "cve_description": "An arbitrary file upload vulnerability, present in TeamPass before 2.1.27.9, allows remote authenticated users to upload arbitrary files leading to Remote Command Execution. To exploit this vulnerability, an authenticated attacker has to tamper with parameters of a request to upload.files.php, in order to select the correct branch and be able to upload any arbitrary file. From there, it can simply access the file to execute code on the server.",
    "cve_publish_date": "2017-11-27",
    "cwe_id": "CWE-434",
    "cwe_name": "Unrestricted Upload of File with Dangerous Type",
    "cwe_description": "The product allows the upload or transfer of dangerous file types that are automatically processed within its environment.",
    "commit_message": "2.1.27\n\nImproved security regarding uploading files\nFixed issue while restoring DB from administration page",
    "type_of_change": "Modification",
    "filename_of_changes": "upload.files.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "92",
    "number_of_lines_deleted_vulnerable_to_cve": "29",
    "vulnerable_lines": [
        "// Line_Reference 76:                 ),",
        "// Line_Reference 318:     $newFileName = time().\"_\".$_SESSION['user_id'];",
        "// Line_Reference 321:         $targetDir.DIRECTORY_SEPARATOR.$newFileName",
        "// Line_Reference 326:     $newFileName = time().\"_\".$_SESSION['user_id'];",
        "// Line_Reference 329:         $targetDir.DIRECTORY_SEPARATOR.$newFileName",
        "// Line_Reference 334:     // sanitize the new file name",
        "// Line_Reference 335:     $newFileName = preg_replace('/[^\\w\\._]+/', '_', htmlentities($post_newFileName, ENT_QUOTES));",
        "// Line_Reference 336:     $newFileName = preg_replace('/[^'.$valid_chars_regex.'\\.]/', '', strtolower(basename($newFileName)));",
        "// Line_Reference 337: ",
        "// Line_Reference 354:     //Connect to mysql server",
        "// Line_Reference 355:     require_once '../../includes/config/settings.php';",
        "// Line_Reference 356:     require_once $SETTINGS['cpassman_dir'].'/includes/libraries/Database/Meekrodb/db.class.php';",
        "// Line_Reference 357:     $pass = defuse_return_decrypted($pass);",
        "// Line_Reference 358: DB::$host = $server;",
        "// Line_Reference 359:     DB::$user = $user;",
        "// Line_Reference 360:     DB::$password = $pass;",
        "// Line_Reference 361:     DB::$dbName = $database;",
        "// Line_Reference 362:     DB::$port = $port;",
        "// Line_Reference 363:     DB::$encoding = $encoding;",
        "// Line_Reference 364:     DB::$error_handler = true;",
        "// Line_Reference 365:     $link = mysqli_connect($server, $user, $pass, $database, $port);",
        "// Line_Reference 366:     $link->set_charset($encoding);",
        "// Line_Reference 367: ",
        "// Line_Reference 385:     echo '{\"filename\" : \"'.htmlentities($_SESSION['user_avatar'], ENT_QUOTES).'\" , \"filename_thumb\" : \"'.htmlentities($_SESSION['user_avatar_thumb'], ENT_QUOTES).'\"}';",
        "// Line_Reference 387: } else {",
        "// Line_Reference 388:     $newFileName = time().\"_\".$_SESSION['user_id'];",
        "// Line_Reference 391:         $targetDir.DIRECTORY_SEPARATOR.$newFileName",
        "// Line_Reference 395: // Return JSON-RPC response",
        "// Line_Reference 396: die('{\"jsonrpc\" : \"2.0\", \"result\" : null, \"id\" : \"id\" , \"newfilename\" : \"'.$newFileName.'\"}');"
    ]
}
