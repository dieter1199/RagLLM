{
    "cve_id": "CVE-2022-28055",
    "cve_description": "Fusionpbx v4.4 and below contains a command injection vulnerability via the download email logs function.",
    "cve_publish_date": "2022-05-04",
    "cwe_id": "CWE-78",
    "cwe_name": "Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')",
    "cwe_description": "The product constructs all or part of an OS command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended OS command when it is sent to a downstream component.",
    "commit_message": "Remove email_logs download. (#6331)\n\n* Remove email_logs download.\r\n\r\nThis feature has a security risk that is being eliminated by removing the download feature.\r\n\r\n* Update email_logs.php",
    "type_of_change": "Modification",
    "filename_of_changes": "email_logs.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "1",
    "number_of_lines_deleted_vulnerable_to_cve": "123",
    "vulnerable_lines": [
        "// Line_Reference 201: \t\t/**",
        "// Line_Reference 202: \t\t * download records",
        "// Line_Reference 203: \t\t */",
        "// Line_Reference 204: \t\tpublic function download($records) {",
        "// Line_Reference 205: \t\t\tif (permission_exists($this->permission_prefix.'download')) {",
        "// Line_Reference 206: ",
        "// Line_Reference 207: \t\t\t\t//add multi-lingual support",
        "// Line_Reference 208: \t\t\t\t\t$language = new text;",
        "// Line_Reference 209: \t\t\t\t\t$text = $language->get();",
        "// Line_Reference 210: ",
        "// Line_Reference 211: \t\t\t\t//validate the token",
        "// Line_Reference 212: \t\t\t\t\t$token = new token;",
        "// Line_Reference 213: \t\t\t\t\tif (!$token->validate('/app/email_logs/email_logs.php')) {",
        "// Line_Reference 214: \t\t\t\t\t\tmessage::add($text['message-invalid_token'],'negative');",
        "// Line_Reference 215: \t\t\t\t\t\theader('Location: '.$this->list_page);",
        "// Line_Reference 216: \t\t\t\t\t\texit;",
        "// Line_Reference 217: \t\t\t\t\t}",
        "// Line_Reference 218: ",
        "// Line_Reference 219: \t\t\t\t//download multiple records (eventually zip individual emails together)",
        "// Line_Reference 220: \t\t\t\t\tif (is_array($records) && @sizeof($records) != 0) {",
        "// Line_Reference 221: ",
        "// Line_Reference 222: \t\t\t\t\t\t//retrieve checked records",
        "// Line_Reference 223: \t\t\t\t\t\t\tforeach($records as $x => $record) {",
        "// Line_Reference 224: \t\t\t\t\t\t\t\tif ($record['checked'] == 'true' && is_uuid($record['uuid'])) {",
        "// Line_Reference 225: \t\t\t\t\t\t\t\t\t$uuids[] = $record['uuid'];",
        "// Line_Reference 226: \t\t\t\t\t\t\t\t}",
        "// Line_Reference 227: \t\t\t\t\t\t\t}",
        "// Line_Reference 228: ",
        "// Line_Reference 229: \t\t\t\t\t\t//download emails",
        "// Line_Reference 230: \t\t\t\t\t\t\tif (is_array($uuids) && @sizeof($uuids) != 0) {",
        "// Line_Reference 231: \t\t\t\t\t\t\t\tforeach ($uuids as $x => $uuid) {",
        "// Line_Reference 232: ",
        "// Line_Reference 233: \t\t\t\t\t\t\t\t\t//get email details",
        "// Line_Reference 234: \t\t\t\t\t\t\t\t\t\t$sql = \"select call_uuid, sent_date, type, email from v_email_logs \";",
        "// Line_Reference 235: \t\t\t\t\t\t\t\t\t\t$sql .= \"where email_log_uuid = :email_log_uuid \";",
        "// Line_Reference 236: \t\t\t\t\t\t\t\t\t\t$parameters['email_log_uuid'] = $uuid;",
        "// Line_Reference 237: \t\t\t\t\t\t\t\t\t\t$database = new database;",
        "// Line_Reference 238: \t\t\t\t\t\t\t\t\t\t$row = $database->select($sql, $parameters, 'row');",
        "// Line_Reference 239: \t\t\t\t\t\t\t\t\t\tif (is_array($row) && @sizeof($row) != 0 && is_uuid($row['call_uuid'])) {",
        "// Line_Reference 240: ",
        "// Line_Reference 241: \t\t\t\t\t\t\t\t\t\t\t//santize filename components",
        "// Line_Reference 242: \t\t\t\t\t\t\t\t\t\t\t\t$sent_date = str_replace('-','', $row['sent_date']);",
        "// Line_Reference 243: \t\t\t\t\t\t\t\t\t\t\t\t$sent_date = str_replace(':','', $sent_date);",
        "// Line_Reference 244: \t\t\t\t\t\t\t\t\t\t\t\t$sent_date = str_replace(' ','_', $sent_date);",
        "// Line_Reference 245: \t\t\t\t\t\t\t\t\t\t\t\t$type = strtolower($row['type']);",
        "// Line_Reference 246: \t\t\t\t\t\t\t\t\t\t\t\t$email_filename = $sent_date.'_'.$type.'_'.$row['call_uuid'].'.eml';",
        "// Line_Reference 247: ",
        "// Line_Reference 248: \t\t\t\t\t\t\t\t\t\t\t//single email",
        "// Line_Reference 249: \t\t\t\t\t\t\t\t\t\t\t\tif (@sizeof($uuids) == 1) {",
        "// Line_Reference 250: ",
        "// Line_Reference 251: \t\t\t\t\t\t\t\t\t\t\t\t\t//set headers",
        "// Line_Reference 252: \t\t\t\t\t\t\t\t\t\t\t\t\t\theader(\"Content-Type: message/rfc822\");",
        "// Line_Reference 253: \t\t\t\t\t\t\t\t\t\t\t\t\t\theader('Content-Disposition: attachment; filename=\"'.$email_filename.'\"');",
        "// Line_Reference 254: \t\t\t\t\t\t\t\t\t\t\t\t\t\theader(\"Cache-Control: no-cache, must-revalidate\"); // HTTP/1.1",
        "// Line_Reference 255: \t\t\t\t\t\t\t\t\t\t\t\t\t\theader(\"Expires: Sat, 26 Jul 1997 05:00:00 GMT\"); // Date in the past",
        "// Line_Reference 256: \t\t\t\t\t\t\t\t\t\t\t\t\t\theader(\"Content-Length: \".strlen($row['email']));",
        "// Line_Reference 257: ",
        "// Line_Reference 258: \t\t\t\t\t\t\t\t\t\t\t\t\t//output content",
        "// Line_Reference 259: \t\t\t\t\t\t\t\t\t\t\t\t\t\techo $row['email'];",
        "// Line_Reference 260: \t\t\t\t\t\t\t\t\t\t\t\t\t\texit;",
        "// Line_Reference 261: \t\t\t\t\t\t\t\t\t\t\t\t}",
        "// Line_Reference 262: ",
        "// Line_Reference 263: \t\t\t\t\t\t\t\t\t\t\t//multiple emails",
        "// Line_Reference 264: \t\t\t\t\t\t\t\t\t\t\t\telse {",
        "// Line_Reference 265: \t\t\t\t\t\t\t\t\t\t\t\t\tif (is_dir($_SESSION['server']['temp']['dir'])) {",
        "// Line_Reference 266: ",
        "// Line_Reference 267: \t\t\t\t\t\t\t\t\t\t\t\t\t\tif (file_put_contents($_SESSION['server']['temp']['dir'].'/'.$email_filename, $row['email'])) {",
        "// Line_Reference 268: \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$email_files[] = $_SESSION['server']['temp']['dir'].'/'.$email_filename;",
        "// Line_Reference 269: \t\t\t\t\t\t\t\t\t\t\t\t\t\t}",
        "// Line_Reference 270: \t\t\t\t\t\t\t\t\t\t\t\t\t}",
        "// Line_Reference 271: \t\t\t\t\t\t\t\t\t\t\t\t}",
        "// Line_Reference 272: ",
        "// Line_Reference 273: \t\t\t\t\t\t\t\t\t\t}",
        "// Line_Reference 274: \t\t\t\t\t\t\t\t\t\tunset($sql, $parameters, $row);",
        "// Line_Reference 275: \t\t\t\t\t\t\t\t}",
        "// Line_Reference 276: ",
        "// Line_Reference 277: \t\t\t\t\t\t\t\t//download compressed file",
        "// Line_Reference 278: \t\t\t\t\t\t\t\tif (@sizeof($email_files) != 0) {",
        "// Line_Reference 279: ",
        "// Line_Reference 280: \t\t\t\t\t\t\t\t\t//define compressed file name",
        "// Line_Reference 281: \t\t\t\t\t\t\t\t\t\t$compressed_filename = 'emails_'.date('Ymd_His').'.zip';",
        "// Line_Reference 282: ",
        "// Line_Reference 283: \t\t\t\t\t\t\t\t\t//compress email files",
        "// Line_Reference 284: \t\t\t\t\t\t\t\t\t\t$command = 'zip -mj '.$_SESSION['server']['temp']['dir'].'/'.$compressed_filename.' '.implode(' ', $email_files).' 2>&1';",
        "// Line_Reference 285: \t\t\t\t\t\t\t\t\t\texec($command, $response, $restore_errlevel);",
        "// Line_Reference 286: \t\t\t\t\t\t\t\t\t\tunset($command);",
        "// Line_Reference 287: ",
        "// Line_Reference 288: \t\t\t\t\t\t\t\t\t//push download",
        "// Line_Reference 289: \t\t\t\t\t\t\t\t\t\tif (file_exists($_SESSION['server']['temp']['dir'].'/'.$compressed_filename)) {",
        "// Line_Reference 290: ",
        "// Line_Reference 291: \t\t\t\t\t\t\t\t\t\t\t//open file",
        "// Line_Reference 292: \t\t\t\t\t\t\t\t\t\t\t\tsession_cache_limiter('public');",
        "// Line_Reference 293: \t\t\t\t\t\t\t\t\t\t\t\t$fd = fopen($_SESSION['server']['temp']['dir'].'/'.$compressed_filename, 'rb');",
        "// Line_Reference 294: ",
        "// Line_Reference 295: \t\t\t\t\t\t\t\t\t\t\t//set headers",
        "// Line_Reference 296: \t\t\t\t\t\t\t\t\t\t\t\theader(\"Content-Type: application/zip\");",
        "// Line_Reference 297: \t\t\t\t\t\t\t\t\t\t\t\theader('Content-Disposition: attachment; filename=\"'.$compressed_filename.'\"');",
        "// Line_Reference 298: \t\t\t\t\t\t\t\t\t\t\t\theader(\"Cache-Control: no-cache, must-revalidate\"); // HTTP/1.1",
        "// Line_Reference 299: \t\t\t\t\t\t\t\t\t\t\t\theader(\"Expires: Sat, 26 Jul 1997 05:00:00 GMT\"); // Date in the past",
        "// Line_Reference 300: \t\t\t\t\t\t\t\t\t\t\t\theader(\"Content-Length: \".filesize($_SESSION['server']['temp']['dir'].'/'.$compressed_filename));",
        "// Line_Reference 301: ",
        "// Line_Reference 302: \t\t\t\t\t\t\t\t\t\t\t//output file content",
        "// Line_Reference 303: \t\t\t\t\t\t\t\t\t\t\t\tob_clean();",
        "// Line_Reference 304: \t\t\t\t\t\t\t\t\t\t\t\tfpassthru($fd);",
        "// Line_Reference 305: \t\t\t\t\t\t\t\t\t\t\t\tfclose($fd);",
        "// Line_Reference 306: ",
        "// Line_Reference 307: \t\t\t\t\t\t\t\t\t\t\t//remove compressed file",
        "// Line_Reference 308: \t\t\t\t\t\t\t\t\t\t\t\t@unlink($_SESSION['server']['temp']['dir'].'/'.$compressed_filename);",
        "// Line_Reference 309: \t\t\t\t\t\t\t\t\t\t\t\texit;",
        "// Line_Reference 310: ",
        "// Line_Reference 311: \t\t\t\t\t\t\t\t\t\t}",
        "// Line_Reference 312: ",
        "// Line_Reference 313: \t\t\t\t\t\t\t\t}",
        "// Line_Reference 314: ",
        "// Line_Reference 315: \t\t\t\t\t\t\t}",
        "// Line_Reference 316: ",
        "// Line_Reference 317: \t\t\t\t\t}",
        "// Line_Reference 318: ",
        "// Line_Reference 319: \t\t\t}",
        "// Line_Reference 320: ",
        "// Line_Reference 321: \t\t} //method",
        "// Line_Reference 322: ",
        "// Line_Reference 326: ?>"
    ]
}
