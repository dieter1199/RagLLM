{
    "cve_id": "CVE-2022-0157",
    "cve_description": "phoronix-test-suite is vulnerable to Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "cve_publish_date": "2022-01-10",
    "cwe_id": "CWE-79",
    "cwe_name": "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "cwe_description": "The product does not neutralize or incorrectly neutralizes user-controllable input before it is placed in output that is used as a web page that is served to other users.",
    "commit_message": "phodevi: Input sanitization updates for Phoromatic Server\n\nAlso other code formatting / cleanups while reviewing the code...",
    "type_of_change": "Modification",
    "filename_of_changes": "phoromatic_testing.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "78",
    "number_of_lines_deleted_vulnerable_to_cve": "82",
    "vulnerable_lines": [
        "// Line_Reference 6: \tCopyright (C) 2016, Phoronix Media",
        "// Line_Reference 7: \tCopyright (C) 2016, Michael Larabel",
        "// Line_Reference 23: ",
        "// Line_Reference 46: \t\t\tif(!PHOROMATIC_USER_IS_VIEWER)",
        "// Line_Reference 48: \t\t\t\t$main .= '",
        "// Line_Reference 49: \t\t\t\t<hr />",
        "// Line_Reference 50: \t\t\t\t<h2>Create A Schedule</h2>",
        "// Line_Reference 51: \t\t\t\t<p><a href=\"?sched\">Create a schedule</a> followed by adding tests/suites to run for that schedule on the selected systems.</p>';",
        "// Line_Reference 54: \t\t\t$main .= '<hr /><h2>Current Schedules</h2>';",
        "// Line_Reference 57: \t\t\t\t\t<ul>",
        "// Line_Reference 58: \t\t\t\t\t\t<li><h1>Active Test Schedules</h1></li>';",
        "// Line_Reference 59: ",
        "// Line_Reference 60: \t\t\t\t\t$stmt = phoromatic_server::$db->prepare('SELECT Title, ScheduleID, Description, RunTargetSystems, RunTargetGroups, RunAt, ActiveOn FROM phoromatic_schedules WHERE AccountID = :account_id AND State >= 1 ORDER BY Title ASC');",
        "// Line_Reference 61: \t\t\t\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);",
        "// Line_Reference 62: \t\t\t\t\t$result = $stmt->execute();",
        "// Line_Reference 63: \t\t\t\t\t$row = $result->fetchArray();",
        "// Line_Reference 64: ",
        "// Line_Reference 65: \t\t\t\t\tif($row == false)",
        "// Line_Reference 66: \t\t\t\t\t{",
        "// Line_Reference 67: \t\t\t\t\t\t$main .= '<li class=\"light\" style=\"text-align: center;\">No Schedules Found</li>';",
        "// Line_Reference 68: \t\t\t\t\t}",
        "// Line_Reference 69: \t\t\t\t\telse",
        "// Line_Reference 70: \t\t\t\t\t{",
        "// Line_Reference 71: \t\t\t\t\t\tdo",
        "// Line_Reference 72: \t\t\t\t\t\t{",
        "// Line_Reference 73: \t\t\t\t\t\t\t$stmt_tests = phoromatic_server::$db->prepare('SELECT COUNT(*) AS TestCount FROM phoromatic_schedules_tests WHERE AccountID = :account_id AND ScheduleID = :schedule_id ORDER BY TestProfile ASC');",
        "// Line_Reference 74: \t\t\t\t\t\t\t$stmt_tests->bindValue(':account_id', $_SESSION['AccountID']);",
        "// Line_Reference 75: \t\t\t\t\t\t\t$stmt_tests->bindValue(':schedule_id', $row['ScheduleID']);",
        "// Line_Reference 76: \t\t\t\t\t\t\t$result_tests = $stmt_tests->execute();",
        "// Line_Reference 77: \t\t\t\t\t\t\t$row_tests = $result_tests->fetchArray();",
        "// Line_Reference 78: \t\t\t\t\t\t\t$test_count = !empty($row_tests) ? $row_tests['TestCount'] : 0;",
        "// Line_Reference 79: ",
        "// Line_Reference 80: \t\t\t\t\t\t\t$group_count = empty($row['RunTargetGroups']) ? 0 : count(explode(',', $row['RunTargetGroups']));",
        "// Line_Reference 81: \t\t\t\t\t\t\t$main .= '<a href=\"?schedules/' . $row['ScheduleID'] . '\"><li>' . $row['Title'] . '<br /><table><tr><td>' . pts_strings::plural_handler(count(phoromatic_server::systems_associated_with_schedule($_SESSION['AccountID'], $row['ScheduleID'])), 'System') . '</td><td>' . pts_strings::plural_handler($group_count, 'Group') . '</td><td>' . pts_strings::plural_handler($test_count, 'Test') . '</td><td>' . pts_strings::plural_handler(phoromatic_results_for_schedule($row['ScheduleID']), 'Result') . ' Total</td><td>' . pts_strings::plural_handler(phoromatic_results_for_schedule($row['ScheduleID'], 'TODAY'), 'Result') . ' Today</td><td><strong>' . phoromatic_schedule_activeon_string($row['ActiveOn'], $row['RunAt']) . '</strong></td></tr></table></li></a>';",
        "// Line_Reference 82: \t\t\t\t\t\t}",
        "// Line_Reference 83: \t\t\t\t\t\twhile($row = $result->fetchArray());",
        "// Line_Reference 84: \t\t\t\t\t}",
        "// Line_Reference 85: ",
        "// Line_Reference 86: ",
        "// Line_Reference 87: \t\t\t$main .= '</ul>",
        "// Line_Reference 88: \t\t\t</div>';",
        "// Line_Reference 89: ",
        "// Line_Reference 90: \t\t\t$stmt = phoromatic_server::$db->prepare('SELECT * FROM phoromatic_benchmark_tickets WHERE AccountID = :account_id AND State >= 0 AND TicketIssueTime > :time_cutoff ORDER BY TicketIssueTime DESC LIMIT 30');",
        "// Line_Reference 91: \t\t\t$stmt->bindValue(':account_id', $_SESSION['AccountID']);",
        "// Line_Reference 92: \t\t\t$stmt->bindValue(':time_cutoff', (time() - (60 * 60 * 24 * 14)));",
        "// Line_Reference 93: \t\t\t$result = $stmt->execute();",
        "// Line_Reference 94: \t\t\t$right = '<ul><li>Benchmark Tickets</li>';",
        "// Line_Reference 95: ",
        "// Line_Reference 96: \t\t\tif($result)",
        "// Line_Reference 97: \t\t\t{",
        "// Line_Reference 98: \t\t\t\t$main .= '<div class=\"pts_phoromatic_info_box_area\">",
        "// Line_Reference 99: \t\t\t\t\t\t<ul>",
        "// Line_Reference 100: \t\t\t\t\t\t\t<li><h1>Active Benchmark Tickets</h1></li>';",
        "// Line_Reference 102: \t\t\t\t$row = $result->fetchArray();",
        "// Line_Reference 104: \t\t\t\tif(!empty($row))",
        "// Line_Reference 105: \t\t\t\t{",
        "// Line_Reference 106: \t\t\t\t\tdo",
        "// Line_Reference 107: \t\t\t\t\t{",
        "// Line_Reference 108: \t\t\t\t\t\t$main .= '<a href=\"?benchmark/' . $row['TicketID'] . '\"><li>' . $row['Title'] . '</li></a>';",
        "// Line_Reference 109: \t\t\t\t\t}",
        "// Line_Reference 110: \t\t\t\t\twhile($row = $result->fetchArray());",
        "// Line_Reference 111: \t\t\t\t}",
        "// Line_Reference 112: \t\t\t\telse",
        "// Line_Reference 114: \t\t\t\t\t$main .= '<li class=\"light\" style=\"text-align: center;\">No Tickets Found</li>';",
        "// Line_Reference 117: \t\t\t$main .= '</ul>",
        "// Line_Reference 118: \t\t\t</div>';",
        "// Line_Reference 119: ",
        "// Line_Reference 120: \t\t\tif(!PHOROMATIC_USER_IS_VIEWER)",
        "// Line_Reference 122: \t\t\t\t$main .= '",
        "// Line_Reference 123: \t\t\t\t<hr />",
        "// Line_Reference 124: \t\t\t\t<h2>Run A Benchmark</h2>",
        "// Line_Reference 125: \t\t\t\t<p><a href=\"?benchmark\">Run a benchmark</a> is the area where you can run a one-time benchmark on selected system(s) and is also where to go for setting up a stress-run benchmark.</p>",
        "// Line_Reference 126: \t\t\t\t<hr />",
        "// Line_Reference 127: \t\t\t\t<h2>Create A Suite</h2>",
        "// Line_Reference 128: \t\t\t\t<p><a href=\"?build_suite\">Build a suite</a>, which is a collection of predefined test profiles.</p>",
        "// Line_Reference 129: \t\t\t\t<hr />",
        "// Line_Reference 130: \t\t\t\t<h2>View Local Suites</h2>",
        "// Line_Reference 131: \t\t\t\t<p><a href=\"?local_suites\">See local suites</a> available for your benchmarking needs.</p>';",
        "// Line_Reference 133: ",
        "// Line_Reference 134: ",
        "// Line_Reference 135: \t\t\techo '<div id=\"pts_phoromatic_main_area\">' . $main . '</div>';",
        "// Line_Reference 136: \t\t\techo phoromatic_webui_footer();"
    ]
}
