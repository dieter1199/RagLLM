{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "AllowEditFnc.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "135",
    "number_of_lines_deleted_vulnerable_to_cve": "163",
    "vulnerable_lines": [
        "// Line_Reference 28: function AllowEdit($modname=false)",
        "// Line_Reference 29: {\tglobal $_openSIS;",
        "// Line_Reference 30: \tif(!$modname)",
        "// Line_Reference 31: \t\t$modname = $_REQUEST['modname'];",
        "// Line_Reference 32: ",
        "// Line_Reference 33: \tif($modname=='students/Student.php' && $_REQUEST['category_id'])",
        "// Line_Reference 34: \t\t$modname = $modname.'&category_id='.$_REQUEST['category_id'];",
        "// Line_Reference 35:         if($modname=='users/Staff.php' && $_REQUEST['category_id'])",
        "// Line_Reference 36: \t\t$modname = $modname.'&category_id='.$_REQUEST['category_id'];",
        "// Line_Reference 37: ",
        "// Line_Reference 38: ",
        "// Line_Reference 39: \tif(User('PROFILE')=='admin')",
        "// Line_Reference 40: \t{",
        "// Line_Reference 41: ",
        "// Line_Reference 42: \t\tif(!$_openSIS['AllowEdit'])",
        "// Line_Reference 43: \t\t{",
        "// Line_Reference 44: ",
        "// Line_Reference 45: \t\t\tif(User('PROFILE_ID')!='')",
        "// Line_Reference 46:                         {",
        "// Line_Reference 47: \t\t\t\t$_openSIS['AllowEdit'] = DBGet(DBQuery('SELECT MODNAME FROM profile_exceptions WHERE PROFILE_ID=\\''.User('PROFILE_ID').'\\' AND CAN_EDIT=\\'Y\\''),array(),array('MODNAME'));",
        "// Line_Reference 48:                         }",
        "// Line_Reference 49:                         else",
        "// Line_Reference 50:                         {",
        "// Line_Reference 51:                         $profile_id_mod=DBGet(DBQuery(\"SELECT PROFILE_ID FROM staff WHERE USER_ID='\".User('STAFF_ID')));",
        "// Line_Reference 52: \t\t\t$profile_id_mod=$profile_id_mod[1]['PROFILE_ID'];",
        "// Line_Reference 53:                         if($profile_id_mod!='')",
        "// Line_Reference 54:                         $_openSIS['AllowEdit'] = DBGet(DBQuery('SELECT MODNAME FROM profile_exceptions WHERE PROFILE_ID=\\''.$profile_id_mod.'\\' AND CAN_EDIT=\\'Y\\''),array(),array('MODNAME'));",
        "// Line_Reference 55:                         }",
        "// Line_Reference 56: ",
        "// Line_Reference 57: \t\t}",
        "// Line_Reference 58: \t\tif(!$_openSIS['AllowEdit'])",
        "// Line_Reference 59: \t\t\t$_openSIS['AllowEdit'] = array(true);",
        "// Line_Reference 60: ",
        "// Line_Reference 61: \t\tif(count($_openSIS['AllowEdit'][$modname]))",
        "// Line_Reference 62: \t\t\treturn true;",
        "// Line_Reference 63: \t\telse",
        "// Line_Reference 64: \t\t\treturn false;",
        "// Line_Reference 65: \t}",
        "// Line_Reference 66: \telse",
        "// Line_Reference 67:         {",
        "// Line_Reference 68:                 if(User('PROFILE_ID')==3 || User('PROFILE_ID')==4)",
        "// Line_Reference 69:                 {",
        "// Line_Reference 70:                    if($modname=='attendance/StudentSummary.php')",
        "// Line_Reference 71:                         return true;",
        "// Line_Reference 72:                     elseif($modname=='schoolsetup/Calendar.php')",
        "// Line_Reference 73:                         return true;",
        "// Line_Reference 74:                     elseif($modname=='attendance/DailySummary.php')",
        "// Line_Reference 75:                         return true;",
        "// Line_Reference 76:                     elseif($modname=='scheduling/ViewSchedule.php')",
        "// Line_Reference 77:                         return true;",
        "// Line_Reference 78:                    elseif($modname=='messaging/Group.php')",
        "// Line_Reference 79:                         return true;",
        "// Line_Reference 80:                     else",
        "// Line_Reference 81:                         return $_openSIS['allow_edit'];",
        "// Line_Reference 83:                 elseif(User('PROFILE')=='teacher')",
        "// Line_Reference 84:                 {",
        "// Line_Reference 85:                     if(User('PROFILE_ID')!='')",
        "// Line_Reference 86: \t\t\t\t$_openSIS['AllowEdit'] = DBGet(DBQuery('SELECT MODNAME FROM profile_exceptions WHERE PROFILE_ID=\\''.User('PROFILE_ID').'\\' AND CAN_EDIT=\\'Y\\''),array(),array('MODNAME'));",
        "// Line_Reference 87: ",
        "// Line_Reference 88:                     if($modname=='attendance/StudentSummary.php')",
        "// Line_Reference 89:                         return true;",
        "// Line_Reference 90: ",
        "// Line_Reference 91:                      elseif($modname=='scheduling/ViewSchedule.php')",
        "// Line_Reference 92:                       return true;",
        "// Line_Reference 93:                     elseif($modname=='attendance/DailySummary.php')",
        "// Line_Reference 94:                         return true;",
        "// Line_Reference 95:                     elseif($modname=='schoolsetup/Calendar.php')",
        "// Line_Reference 96:                         return true;",
        "// Line_Reference 97:                     elseif($modname=='scheduling/PrintSchedules.php')",
        "// Line_Reference 98:                         return true;",
        "// Line_Reference 99:                     elseif($modname=='messaging/Group.php')",
        "// Line_Reference 100:                         return true;",
        "// Line_Reference 101:                     elseif($modname=='grades/Assignments.php')",
        "// Line_Reference 102:                         return true;",
        "// Line_Reference 103:                     elseif($modname=='grades/Grades.php')",
        "// Line_Reference 105:                     elseif($modname=='grades/InputFinalGrades.php')",
        "// Line_Reference 106:                     {",
        "// Line_Reference 107:                         $grade_post_date= DBGet(DBQuery('SELECT POST_START_DATE, POST_END_DATE FROM marking_periods WHERE SCHOOL_ID='. UserSchool().' AND SYEAR='. UserSyear().' AND MARKING_PERIOD_ID='. UserMP()));",
        "// Line_Reference 108:                         if($grade_post_date[1]['POST_START_DATE']!='' && $grade_post_date[1]['POST_END_DATE']!='')",
        "// Line_Reference 109:                         {",
        "// Line_Reference 110:                             if(date('Y-m-d') >= $grade_post_date[1]['POST_START_DATE'] && date('Y-m-d') <= $grade_post_date[1]['POST_END_DATE'])",
        "// Line_Reference 111:                                 return true;",
        "// Line_Reference 112:                             else",
        "// Line_Reference 113:                                  return false;",
        "// Line_Reference 114:                         }",
        "// Line_Reference 115:                         else",
        "// Line_Reference 116:                             return false;",
        "// Line_Reference 117:                     }",
        "// Line_Reference 118:                        elseif($modname== 'attendance/TakeAttendance.php')",
        "// Line_Reference 119:                          return true;",
        "// Line_Reference 120:                      elseif($modname== 'attendance/StudentSummary.php')",
        "// Line_Reference 121:                          return true;",
        "// Line_Reference 122:                       elseif($modname== 'users/TeacherPrograms.php?include=attendance/TakeAttendance.php')",
        "// Line_Reference 123:                          return true;",
        "// Line_Reference 125:                     {",
        "// Line_Reference 126:                         if(!$_openSIS['AllowEdit'])",
        "// Line_Reference 127: \t\t\t$_openSIS['AllowEdit'] = array(true);",
        "// Line_Reference 128: ",
        "// Line_Reference 129:                         if(count($_openSIS['AllowEdit'][$modname]))",
        "// Line_Reference 130:                                 return true;",
        "// Line_Reference 131:                         else",
        "// Line_Reference 132:                                 return false;",
        "// Line_Reference 133: //                        return $_openSIS['allow_edit'];",
        "// Line_Reference 134:                     }",
        "// Line_Reference 135:                 }",
        "// Line_Reference 137: \t\treturn $_openSIS['allow_edit'];",
        "// Line_Reference 138:         }",
        "// Line_Reference 141: function AllowUse($modname=false)",
        "// Line_Reference 142: {\tglobal $_openSIS;",
        "// Line_Reference 143: \tif(!$modname)",
        "// Line_Reference 144: \t\t$modname = $_REQUEST['modname'];",
        "// Line_Reference 145: ",
        "// Line_Reference 146: \tif($modname=='students/Student.php' && $_REQUEST['category_id'])",
        "// Line_Reference 147: \t\t$modname = $modname.'&category_id='.$_REQUEST['category_id'];",
        "// Line_Reference 148: ",
        "// Line_Reference 149: \tif(!$_openSIS['AllowUse'])",
        "// Line_Reference 150: \t{",
        "// Line_Reference 151: \t\tif(User('PROFILE_ID')!='')",
        "// Line_Reference 152:                 {",
        "// Line_Reference 153: \t\t\t$_openSIS['AllowUse'] = DBGet(DBQuery('SELECT MODNAME FROM profile_exceptions WHERE PROFILE_ID=\\''.User('PROFILE_ID').'\\' AND CAN_USE=\\'Y\\''),array(),array('MODNAME'));",
        "// Line_Reference 154: ",
        "// Line_Reference 155:                 if(User('PROFILE_ID')==4)",
        "// Line_Reference 156:                 {",
        "// Line_Reference 157:                  $_openSIS['AllowUse']['scheduling/PrintSchedules.php'] ['1'] ['MODNAME'] = 'scheduling/PrintSchedules.php';",
        "// Line_Reference 158:                 }",
        "// Line_Reference 159: ",
        "// Line_Reference 160:                 }",
        "// Line_Reference 161: \t\telse",
        "// Line_Reference 162:                 {",
        "// Line_Reference 163:                         $profile_id_mod=DBGet(DBQuery(\"SELECT PROFILE_ID FROM staff WHERE USER_ID='\".User('STAFF_ID')));",
        "// Line_Reference 164: \t\t\t$profile_id_mod=$profile_id_mod[1]['PROFILE_ID'];",
        "// Line_Reference 165: \t\t\t$_openSIS['AllowUse'] = DBGet(DBQuery('SELECT MODNAME FROM profile_exceptions WHERE PROFILE_ID=\\''.$profile_id_mod.'\\' AND CAN_USE=\\'Y\\''),array(),array('MODNAME'));",
        "// Line_Reference 166: ",
        "// Line_Reference 167:                 }",
        "// Line_Reference 168: ",
        "// Line_Reference 169: ",
        "// Line_Reference 170: \t}",
        "// Line_Reference 173: \tif(!$_openSIS['AllowUse'])",
        "// Line_Reference 174: \t\t$_openSIS['AllowUse'] = array(true);",
        "// Line_Reference 176: \tif(count($_openSIS['AllowUse'][$modname]))",
        "// Line_Reference 177: \t\treturn true;",
        "// Line_Reference 178: \telse",
        "// Line_Reference 179: \t\treturn false;",
        "// Line_Reference 182: function ProgramLink($modname,$title='',$options='')",
        "// Line_Reference 184: \tif(AllowUse($modname))",
        "// Line_Reference 185: \t\t$link = '<A HREF=Modules.php?modname='.$modname.$options.'>';",
        "// Line_Reference 186: \tif($title)",
        "// Line_Reference 187: \t\t$link .= $title;",
        "// Line_Reference 188: \tif(AllowUse($modname))",
        "// Line_Reference 189: \t\t$link .= '</A>';",
        "// Line_Reference 190: ",
        "// Line_Reference 191: \treturn $link;",
        "// Line_Reference 194: function ProgramLinkforExport($modname,$title='',$options='',$extra='')",
        "// Line_Reference 196: \tif(AllowUse($modname))",
        "// Line_Reference 197: \t\t$link = '<A HREF=ForExport.php?modname='.$modname.$options.' '.$extra.'>';",
        "// Line_Reference 198: \tif($title)",
        "// Line_Reference 199: \t\t$link .= $title;",
        "// Line_Reference 200: \tif(AllowUse($modname))",
        "// Line_Reference 201: \t\t$link .= '</A>';",
        "// Line_Reference 202: ",
        "// Line_Reference 203: \treturn $link;",
        "// Line_Reference 205: ",
        "// Line_Reference 206: ?>"
    ]
}
