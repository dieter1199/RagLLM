{
    "cve_id": "CVE-2021-27340",
    "cve_description": "OpenSIS Community Edition version <= 7.6 is affected by a reflected XSS vulnerability in EmailCheck.php via the \"opt\" parameter.",
    "cve_publish_date": "2021-09-16",
    "cwe_id": "CWE-79",
    "cwe_name": "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    "cwe_description": "The product does not neutralize or incorrectly neutralizes user-controllable input before it is placed in output that is used as a web page that is served to other users.",
    "commit_message": "Commit with security and bug fixes",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "Modules.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "109",
    "number_of_lines_deleted_vulnerable_to_cve": "96",
    "vulnerable_lines": [
        "// Line_Reference 123:     echo '<script type=\"text/javascript\" src=\"assets/js/plugins/media/cropper.min.js\"></script>';",
        "// Line_Reference 162: ",
        "// Line_Reference 169: echo '<div id=\"loading-image\"><i class=\"fa fa-cog fa-spin fa-lg fa-fw\"></i> ' . _loading . '...</div>';",
        "// Line_Reference 200: ",
        "// Line_Reference 211: ",
        "// Line_Reference 298:         } else {",
        "// Line_Reference 318:         } else {",
        "// Line_Reference 392: } ################## Porfile Not Teacher End ##########################################",
        "// Line_Reference 445:     //===================================================================================================",
        "// Line_Reference 449:     $RET_temp = DBGet($course);",
        "// Line_Reference 450:     $ret_increment = 1;",
        "// Line_Reference 451:     $RET = array();",
        "// Line_Reference 452:     foreach ($RET_temp as $ret_courses) {",
        "// Line_Reference 453:         $get_cps = DBGet(DBQuery(\"SELECT cpv.ID,cp.COURSE_PERIOD_ID,cp.MARKING_PERIOD_ID,cp.COURSE_ID,cp.TITLE,cp.SCHOOL_ID,cpv.PERIOD_ID FROM course_periods cp,course_period_var cpv WHERE cp.SYEAR='\" . UserSyear() . \"' AND cp.COURSE_PERIOD_ID=cpv.COURSE_PERIOD_ID AND cp.SCHOOL_ID='\" . UserSchool() . \"' AND cp.COURSE_ID='\" . $ret_courses['COURSE_ID'] . \"' AND (TEACHER_ID='\" . User('STAFF_ID') . \"' OR SECONDARY_TEACHER_ID='\" . User('STAFF_ID') . \"') AND (MARKING_PERIOD_ID IN (\" . GetAllMP($allMP, UserMP()) . \") OR (MARKING_PERIOD_ID IS NULL)) group by (cp.COURSE_PERIOD_ID)\"));",
        "// Line_Reference 454:         if (count($get_cps) > 0) {",
        "// Line_Reference 455:             $RET[$ret_increment] = $ret_courses;",
        "// Line_Reference 459: ",
        "// Line_Reference 472:     //===================================================================================================",
        "// Line_Reference 527: ",
        "// Line_Reference 528:     if (User('PROFILE') == 'student') {",
        "// Line_Reference 529:         $img_info = DBGet(DBQuery('SELECT * FROM user_file_upload WHERE USER_ID=' . UserStudentID() . ' AND PROFILE_ID=3 AND SCHOOL_ID=' . UserSchool() . ' AND SYEAR=' . UserSyear() . ' AND FILE_INFO=\\'stuimg\\''));",
        "// Line_Reference 530:         $img_info = $img_info[1]['CONTENT'];",
        "// Line_Reference 531:     } else {",
        "// Line_Reference 532:         $img_info = DBGet(DBQuery('SELECT * FROM staff WHERE STAFF_ID=' . UserID()));",
        "// Line_Reference 533:         $img_info = $img_info[1]['IMG_CONTENT'];",
        "// Line_Reference 535:     if ($img_info != '')",
        "// Line_Reference 536:         $user_picture = '<a href=\"javascript:void(0)\"><IMG src=\"data:image/jpeg;base64,' . base64_encode($img_info) . '\" class=\"img-circle img-responsive\"></a>';",
        "// Line_Reference 539:     // if (($StudentPicturesPath . UserStudentID() . '.JPG' || ($UserPicturesPath . UserID() . '.JPG'))) {",
        "// Line_Reference 540:     //     if (UserStudentID())",
        "// Line_Reference 541:     //         $picture_path = $StudentPicturesPath . UserStudentID() . '.JPG';",
        "// Line_Reference 542:     //     if (UserID())",
        "// Line_Reference 543:     //         $picture_path = $UserPicturesPath . UserID() . '.JPG';",
        "// Line_Reference 544:     //     if (file_exists($picture_path)) {",
        "// Line_Reference 545:     //         $user_picture = '<a href=\"javascript:void(0)\"><img src=\"' . $picture_path . '\"  alt=\"\" class=\"img-circle img-responsive\"></a>';",
        "// Line_Reference 546:     //     } else {",
        "// Line_Reference 547:     //         $user_picture = '<a href=\"javascript:void(0)\"><IMG SRC=\"assets/no_avtar.png\" class=\"img-circle img-responsive\"></a>';",
        "// Line_Reference 548:     //     }",
        "// Line_Reference 549:     // } else {",
        "// Line_Reference 550:     //     $user_picture = '<a href=\"javascript:void(0)\"><IMG SRC=\"assets/no_avtar.png\" class=\"img-circle img-responsive\"></a>';",
        "// Line_Reference 551:     // }",
        "// Line_Reference 563: ",
        "// Line_Reference 567: ",
        "// Line_Reference 608:                                             <a href=\"#user-nav\" data-toggle=\"collapse\"><span>' . _myAccount . '</span> <i class=\"caret\"></i></a>",
        "// Line_Reference 615:                                             <li><a href=\"javascript:void(0)\" onclick=\"check_content(\\'Ajax.php?modname=messaging/Inbox.php\\');\"><i class=\"icon-comment-discussion\"></i> <span>' . _messages . '</span></a></li>';",
        "// Line_Reference 616: if (User('PROFILE') != 'student')",
        "// Line_Reference 617:     echo '<li><a href=\"javascript:void(0)\" onclick=\"check_content(\\'Ajax.php?modname=users/Preferences.php\\');\"><i class=\"icon-equalizer\"></i> <span>' . _preferences . '</span></a></li>';",
        "// Line_Reference 619: echo '<li><a href=\"index.php?modfunc=logout\"><i class=\"icon-switch2\"></i> <span>' . _logout . '</span></a></li>",
        "// Line_Reference 654: echo \"<li><a href='#' onmouseup='check_content(\\\"Ajax.php?modname=miscellaneous/Portal.php\\\");' onmousedown='document.getElementById(\\\"header\\\").innerHTML = \\\"Home\\\";document.getElementById(\\\"cframe\\\").src = \\\"Bottom.php?modcat=home\\\"'><i class=\\\"icon-home4\\\"></i><span>\" . _home . \"</span></a></li>\";",
        "// Line_Reference 670:             echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\" . _schoolInfo . \"</span></a>\";",
        "// Line_Reference 672:             echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\" . _myInfo . \"</span></a>\";",
        "// Line_Reference 675:             echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\" . _myInfo . \"</span></a>\";",
        "// Line_Reference 677:             echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\" . _schedule . \"</span></a>\";",
        "// Line_Reference 679:             echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\" . _messaging . \"</span></a>\";",
        "// Line_Reference 683:                 echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\" . _extracurricular . \"</span></a>\";",
        "// Line_Reference 685:                 echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\" . _schoolSetup . \"</span></a>\";",
        "// Line_Reference 687:                 echo \"<li \" . (($current_mod == $modcat) ? 'class=\"active\"' : '') . \"><a HREF=javascript:void(0)><i class=\\\"{$menu_icons[$modcat]}\\\"></i><span>\" . ucfirst(str_replace('_', ' ', constant('_' . $modcat))) . \"</span></a>\";",
        "// Line_Reference 728:                                 echo \"<li  \" . (($current_menu == $title) ? 'class=\"current-submenu\"' : '') . \"><A id=hm HREF=javascript:void(0) onClick='check_content(\\\"Ajax.php?modname=\" . $file . \" \\\");'  onmousedown='$(\\\"#header\\\").html(\\\"\" . ($modcat == 'schoolsetup' ? schoolSetup : ucwords(constant($modcat))) . \" <i class=icon-arrow-right5></i> \" . $title . \"\\\");' onmouseup=\\\"$('#cframe').attr('src','Bottom.php?modname=\" . str_replace('&', '?', $file) . \"');\\\">$title</A>\";",
        "// Line_Reference 769:                 } elseif ($keys[$key_index + 1] && !is_numeric($keys[$key_index + 1])) {",
        "// Line_Reference 830:         $admin_COMMON_FROM .= \" ,student_mp_comments smc\";",
        "// Line_Reference 831:         $admin_COMMON_WHERE .= \" AND smc.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 836:         $admin_COMMON_FROM .= \" ,student_goal g \";",
        "// Line_Reference 837:         $admin_COMMON_WHERE .= \" AND g.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 842:         $admin_COMMON_FROM .= \" ,student_goal_progress p \";",
        "// Line_Reference 843:         $admin_COMMON_WHERE .= \" AND p.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 848:         $admin_COMMON_FROM .= \" ,student_medical_notes smn \";",
        "// Line_Reference 849:         $admin_COMMON_WHERE .= \" AND smn.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 855:         $admin_COMMON_FROM .= \" ,student_immunization sm \";",
        "// Line_Reference 856:         $admin_COMMON_WHERE .= \" AND sm.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 862:         $admin_COMMON_FROM .= \" ,student_medical_alerts sma  \";",
        "// Line_Reference 863:         $admin_COMMON_WHERE .= \" AND sma.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 868:         $admin_COMMON_FROM .= \" ,student_medical_visits smv   \";",
        "// Line_Reference 869:         $admin_COMMON_WHERE .= \" AND smv.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 884:         $teacher_COMMON_FROM .= \" ,student_mp_comments smc\";",
        "// Line_Reference 885:         $teacher_COMMON_WHERE .= \" AND smc.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 890:         $teacher_COMMON_FROM .= \" ,student_goal g \";",
        "// Line_Reference 891:         $teacher_COMMON_WHERE .= \" AND g.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 896:         $teacher_COMMON_FROM .= \" ,student_goal_progress p \";",
        "// Line_Reference 897:         $teacher_COMMON_WHERE .= \" AND p.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 902:         $teacher_COMMON_FROM .= \" ,student_medical_notes smn \";",
        "// Line_Reference 903:         $teacher_COMMON_WHERE .= \" AND smn.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 909:         $teacher_COMMON_FROM .= \" ,student_immunization sm \";",
        "// Line_Reference 910:         $teacher_COMMON_WHERE .= \" AND sm.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 915:         $teacher_COMMON_FROM .= \" ,student_medical_alerts sma  \";",
        "// Line_Reference 916:         $teacher_COMMON_WHERE .= \" AND sma.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 921:         $teacher_COMMON_FROM .= \" ,student_medical_visits smv   \";",
        "// Line_Reference 922:         $teacher_COMMON_WHERE .= \" AND smv.STUDENT_ID=s.STUDENT_ID \";",
        "// Line_Reference 986: ",
        "// Line_Reference 992:     if (!empty($check_backups)) {",
        "// Line_Reference 993:         foreach ($check_backups as $each_backups) {",
        "// Line_Reference 994:             $filename = $each_backups['TITLE'] . '.sql';",
        "// Line_Reference 996:             if (file_exists($filename)) {",
        "// Line_Reference 999:                 DBQuery(\"DELETE FROM `program_config` WHERE `program` = 'DB_BACKUP' AND `value` = '\" . $each_backups['VALUE'] . \"'\");",
        "// Line_Reference 1005: ",
        "// Line_Reference 1034:     } else {",
        "// Line_Reference 1036:             echo \"\" . _youReNotAllowedToUseThisProgram . \"! \" . _thisAttemptedViolationHasBeenLoggedAndYourIpAddressWasCaptured . \".\";",
        "// Line_Reference 1116:                             ' . _footerText . '"
    ]
}
