{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "CustomFieldsFnc.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "128",
    "number_of_lines_deleted_vulnerable_to_cve": "161",
    "vulnerable_lines": [
        "// Line_Reference 33: function CustomFields($location,$table_arr='',$exp=0)",
        "// Line_Reference 34: {\tglobal $_openSIS;",
        "// Line_Reference 35: \tif(count($_REQUEST['month__cust_begin']))",
        "// Line_Reference 36: \t{",
        "// Line_Reference 37: \t\tforeach($_REQUEST['month__cust_begin'] as $field_name=>$month)",
        "// Line_Reference 38: \t\t{",
        "// Line_Reference 39: \t\t\t$_REQUEST['cust_begin'][$field_name] = $_REQUEST['day__cust_begin'][$field_name].'-'.$_REQUEST['month__cust_begin'][$field_name].'-'.$_REQUEST['year__cust_begin'][$field_name];",
        "// Line_Reference 40: \t\t\t$_REQUEST['cust_end'][$field_name] = $_REQUEST['day__cust_end'][$field_name].'-'.$_REQUEST['month__cust_end'][$field_name].'-'.$_REQUEST['year__cust_end'][$field_name];",
        "// Line_Reference 41:                         if(!VerifyDate($_REQUEST['cust_begin'][$field_name]) || !VerifyDate($_REQUEST['cust_end'][$field_name]))",
        "// Line_Reference 42: \t\t\t{",
        "// Line_Reference 47: \t\tunset($_REQUEST['month__cust_begin']);unset($_REQUEST['year__cust_begin']);unset($_REQUEST['day__cust_begin']);",
        "// Line_Reference 48: \t\tunset($_REQUEST['month__cust_end']);unset($_REQUEST['year__cust_end']);unset($_REQUEST['day__cust_end']);",
        "// Line_Reference 50: \tif(count($_REQUEST['cust']))",
        "// Line_Reference 51: \t{",
        "// Line_Reference 52: \t\tforeach($_REQUEST['cust'] as $key=>$value)",
        "// Line_Reference 53: \t\t{",
        "// Line_Reference 54: \t\t\tif($value=='')",
        "// Line_Reference 58: \tswitch($location)",
        "// Line_Reference 59: \t{",
        "// Line_Reference 61: \t\tbreak;",
        "// Line_Reference 64: \t\tif(count($_REQUEST['cust']) || count($_REQUEST['cust_begin']))",
        "// Line_Reference 65:                 {",
        "// Line_Reference 66: \t\t\t$fields = DBGet(DBQuery('SELECT TITLE,ID,TYPE,SYSTEM_FIELD FROM custom_fields'),array(),array('ID'));",
        "// Line_Reference 67:                 }",
        "// Line_Reference 68: \t\tif(count($_REQUEST['cust']))",
        "// Line_Reference 69: \t\t{",
        "// Line_Reference 70: \t\t\tforeach($_REQUEST['cust'] as $id => $value)",
        "// Line_Reference 71: \t\t\t{",
        "// Line_Reference 72: \t\t\t\t$field_name = $id;",
        "// Line_Reference 73: \t\t\t\t$id = substr($id,7);",
        "// Line_Reference 74: \t\t\t\tif($fields[$id][1]['SYSTEM_FIELD'] == 'Y')",
        "// Line_Reference 75: \t\t\t\t\t$field_name = strtoupper(str_replace(' ','_',$fields[$id][1]['TITLE']));",
        "// Line_Reference 76: \t\t\t\tif($value!='')",
        "// Line_Reference 77: \t\t\t\t{",
        "// Line_Reference 78: \t\t\t\t\tswitch($fields[$id][1]['TYPE'])",
        "// Line_Reference 79: \t\t\t\t\t{",
        "// Line_Reference 80: \t\t\t\t\t\tcase 'radio':",
        "// Line_Reference 81: \t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<font color=gray><b>'.$fields[$id][1]['TITLE'].': </b></font>';",
        "// Line_Reference 82: \t\t\t\t\t\t\tif($value=='Y')",
        "// Line_Reference 83: \t\t\t\t\t\t\t{",
        "// Line_Reference 84: \t\t\t\t\t\t\t\t$string .= ' and s.'.$field_name.'=\\''.$value.'\\' ';",
        "// Line_Reference 85: \t\t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= 'Yes';",
        "// Line_Reference 86: \t\t\t\t\t\t\t}",
        "// Line_Reference 87: \t\t\t\t\t\t\telseif($value=='N')",
        "// Line_Reference 88: \t\t\t\t\t\t\t{",
        "// Line_Reference 89: \t\t\t\t\t\t\t\t$string .= ' and (s.'.$field_name.'!=\\'Y\\' OR s.'.$field_name.' IS NULL) ';",
        "// Line_Reference 90: \t\t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= 'No';",
        "// Line_Reference 91: \t\t\t\t\t\t\t}",
        "// Line_Reference 92: \t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<BR>';",
        "// Line_Reference 93: \t\t\t\t\t\tbreak;",
        "// Line_Reference 95: \t\t\t\t\t\tcase 'codeds':",
        "// Line_Reference 96: \t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<font color=gray><b>'.$fields[$id][1]['TITLE'].': </b></font>';",
        "// Line_Reference 97: \t\t\t\t\t\t\tif($value=='!')",
        "// Line_Reference 98: \t\t\t\t\t\t\t{",
        "// Line_Reference 99: \t\t\t\t\t\t\t\t$string .= ' and (s.'.$field_name.'=\\'\\' OR s.'.$field_name.' IS NULL) ';",
        "// Line_Reference 100: \t\t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= 'No Value';",
        "// Line_Reference 101: \t\t\t\t\t\t\t}",
        "// Line_Reference 102: \t\t\t\t\t\t\telse",
        "// Line_Reference 103: \t\t\t\t\t\t\t{",
        "// Line_Reference 104: \t\t\t\t\t\t\t\t$string .= ' and s.'.$field_name.'=\\''.$value.'\\' ';",
        "// Line_Reference 105: \t\t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= $value;",
        "// Line_Reference 106: \t\t\t\t\t\t\t}",
        "// Line_Reference 107: \t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<BR>';",
        "// Line_Reference 108: \t\t\t\t\t\t\tbreak;",
        "// Line_Reference 110: \t\t\t\t\t\tcase 'select':",
        "// Line_Reference 111: \t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<font color=gray><b>'.$fields[$id][1]['TITLE'].': </b></font>';",
        "// Line_Reference 112: \t\t\t\t\t\t\tif($value=='!')",
        "// Line_Reference 113: \t\t\t\t\t\t\t{",
        "// Line_Reference 114: \t\t\t\t\t\t\t\t$string .= ' and (s.'.$field_name.'=\\'\\' OR s.'.$field_name.' IS NULL) ';",
        "// Line_Reference 115: \t\t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= 'No Value';",
        "// Line_Reference 116: \t\t\t\t\t\t\t}",
        "// Line_Reference 117: \t\t\t\t\t\t\telse",
        "// Line_Reference 118: \t\t\t\t\t\t\t{",
        "// Line_Reference 119: \t\t\t\t\t\t\t\t$string .= ' and s.'.$field_name.'=\\''.$value.'\\' ';",
        "// Line_Reference 120: \t\t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= $value;",
        "// Line_Reference 121: \t\t\t\t\t\t\t}",
        "// Line_Reference 122: \t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<BR>';",
        "// Line_Reference 123: \t\t\t\t\t\t\tbreak;",
        "// Line_Reference 125: \t\t\t\t\t\tcase 'autos':",
        "// Line_Reference 126: \t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<font color=gray><b>'.$fields[$id][1]['TITLE'].': </b></font>';",
        "// Line_Reference 127: \t\t\t\t\t\t\tif($value=='!')",
        "// Line_Reference 128: \t\t\t\t\t\t\t{",
        "// Line_Reference 129: \t\t\t\t\t\t\t\t$string .= ' and (s.'.$field_name.'=\\'\\' OR s.'.$field_name.' IS NULL) ';",
        "// Line_Reference 130: \t\t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= 'No Value';",
        "// Line_Reference 131: \t\t\t\t\t\t\t}",
        "// Line_Reference 132: \t\t\t\t\t\t\telse",
        "// Line_Reference 133: \t\t\t\t\t\t\t{",
        "// Line_Reference 134: \t\t\t\t\t\t\t\t$string .= ' and s.'.$field_name.'=\\''.$value.'\\' ';",
        "// Line_Reference 135: \t\t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= $value;",
        "// Line_Reference 136: \t\t\t\t\t\t\t}",
        "// Line_Reference 137: \t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<BR>';",
        "// Line_Reference 138: \t\t\t\t\t\t\tbreak;",
        "// Line_Reference 140: \t\t\t\t\t\tcase 'edits':",
        "// Line_Reference 141: \t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<font color=gray><b>'.$fields[$id][1]['TITLE'].': </b></font>';",
        "// Line_Reference 142: \t\t\t\t\t\t\tif($value=='!')",
        "// Line_Reference 143: \t\t\t\t\t\t\t{",
        "// Line_Reference 144: \t\t\t\t\t\t\t\t$string .= ' and (s.'.$field_name.'=\\'\\' OR s.'.$field_name.' IS NULL) ';",
        "// Line_Reference 145: \t\t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= 'No Value';",
        "// Line_Reference 146: \t\t\t\t\t\t\t}",
        "// Line_Reference 147: \t\t\t\t\t\t\telseif($value=='~')",
        "// Line_Reference 148: \t\t\t\t\t\t\t{",
        "// Line_Reference 149: \t\t\t\t\t\t\t\t$string .= \" and position('\\n'||s.$field_name||'\\r' IN '\\n'||(SELECT SELECT_OPTIONS FROM custom_fields WHERE ID='\".$id.\"')||'\\r')=0 \";",
        "// Line_Reference 150: \t\t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= 'Other';",
        "// Line_Reference 151: \t\t\t\t\t\t\t}",
        "// Line_Reference 152: \t\t\t\t\t\t\telse",
        "// Line_Reference 153: \t\t\t\t\t\t\t{",
        "// Line_Reference 154: \t\t\t\t\t\t\t\t$string .= ' and s.'.$field_name.'=\\''.$value.'\\' ';",
        "// Line_Reference 155: \t\t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= $value;",
        "// Line_Reference 156: \t\t\t\t\t\t\t}",
        "// Line_Reference 157: \t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<BR>';",
        "// Line_Reference 158: \t\t\t\t\t\t\tbreak;",
        "// Line_Reference 160: \t\t\t\t\t\tcase 'text':",
        "// Line_Reference 161: \t\t\t\t\t\t\tif(substr($value,0,2)=='\\\"' && substr($value,-2)=='\\\"')",
        "// Line_Reference 162: \t\t\t\t\t\t\t{",
        "// Line_Reference 163: \t\t\t\t\t\t\t\t$string .= ' and s.'.$field_name.'=\\''.substr($value,2,-2).'\\' ';",
        "// Line_Reference 164: \t\t\t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<font color=gray><b>'.$fields[$id][1]['TITLE'].': </b></font>'.substr($value,2,-2).'<BR>';",
        "// Line_Reference 165: \t\t\t\t\t\t\t}",
        "// Line_Reference 166: \t\t\t\t\t\t\telse",
        "// Line_Reference 167: \t\t\t\t\t\t\t{",
        "// Line_Reference 168: \t\t\t\t\t\t\t\t$string .= ' and LOWER(s.'.$field_name.') LIKE \\''.strtolower($value).'%\\' ';",
        "// Line_Reference 169:                                                                 if($exp==1)",
        "// Line_Reference 170: \t\t\t\t\t\t\t\t$_openSIS['Search'] .= '<font color=gray><b>'.$fields[$id][1]['TITLE'].' starts with: </b></font>'.$value.'<BR>';",
        "// Line_Reference 171:                                                             elseif($exp==2){",
        "// Line_Reference 172:                                                                 $_openSIS['SearchTerms'] .= '<font color=gray><b>'.$fields[$id][1]['TITLE'].' starts with: </b></font>'.$value.'<BR>';",
        "// Line_Reference 173:                                                             }",
        "// Line_Reference 174:                                                              else {",
        "// Line_Reference 175:                                                                           $_openSIS['SearchTerms'] .= '<font color=gray><b>'.$fields[$id][1]['TITLE'].' starts with: </b></font>'.$value.'<BR>';",
        "// Line_Reference 176:                                                             }",
        "// Line_Reference 177: \t\t\t\t\t\t\t}",
        "// Line_Reference 178: \t\t\t\t\t\tbreak;",
        "// Line_Reference 182: \t\t}",
        "// Line_Reference 183: \t\tif(count($_REQUEST['cust_begin']))",
        "// Line_Reference 184: \t\t{",
        "// Line_Reference 185: \t\t\tforeach($_REQUEST['cust_begin'] as $id => $value)",
        "// Line_Reference 186: \t\t\t{",
        "// Line_Reference 187: \t\t\t\t$field_name = $id;",
        "// Line_Reference 188: \t\t\t\t$id = substr($id,7);",
        "// Line_Reference 189: \t\t\t\t$column_name = $field_name;",
        "// Line_Reference 190: \t\t\t\tif($fields[$id][1]['SYSTEM_FIELD'] == 'Y')",
        "// Line_Reference 191: \t\t\t\t\t$column_name = strtoupper(str_replace(' ','_',$fields[$id][1]['TITLE']));",
        "// Line_Reference 192: \t\t\t\tif($fields[$id][1]['TYPE']=='numeric')",
        "// Line_Reference 193: \t\t\t\t{",
        "// Line_Reference 194: \t\t\t\t\t$_REQUEST['cust_end'][$field_name] = par_rep('/[^0-9.-]+/','',$_REQUEST['cust_end'][$field_name]);",
        "// Line_Reference 195: \t\t\t\t\t$value = par_rep('/[^0-9.-]+/','',$value);",
        "// Line_Reference 196: \t\t\t\t}",
        "// Line_Reference 198: \t\t\t\tif($_REQUEST['cust_begin'][$field_name]!='' && $_REQUEST['cust_end'][$field_name]!='')",
        "// Line_Reference 199: \t\t\t\t{",
        "// Line_Reference 200: \t\t\t\t\tif($fields[$id][1]['TYPE']=='numeric' && $_REQUEST['cust_begin'][$field_name]>$_REQUEST['cust_end'][$field_name])",
        "// Line_Reference 201: \t\t\t\t\t{",
        "// Line_Reference 202: \t\t\t\t\t\t$temp = $_REQUEST['cust_end'][$field_name];",
        "// Line_Reference 203: \t\t\t\t\t\t$_REQUEST['cust_end'][$field_name] = $value;",
        "// Line_Reference 204: \t\t\t\t\t\t$value = $temp;",
        "// Line_Reference 206: \t\t\t\t\t$string .= ' and s.'.$column_name.' BETWEEN \\''.date('Y-m-d',strtotime($value)).'\\' AND \\''.date('Y-m-d',strtotime($_REQUEST['cust_end'][$field_name])).'\\' ';",
        "// Line_Reference 207: \t\t\t\t\tif($fields[$id][1]['TYPE']=='date')",
        "// Line_Reference 208: \t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<font color=gray><b>'.$fields[$id][1]['TITLE'].' between: </b></font>'.date('M/d/Y',strtotime($value)).' &amp; '.date('M/d/Y',strtotime($_REQUEST['cust_end'][$field_name])).'<BR>';",
        "// Line_Reference 209: \t\t\t\t\telse",
        "// Line_Reference 210: \t\t\t\t\t\t$_openSIS['SearchTerms'] .= '<font color=gray><b>'.$fields[$id][1]['TITLE'].' between: </b></font>'.$value.' &amp; '.$_REQUEST['cust_end'][$field_name].'<BR>';",
        "// Line_Reference 213: \t\t}",
        "// Line_Reference 215: \t\tbreak;",
        "// Line_Reference 217: \t\treturn $string;",
        "// Line_Reference 219: ?>"
    ]
}
