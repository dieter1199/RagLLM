{
    "cve_id": "CVE-2022-21666",
    "cve_description": "Useful Simple Open-Source CMS (USOC) is a content management system (CMS) for programmers. Versions prior to Pb2.4Bfx3 allowed Sql injection in usersearch.php only for users with administrative privileges. Users should replace the file `admin/pages/useredit.php` with a newer version. USOC version Pb2.4Bfx3 contains a fixed version of `admin/pages/useredit.php`.",
    "cve_publish_date": "2022-01-10",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Update usersearch.php",
    "type_of_change": "Modification",
    "filename_of_changes": "usersearch.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "124",
    "number_of_lines_deleted_vulnerable_to_cve": "100",
    "vulnerable_lines": [
        "// Line_Reference 2:     if($U->userHasPermission(\"Backend\", \"User\",\"Search\")){",
        "// Line_Reference 4:     <!DOCTYPE html>",
        "// Line_Reference 5:     <html lang=\"<?php echo $U->getSetting(\"site.lang\"); ?>\" dir=\"ltr\">",
        "// Line_Reference 6:         <head>",
        "// Line_Reference 7:             <style>",
        "// Line_Reference 8:                 tbody > tr > th {",
        "// Line_Reference 9:                     font-weight: normal;",
        "// Line_Reference 10:                 }",
        "// Line_Reference 11:             </style>",
        "// Line_Reference 12:             <meta charset=\"utf-8\">",
        "// Line_Reference 13:             <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.user.search\"); ?></title>",
        "// Line_Reference 14:         </head>",
        "// Line_Reference 15:         <body>",
        "// Line_Reference 16:             <a href=\"javascript:window.close()\"><?php echo $U->getLang(\"admin.exit\"); ?></a>",
        "// Line_Reference 17:             <p><?php echo $U->getLang(\"admin.user.search.intro\"); ?></p>",
        "// Line_Reference 18:             <form>",
        "// Line_Reference 19:                 <label for=\"Name\"><?php echo $U->getLang(\"admin.user.field.username\"); ?>:</label><br />",
        "// Line_Reference 20:                 <input type=\"text\" name=\"Name\" /><br />",
        "// Line_Reference 21:                 <label for=\"Mail\"><?php echo $U->getLang(\"admin.user.field.mail\"); ?>:</label><br />",
        "// Line_Reference 22:                 <input type=\"mail\" name=\"Mail\" /><br />",
        "// Line_Reference 23:                 <input type=\"hidden\" name=\"URL\" value=\"usersearch\" />",
        "// Line_Reference 24:                 <input type=\"submit\" value=\"<?php echo $U->getLang(\"admin.user.search.action\"); ?>\" />",
        "// Line_Reference 25:             </form>",
        "// Line_Reference 26:             <?php",
        "// Line_Reference 27:                 if(isset($_GET[\"Name\"])){",
        "// Line_Reference 28:                     if($_GET[\"Name\"] !== \"\"){",
        "// Line_Reference 29:                         $sql = \"SELECT * FROM User WHERE Username='\".mysqli::real_escape_string($_GET[\"Name\"]).\"';\";",
        "// Line_Reference 30:                         $dbRes = mysqli_query($U->db_link, $sql);",
        "// Line_Reference 31:                     }",
        "// Line_Reference 32:                 }",
        "// Line_Reference 33:                 if(isset($_GET[\"Mail\"])){",
        "// Line_Reference 34:                     if($_GET[\"Mail\"] !== \"\"){",
        "// Line_Reference 35:                         $sql = \"SELECT * FROM User WHERE Mail='\".mysqli::real_escape_string($_GET[\"Mail\"]).\"';\";",
        "// Line_Reference 36:                         $dbRes = mysqli_query($U->db_link, $sql);",
        "// Line_Reference 37:                     }",
        "// Line_Reference 38:                 }",
        "// Line_Reference 39:                 if(isset($_GET[\"Id\"])){",
        "// Line_Reference 40:                     if($_GET[\"Id\"] !== \"\"){",
        "// Line_Reference 41:                         $sql = \"SELECT * FROM User WHERE Id='\".mysqli::real_escape_string($_GET[\"Id\"]).\"';\";",
        "// Line_Reference 42:                         $dbRes = mysqli_query($U->db_link, $sql);",
        "// Line_Reference 43:                     }",
        "// Line_Reference 44:                 }",
        "// Line_Reference 45:                 if(isset($_GET[\"Mail\"]) || isset($_GET[\"Name\"]) || isset($_GET[\"Id\"])){",
        "// Line_Reference 46:                     $userhere = False;",
        "// Line_Reference 47:                     while($row = mysqli_fetch_array($dbRes, MYSQLI_ASSOC)){",
        "// Line_Reference 48:                         $userhere = True;",
        "// Line_Reference 49:             ?>",
        "// Line_Reference 50:                         <h4><?php echo str_replace(\"%a\",$row[\"Username\"],$U->getLang(\"admin.user.search.title\")); ?></h4>",
        "// Line_Reference 51:                         <table>",
        "// Line_Reference 52:                             <tbody>",
        "// Line_Reference 53:                                 <tr>",
        "// Line_Reference 54:                                     <th>",
        "// Line_Reference 55:                                         Id:",
        "// Line_Reference 56:                                     </th>",
        "// Line_Reference 57:                                     <th>",
        "// Line_Reference 58:                                         <?php echo $row[\"Id\"]; ?>",
        "// Line_Reference 59:                                     </th>",
        "// Line_Reference 60:                                 </tr>",
        "// Line_Reference 61:                                 <tr>",
        "// Line_Reference 62:                                     <th>",
        "// Line_Reference 63:                                         <?php echo $U->getLang(\"admin.user.field.mail\"); ?>:",
        "// Line_Reference 64:                                     </th>",
        "// Line_Reference 65:                                     <th>",
        "// Line_Reference 66:                                         <?php echo $row[\"Mail\"]; ?>",
        "// Line_Reference 67:                                     </th>",
        "// Line_Reference 68:                                 </tr>",
        "// Line_Reference 69:                                 <tr>",
        "// Line_Reference 70:                                     <th>",
        "// Line_Reference 71:                                         <?php echo $U->getLang(\"admin.user.field.permissionlevel\"); ?>",
        "// Line_Reference 72:                                     </th>",
        "// Line_Reference 73:                                     <th>",
        "// Line_Reference 74:                                         <?php echo $U->getPermissionName($row[\"Type\"]); ?>",
        "// Line_Reference 75:                                     </th>",
        "// Line_Reference 76:                                 </tr>",
        "// Line_Reference 77:                                 <tr>",
        "// Line_Reference 78:                                     <th>",
        "// Line_Reference 79:                                         <?php echo $U->getLang(\"admin.user.field.blocked\"); ?>",
        "// Line_Reference 80:                                     </th>",
        "// Line_Reference 81:                                     <th>",
        "// Line_Reference 82:                                         <?php echo $row[\"blocked\"]==0?$U->getLang(\"admin.no\"):$U->getLang(\"admin.yes\"); ?>",
        "// Line_Reference 83:                                     </th>",
        "// Line_Reference 84:                                 </tr>",
        "// Line_Reference 85:                             </tbody>",
        "// Line_Reference 86:                         </table>",
        "// Line_Reference 87:             <?php",
        "// Line_Reference 88:                     }",
        "// Line_Reference 89:                     if(!$userhere&&isset($_GET[\"Mail\"])&&$_GET[\"Mail\"]!==\"\"){",
        "// Line_Reference 90:                         echo str_replace(\"%a\", $U->getLang(\"admin.user.field.mail\"), str_replace(\"%b\", $_GET[\"Mail\"], $U->getLang(\"admin.user.notFound.property\")));",
        "// Line_Reference 91:                     }",
        "// Line_Reference 92:                     if(!$userhere&&isset($_GET[\"Name\"])&&$_GET[\"Name\"]!==\"\"){",
        "// Line_Reference 93:                         echo str_replace(\"%a\", $U->getLang(\"admin.user.field.username\"), str_replace(\"%b\", $_GET[\"Name\"], $U->getLang(\"admin.user.notFound.property\")));",
        "// Line_Reference 94:                     }",
        "// Line_Reference 95:                     if(!$userhere&&isset($_GET[\"Id\"])){",
        "// Line_Reference 96:                         echo str_replace(\"%a\", $U->getLang(\"admin.user.field.id\"), str_replace(\"%b\", $_GET[\"Id\"], $U->getLang(\"admin.user.notFound.property\")));",
        "// Line_Reference 97:                     }",
        "// Line_Reference 99:             ?>",
        "// Line_Reference 100:         </body>",
        "// Line_Reference 101:     </html>",
        "// Line_Reference 109:       <title><?php echo $U->getLang(\"admin\") ?> - <?php echo $U->getLang(\"admin.settings\"); ?></title>",
        "// Line_Reference 112:         <a href=\"javascript:window.close()\"><?php echo $U->getLang(\"admin.exit\"); ?></a>"
    ]
}
