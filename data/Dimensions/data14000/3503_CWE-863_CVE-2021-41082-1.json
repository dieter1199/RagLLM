{
    "cve_id": "CVE-2021-41082",
    "cve_description": "Discourse is a platform for community discussion. In affected versions any private message that includes a group had its title and participating user exposed to users that do not have access to the private messages. However, access control for the private messages was not compromised as users were not able to view the posts in the leaked private message despite seeing it in their inbox. The problematic commit was reverted around 32 minutes after it was made. Users are encouraged to upgrade to the latest commit if they are running Discourse against the `tests-passed` branch.",
    "cve_publish_date": "2021-09-20",
    "cwe_id": "CWE-863",
    "cwe_name": "Incorrect Authorization",
    "cwe_description": "The product performs an authorization check when an actor attempts to access a resource or perform an action, but it does not correctly perform the check. This allows attackers to bypass intended access restrictions.",
    "commit_message": "PERF: Improve query performance all inbox private messages. (#14304)\n\nFirst reported in https://meta.discourse.org/t/-/202482/19\r\n\r\nThere are two optimizations being applied here:\r\n\r\n1. Fetch a user's group ids in a seperate query instead of including it\r\n   as a sub-query. When I tried a subquery, the query plan becomes very\r\ninefficient.\r\n\r\n1. Join against the `topic_allowed_users` and `topic_allowed_groups`\r\n   table instead of doing an IN against a subquery where we UNION the\r\n`topic_id`s from the two tables. From my profiling, this enables PG to\r\ndo a backwards index scan on the `index_topics_on_timestamps_private`\r\nindex.\r\n\r\nThis commit fixes a bug where listing all messages was incorrectly\r\nexcluding topics if a topic has been archived by a group even if the\r\nuser did not belong to the group.\r\n\r\nThis commit also fixes another bug where dismissing private messages\r\nselectively was subjected to the default limit of 30.",
    "type_of_change": "Modification",
    "filename_of_changes": "private_message_lists.rb",
    "code_language": "Ruby",
    "number_of_lines_added_for_mitigation": "32",
    "number_of_lines_deleted_vulnerable_to_cve": "11",
    "vulnerable_lines": [
        "// Line_Reference 146:         result = result.where(\"topics.id IN (",
        "// Line_Reference 147:               SELECT topic_id",
        "// Line_Reference 148:               FROM topic_allowed_users",
        "// Line_Reference 149:               WHERE user_id = #{user.id.to_i}",
        "// Line_Reference 150:               UNION ALL",
        "// Line_Reference 151:               SELECT topic_id FROM topic_allowed_groups",
        "// Line_Reference 152:               WHERE group_id IN (",
        "// Line_Reference 153:                 SELECT group_id FROM group_users WHERE user_id = #{user.id.to_i}",
        "// Line_Reference 154:               )",
        "// Line_Reference 155:       )\")",
        "// Line_Reference 233:       LEFT JOIN group_archived_messages gm ON gm.topic_id = topics.id"
    ]
}
