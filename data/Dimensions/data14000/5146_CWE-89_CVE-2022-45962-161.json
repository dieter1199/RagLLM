{
    "cve_id": "CVE-2022-45962",
    "cve_description": "Open Solutions for Education, Inc openSIS Community Edition v8.0 and earlier is vulnerable to SQL Injection via CalendarModal.php.",
    "cve_publish_date": "2023-02-13",
    "cwe_id": "CWE-89",
    "cwe_name": "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    "cwe_description": "The product constructs all or part of an SQL command using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the intended SQL command when it is sent to a downstream component. Without sufficient removal or quoting of SQL syntax in user-controllable inputs, the generated SQL query can cause those inputs to be interpreted as SQL instead of ordinary user data.",
    "commit_message": "Version 9.0 release\n\nOlder version shifted to branch: Version_8.0",
    "type_of_change": "ModificationType.ADD",
    "filename_of_changes": "UserFnc.php",
    "code_language": "PHP",
    "number_of_lines_added_for_mitigation": "64",
    "number_of_lines_deleted_vulnerable_to_cve": "76",
    "vulnerable_lines": [
        "// Line_Reference 29: {\tglobal $_openSIS,$DefaultSyear;",
        "// Line_Reference 30: \tif(!$_SESSION['UserSyear'])",
        "// Line_Reference 33: \tif(!$_openSIS['User'] || $_SESSION['UserSyear']!=$_openSIS['User'][1]['SYEAR'])",
        "// Line_Reference 34: \t{",
        "// Line_Reference 35: \t\tif($_SESSION['STAFF_ID'])",
        "// Line_Reference 36: \t\t{",
        "// Line_Reference 37:                     if($_SESSION['PROFILE_ID']!=4)",
        "// Line_Reference 38:                     $sql = 'SELECT STAFF_ID,USERNAME,CONCAT(FIRST_NAME,\\' \\',LAST_NAME) AS NAME,PROFILE,la.PROFILE_ID,CURRENT_SCHOOL_ID,EMAIL FROM staff s ,login_authentication la WHERE la.USER_ID=s.STAFF_ID AND la.PROFILE_ID <> 3 AND la.PROFILE_ID=s.PROFILE_ID AND STAFF_ID='.$_SESSION[STAFF_ID];",
        "// Line_Reference 39:                     if($_SESSION['PROFILE_ID']==4 || $_SESSION['PROFILE']=='parent')",
        "// Line_Reference 40:                     $sql = 'SELECT p.STAFF_ID,la.USERNAME,CONCAT(p.FIRST_NAME,\\' \\',p.LAST_NAME) AS NAME,p.PROFILE,p.PROFILE_ID,p.CURRENT_SCHOOL_ID,p.EMAIL FROM people p ,login_authentication la WHERE la.USER_ID=p.STAFF_ID AND la.PROFILE_ID <> 3  AND la.PROFILE_ID=p.PROFILE_ID AND STAFF_ID='.$_SESSION[STAFF_ID];",
        "// Line_Reference 41:                     $_openSIS['User'] = DBGet(DBQuery($sql));",
        "// Line_Reference 42: \t\t}",
        "// Line_Reference 43: \t\telseif($_SESSION['STUDENT_ID'])",
        "// Line_Reference 44: \t\t{",
        "// Line_Reference 45: \t\t\t$sql = 'SELECT USERNAME,CONCAT(s.FIRST_NAME,\\' \\',s.LAST_NAME) AS NAME,\\'student\\' AS PROFILE,\\'3\\' AS PROFILE_ID,CONCAT(\\',\\',se.SCHOOL_ID,\\',\\') AS SCHOOLS,se.SYEAR,se.SCHOOL_ID FROM students s,student_enrollment se,login_authentication la WHERE la.USER_ID=s.STUDENT_ID AND la.PROFILE_ID = 3 AND s.STUDENT_ID='.$_SESSION[STUDENT_ID].' AND se.SYEAR=\\''.$_SESSION[UserSyear].'\\'  AND (se.END_DATE IS NULL OR se.END_DATE=\\'0000-00-00\\' OR se.END_DATE>=\\''.date('Y-m-d').'\\' ) AND se.STUDENT_ID=s.STUDENT_ID ORDER BY se.END_DATE DESC LIMIT 1';",
        "// Line_Reference 46:                         $_openSIS['User'] = DBGet(DBQuery($sql));",
        "// Line_Reference 47:                         if(count($_openSIS['User'])==0)",
        "// Line_Reference 48:                         {",
        "// Line_Reference 49:                             $sql = 'SELECT USERNAME,CONCAT(s.FIRST_NAME,\\' \\',s.LAST_NAME) AS NAME,\\'student\\' AS PROFILE,\\'3\\' AS PROFILE_ID,CONCAT(\\',\\',se.SCHOOL_ID,\\',\\') AS SCHOOLS,se.SYEAR,se.SCHOOL_ID FROM students s,student_enrollment se,login_authentication la WHERE la.USER_ID=s.STUDENT_ID AND la.PROFILE_ID = 3 AND s.STUDENT_ID='.$_SESSION[STUDENT_ID].' AND se.SYEAR=\\''.$_SESSION[UserSyear].'\\'   AND se.STUDENT_ID=s.STUDENT_ID ORDER BY se.END_DATE DESC LIMIT 1';",
        "// Line_Reference 50:                             $_openSIS['User'] = DBGet(DBQuery($sql));",
        "// Line_Reference 51: \t\t\t$_SESSION['UserSchool'] = $_openSIS['User'][1]['SCHOOL_ID'];",
        "// Line_Reference 52: \t\t}",
        "// Line_Reference 53: \t\telse",
        "// Line_Reference 54:                 {",
        "// Line_Reference 55: \t\t\t$_SESSION['UserSchool'] = $_openSIS['User'][1]['SCHOOL_ID'];",
        "// Line_Reference 56: \t\t}",
        "// Line_Reference 57:                 }",
        "// Line_Reference 58: \t\telse",
        "// Line_Reference 59:                 {",
        "// Line_Reference 61:                 }",
        "// Line_Reference 68:     $prof=DBGet(DBQuery('SELECT '.$option.' FROM staff WHERE STAFF_ID='.UserStaffID()));",
        "// Line_Reference 69:     return $prof[1][$option];",
        "// Line_Reference 73:     $prof=DBGet(DBQuery('SELECT '.$option.' FROM staff WHERE STAFF_ID='.UserID()));",
        "// Line_Reference 74:     return $prof[1][$option];",
        "// Line_Reference 76: function Preferences($item,$program='Preferences')",
        "// Line_Reference 77: {\tglobal $_openSIS;",
        "// Line_Reference 79: \tif($_SESSION['STAFF_ID'] && !$_openSIS['Preferences'][$program])",
        "// Line_Reference 80: \t{",
        "// Line_Reference 81:             if($program=='Gradebook')",
        "// Line_Reference 82: \t\t$QI=DBQuery('SELECT TITLE,VALUE FROM program_user_config WHERE USER_ID='.$_SESSION[STAFF_ID].' AND PROGRAM=\\''.$program.'\\' AND VALUE LIKE \\'%_'.UserCoursePeriod().'\\'');",
        "// Line_Reference 83:             else",
        "// Line_Reference 84: \t\t$QI=DBQuery('SELECT TITLE,VALUE FROM program_user_config WHERE USER_ID='.$_SESSION[STAFF_ID].' AND PROGRAM=\\''.$program.'\\'');",
        "// Line_Reference 85: \t\t$_openSIS['Preferences'][$program] = DBGet($QI,array(),array('TITLE'));",
        "// Line_Reference 88: \t$defaults = array('NAME'=>'Common',",
        "// Line_Reference 89: \t\t\t\t'SORT'=>'Name',",
        "// Line_Reference 90: \t\t\t\t'SEARCH'=>'Y',",
        "// Line_Reference 91: \t\t\t\t'DELIMITER'=>'Tab',",
        "// Line_Reference 92: \t\t\t\t'COLOR'=>'#FFFFCC',",
        "// Line_Reference 93: \t\t\t\t'HIGHLIGHT'=>'#85E1FF',",
        "// Line_Reference 94: \t\t\t\t'TITLES'=>'gray',",
        "// Line_Reference 95: \t\t\t\t'THEME'=>'Brushed-Steel',",
        "// Line_Reference 96: \t\t\t\t'HIDDEN'=>'Y',",
        "// Line_Reference 97: \t\t\t\t'MONTH'=>'M',",
        "// Line_Reference 98: \t\t\t\t'DAY'=>'j',",
        "// Line_Reference 99: \t\t\t\t'YEAR'=>'Y',",
        "// Line_Reference 100: \t\t\t\t'DEFAULT_ALL_SCHOOLS'=>'N',",
        "// Line_Reference 101: \t\t\t\t'ASSIGNMENT_SORTING'=>'ASSIGNMENT_ID',",
        "// Line_Reference 102: \t\t\t\t'ANOMALOUS_MAX'=>'100'",
        "// Line_Reference 103: \t\t\t\t);",
        "// Line_Reference 105: \tif(!isset($_openSIS['Preferences'][$program][$item][1]['VALUE']))",
        "// Line_Reference 108: \tif($_SESSION['STAFF_ID'] && User('PROFILE')=='parent' || $_SESSION['STUDENT_ID'])",
        "// Line_Reference 110:         if($program=='Gradebook')",
        "// Line_Reference 111:         {",
        "// Line_Reference 112:            if($item=='ANOMALOUS_MAX')",
        "// Line_Reference 113:            {",
        "// Line_Reference 114:                $arr=explode('_',$_openSIS['Preferences'][$program][$item][1]['VALUE']);",
        "// Line_Reference 115:                return $arr[0];",
        "// Line_Reference 116:            }",
        "// Line_Reference 117:            else",
        "// Line_Reference 118: \t return rtrim($_openSIS['Preferences'][$program][$item][1]['VALUE'],'_'.UserCoursePeriod());",
        "// Line_Reference 119:         }",
        "// Line_Reference 120:         else",
        "// Line_Reference 121: \treturn $_openSIS['Preferences'][$program][$item][1]['VALUE'];",
        "// Line_Reference 125:     $category=DBGet(DBquery('SELECT CATEGORY FROM staff_school_info WHERE STAFF_ID='.$staff_id));",
        "// Line_Reference 126:     return ($category[1]['CATEGORY']==''?'N/A':$category[1]['CATEGORY']);",
        "// Line_Reference 128: ?>"
    ]
}
