{
    "cve_id": "CVE-2021-41133",
    "cve_description": "Flatpak is a system for building, distributing, and running sandboxed desktop applications on Linux. In versions prior to 1.10.4 and 1.12.0, Flatpak apps with direct access to AF_UNIX sockets such as those used by Wayland, Pipewire or pipewire-pulse can trick portals and other host-OS services into treating the Flatpak app as though it was an ordinary, non-sandboxed host-OS process. They can do this by manipulating the VFS using recent mount-related syscalls that are not blocked by Flatpak's denylist seccomp filter, in order to substitute a crafted `/.flatpak-info` or make that file disappear entirely. Flatpak apps that act as clients for AF_UNIX sockets such as those used by Wayland, Pipewire or pipewire-pulse can escalate the privileges that the corresponding services will believe the Flatpak app has. Note that protocols that operate entirely over the D-Bus session bus (user bus), system bus or accessibility bus are not affected by this. This is due to the use of a proxy process `xdg-dbus-proxy`, whose VFS cannot be manipulated by the Flatpak app, when interacting with these buses. Patches exist for versions 1.10.4 and 1.12.0, and as of time of publication, a patch for version 1.8.2 is being planned. There are no workarounds aside from upgrading to a patched version.",
    "cve_publish_date": "2021-10-08",
    "cwe_id": "NVD-CWE-Other",
    "cwe_name": "Other",
    "cwe_description": "NVD is only using a subset of CWE for mapping instead of the entire CWE, and the weakness type is not covered by that subset.",
    "commit_message": "run: Add an errno value to seccomp filters\n\nAt the moment, if we block a syscall we always make it fail with EPERM,\nbut this is risky: user-space libraries can start to use new replacements\nfor old syscalls at any time, and will often treat EPERM as a fatal error.\nFor new syscalls, we should make the syscall fail with ENOSYS, which is\nindistinguishable from running on an older kernel and will cause fallback\nto an older implementation, for example clone3() to clone().\n\nIn future we should probably move from EPERM to ENOSYS for some of the\nsyscalls we already block, but for now keep the status quo.\n\nThis is a prerequisite for fixing the vulnerability tracked as\nGHSA-67h7-w3jq-vh4q.\n\nSigned-off-by: Simon McVittie <smcv@collabora.com>",
    "type_of_change": "Modification",
    "filename_of_changes": "flatpak-run.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "36",
    "number_of_lines_deleted_vulnerable_to_cve": "26",
    "vulnerable_lines": [
        "// Line_Reference 2903:     {SCMP_SYS (syslog)},",
        "// Line_Reference 2905:     {SCMP_SYS (uselib)},",
        "// Line_Reference 2907:     {SCMP_SYS (acct)},",
        "// Line_Reference 2910:     {SCMP_SYS (modify_ldt)},",
        "// Line_Reference 2912:     {SCMP_SYS (quotactl)},",
        "// Line_Reference 2915:     {SCMP_SYS (add_key)},",
        "// Line_Reference 2916:     {SCMP_SYS (keyctl)},",
        "// Line_Reference 2917:     {SCMP_SYS (request_key)},",
        "// Line_Reference 2920:     {SCMP_SYS (move_pages)},",
        "// Line_Reference 2921:     {SCMP_SYS (mbind)},",
        "// Line_Reference 2922:     {SCMP_SYS (get_mempolicy)},",
        "// Line_Reference 2923:     {SCMP_SYS (set_mempolicy)},",
        "// Line_Reference 2924:     {SCMP_SYS (migrate_pages)},",
        "// Line_Reference 2927:     {SCMP_SYS (unshare)},",
        "// Line_Reference 2928:     {SCMP_SYS (mount)},",
        "// Line_Reference 2929:     {SCMP_SYS (pivot_root)},",
        "// Line_Reference 2933:     {SCMP_SYS (clone), &SCMP_A1 (SCMP_CMP_MASKED_EQ, CLONE_NEWUSER, CLONE_NEWUSER)},",
        "// Line_Reference 2936:     {SCMP_SYS (clone), &SCMP_A0 (SCMP_CMP_MASKED_EQ, CLONE_NEWUSER, CLONE_NEWUSER)},",
        "// Line_Reference 2940:     {SCMP_SYS (ioctl), &SCMP_A1 (SCMP_CMP_MASKED_EQ, 0xFFFFFFFFu, (int) TIOCSTI)},",
        "// Line_Reference 2951:     {SCMP_SYS (perf_event_open)},",
        "// Line_Reference 2953:     {SCMP_SYS (personality), &SCMP_A0 (SCMP_CMP_NE, allowed_personality)},",
        "// Line_Reference 2954:     {SCMP_SYS (ptrace)}",
        "// Line_Reference 3039:         r = seccomp_rule_add (seccomp, SCMP_ACT_ERRNO (EPERM), scall, 1, *syscall_blocklist[i].arg);",
        "// Line_Reference 3041:         r = seccomp_rule_add (seccomp, SCMP_ACT_ERRNO (EPERM), scall, 0);",
        "// Line_Reference 3052:             r = seccomp_rule_add (seccomp, SCMP_ACT_ERRNO (EPERM), scall, 1, *syscall_nondevel_blocklist[i].arg);",
        "// Line_Reference 3054:             r = seccomp_rule_add (seccomp, SCMP_ACT_ERRNO (EPERM), scall, 0);"
    ]
}
