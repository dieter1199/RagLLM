{
    "cve_id": "CVE-2021-40346",
    "cve_description": "An integer overflow exists in HAProxy 2.0 through 2.5 in htx_add_header that can be exploited to perform an HTTP request smuggling attack, allowing an attacker to bypass all configured http-request HAProxy ACLs and possibly other ACLs.",
    "cve_publish_date": "2021-09-08",
    "cwe_id": "CWE-190",
    "cwe_name": "Integer Overflow or Wraparound",
    "cwe_description": "The product performs a calculation that can\n         produce an integer overflow or wraparound when the logic\n         assumes that the resulting value will always be larger than\n         the original value. This occurs when an integer value is\n         incremented to a value that is too large to store in the\n         associated representation. When this occurs, the value may\n         become a very small or negative number.",
    "commit_message": "BUG/MAJOR: htx: fix missing header name length check in htx_add_header/trailer\n\nOri Hollander of JFrog Security reported that htx_add_header() and\nhtx_add_trailer() were missing a length check on the header name. While\nthis does not allow to overwrite any memory area, it results in bits of\nthe header name length to slip into the header value length and may\nresult in forging certain header names on the input. The sad thing here\nis that a FIXME comment was present suggesting to add the required length\nchecks :-(\n\nThe injected headers are visible to the HTTP internals and to the config\nrules, so haproxy will generally stay synchronized with the server. But\nthere is one exception which is the content-length header field, because\nit is already deduplicated on the input, but before being indexed. As\nsuch, injecting a content-length header after the deduplication stage\nmay be abused to present a different, shorter one on the other side and\nhelp build a request smuggling attack, or even maybe a response splitting\nattack. CVE-2021-40346 was assigned to this problem.\n\nAs a mitigation measure, it is sufficient to verify that no more than\none such header is present in any message, which is normally the case\nthanks to the duplicate checks:\n\n   http-request  deny if { req.hdr_cnt(content-length) gt 1 }\n   http-response deny if { res.hdr_cnt(content-length) gt 1 }\n\nThis must be backported to all HTX-enabled versions, hence as far as 2.0.\nIn 2.3 and earlier, the functions are in src/htx.c instead.\n\nMany thanks to Ori for his work and his responsible report!",
    "type_of_change": "Modification",
    "filename_of_changes": "htx.h",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "6",
    "number_of_lines_deleted_vulnerable_to_cve": "2",
    "vulnerable_lines": [
        "// Line_Reference 469: \t/* FIXME: check name.len (< 256B) and value.len (< 1MB) */",
        "// Line_Reference 488: \t/* FIXME: check name.len (< 256B) and value.len (< 1MB) */"
    ]
}
