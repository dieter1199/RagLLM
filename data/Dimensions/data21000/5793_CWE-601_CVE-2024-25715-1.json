{
    "cve_id": "CVE-2024-25715",
    "cve_description": "Glewlwyd SSO server 2.x through 2.7.6 allows open redirection via redirect_uri.",
    "cve_publish_date": "2024-02-11",
    "cwe_id": "CWE-601",
    "cwe_name": "URL Redirection to Untrusted Site ('Open Redirect')",
    "cwe_description": "A web application accepts a user-controlled input that specifies a link to an external site, and uses that link in a Redirect. This simplifies phishing attacks.",
    "commit_message": "Fix PKCE downgrade and open redirection issues\n\nThanks to Pieter Philippaerts",
    "type_of_change": "Modification",
    "filename_of_changes": "protocol_oauth2.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "44",
    "number_of_lines_deleted_vulnerable_to_cve": "68",
    "vulnerable_lines": [
        "// Line_Reference 699:   int uri_found, authorization_type_enabled;",
        "// Line_Reference 710:   if (check_result_value(j_client, G_OK)) {",
        "// Line_Reference 716:         uri_found = 0;",
        "// Line_Reference 722:       } else {",
        "// Line_Reference 723:         uri_found = 1;",
        "// Line_Reference 941: static int validate_code_challenge(json_t * j_result_code, const char * code_verifier) {",
        "// Line_Reference 947:   if (!json_string_null_or_empty(json_object_get(j_result_code, \"code_challenge\"))) {",
        "// Line_Reference 961:             y_log_message(Y_LOG_LEVEL_ERROR, \"validate_code_challenge - Error o_base64url_encode\");",
        "// Line_Reference 965:           y_log_message(Y_LOG_LEVEL_ERROR, \"validate_code_challenge - Error gnutls_fingerprint\");",
        "// Line_Reference 972:           ret = G_ERROR_PARAM;",
        "// Line_Reference 976:       ret = G_ERROR_PARAM;",
        "// Line_Reference 978:   } else {",
        "// Line_Reference 979:     ret = G_OK;",
        "// Line_Reference 1082:           if ((res = validate_code_challenge(json_array_get(j_result, 0), code_verifier)) == G_OK) {",
        "// Line_Reference 2447:     if (u_map_has_key(request->map_url, \"g_continue\")) {",
        "// Line_Reference 2448:       if (!o_strnullempty(u_map_get(request->map_url, \"scope\"))) {",
        "// Line_Reference 2529:         // Scope is not allowed for this user",
        "// Line_Reference 2530:         y_log_message(Y_LOG_LEVEL_DEBUG, \"check_auth_type_auth_code_grant - oauth2 - scope list is missing or empty, origin: %s\", ip_source);",
        "// Line_Reference 2531:         response->status = 302;",
        "// Line_Reference 2532:         redirect_url = msprintf(\"%s%serror=invalid_scope%s\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"), state_param);",
        "// Line_Reference 2537:       // Redirect to login page",
        "// Line_Reference 2538:       redirect_url = get_login_url(config, request, \"auth\", u_map_get(request->map_url, \"client_id\"), u_map_get(request->map_url, \"scope\"), NULL);",
        "// Line_Reference 2539:       ulfius_add_header_to_response(response, \"Location\", redirect_url);",
        "// Line_Reference 2540:       o_free(redirect_url);",
        "// Line_Reference 2541:       response->status = 302;",
        "// Line_Reference 2545:     response->status = 302;",
        "// Line_Reference 2546:     redirect_url = msprintf(\"%s%serror=unauthorized_client%s%s\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"), (u_map_get(request->map_url, \"state\")!=NULL?\"&state=\":\"\"), (u_map_get(request->map_url, \"state\")!=NULL?u_map_get(request->map_url, \"state\"):\"\"));",
        "// Line_Reference 2547:     ulfius_add_header_to_response(response, \"Location\", redirect_url);",
        "// Line_Reference 2548:     o_free(redirect_url);",
        "// Line_Reference 2710:     if (u_map_has_key(request->map_url, \"g_continue\")) {",
        "// Line_Reference 2711:       if (!o_strnullempty(u_map_get(request->map_url, \"scope\"))) {",
        "// Line_Reference 2794:         // Empty scope is not allowed",
        "// Line_Reference 2795:         response->status = 302;",
        "// Line_Reference 2796:         redirect_url = msprintf(\"%s%serror=invalid_scope%s\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"), state_param);",
        "// Line_Reference 2801:       // Redirect to login page",
        "// Line_Reference 2802:       redirect_url = get_login_url(config, request, \"auth\", u_map_get(request->map_url, \"client_id\"), u_map_get(request->map_url, \"scope\"), NULL);",
        "// Line_Reference 2803:       ulfius_add_header_to_response(response, \"Location\", redirect_url);",
        "// Line_Reference 2804:       o_free(redirect_url);",
        "// Line_Reference 2805:       response->status = 302;",
        "// Line_Reference 2809:     response->status = 302;",
        "// Line_Reference 2810:     redirect_url = msprintf(\"%s%serror=unauthorized_client%s%s\", u_map_get(request->map_url, \"redirect_uri\"), (o_strchr(u_map_get(request->map_url, \"redirect_uri\"), '?')!=NULL?\"&\":\"?\"), (u_map_get(request->map_url, \"state\")!=NULL?\"&state=\":\"\"), (u_map_get(request->map_url, \"state\")!=NULL?u_map_get(request->map_url, \"state\"):\"\"));",
        "// Line_Reference 2811:     ulfius_add_header_to_response(response, \"Location\", redirect_url);",
        "// Line_Reference 2812:     o_free(redirect_url);",
        "// Line_Reference 3316:   char * redirect_url, * state_encoded = NULL, * state_param = NULL;",
        "// Line_Reference 3333:       if (u_map_get(request->map_url, \"redirect_uri\") != NULL) {",
        "// Line_Reference 3334:         response->status = 302;",
        "// Line_Reference 3335:         redirect_url = msprintf(\"%s#error=unsupported_response_type%s\", u_map_get(request->map_url, \"redirect_uri\"), state_param);",
        "// Line_Reference 3336:         ulfius_add_header_to_response(response, \"Location\", redirect_url);",
        "// Line_Reference 3337:         o_free(redirect_url);",
        "// Line_Reference 3338:       } else {",
        "// Line_Reference 3339:         response->status = 403;",
        "// Line_Reference 3340:       }",
        "// Line_Reference 3345:     } else {",
        "// Line_Reference 3346:       if (u_map_get(request->map_url, \"redirect_uri\") != NULL) {",
        "// Line_Reference 3347:         response->status = 302;",
        "// Line_Reference 3348:         redirect_url = msprintf(\"%s#error=unsupported_response_type%s\", u_map_get(request->map_url, \"redirect_uri\"), state_param);",
        "// Line_Reference 3349:         ulfius_add_header_to_response(response, \"Location\", redirect_url);",
        "// Line_Reference 3350:         o_free(redirect_url);",
        "// Line_Reference 3351:       } else {",
        "// Line_Reference 3352:         response->status = 403;",
        "// Line_Reference 3353:       }",
        "// Line_Reference 3354:     }",
        "// Line_Reference 3355:   } else {",
        "// Line_Reference 3356:     if (u_map_get(request->map_url, \"redirect_uri\") != NULL) {",
        "// Line_Reference 3357:       response->status = 302;",
        "// Line_Reference 3358:       redirect_url = msprintf(\"%s#error=unsupported_response_type%s\", u_map_get(request->map_url, \"redirect_uri\"), state_param);",
        "// Line_Reference 3359:       ulfius_add_header_to_response(response, \"Location\", redirect_url);",
        "// Line_Reference 3360:       o_free(redirect_url);"
    ]
}
