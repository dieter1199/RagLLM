{
    "cve_id": "CVE-2019-14763",
    "cve_description": "In the Linux kernel before 4.16.4, a double-locking error in drivers/usb/dwc3/gadget.c may potentially cause a deadlock with f_hid.",
    "cve_publish_date": "2019-08-07",
    "cwe_id": "CWE-667",
    "cwe_name": "Improper Locking",
    "cwe_description": "The product does not properly acquire or release a lock on a resource, leading to unexpected resource state changes and behaviors.",
    "commit_message": "USB: gadget: f_hid: fix deadlock in f_hidg_write()\n\nIn f_hidg_write() the write_spinlock is acquired before calling\nusb_ep_queue() which causes a deadlock when dummy_hcd is being used.\nThis is because dummy_queue() callbacks into f_hidg_req_complete() which\ntries to acquire the same spinlock. This is (part of) the backtrace when\nthe deadlock occurs:\n\n  0xffffffffc06b1410 in f_hidg_req_complete\n  0xffffffffc06a590a in usb_gadget_giveback_request\n  0xffffffffc06cfff2 in dummy_queue\n  0xffffffffc06a4b96 in usb_ep_queue\n  0xffffffffc06b1eb6 in f_hidg_write\n  0xffffffff8127730b in __vfs_write\n  0xffffffff812774d1 in vfs_write\n  0xffffffff81277725 in SYSC_write\n\nFix this by releasing the write_spinlock before calling usb_ep_queue()\n\nReviewed-by: James Bottomley <James.Bottomley@HansenPartnership.com>\nTested-by: James Bottomley <James.Bottomley@HansenPartnership.com>\nCc: stable@vger.kernel.org # 4.11+\nFixes: 749494b6bdbb (\"usb: gadget: f_hid: fix: Move IN request allocation to set_alt()\")\nSigned-off-by: Radoslav Gerganov <rgerganov@vmware.com>\nSigned-off-by: Felipe Balbi <felipe.balbi@linux.intel.com>",
    "type_of_change": "Modification",
    "filename_of_changes": "f_hid.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "3",
    "number_of_lines_deleted_vulnerable_to_cve": "3",
    "vulnerable_lines": [
        "// Line_Reference 398: \t\tgoto release_write_pending_unlocked;",
        "// Line_Reference 402: \tspin_unlock_irqrestore(&hidg->write_spinlock, flags);",
        "// Line_Reference 407: release_write_pending_unlocked:"
    ]
}
