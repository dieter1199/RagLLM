{
    "cve_id": "CVE-2011-1927",
    "cve_description": "The ip_expire function in net/ipv4/ip_fragment.c in the Linux kernel before 2.6.39 does not properly construct ICMP_TIME_EXCEEDED packets after a timeout, which allows remote attackers to cause a denial of service (invalid pointer dereference) via crafted fragmented packets.",
    "cve_publish_date": "2012-06-13",
    "cwe_id": "NVD-CWE-Other",
    "cwe_name": "Other",
    "cwe_description": "NVD is only using a subset of CWE for mapping instead of the entire CWE, and the weakness type is not covered by that subset.",
    "commit_message": "net: ip_expire() must revalidate route\n\nCommit 4a94445c9a5c (net: Use ip_route_input_noref() in input path)\nadded a bug in IP defragmentation handling, in case timeout is fired.\n\nWhen a frame is defragmented, we use last skb dst field when building\nfinal skb. Its dst is valid, since we are in rcu read section.\n\nBut if a timeout occurs, we take first queued fragment to build one ICMP\nTIME EXCEEDED message. Problem is all queued skb have weak dst pointers,\nsince we escaped RCU critical section after their queueing. icmp_send()\nmight dereference a now freed (and possibly reused) part of memory.\n\nCalling skb_dst_drop() and ip_route_input_noref() to revalidate route is\nthe only possible choice.\n\nReported-by: Denys Fedoryshchenko <denys@visp.net.lb>\nSigned-off-by: Eric Dumazet <eric.dumazet@gmail.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
    "type_of_change": "Modification",
    "filename_of_changes": "ip_fragment.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "15",
    "number_of_lines_deleted_vulnerable_to_cve": "16",
    "vulnerable_lines": [
        "// Line_Reference 233: \t\t * Only search router table for the head fragment,",
        "// Line_Reference 234: \t\t * when defraging timeout at PRE_ROUTING HOOK.",
        "// Line_Reference 236: \t\tif (qp->user == IP_DEFRAG_CONNTRACK_IN && !skb_dst(head)) {",
        "// Line_Reference 237: \t\t\tconst struct iphdr *iph = ip_hdr(head);",
        "// Line_Reference 238: \t\t\tint err = ip_route_input(head, iph->daddr, iph->saddr,",
        "// Line_Reference 239: \t\t\t\t\t\t iph->tos, head->dev);",
        "// Line_Reference 240: \t\t\tif (unlikely(err))",
        "// Line_Reference 241: \t\t\t\tgoto out_rcu_unlock;",
        "// Line_Reference 242: ",
        "// Line_Reference 243: \t\t\t/*",
        "// Line_Reference 244: \t\t\t * Only an end host needs to send an ICMP",
        "// Line_Reference 245: \t\t\t * \"Fragment Reassembly Timeout\" message, per RFC792.",
        "// Line_Reference 246: \t\t\t */",
        "// Line_Reference 247: \t\t\tif (skb_rtable(head)->rt_type != RTN_LOCAL)",
        "// Line_Reference 248: \t\t\t\tgoto out_rcu_unlock;",
        "// Line_Reference 250: \t\t}"
    ]
}
