if( $action == 'user.index.index' ||
$action == 'user.view.call'){
$systemPassword = Model('SystemOption')->get('systemPassword');
$accessToken = isset($_REQUEST['accessToken']) ? $_REQUEST['accessToken'] : '';
if($accessToken && strlen($accessToken) < 500){
$pass = substr(md5('kodbox_'.$systemPassword),0,15);
$sessionSign = Mcrypt::decode($accessToken,$pass);
$this->initAccessToken();
public function accessTokenCheck($accessToken){
$systemPassword = Model('SystemOption')->get('systemPassword');
if(!$accessToken || strlen($accessToken) > 500) return false;
$pass = substr(md5('kodbox_'.$systemPassword),0,15);
$sessionSign = Mcrypt::decode($accessToken,$pass);
if(!$sessionSign || $sessionSign != Session::sign()) return false;
return true;
}
// accesstoken 登录前处理;
private function initAccessToken(){
$action = strtolower(ACTION);
$disableCookie = array(
'explorer.index.filedownload',
'explorer.index.fileout',
'explorer.share.filedownload',
'explorer.share.fileout',
);
$enableCookie = array('user.index.index');
if(in_array($action,$enableCookie)){Cookie::disable(false);} // 带token的url跳转入口页面允许cookie输出;
if(in_array($action,$disableCookie)){Cookie::disable(true);allowCROS();}
}
$pass = Model('SystemOption')->get('systemPassword');
$pass = substr(md5('kodbox_'.$pass),0,15);
$token = Mcrypt::encode(Session::sign(),$pass,3600*24*30);
return $token;
if(!Session::get('kodUser')){
show_json('user not login!',ERROR_CODE_LOGOUT);
}
