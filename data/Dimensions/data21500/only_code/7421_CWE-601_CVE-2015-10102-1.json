@version 1.7
Version: 1.7
if ( $_REQUEST['wp-submit'] == "Log In" && is_a( $user, 'WP_User' ) ) {
$freshdesk_options = get_option( 'freshdesk_options' );
$ssl_url = $fd_redirect_to."/login/sso?name=".urlencode($user->data->display_name)."&email=".urlencode($user->data->user_email)."&timestamp=".time()."&hash=".urlencode($hash_key);
if ( ! preg_match("/\b(?:(?:https?):\/\/|www\.)[-a-z0-9+&@#\/%?=~_|!:,.;]*[-a-z0-9+&@#\/%=~_|]/i", $url ) ) {
$url ='';
'Domain url cannot be blank', // error message
$settings = array( 'freshdesk_domain_url' => $url, 'freshdesk_enable_sso' => $enable_sso, 'freshdesk_sso_key' => $sso_secret, 'freshdesk_api_key' => $api_key, 'freshdesk_enable_feedback' => $enable_feedback );
$freshdesk_options = get_option( 'freshdesk_options' );
$url = freshdesk_sso_login_url( $user_name, $user_email ,$hash_key );
$domain = ( $_REQUEST['host_url'] ) ? get_domain_protocol()."://".$_REQUEST['host_url'] : $freshdesk_options['freshdesk_domain_url']; // Redirect to the host url if host url option is present with the request.
$redirect_url = wp_login_url();
// Sometimes we get the http referer and some times don't so to find if it is coming from Freshdesk we do a two condition check and if one is satisfied then Freshdesk is the referer.
// Condition-1) Host url is a substring of http referer
// Condition-2) Host url exists and the http_referer is empty because request from within wordpress seems to always have a referer.
$condition_one = ( strpos($_SERVER['HTTP_REFERER'], $_REQUEST['host_url']) !== FALSE ) ? TRUE : FALSE;
$condition_two = ( $_REQUEST['host_url'] && empty( $_SERVER['HTTP_REFERER'] ) );
if ( $condition_one || $condition_two ) {
$redirect_url = get_domain_protocol()."://".$_REQUEST['host_url'];
}
header( 'Location: '.$redirect_url );
function get_domain_protocol() {
$freshdesk_options= get_option( 'freshdesk_options' );
$domain_url = $freshdesk_options['freshdesk_domain_url'];
$temp_array = explode( ":", $domain_url );
$protocol = $temp_array[0];
return $protocol;
}
function freshdesk_sso_login_url($user_name,$email,$hash_key){
$host_url = $_GET['host_url'];
$protocol = get_domain_protocol()."://";
$domain = (empty($host_url) === true) ? $domain_url : $host_url; // Take the domain_url if host_url is null.
return $protocol.$domain."/login/sso?name=".urlencode($user_name)."&email=".urlencode($email)."&timestamp=".time()."&hash=".urlencode($hash_key);
