{
    "cve_id": "CVE-2015-2695",
    "cve_description": "lib/gssapi/spnego/spnego_mech.c in MIT Kerberos 5 (aka krb5) before 1.14 relies on an inappropriate context handle, which allows remote attackers to cause a denial of service (incorrect pointer read and process crash) via a crafted SPNEGO packet that is mishandled during a gss_inquire_context call.",
    "cve_publish_date": "2015-11-09",
    "cwe_id": "CWE-763",
    "cwe_name": "Release of Invalid Pointer or Reference",
    "cwe_description": "The product attempts to return a memory resource to the system, but it calls the wrong release function or calls the appropriate release function incorrectly.",
    "commit_message": "Fix SPNEGO context aliasing bugs [CVE-2015-2695]\n\nThe SPNEGO mechanism currently replaces its context handle with the\nmechanism context handle upon establishment, under the assumption that\nmost GSS functions are only called after context establishment.  This\nassumption is incorrect, and can lead to aliasing violations for some\nprograms.  Maintain the SPNEGO context structure after context\nestablishment and refer to it in all GSS methods.  Add initiate and\nopened flags to the SPNEGO context structure for use in\ngss_inquire_context() prior to context establishment.\n\nCVE-2015-2695:\n\nIn MIT krb5 1.5 and later, applications which call\ngss_inquire_context() on a partially-established SPNEGO context can\ncause the GSS-API library to read from a pointer using the wrong type,\ngenerally causing a process crash.  This bug may go unnoticed, because\nthe most common SPNEGO authentication scenario establishes the context\nafter just one call to gss_accept_sec_context().  Java server\napplications using the native JGSS provider are vulnerable to this\nbug.  A carefully crafted SPNEGO packet might allow the\ngss_inquire_context() call to succeed with attacker-determined\nresults, but applications should not make access control decisions\nbased on gss_inquire_context() results prior to context establishment.\n\n    CVSSv2 Vector: AV:N/AC:M/Au:N/C:N/I:N/A:C/E:POC/RL:OF/RC:C\n\n[ghudson@mit.edu: several bugfixes, style changes, and edge-case\nbehavior changes; commit message and CVE description]\n\nticket: 8244\ntarget_version: 1.14\ntags: pullup",
    "type_of_change": "Modification",
    "filename_of_changes": "spnego_mech.c",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "190",
    "number_of_lines_deleted_vulnerable_to_cve": "64",
    "vulnerable_lines": [
        "// Line_Reference 105: static spnego_gss_ctx_id_t create_spnego_ctx(void);",
        "// Line_Reference 457: create_spnego_ctx(void)",
        "// Line_Reference 645: \tsc = create_spnego_ctx();",
        "// Line_Reference 662: \t/*",
        "// Line_Reference 663: \t * The actual context is not yet determined, set the output",
        "// Line_Reference 664: \t * context handle to refer to the spnego context itself.",
        "// Line_Reference 665: \t */",
        "// Line_Reference 1111: \t\t/*",
        "// Line_Reference 1112: \t\t * Now, switch the output context to refer to the",
        "// Line_Reference 1113: \t\t * negotiated mechanism's context.",
        "// Line_Reference 1114: \t\t */",
        "// Line_Reference 1115: \t\t*context_handle = (gss_ctx_id_t)spnego_ctx->ctx_handle;",
        "// Line_Reference 1120: \t\trelease_spnego_ctx(&spnego_ctx);",
        "// Line_Reference 1288: \tsc = create_spnego_ctx();",
        "// Line_Reference 1370: \t\tsc = create_spnego_ctx();",
        "// Line_Reference 1753: \t\t*context_handle = (gss_ctx_id_t)sc->ctx_handle;",
        "// Line_Reference 1759: \t\trelease_spnego_ctx(&sc);",
        "// Line_Reference 2073: \t\t\tcontext_handle,",
        "// Line_Reference 2094: \t\t    context_handle,",
        "// Line_Reference 2112: \t\t\t\t\tcontext_handle,",
        "// Line_Reference 2136: \t/*",
        "// Line_Reference 2137: \t * If this is still an SPNEGO mech, release it locally.",
        "// Line_Reference 2138: \t */",
        "// Line_Reference 2139: \tif ((*ctx)->magic_num == SPNEGO_MAGIC_ID) {",
        "// Line_Reference 2140: \t\t(void) gss_delete_sec_context(minor_status,",
        "// Line_Reference 2141: \t\t\t\t    &(*ctx)->ctx_handle,",
        "// Line_Reference 2142: \t\t\t\t    output_token);",
        "// Line_Reference 2143: \t\t(void) release_spnego_ctx(ctx);",
        "// Line_Reference 2144: \t} else {",
        "// Line_Reference 2145: \t\tret = gss_delete_sec_context(minor_status,",
        "// Line_Reference 2146: \t\t\t\t    context_handle,",
        "// Line_Reference 2147: \t\t\t\t    output_token);",
        "// Line_Reference 2148: \t}",
        "// Line_Reference 2161: \t\t\t    context_handle,",
        "// Line_Reference 2174: \t\t\t\t    context_handle,",
        "// Line_Reference 2185: \tOM_uint32 ret;",
        "// Line_Reference 2186: \tret = gss_import_sec_context(minor_status,",
        "// Line_Reference 2187: \t\t\t\t    interprocess_token,",
        "// Line_Reference 2188: \t\t\t\t    context_handle);",
        "// Line_Reference 2189: \treturn (ret);",
        "// Line_Reference 2207: \tret = gss_inquire_context(minor_status,",
        "// Line_Reference 2208: \t\t\t\tcontext_handle,",
        "// Line_Reference 2209: \t\t\t\tsrc_name,",
        "// Line_Reference 2210: \t\t\t\ttarg_name,",
        "// Line_Reference 2211: \t\t\t\tlifetime_rec,",
        "// Line_Reference 2212: \t\t\t\tmech_type,",
        "// Line_Reference 2213: \t\t\t\tctx_flags,",
        "// Line_Reference 2214: \t\t\t\tlocally_initiated,",
        "// Line_Reference 2215: \t\t\t\topened);",
        "// Line_Reference 2231: \t\t\t\tcontext_handle,",
        "// Line_Reference 2249: \t\t    context_handle,",
        "// Line_Reference 2266: \t\t\t    context_handle,",
        "// Line_Reference 2282: \t\t\t    context_handle,",
        "// Line_Reference 2363: \t\t\t    context_handle,",
        "// Line_Reference 2381: \t\t\t    context_handle,",
        "// Line_Reference 2403: \t\t\t      context_handle,",
        "// Line_Reference 2423: \t\t\t   context_handle,",
        "// Line_Reference 2442: \t\t\t     context_handle,",
        "// Line_Reference 2461: \t\t\t\t  context_handle,",
        "// Line_Reference 2479: \t\t\t\t      context_handle,",
        "// Line_Reference 2725: \t\t\t\tcontext,",
        "// Line_Reference 2866:     return gss_get_mic_iov(minor_status, context_handle, qop_req, iov,",
        "// Line_Reference 2875:     return gss_verify_mic_iov(minor_status, context_handle, qop_state, iov,",
        "// Line_Reference 2884:     return gss_get_mic_iov_length(minor_status, context_handle, qop_req, iov,"
    ]
}
