{
    "cve_id": "CVE-2017-14340",
    "cve_description": "The XFS_IS_REALTIME_INODE macro in fs/xfs/xfs_linux.h in the Linux kernel before 4.13.2 does not verify that a filesystem has a realtime device, which allows local users to cause a denial of service (NULL pointer dereference and OOPS) via vectors related to setting an RHINHERIT flag on a directory.",
    "cve_publish_date": "2017-09-15",
    "cwe_id": "CWE-476",
    "cwe_name": "NULL Pointer Dereference",
    "cwe_description": "The product dereferences a pointer that it expects to be valid but is NULL.",
    "commit_message": "xfs: XFS_IS_REALTIME_INODE() should be false if no rt device present\n\nIf using a kernel with CONFIG_XFS_RT=y and we set the RHINHERIT flag on\na directory in a filesystem that does not have a realtime device and\ncreate a new file in that directory, it gets marked as a real time file.\nWhen data is written and a fsync is issued, the filesystem attempts to\nflush a non-existent rt device during the fsync process.\n\nThis results in a crash dereferencing a null buftarg pointer in\nxfs_blkdev_issue_flush():\n\n  BUG: unable to handle kernel NULL pointer dereference at 0000000000000008\n  IP: xfs_blkdev_issue_flush+0xd/0x20\n  .....\n  Call Trace:\n    xfs_file_fsync+0x188/0x1c0\n    vfs_fsync_range+0x3b/0xa0\n    do_fsync+0x3d/0x70\n    SyS_fsync+0x10/0x20\n    do_syscall_64+0x4d/0xb0\n    entry_SYSCALL64_slow_path+0x25/0x25\n\nSetting RT inode flags does not require special privileges so any\nunprivileged user can cause this oops to occur.  To reproduce, confirm\nkernel is compiled with CONFIG_XFS_RT=y and run:\n\n  # mkfs.xfs -f /dev/pmem0\n  # mount /dev/pmem0 /mnt/test\n  # mkdir /mnt/test/foo\n  # xfs_io -c 'chattr +t' /mnt/test/foo\n  # xfs_io -f -c 'pwrite 0 5m' -c fsync /mnt/test/foo/bar\n\nOr just run xfstests with MKFS_OPTIONS=\"-d rtinherit=1\" and wait.\n\nKernels built with CONFIG_XFS_RT=n are not exposed to this bug.\n\nFixes: f538d4da8d52 (\"[XFS] write barrier support\")\nCc: <stable@vger.kernel.org>\nSigned-off-by: Richard Wareing <rwareing@fb.com>\nSigned-off-by: Dave Chinner <david@fromorbit.com>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>",
    "type_of_change": "Modification",
    "filename_of_changes": "xfs_linux.h",
    "code_language": "C",
    "number_of_lines_added_for_mitigation": "8",
    "number_of_lines_deleted_vulnerable_to_cve": "1",
    "vulnerable_lines": [
        "// Line_Reference 273: #define XFS_IS_REALTIME_INODE(ip) ((ip)->i_d.di_flags & XFS_DIFLAG_REALTIME)"
    ]
}
