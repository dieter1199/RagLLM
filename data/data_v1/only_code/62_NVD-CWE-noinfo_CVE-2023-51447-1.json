filename = file_name_for(attachment)
return filename if filename.length <= max_length
name.truncate(max_length, omission: "...#{name.last((max_length / 2) - 3)}#{File.extname(filename)}")
determine_filename(attachment)